<?xml version="1.0" encoding="ISO-8859-1"?>

<xwikidoc>
<web>XWiki</web>
<name>SkinEditor</name>
<language></language>
<defaultLanguage></defaultLanguage>
<translation>0</translation>
<parent></parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1234634502000</creationDate>
<date>1235835686000</date>
<contentUpdateDate>1235835686000</contentUpdateDate>
<version>4.1</version>
<title>XWiki Skin Editor</title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment></comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/1.0</syntaxId>
<attachment>
<filename>bespin.js</filename>
<filesize>308518</filesize>
<author>XWiki.Admin</author>
<date>1235337053000</date>
<version>1.7</version>
<comment></comment>
<content>Ly8gc2NyaXB0LmFjdWxvLnVzIGVmZmVjdHMuanMgdjEuOC4yLCBUdWUgTm92IDE4IDE4OjMwOjU4ICswMTAwIDIwMDgKCi8vIENvcHlyaWdodCAoYykgMjAwNS0yMDA4IFRob21hcyBGdWNocyAoaHR0cDovL3NjcmlwdC5hY3Vsby51cywgaHR0cDovL21pci5hY3Vsby51cykKLy8gQ29udHJpYnV0b3JzOgovLyAgSnVzdGluIFBhbG1lciAoaHR0cDovL2VuY3l0ZW1lZGlhLmNvbS8pCi8vICBNYXJrIFBpbGdyaW0gKGh0dHA6Ly9kaXZlaW50b21hcmsub3JnLykKLy8gIE1hcnRpbiBCaWFsYXNpbmtpCi8vCi8vIHNjcmlwdC5hY3Vsby51cyBpcyBmcmVlbHkgZGlzdHJpYnV0YWJsZSB1bmRlciB0aGUgdGVybXMgb2YgYW4gTUlULXN0eWxlIGxpY2Vuc2UuCi8vIEZvciBkZXRhaWxzLCBzZWUgdGhlIHNjcmlwdC5hY3Vsby51cyB3ZWIgc2l0ZTogaHR0cDovL3NjcmlwdC5hY3Vsby51cy8KCi8vIGNvbnZlcnRzIHJnYigpIGFuZCAjeHh4IHRvICN4eHh4eHggZm9ybWF0LAovLyByZXR1cm5zIHNlbGYgKG9yIGZpcnN0IGFyZ3VtZW50KSBpZiBub3QgY29udmVydGFibGUKU3RyaW5nLnByb3RvdHlwZS5wYXJzZUNvbG9yID0gZnVuY3Rpb24oKSB7CiAgdmFyIGNvbG9yID0gJyMnOwogIGlmICh0aGlzLnNsaWNlKDAsNCkgPT0gJ3JnYignKSB7CiAgICB2YXIgY29scyA9IHRoaXMuc2xpY2UoNCx0aGlzLmxlbmd0aC0xKS5zcGxpdCgnLCcpOwogICAgdmFyIGk9MDsgZG8geyBjb2xvciArPSBwYXJzZUludChjb2xzW2ldKS50b0NvbG9yUGFydCgpIH0gd2hpbGUgKCsraTwzKTsKICB9IGVsc2UgewogICAgaWYgKHRoaXMuc2xpY2UoMCwxKSA9PSAnIycpIHsKICAgICAgaWYgKHRoaXMubGVuZ3RoPT00KSBmb3IodmFyIGk9MTtpPDQ7aSsrKSBjb2xvciArPSAodGhpcy5jaGFyQXQoaSkgKyB0aGlzLmNoYXJBdChpKSkudG9Mb3dlckNhc2UoKTsKICAgICAgaWYgKHRoaXMubGVuZ3RoPT03KSBjb2xvciA9IHRoaXMudG9Mb3dlckNhc2UoKTsKICAgIH0KICB9CiAgcmV0dXJuIChjb2xvci5sZW5ndGg9PTcgPyBjb2xvciA6IChhcmd1bWVudHNbMF0gfHwgdGhpcykpOwp9OwoKLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgpFbGVtZW50LmNvbGxlY3RUZXh0Tm9kZXMgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgcmV0dXJuICRBKCQoZWxlbWVudCkuY2hpbGROb2RlcykuY29sbGVjdCggZnVuY3Rpb24obm9kZSkgewogICAgcmV0dXJuIChub2RlLm5vZGVUeXBlPT0zID8gbm9kZS5ub2RlVmFsdWUgOgogICAgICAobm9kZS5oYXNDaGlsZE5vZGVzKCkgPyBFbGVtZW50LmNvbGxlY3RUZXh0Tm9kZXMobm9kZSkgOiAnJykpOwogIH0pLmZsYXR0ZW4oKS5qb2luKCcnKTsKfTsKCkVsZW1lbnQuY29sbGVjdFRleHROb2Rlc0lnbm9yZUNsYXNzID0gZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lKSB7CiAgcmV0dXJuICRBKCQoZWxlbWVudCkuY2hpbGROb2RlcykuY29sbGVjdCggZnVuY3Rpb24obm9kZSkgewogICAgcmV0dXJuIChub2RlLm5vZGVUeXBlPT0zID8gbm9kZS5ub2RlVmFsdWUgOgogICAgICAoKG5vZGUuaGFzQ2hpbGROb2RlcygpICYmICFFbGVtZW50Lmhhc0NsYXNzTmFtZShub2RlLGNsYXNzTmFtZSkpID8KICAgICAgICBFbGVtZW50LmNvbGxlY3RUZXh0Tm9kZXNJZ25vcmVDbGFzcyhub2RlLCBjbGFzc05hbWUpIDogJycpKTsKICB9KS5mbGF0dGVuKCkuam9pbignJyk7Cn07CgpFbGVtZW50LnNldENvbnRlbnRab29tID0gZnVuY3Rpb24oZWxlbWVudCwgcGVyY2VudCkgewogIGVsZW1lbnQgPSAkKGVsZW1lbnQpOwogIGVsZW1lbnQuc2V0U3R5bGUoe2ZvbnRTaXplOiAocGVyY2VudC8xMDApICsgJ2VtJ30pOwogIGlmIChQcm90b3R5cGUuQnJvd3Nlci5XZWJLaXQpIHdpbmRvdy5zY3JvbGxCeSgwLDApOwogIHJldHVybiBlbGVtZW50Owp9OwoKRWxlbWVudC5nZXRJbmxpbmVPcGFjaXR5ID0gZnVuY3Rpb24oZWxlbWVudCl7CiAgcmV0dXJuICQoZWxlbWVudCkuc3R5bGUub3BhY2l0eSB8fCAnJzsKfTsKCkVsZW1lbnQuZm9yY2VSZXJlbmRlcmluZyA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICB0cnkgewogICAgZWxlbWVudCA9ICQoZWxlbWVudCk7CiAgICB2YXIgbiA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCcgJyk7CiAgICBlbGVtZW50LmFwcGVuZENoaWxkKG4pOwogICAgZWxlbWVudC5yZW1vdmVDaGlsZChuKTsKICB9IGNhdGNoKGUpIHsgfQp9OwoKLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgp2YXIgRWZmZWN0ID0gewogIF9lbGVtZW50RG9lc05vdEV4aXN0RXJyb3I6IHsKICAgIG5hbWU6ICdFbGVtZW50RG9lc05vdEV4aXN0RXJyb3InLAogICAgbWVzc2FnZTogJ1RoZSBzcGVjaWZpZWQgRE9NIGVsZW1lbnQgZG9lcyBub3QgZXhpc3QsIGJ1dCBpcyByZXF1aXJlZCBmb3IgdGhpcyBlZmZlY3QgdG8gb3BlcmF0ZScKICB9LAogIFRyYW5zaXRpb25zOiB7CiAgICBsaW5lYXI6IFByb3RvdHlwZS5LLAogICAgc2lub2lkYWw6IGZ1bmN0aW9uKHBvcykgewogICAgICByZXR1cm4gKC1NYXRoLmNvcyhwb3MqTWF0aC5QSSkvMikgKyAuNTsKICAgIH0sCiAgICByZXZlcnNlOiBmdW5jdGlvbihwb3MpIHsKICAgICAgcmV0dXJuIDEtcG9zOwogICAgfSwKICAgIGZsaWNrZXI6IGZ1bmN0aW9uKHBvcykgewogICAgICB2YXIgcG9zID0gKCgtTWF0aC5jb3MocG9zKk1hdGguUEkpLzQpICsgLjc1KSArIE1hdGgucmFuZG9tKCkvNDsKICAgICAgcmV0dXJuIHBvcyA+IDEgPyAxIDogcG9zOwogICAgfSwKICAgIHdvYmJsZTogZnVuY3Rpb24ocG9zKSB7CiAgICAgIHJldHVybiAoLU1hdGguY29zKHBvcypNYXRoLlBJKig5KnBvcykpLzIpICsgLjU7CiAgICB9LAogICAgcHVsc2U6IGZ1bmN0aW9uKHBvcywgcHVsc2VzKSB7CiAgICAgIHJldHVybiAoLU1hdGguY29zKChwb3MqKChwdWxzZXN8fDUpLS41KSoyKSpNYXRoLlBJKS8yKSArIC41OwogICAgfSwKICAgIHNwcmluZzogZnVuY3Rpb24ocG9zKSB7CiAgICAgIHJldHVybiAxIC0gKE1hdGguY29zKHBvcyAqIDQuNSAqIE1hdGguUEkpICogTWF0aC5leHAoLXBvcyAqIDYpKTsKICAgIH0sCiAgICBub25lOiBmdW5jdGlvbihwb3MpIHsKICAgICAgcmV0dXJuIDA7CiAgICB9LAogICAgZnVsbDogZnVuY3Rpb24ocG9zKSB7CiAgICAgIHJldHVybiAxOwogICAgfQogIH0sCiAgRGVmYXVsdE9wdGlvbnM6IHsKICAgIGR1cmF0aW9uOiAgIDEuMCwgICAvLyBzZWNvbmRzCiAgICBmcHM6ICAgICAgICAxMDAsICAgLy8gMTAwPSBhc3N1bWUgNjZmcHMgbWF4LgogICAgc3luYzogICAgICAgZmFsc2UsIC8vIHRydWUgZm9yIGNvbWJpbmluZwogICAgZnJvbTogICAgICAgMC4wLAogICAgdG86ICAgICAgICAgMS4wLAogICAgZGVsYXk6ICAgICAgMC4wLAogICAgcXVldWU6ICAgICAgJ3BhcmFsbGVsJwogIH0sCiAgdGFnaWZ5VGV4dDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgdmFyIHRhZ2lmeVN0eWxlID0gJ3Bvc2l0aW9uOnJlbGF0aXZlJzsKICAgIGlmIChQcm90b3R5cGUuQnJvd3Nlci5JRSkgdGFnaWZ5U3R5bGUgKz0gJzt6b29tOjEnOwoKICAgIGVsZW1lbnQgPSAkKGVsZW1lbnQpOwogICAgJEEoZWxlbWVudC5jaGlsZE5vZGVzKS5lYWNoKCBmdW5jdGlvbihjaGlsZCkgewogICAgICBpZiAoY2hpbGQubm9kZVR5cGU9PTMpIHsKICAgICAgICBjaGlsZC5ub2RlVmFsdWUudG9BcnJheSgpLmVhY2goIGZ1bmN0aW9uKGNoYXJhY3RlcikgewogICAgICAgICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoCiAgICAgICAgICAgIG5ldyBFbGVtZW50KCdzcGFuJywge3N0eWxlOiB0YWdpZnlTdHlsZX0pLnVwZGF0ZSgKICAgICAgICAgICAgICBjaGFyYWN0ZXIgPT0gJyAnID8gU3RyaW5nLmZyb21DaGFyQ29kZSgxNjApIDogY2hhcmFjdGVyKSwKICAgICAgICAgICAgICBjaGlsZCk7CiAgICAgICAgfSk7CiAgICAgICAgRWxlbWVudC5yZW1vdmUoY2hpbGQpOwogICAgICB9CiAgICB9KTsKICB9LAogIG11bHRpcGxlOiBmdW5jdGlvbihlbGVtZW50LCBlZmZlY3QpIHsKICAgIHZhciBlbGVtZW50czsKICAgIGlmICgoKHR5cGVvZiBlbGVtZW50ID09ICdvYmplY3QnKSB8fAogICAgICAgIE9iamVjdC5pc0Z1bmN0aW9uKGVsZW1lbnQpKSAmJgogICAgICAgKGVsZW1lbnQubGVuZ3RoKSkKICAgICAgZWxlbWVudHMgPSBlbGVtZW50OwogICAgZWxzZQogICAgICBlbGVtZW50cyA9ICQoZWxlbWVudCkuY2hpbGROb2RlczsKCiAgICB2YXIgb3B0aW9ucyA9IE9iamVjdC5leHRlbmQoewogICAgICBzcGVlZDogMC4xLAogICAgICBkZWxheTogMC4wCiAgICB9LCBhcmd1bWVudHNbMl0gfHwgeyB9KTsKICAgIHZhciBtYXN0ZXJEZWxheSA9IG9wdGlvbnMuZGVsYXk7CgogICAgJEEoZWxlbWVudHMpLmVhY2goIGZ1bmN0aW9uKGVsZW1lbnQsIGluZGV4KSB7CiAgICAgIG5ldyBlZmZlY3QoZWxlbWVudCwgT2JqZWN0LmV4dGVuZChvcHRpb25zLCB7IGRlbGF5OiBpbmRleCAqIG9wdGlvbnMuc3BlZWQgKyBtYXN0ZXJEZWxheSB9KSk7CiAgICB9KTsKICB9LAogIFBBSVJTOiB7CiAgICAnc2xpZGUnOiAgWydTbGlkZURvd24nLCdTbGlkZVVwJ10sCiAgICAnYmxpbmQnOiAgWydCbGluZERvd24nLCdCbGluZFVwJ10sCiAgICAnYXBwZWFyJzogWydBcHBlYXInLCdGYWRlJ10KICB9LAogIHRvZ2dsZTogZnVuY3Rpb24oZWxlbWVudCwgZWZmZWN0KSB7CiAgICBlbGVtZW50ID0gJChlbGVtZW50KTsKICAgIGVmZmVjdCA9IChlZmZlY3QgfHwgJ2FwcGVhcicpLnRvTG93ZXJDYXNlKCk7CiAgICB2YXIgb3B0aW9ucyA9IE9iamVjdC5leHRlbmQoewogICAgICBxdWV1ZTogeyBwb3NpdGlvbjonZW5kJywgc2NvcGU6KGVsZW1lbnQuaWQgfHwgJ2dsb2JhbCcpLCBsaW1pdDogMSB9CiAgICB9LCBhcmd1bWVudHNbMl0gfHwgeyB9KTsKICAgIEVmZmVjdFtlbGVtZW50LnZpc2libGUoKSA/CiAgICAgIEVmZmVjdC5QQUlSU1tlZmZlY3RdWzFdIDogRWZmZWN0LlBBSVJTW2VmZmVjdF1bMF1dKGVsZW1lbnQsIG9wdGlvbnMpOwogIH0KfTsKCkVmZmVjdC5EZWZhdWx0T3B0aW9ucy50cmFuc2l0aW9uID0gRWZmZWN0LlRyYW5zaXRpb25zLnNpbm9pZGFsOwoKLyogLS0tLS0tLS0tLS0tLSBjb3JlIGVmZmVjdHMgLS0tLS0tLS0tLS0tLSAqLwoKRWZmZWN0LlNjb3BlZFF1ZXVlID0gQ2xhc3MuY3JlYXRlKEVudW1lcmFibGUsIHsKICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuZWZmZWN0cyAgPSBbXTsKICAgIHRoaXMuaW50ZXJ2YWwgPSBudWxsOwogIH0sCiAgX2VhY2g6IGZ1bmN0aW9uKGl0ZXJhdG9yKSB7CiAgICB0aGlzLmVmZmVjdHMuX2VhY2goaXRlcmF0b3IpOwogIH0sCiAgYWRkOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgIHZhciB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCiAgICB2YXIgcG9zaXRpb24gPSBPYmplY3QuaXNTdHJpbmcoZWZmZWN0Lm9wdGlvbnMucXVldWUpID8KICAgICAgZWZmZWN0Lm9wdGlvbnMucXVldWUgOiBlZmZlY3Qub3B0aW9ucy5xdWV1ZS5wb3NpdGlvbjsKCiAgICBzd2l0Y2gocG9zaXRpb24pIHsKICAgICAgY2FzZSAnZnJvbnQnOgogICAgICAgIC8vIG1vdmUgdW5zdGFydGVkIGVmZmVjdHMgYWZ0ZXIgdGhpcyBlZmZlY3QKICAgICAgICB0aGlzLmVmZmVjdHMuZmluZEFsbChmdW5jdGlvbihlKXsgcmV0dXJuIGUuc3RhdGU9PSdpZGxlJyB9KS5lYWNoKCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIGUuc3RhcnRPbiAgKz0gZWZmZWN0LmZpbmlzaE9uOwogICAgICAgICAgICBlLmZpbmlzaE9uICs9IGVmZmVjdC5maW5pc2hPbjsKICAgICAgICAgIH0pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICd3aXRoLWxhc3QnOgogICAgICAgIHRpbWVzdGFtcCA9IHRoaXMuZWZmZWN0cy5wbHVjaygnc3RhcnRPbicpLm1heCgpIHx8IHRpbWVzdGFtcDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnZW5kJzoKICAgICAgICAvLyBzdGFydCBlZmZlY3QgYWZ0ZXIgbGFzdCBxdWV1ZWQgZWZmZWN0IGhhcyBmaW5pc2hlZAogICAgICAgIHRpbWVzdGFtcCA9IHRoaXMuZWZmZWN0cy5wbHVjaygnZmluaXNoT24nKS5tYXgoKSB8fCB0aW1lc3RhbXA7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgZWZmZWN0LnN0YXJ0T24gICs9IHRpbWVzdGFtcDsKICAgIGVmZmVjdC5maW5pc2hPbiArPSB0aW1lc3RhbXA7CgogICAgaWYgKCFlZmZlY3Qub3B0aW9ucy5xdWV1ZS5saW1pdCB8fCAodGhpcy5lZmZlY3RzLmxlbmd0aCA8IGVmZmVjdC5vcHRpb25zLnF1ZXVlLmxpbWl0KSkKICAgICAgdGhpcy5lZmZlY3RzLnB1c2goZWZmZWN0KTsKCiAgICBpZiAoIXRoaXMuaW50ZXJ2YWwpCiAgICAgIHRoaXMuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLmxvb3AuYmluZCh0aGlzKSwgMTUpOwogIH0sCiAgcmVtb3ZlOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgIHRoaXMuZWZmZWN0cyA9IHRoaXMuZWZmZWN0cy5yZWplY3QoZnVuY3Rpb24oZSkgeyByZXR1cm4gZT09ZWZmZWN0IH0pOwogICAgaWYgKHRoaXMuZWZmZWN0cy5sZW5ndGggPT0gMCkgewogICAgICBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWwpOwogICAgICB0aGlzLmludGVydmFsID0gbnVsbDsKICAgIH0KICB9LAogIGxvb3A6IGZ1bmN0aW9uKCkgewogICAgdmFyIHRpbWVQb3MgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIGZvcih2YXIgaT0wLCBsZW49dGhpcy5lZmZlY3RzLmxlbmd0aDtpPGxlbjtpKyspCiAgICAgIHRoaXMuZWZmZWN0c1tpXSAmJiB0aGlzLmVmZmVjdHNbaV0ubG9vcCh0aW1lUG9zKTsKICB9Cn0pOwoKRWZmZWN0LlF1ZXVlcyA9IHsKICBpbnN0YW5jZXM6ICRIKCksCiAgZ2V0OiBmdW5jdGlvbihxdWV1ZU5hbWUpIHsKICAgIGlmICghT2JqZWN0LmlzU3RyaW5nKHF1ZXVlTmFtZSkpIHJldHVybiBxdWV1ZU5hbWU7CgogICAgcmV0dXJuIHRoaXMuaW5zdGFuY2VzLmdldChxdWV1ZU5hbWUpIHx8CiAgICAgIHRoaXMuaW5zdGFuY2VzLnNldChxdWV1ZU5hbWUsIG5ldyBFZmZlY3QuU2NvcGVkUXVldWUoKSk7CiAgfQp9OwpFZmZlY3QuUXVldWUgPSBFZmZlY3QuUXVldWVzLmdldCgnZ2xvYmFsJyk7CgpFZmZlY3QuQmFzZSA9IENsYXNzLmNyZWF0ZSh7CiAgcG9zaXRpb246IG51bGwsCiAgc3RhcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIGZ1bmN0aW9uIGNvZGVGb3JFdmVudChvcHRpb25zLGV2ZW50TmFtZSl7CiAgICAgIHJldHVybiAoCiAgICAgICAgKG9wdGlvbnNbZXZlbnROYW1lKydJbnRlcm5hbCddID8gJ3RoaXMub3B0aW9ucy4nK2V2ZW50TmFtZSsnSW50ZXJuYWwodGhpcyk7JyA6ICcnKSArCiAgICAgICAgKG9wdGlvbnNbZXZlbnROYW1lXSA/ICd0aGlzLm9wdGlvbnMuJytldmVudE5hbWUrJyh0aGlzKTsnIDogJycpCiAgICAgICk7CiAgICB9CiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnRyYW5zaXRpb24gPT09IGZhbHNlKSBvcHRpb25zLnRyYW5zaXRpb24gPSBFZmZlY3QuVHJhbnNpdGlvbnMubGluZWFyOwogICAgdGhpcy5vcHRpb25zICAgICAgPSBPYmplY3QuZXh0ZW5kKE9iamVjdC5leHRlbmQoeyB9LEVmZmVjdC5EZWZhdWx0T3B0aW9ucyksIG9wdGlvbnMgfHwgeyB9KTsKICAgIHRoaXMuY3VycmVudEZyYW1lID0gMDsKICAgIHRoaXMuc3RhdGUgICAgICAgID0gJ2lkbGUnOwogICAgdGhpcy5zdGFydE9uICAgICAgPSB0aGlzLm9wdGlvbnMuZGVsYXkqMTAwMDsKICAgIHRoaXMuZmluaXNoT24gICAgID0gdGhpcy5zdGFydE9uKyh0aGlzLm9wdGlvbnMuZHVyYXRpb24qMTAwMCk7CiAgICB0aGlzLmZyb21Ub0RlbHRhICA9IHRoaXMub3B0aW9ucy50by10aGlzLm9wdGlvbnMuZnJvbTsKICAgIHRoaXMudG90YWxUaW1lICAgID0gdGhpcy5maW5pc2hPbi10aGlzLnN0YXJ0T247CiAgICB0aGlzLnRvdGFsRnJhbWVzICA9IHRoaXMub3B0aW9ucy5mcHMqdGhpcy5vcHRpb25zLmR1cmF0aW9uOwoKICAgIHRoaXMucmVuZGVyID0gKGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiBkaXNwYXRjaChlZmZlY3QsIGV2ZW50TmFtZSkgewogICAgICAgIGlmIChlZmZlY3Qub3B0aW9uc1tldmVudE5hbWUgKyAnSW50ZXJuYWwnXSkKICAgICAgICAgIGVmZmVjdC5vcHRpb25zW2V2ZW50TmFtZSArICdJbnRlcm5hbCddKGVmZmVjdCk7CiAgICAgICAgaWYgKGVmZmVjdC5vcHRpb25zW2V2ZW50TmFtZV0pCiAgICAgICAgICBlZmZlY3Qub3B0aW9uc1tldmVudE5hbWVdKGVmZmVjdCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBmdW5jdGlvbihwb3MpIHsKICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gImlkbGUiKSB7CiAgICAgICAgICB0aGlzLnN0YXRlID0gInJ1bm5pbmciOwogICAgICAgICAgZGlzcGF0Y2godGhpcywgJ2JlZm9yZVNldHVwJyk7CiAgICAgICAgICBpZiAodGhpcy5zZXR1cCkgdGhpcy5zZXR1cCgpOwogICAgICAgICAgZGlzcGF0Y2godGhpcywgJ2FmdGVyU2V0dXAnKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICJydW5uaW5nIikgewogICAgICAgICAgcG9zID0gKHRoaXMub3B0aW9ucy50cmFuc2l0aW9uKHBvcykgKiB0aGlzLmZyb21Ub0RlbHRhKSArIHRoaXMub3B0aW9ucy5mcm9tOwogICAgICAgICAgdGhpcy5wb3NpdGlvbiA9IHBvczsKICAgICAgICAgIGRpc3BhdGNoKHRoaXMsICdiZWZvcmVVcGRhdGUnKTsKICAgICAgICAgIGlmICh0aGlzLnVwZGF0ZSkgdGhpcy51cGRhdGUocG9zKTsKICAgICAgICAgIGRpc3BhdGNoKHRoaXMsICdhZnRlclVwZGF0ZScpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0pKCk7CgogICAgdGhpcy5ldmVudCgnYmVmb3JlU3RhcnQnKTsKICAgIGlmICghdGhpcy5vcHRpb25zLnN5bmMpCiAgICAgIEVmZmVjdC5RdWV1ZXMuZ2V0KE9iamVjdC5pc1N0cmluZyh0aGlzLm9wdGlvbnMucXVldWUpID8KICAgICAgICAnZ2xvYmFsJyA6IHRoaXMub3B0aW9ucy5xdWV1ZS5zY29wZSkuYWRkKHRoaXMpOwogIH0sCiAgbG9vcDogZnVuY3Rpb24odGltZVBvcykgewogICAgaWYgKHRpbWVQb3MgPj0gdGhpcy5zdGFydE9uKSB7CiAgICAgIGlmICh0aW1lUG9zID49IHRoaXMuZmluaXNoT24pIHsKICAgICAgICB0aGlzLnJlbmRlcigxLjApOwogICAgICAgIHRoaXMuY2FuY2VsKCk7CiAgICAgICAgdGhpcy5ldmVudCgnYmVmb3JlRmluaXNoJyk7CiAgICAgICAgaWYgKHRoaXMuZmluaXNoKSB0aGlzLmZpbmlzaCgpOwogICAgICAgIHRoaXMuZXZlbnQoJ2FmdGVyRmluaXNoJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBwb3MgICA9ICh0aW1lUG9zIC0gdGhpcy5zdGFydE9uKSAvIHRoaXMudG90YWxUaW1lLAogICAgICAgICAgZnJhbWUgPSAocG9zICogdGhpcy50b3RhbEZyYW1lcykucm91bmQoKTsKICAgICAgaWYgKGZyYW1lID4gdGhpcy5jdXJyZW50RnJhbWUpIHsKICAgICAgICB0aGlzLnJlbmRlcihwb3MpOwogICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gZnJhbWU7CiAgICAgIH0KICAgIH0KICB9LAogIGNhbmNlbDogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMub3B0aW9ucy5zeW5jKQogICAgICBFZmZlY3QuUXVldWVzLmdldChPYmplY3QuaXNTdHJpbmcodGhpcy5vcHRpb25zLnF1ZXVlKSA/CiAgICAgICAgJ2dsb2JhbCcgOiB0aGlzLm9wdGlvbnMucXVldWUuc2NvcGUpLnJlbW92ZSh0aGlzKTsKICAgIHRoaXMuc3RhdGUgPSAnZmluaXNoZWQnOwogIH0sCiAgZXZlbnQ6IGZ1bmN0aW9uKGV2ZW50TmFtZSkgewogICAgaWYgKHRoaXMub3B0aW9uc1tldmVudE5hbWUgKyAnSW50ZXJuYWwnXSkgdGhpcy5vcHRpb25zW2V2ZW50TmFtZSArICdJbnRlcm5hbCddKHRoaXMpOwogICAgaWYgKHRoaXMub3B0aW9uc1tldmVudE5hbWVdKSB0aGlzLm9wdGlvbnNbZXZlbnROYW1lXSh0aGlzKTsKICB9LAogIGluc3BlY3Q6IGZ1bmN0aW9uKCkgewogICAgdmFyIGRhdGEgPSAkSCgpOwogICAgZm9yKHByb3BlcnR5IGluIHRoaXMpCiAgICAgIGlmICghT2JqZWN0LmlzRnVuY3Rpb24odGhpc1twcm9wZXJ0eV0pKSBkYXRhLnNldChwcm9wZXJ0eSwgdGhpc1twcm9wZXJ0eV0pOwogICAgcmV0dXJuICcjPEVmZmVjdDonICsgZGF0YS5pbnNwZWN0KCkgKyAnLG9wdGlvbnM6JyArICRIKHRoaXMub3B0aW9ucykuaW5zcGVjdCgpICsgJz4nOwogIH0KfSk7CgpFZmZlY3QuUGFyYWxsZWwgPSBDbGFzcy5jcmVhdGUoRWZmZWN0LkJhc2UsIHsKICBpbml0aWFsaXplOiBmdW5jdGlvbihlZmZlY3RzKSB7CiAgICB0aGlzLmVmZmVjdHMgPSBlZmZlY3RzIHx8IFtdOwogICAgdGhpcy5zdGFydChhcmd1bWVudHNbMV0pOwogIH0sCiAgdXBkYXRlOiBmdW5jdGlvbihwb3NpdGlvbikgewogICAgdGhpcy5lZmZlY3RzLmludm9rZSgncmVuZGVyJywgcG9zaXRpb24pOwogIH0sCiAgZmluaXNoOiBmdW5jdGlvbihwb3NpdGlvbikgewogICAgdGhpcy5lZmZlY3RzLmVhY2goIGZ1bmN0aW9uKGVmZmVjdCkgewogICAgICBlZmZlY3QucmVuZGVyKDEuMCk7CiAgICAgIGVmZmVjdC5jYW5jZWwoKTsKICAgICAgZWZmZWN0LmV2ZW50KCdiZWZvcmVGaW5pc2gnKTsKICAgICAgaWYgKGVmZmVjdC5maW5pc2gpIGVmZmVjdC5maW5pc2gocG9zaXRpb24pOwogICAgICBlZmZlY3QuZXZlbnQoJ2FmdGVyRmluaXNoJyk7CiAgICB9KTsKICB9Cn0pOwoKRWZmZWN0LlR3ZWVuID0gQ2xhc3MuY3JlYXRlKEVmZmVjdC5CYXNlLCB7CiAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob2JqZWN0LCBmcm9tLCB0bykgewogICAgb2JqZWN0ID0gT2JqZWN0LmlzU3RyaW5nKG9iamVjdCkgPyAkKG9iamVjdCkgOiBvYmplY3Q7CiAgICB2YXIgYXJncyA9ICRBKGFyZ3VtZW50cyksIG1ldGhvZCA9IGFyZ3MubGFzdCgpLAogICAgICBvcHRpb25zID0gYXJncy5sZW5ndGggPT0gNSA/IGFyZ3NbM10gOiBudWxsOwogICAgdGhpcy5tZXRob2QgPSBPYmplY3QuaXNGdW5jdGlvbihtZXRob2QpID8gbWV0aG9kLmJpbmQob2JqZWN0KSA6CiAgICAgIE9iamVjdC5pc0Z1bmN0aW9uKG9iamVjdFttZXRob2RdKSA/IG9iamVjdFttZXRob2RdLmJpbmQob2JqZWN0KSA6CiAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7IG9iamVjdFttZXRob2RdID0gdmFsdWUgfTsKICAgIHRoaXMuc3RhcnQoT2JqZWN0LmV4dGVuZCh7IGZyb206IGZyb20sIHRvOiB0byB9LCBvcHRpb25zIHx8IHsgfSkpOwogIH0sCiAgdXBkYXRlOiBmdW5jdGlvbihwb3NpdGlvbikgewogICAgdGhpcy5tZXRob2QocG9zaXRpb24pOwogIH0KfSk7CgpFZmZlY3QuRXZlbnQgPSBDbGFzcy5jcmVhdGUoRWZmZWN0LkJhc2UsIHsKICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuc3RhcnQoT2JqZWN0LmV4dGVuZCh7IGR1cmF0aW9uOiAwIH0sIGFyZ3VtZW50c1swXSB8fCB7IH0pKTsKICB9LAogIHVwZGF0ZTogUHJvdG90eXBlLmVtcHR5RnVuY3Rpb24KfSk7CgpFZmZlY3QuT3BhY2l0eSA9IENsYXNzLmNyZWF0ZShFZmZlY3QuQmFzZSwgewogIGluaXRpYWxpemU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIHRoaXMuZWxlbWVudCA9ICQoZWxlbWVudCk7CiAgICBpZiAoIXRoaXMuZWxlbWVudCkgdGhyb3coRWZmZWN0Ll9lbGVtZW50RG9lc05vdEV4aXN0RXJyb3IpOwogICAgLy8gbWFrZSB0aGlzIHdvcmsgb24gSUUgb24gZWxlbWVudHMgd2l0aG91dCAnbGF5b3V0JwogICAgaWYgKFByb3RvdHlwZS5Ccm93c2VyLklFICYmICghdGhpcy5lbGVtZW50LmN1cnJlbnRTdHlsZS5oYXNMYXlvdXQpKQogICAgICB0aGlzLmVsZW1lbnQuc2V0U3R5bGUoe3pvb206IDF9KTsKICAgIHZhciBvcHRpb25zID0gT2JqZWN0LmV4dGVuZCh7CiAgICAgIGZyb206IHRoaXMuZWxlbWVudC5nZXRPcGFjaXR5KCkgfHwgMC4wLAogICAgICB0bzogICAxLjAKICAgIH0sIGFyZ3VtZW50c1sxXSB8fCB7IH0pOwogICAgdGhpcy5zdGFydChvcHRpb25zKTsKICB9LAogIHVwZGF0ZTogZnVuY3Rpb24ocG9zaXRpb24pIHsKICAgIHRoaXMuZWxlbWVudC5zZXRPcGFjaXR5KHBvc2l0aW9uKTsKICB9Cn0pOwoKRWZmZWN0Lk1vdmUgPSBDbGFzcy5jcmVhdGUoRWZmZWN0LkJhc2UsIHsKICBpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICB0aGlzLmVsZW1lbnQgPSAkKGVsZW1lbnQpOwogICAgaWYgKCF0aGlzLmVsZW1lbnQpIHRocm93KEVmZmVjdC5fZWxlbWVudERvZXNOb3RFeGlzdEVycm9yKTsKICAgIHZhciBvcHRpb25zID0gT2JqZWN0LmV4dGVuZCh7CiAgICAgIHg6ICAgIDAsCiAgICAgIHk6ICAgIDAsCiAgICAgIG1vZGU6ICdyZWxhdGl2ZScKICAgIH0sIGFyZ3VtZW50c1sxXSB8fCB7IH0pOwogICAgdGhpcy5zdGFydChvcHRpb25zKTsKICB9LAogIHNldHVwOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuZWxlbWVudC5tYWtlUG9zaXRpb25lZCgpOwogICAgdGhpcy5vcmlnaW5hbExlZnQgPSBwYXJzZUZsb2F0KHRoaXMuZWxlbWVudC5nZXRTdHlsZSgnbGVmdCcpIHx8ICcwJyk7CiAgICB0aGlzLm9yaWdpbmFsVG9wICA9IHBhcnNlRmxvYXQodGhpcy5lbGVtZW50LmdldFN0eWxlKCd0b3AnKSAgfHwgJzAnKTsKICAgIGlmICh0aGlzLm9wdGlvbnMubW9kZSA9PSAnYWJzb2x1dGUnKSB7CiAgICAgIHRoaXMub3B0aW9ucy54ID0gdGhpcy5vcHRpb25zLnggLSB0aGlzLm9yaWdpbmFsTGVmdDsKICAgICAgdGhpcy5vcHRpb25zLnkgPSB0aGlzLm9wdGlvbnMueSAtIHRoaXMub3JpZ2luYWxUb3A7CiAgICB9CiAgfSwKICB1cGRhdGU6IGZ1bmN0aW9uKHBvc2l0aW9uKSB7CiAgICB0aGlzLmVsZW1lbnQuc2V0U3R5bGUoewogICAgICBsZWZ0OiAodGhpcy5vcHRpb25zLnggICogcG9zaXRpb24gKyB0aGlzLm9yaWdpbmFsTGVmdCkucm91bmQoKSArICdweCcsCiAgICAgIHRvcDogICh0aGlzLm9wdGlvbnMueSAgKiBwb3NpdGlvbiArIHRoaXMub3JpZ2luYWxUb3ApLnJvdW5kKCkgICsgJ3B4JwogICAgfSk7CiAgfQp9KTsKCi8vIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQpFZmZlY3QuTW92ZUJ5ID0gZnVuY3Rpb24oZWxlbWVudCwgdG9Ub3AsIHRvTGVmdCkgewogIHJldHVybiBuZXcgRWZmZWN0Lk1vdmUoZWxlbWVudCwKICAgIE9iamVjdC5leHRlbmQoeyB4OiB0b0xlZnQsIHk6IHRvVG9wIH0sIGFyZ3VtZW50c1szXSB8fCB7IH0pKTsKfTsKCkVmZmVjdC5TY2FsZSA9IENsYXNzLmNyZWF0ZShFZmZlY3QuQmFzZSwgewogIGluaXRpYWxpemU6IGZ1bmN0aW9uKGVsZW1lbnQsIHBlcmNlbnQpIHsKICAgIHRoaXMuZWxlbWVudCA9ICQoZWxlbWVudCk7CiAgICBpZiAoIXRoaXMuZWxlbWVudCkgdGhyb3coRWZmZWN0Ll9lbGVtZW50RG9lc05vdEV4aXN0RXJyb3IpOwogICAgdmFyIG9wdGlvbnMgPSBPYmplY3QuZXh0ZW5kKHsKICAgICAgc2NhbGVYOiB0cnVlLAogICAgICBzY2FsZVk6IHRydWUsCiAgICAgIHNjYWxlQ29udGVudDogdHJ1ZSwKICAgICAgc2NhbGVGcm9tQ2VudGVyOiBmYWxzZSwKICAgICAgc2NhbGVNb2RlOiAnYm94JywgICAgICAgIC8vICdib3gnIG9yICdjb250ZW50cycgb3IgeyB9IHdpdGggcHJvdmlkZWQgdmFsdWVzCiAgICAgIHNjYWxlRnJvbTogMTAwLjAsCiAgICAgIHNjYWxlVG86ICAgcGVyY2VudAogICAgfSwgYXJndW1lbnRzWzJdIHx8IHsgfSk7CiAgICB0aGlzLnN0YXJ0KG9wdGlvbnMpOwogIH0sCiAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5yZXN0b3JlQWZ0ZXJGaW5pc2ggPSB0aGlzLm9wdGlvbnMucmVzdG9yZUFmdGVyRmluaXNoIHx8IGZhbHNlOwogICAgdGhpcy5lbGVtZW50UG9zaXRpb25pbmcgPSB0aGlzLmVsZW1lbnQuZ2V0U3R5bGUoJ3Bvc2l0aW9uJyk7CgogICAgdGhpcy5vcmlnaW5hbFN0eWxlID0geyB9OwogICAgWyd0b3AnLCdsZWZ0Jywnd2lkdGgnLCdoZWlnaHQnLCdmb250U2l6ZSddLmVhY2goIGZ1bmN0aW9uKGspIHsKICAgICAgdGhpcy5vcmlnaW5hbFN0eWxlW2tdID0gdGhpcy5lbGVtZW50LnN0eWxlW2tdOwogICAgfS5iaW5kKHRoaXMpKTsKCiAgICB0aGlzLm9yaWdpbmFsVG9wICA9IHRoaXMuZWxlbWVudC5vZmZzZXRUb3A7CiAgICB0aGlzLm9yaWdpbmFsTGVmdCA9IHRoaXMuZWxlbWVudC5vZmZzZXRMZWZ0OwoKICAgIHZhciBmb250U2l6ZSA9IHRoaXMuZWxlbWVudC5nZXRTdHlsZSgnZm9udC1zaXplJykgfHwgJzEwMCUnOwogICAgWydlbScsJ3B4JywnJScsJ3B0J10uZWFjaCggZnVuY3Rpb24oZm9udFNpemVUeXBlKSB7CiAgICAgIGlmIChmb250U2l6ZS5pbmRleE9mKGZvbnRTaXplVHlwZSk+MCkgewogICAgICAgIHRoaXMuZm9udFNpemUgICAgID0gcGFyc2VGbG9hdChmb250U2l6ZSk7CiAgICAgICAgdGhpcy5mb250U2l6ZVR5cGUgPSBmb250U2l6ZVR5cGU7CiAgICAgIH0KICAgIH0uYmluZCh0aGlzKSk7CgogICAgdGhpcy5mYWN0b3IgPSAodGhpcy5vcHRpb25zLnNjYWxlVG8gLSB0aGlzLm9wdGlvbnMuc2NhbGVGcm9tKS8xMDA7CgogICAgdGhpcy5kaW1zID0gbnVsbDsKICAgIGlmICh0aGlzLm9wdGlvbnMuc2NhbGVNb2RlPT0nYm94JykKICAgICAgdGhpcy5kaW1zID0gW3RoaXMuZWxlbWVudC5vZmZzZXRIZWlnaHQsIHRoaXMuZWxlbWVudC5vZmZzZXRXaWR0aF07CiAgICBpZiAoL15jb250ZW50Ly50ZXN0KHRoaXMub3B0aW9ucy5zY2FsZU1vZGUpKQogICAgICB0aGlzLmRpbXMgPSBbdGhpcy5lbGVtZW50LnNjcm9sbEhlaWdodCwgdGhpcy5lbGVtZW50LnNjcm9sbFdpZHRoXTsKICAgIGlmICghdGhpcy5kaW1zKQogICAgICB0aGlzLmRpbXMgPSBbdGhpcy5vcHRpb25zLnNjYWxlTW9kZS5vcmlnaW5hbEhlaWdodCwKICAgICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5zY2FsZU1vZGUub3JpZ2luYWxXaWR0aF07CiAgfSwKICB1cGRhdGU6IGZ1bmN0aW9uKHBvc2l0aW9uKSB7CiAgICB2YXIgY3VycmVudFNjYWxlID0gKHRoaXMub3B0aW9ucy5zY2FsZUZyb20vMTAwLjApICsgKHRoaXMuZmFjdG9yICogcG9zaXRpb24pOwogICAgaWYgKHRoaXMub3B0aW9ucy5zY2FsZUNvbnRlbnQgJiYgdGhpcy5mb250U2l6ZSkKICAgICAgdGhpcy5lbGVtZW50LnNldFN0eWxlKHtmb250U2l6ZTogdGhpcy5mb250U2l6ZSAqIGN1cnJlbnRTY2FsZSArIHRoaXMuZm9udFNpemVUeXBlIH0pOwogICAgdGhpcy5zZXREaW1lbnNpb25zKHRoaXMuZGltc1swXSAqIGN1cnJlbnRTY2FsZSwgdGhpcy5kaW1zWzFdICogY3VycmVudFNjYWxlKTsKICB9LAogIGZpbmlzaDogZnVuY3Rpb24ocG9zaXRpb24pIHsKICAgIGlmICh0aGlzLnJlc3RvcmVBZnRlckZpbmlzaCkgdGhpcy5lbGVtZW50LnNldFN0eWxlKHRoaXMub3JpZ2luYWxTdHlsZSk7CiAgfSwKICBzZXREaW1lbnNpb25zOiBmdW5jdGlvbihoZWlnaHQsIHdpZHRoKSB7CiAgICB2YXIgZCA9IHsgfTsKICAgIGlmICh0aGlzLm9wdGlvbnMuc2NhbGVYKSBkLndpZHRoID0gd2lkdGgucm91bmQoKSArICdweCc7CiAgICBpZiAodGhpcy5vcHRpb25zLnNjYWxlWSkgZC5oZWlnaHQgPSBoZWlnaHQucm91bmQoKSArICdweCc7CiAgICBpZiAodGhpcy5vcHRpb25zLnNjYWxlRnJvbUNlbnRlcikgewogICAgICB2YXIgdG9wZCAgPSAoaGVpZ2h0IC0gdGhpcy5kaW1zWzBdKS8yOwogICAgICB2YXIgbGVmdGQgPSAod2lkdGggIC0gdGhpcy5kaW1zWzFdKS8yOwogICAgICBpZiAodGhpcy5lbGVtZW50UG9zaXRpb25pbmcgPT0gJ2Fic29sdXRlJykgewogICAgICAgIGlmICh0aGlzLm9wdGlvbnMuc2NhbGVZKSBkLnRvcCA9IHRoaXMub3JpZ2luYWxUb3AtdG9wZCArICdweCc7CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5zY2FsZVgpIGQubGVmdCA9IHRoaXMub3JpZ2luYWxMZWZ0LWxlZnRkICsgJ3B4JzsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5vcHRpb25zLnNjYWxlWSkgZC50b3AgPSAtdG9wZCArICdweCc7CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5zY2FsZVgpIGQubGVmdCA9IC1sZWZ0ZCArICdweCc7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuZWxlbWVudC5zZXRTdHlsZShkKTsKICB9Cn0pOwoKRWZmZWN0LkhpZ2hsaWdodCA9IENsYXNzLmNyZWF0ZShFZmZlY3QuQmFzZSwgewogIGluaXRpYWxpemU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIHRoaXMuZWxlbWVudCA9ICQoZWxlbWVudCk7CiAgICBpZiAoIXRoaXMuZWxlbWVudCkgdGhyb3coRWZmZWN0Ll9lbGVtZW50RG9lc05vdEV4aXN0RXJyb3IpOwogICAgdmFyIG9wdGlvbnMgPSBPYmplY3QuZXh0ZW5kKHsgc3RhcnRjb2xvcjogJyNmZmZmOTknIH0sIGFyZ3VtZW50c1sxXSB8fCB7IH0pOwogICAgdGhpcy5zdGFydChvcHRpb25zKTsKICB9LAogIHNldHVwOiBmdW5jdGlvbigpIHsKICAgIC8vIFByZXZlbnQgZXhlY3V0aW5nIG9uIGVsZW1lbnRzIG5vdCBpbiB0aGUgbGF5b3V0IGZsb3cKICAgIGlmICh0aGlzLmVsZW1lbnQuZ2V0U3R5bGUoJ2Rpc3BsYXknKT09J25vbmUnKSB7IHRoaXMuY2FuY2VsKCk7IHJldHVybjsgfQogICAgLy8gRGlzYWJsZSBiYWNrZ3JvdW5kIGltYWdlIGR1cmluZyB0aGUgZWZmZWN0CiAgICB0aGlzLm9sZFN0eWxlID0geyB9OwogICAgaWYgKCF0aGlzLm9wdGlvbnMua2VlcEJhY2tncm91bmRJbWFnZSkgewogICAgICB0aGlzLm9sZFN0eWxlLmJhY2tncm91bmRJbWFnZSA9IHRoaXMuZWxlbWVudC5nZXRTdHlsZSgnYmFja2dyb3VuZC1pbWFnZScpOwogICAgICB0aGlzLmVsZW1lbnQuc2V0U3R5bGUoe2JhY2tncm91bmRJbWFnZTogJ25vbmUnfSk7CiAgICB9CiAgICBpZiAoIXRoaXMub3B0aW9ucy5lbmRjb2xvcikKICAgICAgdGhpcy5vcHRpb25zLmVuZGNvbG9yID0gdGhpcy5lbGVtZW50LmdldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJykucGFyc2VDb2xvcignI2ZmZmZmZicpOwogICAgaWYgKCF0aGlzLm9wdGlvbnMucmVzdG9yZWNvbG9yKQogICAgICB0aGlzLm9wdGlvbnMucmVzdG9yZWNvbG9yID0gdGhpcy5lbGVtZW50LmdldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJyk7CiAgICAvLyBpbml0IGNvbG9yIGNhbGN1bGF0aW9ucwogICAgdGhpcy5fYmFzZSAgPSAkUigwLDIpLm1hcChmdW5jdGlvbihpKXsgcmV0dXJuIHBhcnNlSW50KHRoaXMub3B0aW9ucy5zdGFydGNvbG9yLnNsaWNlKGkqMisxLGkqMiszKSwxNikgfS5iaW5kKHRoaXMpKTsKICAgIHRoaXMuX2RlbHRhID0gJFIoMCwyKS5tYXAoZnVuY3Rpb24oaSl7IHJldHVybiBwYXJzZUludCh0aGlzLm9wdGlvbnMuZW5kY29sb3Iuc2xpY2UoaSoyKzEsaSoyKzMpLDE2KS10aGlzLl9iYXNlW2ldIH0uYmluZCh0aGlzKSk7CiAgfSwKICB1cGRhdGU6IGZ1bmN0aW9uKHBvc2l0aW9uKSB7CiAgICB0aGlzLmVsZW1lbnQuc2V0U3R5bGUoe2JhY2tncm91bmRDb2xvcjogJFIoMCwyKS5pbmplY3QoJyMnLGZ1bmN0aW9uKG0sdixpKXsKICAgICAgcmV0dXJuIG0rKCh0aGlzLl9iYXNlW2ldKyh0aGlzLl9kZWx0YVtpXSpwb3NpdGlvbikpLnJvdW5kKCkudG9Db2xvclBhcnQoKSk7IH0uYmluZCh0aGlzKSkgfSk7CiAgfSwKICBmaW5pc2g6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5lbGVtZW50LnNldFN0eWxlKE9iamVjdC5leHRlbmQodGhpcy5vbGRTdHlsZSwgewogICAgICBiYWNrZ3JvdW5kQ29sb3I6IHRoaXMub3B0aW9ucy5yZXN0b3JlY29sb3IKICAgIH0pKTsKICB9Cn0pOwoKRWZmZWN0LlNjcm9sbFRvID0gZnVuY3Rpb24oZWxlbWVudCkgewogIHZhciBvcHRpb25zID0gYXJndW1lbnRzWzFdIHx8IHsgfSwKICBzY3JvbGxPZmZzZXRzID0gZG9jdW1lbnQudmlld3BvcnQuZ2V0U2Nyb2xsT2Zmc2V0cygpLAogIGVsZW1lbnRPZmZzZXRzID0gJChlbGVtZW50KS5jdW11bGF0aXZlT2Zmc2V0KCk7CgogIGlmIChvcHRpb25zLm9mZnNldCkgZWxlbWVudE9mZnNldHNbMV0gKz0gb3B0aW9ucy5vZmZzZXQ7CgogIHJldHVybiBuZXcgRWZmZWN0LlR3ZWVuKG51bGwsCiAgICBzY3JvbGxPZmZzZXRzLnRvcCwKICAgIGVsZW1lbnRPZmZzZXRzWzFdLAogICAgb3B0aW9ucywKICAgIGZ1bmN0aW9uKHApeyBzY3JvbGxUbyhzY3JvbGxPZmZzZXRzLmxlZnQsIHAucm91bmQoKSk7IH0KICApOwp9OwoKLyogLS0tLS0tLS0tLS0tLSBjb21iaW5hdGlvbiBlZmZlY3RzIC0tLS0tLS0tLS0tLS0gKi8KCkVmZmVjdC5GYWRlID0gZnVuY3Rpb24oZWxlbWVudCkgewogIGVsZW1lbnQgPSAkKGVsZW1lbnQpOwogIHZhciBvbGRPcGFjaXR5ID0gZWxlbWVudC5nZXRJbmxpbmVPcGFjaXR5KCk7CiAgdmFyIG9wdGlvbnMgPSBPYmplY3QuZXh0ZW5kKHsKICAgIGZyb206IGVsZW1lbnQuZ2V0T3BhY2l0eSgpIHx8IDEuMCwKICAgIHRvOiAgIDAuMCwKICAgIGFmdGVyRmluaXNoSW50ZXJuYWw6IGZ1bmN0aW9uKGVmZmVjdCkgewogICAgICBpZiAoZWZmZWN0Lm9wdGlvbnMudG8hPTApIHJldHVybjsKICAgICAgZWZmZWN0LmVsZW1lbnQuaGlkZSgpLnNldFN0eWxlKHtvcGFjaXR5OiBvbGRPcGFjaXR5fSk7CiAgICB9CiAgfSwgYXJndW1lbnRzWzFdIHx8IHsgfSk7CiAgcmV0dXJuIG5ldyBFZmZlY3QuT3BhY2l0eShlbGVtZW50LG9wdGlvbnMpOwp9OwoKRWZmZWN0LkFwcGVhciA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICBlbGVtZW50ID0gJChlbGVtZW50KTsKICB2YXIgb3B0aW9ucyA9IE9iamVjdC5leHRlbmQoewogIGZyb206IChlbGVtZW50LmdldFN0eWxlKCdkaXNwbGF5JykgPT0gJ25vbmUnID8gMC4wIDogZWxlbWVudC5nZXRPcGFjaXR5KCkgfHwgMC4wKSwKICB0bzogICAxLjAsCiAgLy8gZm9yY2UgU2FmYXJpIHRvIHJlbmRlciBmbG9hdGVkIGVsZW1lbnRzIHByb3Blcmx5CiAgYWZ0ZXJGaW5pc2hJbnRlcm5hbDogZnVuY3Rpb24oZWZmZWN0KSB7CiAgICBlZmZlY3QuZWxlbWVudC5mb3JjZVJlcmVuZGVyaW5nKCk7CiAgfSwKICBiZWZvcmVTZXR1cDogZnVuY3Rpb24oZWZmZWN0KSB7CiAgICBlZmZlY3QuZWxlbWVudC5zZXRPcGFjaXR5KGVmZmVjdC5vcHRpb25zLmZyb20pLnNob3coKTsKICB9fSwgYXJndW1lbnRzWzFdIHx8IHsgfSk7CiAgcmV0dXJuIG5ldyBFZmZlY3QuT3BhY2l0eShlbGVtZW50LG9wdGlvbnMpOwp9OwoKRWZmZWN0LlB1ZmYgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgZWxlbWVudCA9ICQoZWxlbWVudCk7CiAgdmFyIG9sZFN0eWxlID0gewogICAgb3BhY2l0eTogZWxlbWVudC5nZXRJbmxpbmVPcGFjaXR5KCksCiAgICBwb3NpdGlvbjogZWxlbWVudC5nZXRTdHlsZSgncG9zaXRpb24nKSwKICAgIHRvcDogIGVsZW1lbnQuc3R5bGUudG9wLAogICAgbGVmdDogZWxlbWVudC5zdHlsZS5sZWZ0LAogICAgd2lkdGg6IGVsZW1lbnQuc3R5bGUud2lkdGgsCiAgICBoZWlnaHQ6IGVsZW1lbnQuc3R5bGUuaGVpZ2h0CiAgfTsKICByZXR1cm4gbmV3IEVmZmVjdC5QYXJhbGxlbCgKICAgWyBuZXcgRWZmZWN0LlNjYWxlKGVsZW1lbnQsIDIwMCwKICAgICAgeyBzeW5jOiB0cnVlLCBzY2FsZUZyb21DZW50ZXI6IHRydWUsIHNjYWxlQ29udGVudDogdHJ1ZSwgcmVzdG9yZUFmdGVyRmluaXNoOiB0cnVlIH0pLAogICAgIG5ldyBFZmZlY3QuT3BhY2l0eShlbGVtZW50LCB7IHN5bmM6IHRydWUsIHRvOiAwLjAgfSApIF0sCiAgICAgT2JqZWN0LmV4dGVuZCh7IGR1cmF0aW9uOiAxLjAsCiAgICAgIGJlZm9yZVNldHVwSW50ZXJuYWw6IGZ1bmN0aW9uKGVmZmVjdCkgewogICAgICAgIFBvc2l0aW9uLmFic29sdXRpemUoZWZmZWN0LmVmZmVjdHNbMF0uZWxlbWVudCk7CiAgICAgIH0sCiAgICAgIGFmdGVyRmluaXNoSW50ZXJuYWw6IGZ1bmN0aW9uKGVmZmVjdCkgewogICAgICAgICBlZmZlY3QuZWZmZWN0c1swXS5lbGVtZW50LmhpZGUoKS5zZXRTdHlsZShvbGRTdHlsZSk7IH0KICAgICB9LCBhcmd1bWVudHNbMV0gfHwgeyB9KQogICApOwp9OwoKRWZmZWN0LkJsaW5kVXAgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgZWxlbWVudCA9ICQoZWxlbWVudCk7CiAgZWxlbWVudC5tYWtlQ2xpcHBpbmcoKTsKICByZXR1cm4gbmV3IEVmZmVjdC5TY2FsZShlbGVtZW50LCAwLAogICAgT2JqZWN0LmV4dGVuZCh7IHNjYWxlQ29udGVudDogZmFsc2UsCiAgICAgIHNjYWxlWDogZmFsc2UsCiAgICAgIHJlc3RvcmVBZnRlckZpbmlzaDogdHJ1ZSwKICAgICAgYWZ0ZXJGaW5pc2hJbnRlcm5hbDogZnVuY3Rpb24oZWZmZWN0KSB7CiAgICAgICAgZWZmZWN0LmVsZW1lbnQuaGlkZSgpLnVuZG9DbGlwcGluZygpOwogICAgICB9CiAgICB9LCBhcmd1bWVudHNbMV0gfHwgeyB9KQogICk7Cn07CgpFZmZlY3QuQmxpbmREb3duID0gZnVuY3Rpb24oZWxlbWVudCkgewogIGVsZW1lbnQgPSAkKGVsZW1lbnQpOwogIHZhciBlbGVtZW50RGltZW5zaW9ucyA9IGVsZW1lbnQuZ2V0RGltZW5zaW9ucygpOwogIHJldHVybiBuZXcgRWZmZWN0LlNjYWxlKGVsZW1lbnQsIDEwMCwgT2JqZWN0LmV4dGVuZCh7CiAgICBzY2FsZUNvbnRlbnQ6IGZhbHNlLAogICAgc2NhbGVYOiBmYWxzZSwKICAgIHNjYWxlRnJvbTogMCwKICAgIHNjYWxlTW9kZToge29yaWdpbmFsSGVpZ2h0OiBlbGVtZW50RGltZW5zaW9ucy5oZWlnaHQsIG9yaWdpbmFsV2lkdGg6IGVsZW1lbnREaW1lbnNpb25zLndpZHRofSwKICAgIHJlc3RvcmVBZnRlckZpbmlzaDogdHJ1ZSwKICAgIGFmdGVyU2V0dXA6IGZ1bmN0aW9uKGVmZmVjdCkgewogICAgICBlZmZlY3QuZWxlbWVudC5tYWtlQ2xpcHBpbmcoKS5zZXRTdHlsZSh7aGVpZ2h0OiAnMHB4J30pLnNob3coKTsKICAgIH0sCiAgICBhZnRlckZpbmlzaEludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgICAgZWZmZWN0LmVsZW1lbnQudW5kb0NsaXBwaW5nKCk7CiAgICB9CiAgfSwgYXJndW1lbnRzWzFdIHx8IHsgfSkpOwp9OwoKRWZmZWN0LlN3aXRjaE9mZiA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICBlbGVtZW50ID0gJChlbGVtZW50KTsKICB2YXIgb2xkT3BhY2l0eSA9IGVsZW1lbnQuZ2V0SW5saW5lT3BhY2l0eSgpOwogIHJldHVybiBuZXcgRWZmZWN0LkFwcGVhcihlbGVtZW50LCBPYmplY3QuZXh0ZW5kKHsKICAgIGR1cmF0aW9uOiAwLjQsCiAgICBmcm9tOiAwLAogICAgdHJhbnNpdGlvbjogRWZmZWN0LlRyYW5zaXRpb25zLmZsaWNrZXIsCiAgICBhZnRlckZpbmlzaEludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgICAgbmV3IEVmZmVjdC5TY2FsZShlZmZlY3QuZWxlbWVudCwgMSwgewogICAgICAgIGR1cmF0aW9uOiAwLjMsIHNjYWxlRnJvbUNlbnRlcjogdHJ1ZSwKICAgICAgICBzY2FsZVg6IGZhbHNlLCBzY2FsZUNvbnRlbnQ6IGZhbHNlLCByZXN0b3JlQWZ0ZXJGaW5pc2g6IHRydWUsCiAgICAgICAgYmVmb3JlU2V0dXA6IGZ1bmN0aW9uKGVmZmVjdCkgewogICAgICAgICAgZWZmZWN0LmVsZW1lbnQubWFrZVBvc2l0aW9uZWQoKS5tYWtlQ2xpcHBpbmcoKTsKICAgICAgICB9LAogICAgICAgIGFmdGVyRmluaXNoSW50ZXJuYWw6IGZ1bmN0aW9uKGVmZmVjdCkgewogICAgICAgICAgZWZmZWN0LmVsZW1lbnQuaGlkZSgpLnVuZG9DbGlwcGluZygpLnVuZG9Qb3NpdGlvbmVkKCkuc2V0U3R5bGUoe29wYWNpdHk6IG9sZE9wYWNpdHl9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIGFyZ3VtZW50c1sxXSB8fCB7IH0pKTsKfTsKCkVmZmVjdC5Ecm9wT3V0ID0gZnVuY3Rpb24oZWxlbWVudCkgewogIGVsZW1lbnQgPSAkKGVsZW1lbnQpOwogIHZhciBvbGRTdHlsZSA9IHsKICAgIHRvcDogZWxlbWVudC5nZXRTdHlsZSgndG9wJyksCiAgICBsZWZ0OiBlbGVtZW50LmdldFN0eWxlKCdsZWZ0JyksCiAgICBvcGFjaXR5OiBlbGVtZW50LmdldElubGluZU9wYWNpdHkoKSB9OwogIHJldHVybiBuZXcgRWZmZWN0LlBhcmFsbGVsKAogICAgWyBuZXcgRWZmZWN0Lk1vdmUoZWxlbWVudCwge3g6IDAsIHk6IDEwMCwgc3luYzogdHJ1ZSB9KSwKICAgICAgbmV3IEVmZmVjdC5PcGFjaXR5KGVsZW1lbnQsIHsgc3luYzogdHJ1ZSwgdG86IDAuMCB9KSBdLAogICAgT2JqZWN0LmV4dGVuZCgKICAgICAgeyBkdXJhdGlvbjogMC41LAogICAgICAgIGJlZm9yZVNldHVwOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgICAgICAgIGVmZmVjdC5lZmZlY3RzWzBdLmVsZW1lbnQubWFrZVBvc2l0aW9uZWQoKTsKICAgICAgICB9LAogICAgICAgIGFmdGVyRmluaXNoSW50ZXJuYWw6IGZ1bmN0aW9uKGVmZmVjdCkgewogICAgICAgICAgZWZmZWN0LmVmZmVjdHNbMF0uZWxlbWVudC5oaWRlKCkudW5kb1Bvc2l0aW9uZWQoKS5zZXRTdHlsZShvbGRTdHlsZSk7CiAgICAgICAgfQogICAgICB9LCBhcmd1bWVudHNbMV0gfHwgeyB9KSk7Cn07CgpFZmZlY3QuU2hha2UgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgZWxlbWVudCA9ICQoZWxlbWVudCk7CiAgdmFyIG9wdGlvbnMgPSBPYmplY3QuZXh0ZW5kKHsKICAgIGRpc3RhbmNlOiAyMCwKICAgIGR1cmF0aW9uOiAwLjUKICB9LCBhcmd1bWVudHNbMV0gfHwge30pOwogIHZhciBkaXN0YW5jZSA9IHBhcnNlRmxvYXQob3B0aW9ucy5kaXN0YW5jZSk7CiAgdmFyIHNwbGl0ID0gcGFyc2VGbG9hdChvcHRpb25zLmR1cmF0aW9uKSAvIDEwLjA7CiAgdmFyIG9sZFN0eWxlID0gewogICAgdG9wOiBlbGVtZW50LmdldFN0eWxlKCd0b3AnKSwKICAgIGxlZnQ6IGVsZW1lbnQuZ2V0U3R5bGUoJ2xlZnQnKSB9OwogICAgcmV0dXJuIG5ldyBFZmZlY3QuTW92ZShlbGVtZW50LAogICAgICB7IHg6ICBkaXN0YW5jZSwgeTogMCwgZHVyYXRpb246IHNwbGl0LCBhZnRlckZpbmlzaEludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgIG5ldyBFZmZlY3QuTW92ZShlZmZlY3QuZWxlbWVudCwKICAgICAgeyB4OiAtZGlzdGFuY2UqMiwgeTogMCwgZHVyYXRpb246IHNwbGl0KjIsICBhZnRlckZpbmlzaEludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgIG5ldyBFZmZlY3QuTW92ZShlZmZlY3QuZWxlbWVudCwKICAgICAgeyB4OiAgZGlzdGFuY2UqMiwgeTogMCwgZHVyYXRpb246IHNwbGl0KjIsICBhZnRlckZpbmlzaEludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgIG5ldyBFZmZlY3QuTW92ZShlZmZlY3QuZWxlbWVudCwKICAgICAgeyB4OiAtZGlzdGFuY2UqMiwgeTogMCwgZHVyYXRpb246IHNwbGl0KjIsICBhZnRlckZpbmlzaEludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgIG5ldyBFZmZlY3QuTW92ZShlZmZlY3QuZWxlbWVudCwKICAgICAgeyB4OiAgZGlzdGFuY2UqMiwgeTogMCwgZHVyYXRpb246IHNwbGl0KjIsICBhZnRlckZpbmlzaEludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgIG5ldyBFZmZlY3QuTW92ZShlZmZlY3QuZWxlbWVudCwKICAgICAgeyB4OiAtZGlzdGFuY2UsIHk6IDAsIGR1cmF0aW9uOiBzcGxpdCwgYWZ0ZXJGaW5pc2hJbnRlcm5hbDogZnVuY3Rpb24oZWZmZWN0KSB7CiAgICAgICAgZWZmZWN0LmVsZW1lbnQudW5kb1Bvc2l0aW9uZWQoKS5zZXRTdHlsZShvbGRTdHlsZSk7CiAgfX0pOyB9fSk7IH19KTsgfX0pOyB9fSk7IH19KTsKfTsKCkVmZmVjdC5TbGlkZURvd24gPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgZWxlbWVudCA9ICQoZWxlbWVudCkuY2xlYW5XaGl0ZXNwYWNlKCk7CiAgLy8gU2xpZGVEb3duIG5lZWQgdG8gaGF2ZSB0aGUgY29udGVudCBvZiB0aGUgZWxlbWVudCB3cmFwcGVkIGluIGEgY29udGFpbmVyIGVsZW1lbnQgd2l0aCBmaXhlZCBoZWlnaHQhCiAgdmFyIG9sZElubmVyQm90dG9tID0gZWxlbWVudC5kb3duKCkuZ2V0U3R5bGUoJ2JvdHRvbScpOwogIHZhciBlbGVtZW50RGltZW5zaW9ucyA9IGVsZW1lbnQuZ2V0RGltZW5zaW9ucygpOwogIHJldHVybiBuZXcgRWZmZWN0LlNjYWxlKGVsZW1lbnQsIDEwMCwgT2JqZWN0LmV4dGVuZCh7CiAgICBzY2FsZUNvbnRlbnQ6IGZhbHNlLAogICAgc2NhbGVYOiBmYWxzZSwKICAgIHNjYWxlRnJvbTogd2luZG93Lm9wZXJhID8gMCA6IDEsCiAgICBzY2FsZU1vZGU6IHtvcmlnaW5hbEhlaWdodDogZWxlbWVudERpbWVuc2lvbnMuaGVpZ2h0LCBvcmlnaW5hbFdpZHRoOiBlbGVtZW50RGltZW5zaW9ucy53aWR0aH0sCiAgICByZXN0b3JlQWZ0ZXJGaW5pc2g6IHRydWUsCiAgICBhZnRlclNldHVwOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgICAgZWZmZWN0LmVsZW1lbnQubWFrZVBvc2l0aW9uZWQoKTsKICAgICAgZWZmZWN0LmVsZW1lbnQuZG93bigpLm1ha2VQb3NpdGlvbmVkKCk7CiAgICAgIGlmICh3aW5kb3cub3BlcmEpIGVmZmVjdC5lbGVtZW50LnNldFN0eWxlKHt0b3A6ICcnfSk7CiAgICAgIGVmZmVjdC5lbGVtZW50Lm1ha2VDbGlwcGluZygpLnNldFN0eWxlKHtoZWlnaHQ6ICcwcHgnfSkuc2hvdygpOwogICAgfSwKICAgIGFmdGVyVXBkYXRlSW50ZXJuYWw6IGZ1bmN0aW9uKGVmZmVjdCkgewogICAgICBlZmZlY3QuZWxlbWVudC5kb3duKCkuc2V0U3R5bGUoe2JvdHRvbToKICAgICAgICAoZWZmZWN0LmRpbXNbMF0gLSBlZmZlY3QuZWxlbWVudC5jbGllbnRIZWlnaHQpICsgJ3B4JyB9KTsKICAgIH0sCiAgICBhZnRlckZpbmlzaEludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgICAgZWZmZWN0LmVsZW1lbnQudW5kb0NsaXBwaW5nKCkudW5kb1Bvc2l0aW9uZWQoKTsKICAgICAgZWZmZWN0LmVsZW1lbnQuZG93bigpLnVuZG9Qb3NpdGlvbmVkKCkuc2V0U3R5bGUoe2JvdHRvbTogb2xkSW5uZXJCb3R0b219KTsgfQogICAgfSwgYXJndW1lbnRzWzFdIHx8IHsgfSkKICApOwp9OwoKRWZmZWN0LlNsaWRlVXAgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgZWxlbWVudCA9ICQoZWxlbWVudCkuY2xlYW5XaGl0ZXNwYWNlKCk7CiAgdmFyIG9sZElubmVyQm90dG9tID0gZWxlbWVudC5kb3duKCkuZ2V0U3R5bGUoJ2JvdHRvbScpOwogIHZhciBlbGVtZW50RGltZW5zaW9ucyA9IGVsZW1lbnQuZ2V0RGltZW5zaW9ucygpOwogIHJldHVybiBuZXcgRWZmZWN0LlNjYWxlKGVsZW1lbnQsIHdpbmRvdy5vcGVyYSA/IDAgOiAxLAogICBPYmplY3QuZXh0ZW5kKHsgc2NhbGVDb250ZW50OiBmYWxzZSwKICAgIHNjYWxlWDogZmFsc2UsCiAgICBzY2FsZU1vZGU6ICdib3gnLAogICAgc2NhbGVGcm9tOiAxMDAsCiAgICBzY2FsZU1vZGU6IHtvcmlnaW5hbEhlaWdodDogZWxlbWVudERpbWVuc2lvbnMuaGVpZ2h0LCBvcmlnaW5hbFdpZHRoOiBlbGVtZW50RGltZW5zaW9ucy53aWR0aH0sCiAgICByZXN0b3JlQWZ0ZXJGaW5pc2g6IHRydWUsCiAgICBhZnRlclNldHVwOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgICAgZWZmZWN0LmVsZW1lbnQubWFrZVBvc2l0aW9uZWQoKTsKICAgICAgZWZmZWN0LmVsZW1lbnQuZG93bigpLm1ha2VQb3NpdGlvbmVkKCk7CiAgICAgIGlmICh3aW5kb3cub3BlcmEpIGVmZmVjdC5lbGVtZW50LnNldFN0eWxlKHt0b3A6ICcnfSk7CiAgICAgIGVmZmVjdC5lbGVtZW50Lm1ha2VDbGlwcGluZygpLnNob3coKTsKICAgIH0sCiAgICBhZnRlclVwZGF0ZUludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgICAgZWZmZWN0LmVsZW1lbnQuZG93bigpLnNldFN0eWxlKHtib3R0b206CiAgICAgICAgKGVmZmVjdC5kaW1zWzBdIC0gZWZmZWN0LmVsZW1lbnQuY2xpZW50SGVpZ2h0KSArICdweCcgfSk7CiAgICB9LAogICAgYWZ0ZXJGaW5pc2hJbnRlcm5hbDogZnVuY3Rpb24oZWZmZWN0KSB7CiAgICAgIGVmZmVjdC5lbGVtZW50LmhpZGUoKS51bmRvQ2xpcHBpbmcoKS51bmRvUG9zaXRpb25lZCgpOwogICAgICBlZmZlY3QuZWxlbWVudC5kb3duKCkudW5kb1Bvc2l0aW9uZWQoKS5zZXRTdHlsZSh7Ym90dG9tOiBvbGRJbm5lckJvdHRvbX0pOwogICAgfQogICB9LCBhcmd1bWVudHNbMV0gfHwgeyB9KQogICk7Cn07CgovLyBCdWcgaW4gb3BlcmEgbWFrZXMgdGhlIFREIGNvbnRhaW5pbmcgdGhpcyBlbGVtZW50IGV4cGFuZCBmb3IgYSBpbnN0YW5jZSBhZnRlciBmaW5pc2gKRWZmZWN0LlNxdWlzaCA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICByZXR1cm4gbmV3IEVmZmVjdC5TY2FsZShlbGVtZW50LCB3aW5kb3cub3BlcmEgPyAxIDogMCwgewogICAgcmVzdG9yZUFmdGVyRmluaXNoOiB0cnVlLAogICAgYmVmb3JlU2V0dXA6IGZ1bmN0aW9uKGVmZmVjdCkgewogICAgICBlZmZlY3QuZWxlbWVudC5tYWtlQ2xpcHBpbmcoKTsKICAgIH0sCiAgICBhZnRlckZpbmlzaEludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgICAgZWZmZWN0LmVsZW1lbnQuaGlkZSgpLnVuZG9DbGlwcGluZygpOwogICAgfQogIH0pOwp9OwoKRWZmZWN0Lkdyb3cgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgZWxlbWVudCA9ICQoZWxlbWVudCk7CiAgdmFyIG9wdGlvbnMgPSBPYmplY3QuZXh0ZW5kKHsKICAgIGRpcmVjdGlvbjogJ2NlbnRlcicsCiAgICBtb3ZlVHJhbnNpdGlvbjogRWZmZWN0LlRyYW5zaXRpb25zLnNpbm9pZGFsLAogICAgc2NhbGVUcmFuc2l0aW9uOiBFZmZlY3QuVHJhbnNpdGlvbnMuc2lub2lkYWwsCiAgICBvcGFjaXR5VHJhbnNpdGlvbjogRWZmZWN0LlRyYW5zaXRpb25zLmZ1bGwKICB9LCBhcmd1bWVudHNbMV0gfHwgeyB9KTsKICB2YXIgb2xkU3R5bGUgPSB7CiAgICB0b3A6IGVsZW1lbnQuc3R5bGUudG9wLAogICAgbGVmdDogZWxlbWVudC5zdHlsZS5sZWZ0LAogICAgaGVpZ2h0OiBlbGVtZW50LnN0eWxlLmhlaWdodCwKICAgIHdpZHRoOiBlbGVtZW50LnN0eWxlLndpZHRoLAogICAgb3BhY2l0eTogZWxlbWVudC5nZXRJbmxpbmVPcGFjaXR5KCkgfTsKCiAgdmFyIGRpbXMgPSBlbGVtZW50LmdldERpbWVuc2lvbnMoKTsKICB2YXIgaW5pdGlhbE1vdmVYLCBpbml0aWFsTW92ZVk7CiAgdmFyIG1vdmVYLCBtb3ZlWTsKCiAgc3dpdGNoIChvcHRpb25zLmRpcmVjdGlvbikgewogICAgY2FzZSAndG9wLWxlZnQnOgogICAgICBpbml0aWFsTW92ZVggPSBpbml0aWFsTW92ZVkgPSBtb3ZlWCA9IG1vdmVZID0gMDsKICAgICAgYnJlYWs7CiAgICBjYXNlICd0b3AtcmlnaHQnOgogICAgICBpbml0aWFsTW92ZVggPSBkaW1zLndpZHRoOwogICAgICBpbml0aWFsTW92ZVkgPSBtb3ZlWSA9IDA7CiAgICAgIG1vdmVYID0gLWRpbXMud2lkdGg7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnYm90dG9tLWxlZnQnOgogICAgICBpbml0aWFsTW92ZVggPSBtb3ZlWCA9IDA7CiAgICAgIGluaXRpYWxNb3ZlWSA9IGRpbXMuaGVpZ2h0OwogICAgICBtb3ZlWSA9IC1kaW1zLmhlaWdodDsKICAgICAgYnJlYWs7CiAgICBjYXNlICdib3R0b20tcmlnaHQnOgogICAgICBpbml0aWFsTW92ZVggPSBkaW1zLndpZHRoOwogICAgICBpbml0aWFsTW92ZVkgPSBkaW1zLmhlaWdodDsKICAgICAgbW92ZVggPSAtZGltcy53aWR0aDsKICAgICAgbW92ZVkgPSAtZGltcy5oZWlnaHQ7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnY2VudGVyJzoKICAgICAgaW5pdGlhbE1vdmVYID0gZGltcy53aWR0aCAvIDI7CiAgICAgIGluaXRpYWxNb3ZlWSA9IGRpbXMuaGVpZ2h0IC8gMjsKICAgICAgbW92ZVggPSAtZGltcy53aWR0aCAvIDI7CiAgICAgIG1vdmVZID0gLWRpbXMuaGVpZ2h0IC8gMjsKICAgICAgYnJlYWs7CiAgfQoKICByZXR1cm4gbmV3IEVmZmVjdC5Nb3ZlKGVsZW1lbnQsIHsKICAgIHg6IGluaXRpYWxNb3ZlWCwKICAgIHk6IGluaXRpYWxNb3ZlWSwKICAgIGR1cmF0aW9uOiAwLjAxLAogICAgYmVmb3JlU2V0dXA6IGZ1bmN0aW9uKGVmZmVjdCkgewogICAgICBlZmZlY3QuZWxlbWVudC5oaWRlKCkubWFrZUNsaXBwaW5nKCkubWFrZVBvc2l0aW9uZWQoKTsKICAgIH0sCiAgICBhZnRlckZpbmlzaEludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgICAgbmV3IEVmZmVjdC5QYXJhbGxlbCgKICAgICAgICBbIG5ldyBFZmZlY3QuT3BhY2l0eShlZmZlY3QuZWxlbWVudCwgeyBzeW5jOiB0cnVlLCB0bzogMS4wLCBmcm9tOiAwLjAsIHRyYW5zaXRpb246IG9wdGlvbnMub3BhY2l0eVRyYW5zaXRpb24gfSksCiAgICAgICAgICBuZXcgRWZmZWN0Lk1vdmUoZWZmZWN0LmVsZW1lbnQsIHsgeDogbW92ZVgsIHk6IG1vdmVZLCBzeW5jOiB0cnVlLCB0cmFuc2l0aW9uOiBvcHRpb25zLm1vdmVUcmFuc2l0aW9uIH0pLAogICAgICAgICAgbmV3IEVmZmVjdC5TY2FsZShlZmZlY3QuZWxlbWVudCwgMTAwLCB7CiAgICAgICAgICAgIHNjYWxlTW9kZTogeyBvcmlnaW5hbEhlaWdodDogZGltcy5oZWlnaHQsIG9yaWdpbmFsV2lkdGg6IGRpbXMud2lkdGggfSwKICAgICAgICAgICAgc3luYzogdHJ1ZSwgc2NhbGVGcm9tOiB3aW5kb3cub3BlcmEgPyAxIDogMCwgdHJhbnNpdGlvbjogb3B0aW9ucy5zY2FsZVRyYW5zaXRpb24sIHJlc3RvcmVBZnRlckZpbmlzaDogdHJ1ZX0pCiAgICAgICAgXSwgT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgICAgICBiZWZvcmVTZXR1cDogZnVuY3Rpb24oZWZmZWN0KSB7CiAgICAgICAgICAgICAgIGVmZmVjdC5lZmZlY3RzWzBdLmVsZW1lbnQuc2V0U3R5bGUoe2hlaWdodDogJzBweCd9KS5zaG93KCk7CiAgICAgICAgICAgICB9LAogICAgICAgICAgICAgYWZ0ZXJGaW5pc2hJbnRlcm5hbDogZnVuY3Rpb24oZWZmZWN0KSB7CiAgICAgICAgICAgICAgIGVmZmVjdC5lZmZlY3RzWzBdLmVsZW1lbnQudW5kb0NsaXBwaW5nKCkudW5kb1Bvc2l0aW9uZWQoKS5zZXRTdHlsZShvbGRTdHlsZSk7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgfSwgb3B0aW9ucykKICAgICAgKTsKICAgIH0KICB9KTsKfTsKCkVmZmVjdC5TaHJpbmsgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgZWxlbWVudCA9ICQoZWxlbWVudCk7CiAgdmFyIG9wdGlvbnMgPSBPYmplY3QuZXh0ZW5kKHsKICAgIGRpcmVjdGlvbjogJ2NlbnRlcicsCiAgICBtb3ZlVHJhbnNpdGlvbjogRWZmZWN0LlRyYW5zaXRpb25zLnNpbm9pZGFsLAogICAgc2NhbGVUcmFuc2l0aW9uOiBFZmZlY3QuVHJhbnNpdGlvbnMuc2lub2lkYWwsCiAgICBvcGFjaXR5VHJhbnNpdGlvbjogRWZmZWN0LlRyYW5zaXRpb25zLm5vbmUKICB9LCBhcmd1bWVudHNbMV0gfHwgeyB9KTsKICB2YXIgb2xkU3R5bGUgPSB7CiAgICB0b3A6IGVsZW1lbnQuc3R5bGUudG9wLAogICAgbGVmdDogZWxlbWVudC5zdHlsZS5sZWZ0LAogICAgaGVpZ2h0OiBlbGVtZW50LnN0eWxlLmhlaWdodCwKICAgIHdpZHRoOiBlbGVtZW50LnN0eWxlLndpZHRoLAogICAgb3BhY2l0eTogZWxlbWVudC5nZXRJbmxpbmVPcGFjaXR5KCkgfTsKCiAgdmFyIGRpbXMgPSBlbGVtZW50LmdldERpbWVuc2lvbnMoKTsKICB2YXIgbW92ZVgsIG1vdmVZOwoKICBzd2l0Y2ggKG9wdGlvbnMuZGlyZWN0aW9uKSB7CiAgICBjYXNlICd0b3AtbGVmdCc6CiAgICAgIG1vdmVYID0gbW92ZVkgPSAwOwogICAgICBicmVhazsKICAgIGNhc2UgJ3RvcC1yaWdodCc6CiAgICAgIG1vdmVYID0gZGltcy53aWR0aDsKICAgICAgbW92ZVkgPSAwOwogICAgICBicmVhazsKICAgIGNhc2UgJ2JvdHRvbS1sZWZ0JzoKICAgICAgbW92ZVggPSAwOwogICAgICBtb3ZlWSA9IGRpbXMuaGVpZ2h0OwogICAgICBicmVhazsKICAgIGNhc2UgJ2JvdHRvbS1yaWdodCc6CiAgICAgIG1vdmVYID0gZGltcy53aWR0aDsKICAgICAgbW92ZVkgPSBkaW1zLmhlaWdodDsKICAgICAgYnJlYWs7CiAgICBjYXNlICdjZW50ZXInOgogICAgICBtb3ZlWCA9IGRpbXMud2lkdGggLyAyOwogICAgICBtb3ZlWSA9IGRpbXMuaGVpZ2h0IC8gMjsKICAgICAgYnJlYWs7CiAgfQoKICByZXR1cm4gbmV3IEVmZmVjdC5QYXJhbGxlbCgKICAgIFsgbmV3IEVmZmVjdC5PcGFjaXR5KGVsZW1lbnQsIHsgc3luYzogdHJ1ZSwgdG86IDAuMCwgZnJvbTogMS4wLCB0cmFuc2l0aW9uOiBvcHRpb25zLm9wYWNpdHlUcmFuc2l0aW9uIH0pLAogICAgICBuZXcgRWZmZWN0LlNjYWxlKGVsZW1lbnQsIHdpbmRvdy5vcGVyYSA/IDEgOiAwLCB7IHN5bmM6IHRydWUsIHRyYW5zaXRpb246IG9wdGlvbnMuc2NhbGVUcmFuc2l0aW9uLCByZXN0b3JlQWZ0ZXJGaW5pc2g6IHRydWV9KSwKICAgICAgbmV3IEVmZmVjdC5Nb3ZlKGVsZW1lbnQsIHsgeDogbW92ZVgsIHk6IG1vdmVZLCBzeW5jOiB0cnVlLCB0cmFuc2l0aW9uOiBvcHRpb25zLm1vdmVUcmFuc2l0aW9uIH0pCiAgICBdLCBPYmplY3QuZXh0ZW5kKHsKICAgICAgICAgYmVmb3JlU3RhcnRJbnRlcm5hbDogZnVuY3Rpb24oZWZmZWN0KSB7CiAgICAgICAgICAgZWZmZWN0LmVmZmVjdHNbMF0uZWxlbWVudC5tYWtlUG9zaXRpb25lZCgpLm1ha2VDbGlwcGluZygpOwogICAgICAgICB9LAogICAgICAgICBhZnRlckZpbmlzaEludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgICAgICAgICBlZmZlY3QuZWZmZWN0c1swXS5lbGVtZW50LmhpZGUoKS51bmRvQ2xpcHBpbmcoKS51bmRvUG9zaXRpb25lZCgpLnNldFN0eWxlKG9sZFN0eWxlKTsgfQogICAgICAgfSwgb3B0aW9ucykKICApOwp9OwoKRWZmZWN0LlB1bHNhdGUgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgZWxlbWVudCA9ICQoZWxlbWVudCk7CiAgdmFyIG9wdGlvbnMgICAgPSBhcmd1bWVudHNbMV0gfHwgeyB9LAogICAgb2xkT3BhY2l0eSA9IGVsZW1lbnQuZ2V0SW5saW5lT3BhY2l0eSgpLAogICAgdHJhbnNpdGlvbiA9IG9wdGlvbnMudHJhbnNpdGlvbiB8fCBFZmZlY3QuVHJhbnNpdGlvbnMubGluZWFyLAogICAgcmV2ZXJzZXIgICA9IGZ1bmN0aW9uKHBvcyl7CiAgICAgIHJldHVybiAxIC0gdHJhbnNpdGlvbigoLU1hdGguY29zKChwb3MqKG9wdGlvbnMucHVsc2VzfHw1KSoyKSpNYXRoLlBJKS8yKSArIC41KTsKICAgIH07CgogIHJldHVybiBuZXcgRWZmZWN0Lk9wYWNpdHkoZWxlbWVudCwKICAgIE9iamVjdC5leHRlbmQoT2JqZWN0LmV4dGVuZCh7ICBkdXJhdGlvbjogMi4wLCBmcm9tOiAwLAogICAgICBhZnRlckZpbmlzaEludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsgZWZmZWN0LmVsZW1lbnQuc2V0U3R5bGUoe29wYWNpdHk6IG9sZE9wYWNpdHl9KTsgfQogICAgfSwgb3B0aW9ucyksIHt0cmFuc2l0aW9uOiByZXZlcnNlcn0pKTsKfTsKCkVmZmVjdC5Gb2xkID0gZnVuY3Rpb24oZWxlbWVudCkgewogIGVsZW1lbnQgPSAkKGVsZW1lbnQpOwogIHZhciBvbGRTdHlsZSA9IHsKICAgIHRvcDogZWxlbWVudC5zdHlsZS50b3AsCiAgICBsZWZ0OiBlbGVtZW50LnN0eWxlLmxlZnQsCiAgICB3aWR0aDogZWxlbWVudC5zdHlsZS53aWR0aCwKICAgIGhlaWdodDogZWxlbWVudC5zdHlsZS5oZWlnaHQgfTsKICBlbGVtZW50Lm1ha2VDbGlwcGluZygpOwogIHJldHVybiBuZXcgRWZmZWN0LlNjYWxlKGVsZW1lbnQsIDUsIE9iamVjdC5leHRlbmQoewogICAgc2NhbGVDb250ZW50OiBmYWxzZSwKICAgIHNjYWxlWDogZmFsc2UsCiAgICBhZnRlckZpbmlzaEludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgIG5ldyBFZmZlY3QuU2NhbGUoZWxlbWVudCwgMSwgewogICAgICBzY2FsZUNvbnRlbnQ6IGZhbHNlLAogICAgICBzY2FsZVk6IGZhbHNlLAogICAgICBhZnRlckZpbmlzaEludGVybmFsOiBmdW5jdGlvbihlZmZlY3QpIHsKICAgICAgICBlZmZlY3QuZWxlbWVudC5oaWRlKCkudW5kb0NsaXBwaW5nKCkuc2V0U3R5bGUob2xkU3R5bGUpOwogICAgICB9IH0pOwogIH19LCBhcmd1bWVudHNbMV0gfHwgeyB9KSk7Cn07CgpFZmZlY3QuTW9ycGggPSBDbGFzcy5jcmVhdGUoRWZmZWN0LkJhc2UsIHsKICBpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICB0aGlzLmVsZW1lbnQgPSAkKGVsZW1lbnQpOwogICAgaWYgKCF0aGlzLmVsZW1lbnQpIHRocm93KEVmZmVjdC5fZWxlbWVudERvZXNOb3RFeGlzdEVycm9yKTsKICAgIHZhciBvcHRpb25zID0gT2JqZWN0LmV4dGVuZCh7CiAgICAgIHN0eWxlOiB7IH0KICAgIH0sIGFyZ3VtZW50c1sxXSB8fCB7IH0pOwoKICAgIGlmICghT2JqZWN0LmlzU3RyaW5nKG9wdGlvbnMuc3R5bGUpKSB0aGlzLnN0eWxlID0gJEgob3B0aW9ucy5zdHlsZSk7CiAgICBlbHNlIHsKICAgICAgaWYgKG9wdGlvbnMuc3R5bGUuaW5jbHVkZSgnOicpKQogICAgICAgIHRoaXMuc3R5bGUgPSBvcHRpb25zLnN0eWxlLnBhcnNlU3R5bGUoKTsKICAgICAgZWxzZSB7CiAgICAgICAgdGhpcy5lbGVtZW50LmFkZENsYXNzTmFtZShvcHRpb25zLnN0eWxlKTsKICAgICAgICB0aGlzLnN0eWxlID0gJEgodGhpcy5lbGVtZW50LmdldFN0eWxlcygpKTsKICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3NOYW1lKG9wdGlvbnMuc3R5bGUpOwogICAgICAgIHZhciBjc3MgPSB0aGlzLmVsZW1lbnQuZ2V0U3R5bGVzKCk7CiAgICAgICAgdGhpcy5zdHlsZSA9IHRoaXMuc3R5bGUucmVqZWN0KGZ1bmN0aW9uKHN0eWxlKSB7CiAgICAgICAgICByZXR1cm4gc3R5bGUudmFsdWUgPT0gY3NzW3N0eWxlLmtleV07CiAgICAgICAgfSk7CiAgICAgICAgb3B0aW9ucy5hZnRlckZpbmlzaEludGVybmFsID0gZnVuY3Rpb24oZWZmZWN0KSB7CiAgICAgICAgICBlZmZlY3QuZWxlbWVudC5hZGRDbGFzc05hbWUoZWZmZWN0Lm9wdGlvbnMuc3R5bGUpOwogICAgICAgICAgZWZmZWN0LnRyYW5zZm9ybXMuZWFjaChmdW5jdGlvbih0cmFuc2Zvcm0pIHsKICAgICAgICAgICAgZWZmZWN0LmVsZW1lbnQuc3R5bGVbdHJhbnNmb3JtLnN0eWxlXSA9ICcnOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgfQogICAgfQogICAgdGhpcy5zdGFydChvcHRpb25zKTsKICB9LAoKICBzZXR1cDogZnVuY3Rpb24oKXsKICAgIGZ1bmN0aW9uIHBhcnNlQ29sb3IoY29sb3IpewogICAgICBpZiAoIWNvbG9yIHx8IFsncmdiYSgwLCAwLCAwLCAwKScsJ3RyYW5zcGFyZW50J10uaW5jbHVkZShjb2xvcikpIGNvbG9yID0gJyNmZmZmZmYnOwogICAgICBjb2xvciA9IGNvbG9yLnBhcnNlQ29sb3IoKTsKICAgICAgcmV0dXJuICRSKDAsMikubWFwKGZ1bmN0aW9uKGkpewogICAgICAgIHJldHVybiBwYXJzZUludCggY29sb3Iuc2xpY2UoaSoyKzEsaSoyKzMpLCAxNiApOwogICAgICB9KTsKICAgIH0KICAgIHRoaXMudHJhbnNmb3JtcyA9IHRoaXMuc3R5bGUubWFwKGZ1bmN0aW9uKHBhaXIpewogICAgICB2YXIgcHJvcGVydHkgPSBwYWlyWzBdLCB2YWx1ZSA9IHBhaXJbMV0sIHVuaXQgPSBudWxsOwoKICAgICAgaWYgKHZhbHVlLnBhcnNlQ29sb3IoJyN6enp6enonKSAhPSAnI3p6enp6eicpIHsKICAgICAgICB2YWx1ZSA9IHZhbHVlLnBhcnNlQ29sb3IoKTsKICAgICAgICB1bml0ICA9ICdjb2xvcic7CiAgICAgIH0gZWxzZSBpZiAocHJvcGVydHkgPT0gJ29wYWNpdHknKSB7CiAgICAgICAgdmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTsKICAgICAgICBpZiAoUHJvdG90eXBlLkJyb3dzZXIuSUUgJiYgKCF0aGlzLmVsZW1lbnQuY3VycmVudFN0eWxlLmhhc0xheW91dCkpCiAgICAgICAgICB0aGlzLmVsZW1lbnQuc2V0U3R5bGUoe3pvb206IDF9KTsKICAgICAgfSBlbHNlIGlmIChFbGVtZW50LkNTU19MRU5HVEgudGVzdCh2YWx1ZSkpIHsKICAgICAgICAgIHZhciBjb21wb25lbnRzID0gdmFsdWUubWF0Y2goL14oW1wrXC1dP1swLTlcLl0rKSguKikkLyk7CiAgICAgICAgICB2YWx1ZSA9IHBhcnNlRmxvYXQoY29tcG9uZW50c1sxXSk7CiAgICAgICAgICB1bml0ID0gKGNvbXBvbmVudHMubGVuZ3RoID09IDMpID8gY29tcG9uZW50c1syXSA6IG51bGw7CiAgICAgIH0KCiAgICAgIHZhciBvcmlnaW5hbFZhbHVlID0gdGhpcy5lbGVtZW50LmdldFN0eWxlKHByb3BlcnR5KTsKICAgICAgcmV0dXJuIHsKICAgICAgICBzdHlsZTogcHJvcGVydHkuY2FtZWxpemUoKSwKICAgICAgICBvcmlnaW5hbFZhbHVlOiB1bml0PT0nY29sb3InID8gcGFyc2VDb2xvcihvcmlnaW5hbFZhbHVlKSA6IHBhcnNlRmxvYXQob3JpZ2luYWxWYWx1ZSB8fCAwKSwKICAgICAgICB0YXJnZXRWYWx1ZTogdW5pdD09J2NvbG9yJyA/IHBhcnNlQ29sb3IodmFsdWUpIDogdmFsdWUsCiAgICAgICAgdW5pdDogdW5pdAogICAgICB9OwogICAgfS5iaW5kKHRoaXMpKS5yZWplY3QoZnVuY3Rpb24odHJhbnNmb3JtKXsKICAgICAgcmV0dXJuICgKICAgICAgICAodHJhbnNmb3JtLm9yaWdpbmFsVmFsdWUgPT0gdHJhbnNmb3JtLnRhcmdldFZhbHVlKSB8fAogICAgICAgICgKICAgICAgICAgIHRyYW5zZm9ybS51bml0ICE9ICdjb2xvcicgJiYKICAgICAgICAgIChpc05hTih0cmFuc2Zvcm0ub3JpZ2luYWxWYWx1ZSkgfHwgaXNOYU4odHJhbnNmb3JtLnRhcmdldFZhbHVlKSkKICAgICAgICApCiAgICAgICk7CiAgICB9KTsKICB9LAogIHVwZGF0ZTogZnVuY3Rpb24ocG9zaXRpb24pIHsKICAgIHZhciBzdHlsZSA9IHsgfSwgdHJhbnNmb3JtLCBpID0gdGhpcy50cmFuc2Zvcm1zLmxlbmd0aDsKICAgIHdoaWxlKGktLSkKICAgICAgc3R5bGVbKHRyYW5zZm9ybSA9IHRoaXMudHJhbnNmb3Jtc1tpXSkuc3R5bGVdID0KICAgICAgICB0cmFuc2Zvcm0udW5pdD09J2NvbG9yJyA/ICcjJysKICAgICAgICAgIChNYXRoLnJvdW5kKHRyYW5zZm9ybS5vcmlnaW5hbFZhbHVlWzBdKwogICAgICAgICAgICAodHJhbnNmb3JtLnRhcmdldFZhbHVlWzBdLXRyYW5zZm9ybS5vcmlnaW5hbFZhbHVlWzBdKSpwb3NpdGlvbikpLnRvQ29sb3JQYXJ0KCkgKwogICAgICAgICAgKE1hdGgucm91bmQodHJhbnNmb3JtLm9yaWdpbmFsVmFsdWVbMV0rCiAgICAgICAgICAgICh0cmFuc2Zvcm0udGFyZ2V0VmFsdWVbMV0tdHJhbnNmb3JtLm9yaWdpbmFsVmFsdWVbMV0pKnBvc2l0aW9uKSkudG9Db2xvclBhcnQoKSArCiAgICAgICAgICAoTWF0aC5yb3VuZCh0cmFuc2Zvcm0ub3JpZ2luYWxWYWx1ZVsyXSsKICAgICAgICAgICAgKHRyYW5zZm9ybS50YXJnZXRWYWx1ZVsyXS10cmFuc2Zvcm0ub3JpZ2luYWxWYWx1ZVsyXSkqcG9zaXRpb24pKS50b0NvbG9yUGFydCgpIDoKICAgICAgICAodHJhbnNmb3JtLm9yaWdpbmFsVmFsdWUgKwogICAgICAgICAgKHRyYW5zZm9ybS50YXJnZXRWYWx1ZSAtIHRyYW5zZm9ybS5vcmlnaW5hbFZhbHVlKSAqIHBvc2l0aW9uKS50b0ZpeGVkKDMpICsKICAgICAgICAgICAgKHRyYW5zZm9ybS51bml0ID09PSBudWxsID8gJycgOiB0cmFuc2Zvcm0udW5pdCk7CiAgICB0aGlzLmVsZW1lbnQuc2V0U3R5bGUoc3R5bGUsIHRydWUpOwogIH0KfSk7CgpFZmZlY3QuVHJhbnNmb3JtID0gQ2xhc3MuY3JlYXRlKHsKICBpbml0aWFsaXplOiBmdW5jdGlvbih0cmFja3MpewogICAgdGhpcy50cmFja3MgID0gW107CiAgICB0aGlzLm9wdGlvbnMgPSBhcmd1bWVudHNbMV0gfHwgeyB9OwogICAgdGhpcy5hZGRUcmFja3ModHJhY2tzKTsKICB9LAogIGFkZFRyYWNrczogZnVuY3Rpb24odHJhY2tzKXsKICAgIHRyYWNrcy5lYWNoKGZ1bmN0aW9uKHRyYWNrKXsKICAgICAgdHJhY2sgPSAkSCh0cmFjayk7CiAgICAgIHZhciBkYXRhID0gdHJhY2sudmFsdWVzKCkuZmlyc3QoKTsKICAgICAgdGhpcy50cmFja3MucHVzaCgkSCh7CiAgICAgICAgaWRzOiAgICAgdHJhY2sua2V5cygpLmZpcnN0KCksCiAgICAgICAgZWZmZWN0OiAgRWZmZWN0Lk1vcnBoLAogICAgICAgIG9wdGlvbnM6IHsgc3R5bGU6IGRhdGEgfQogICAgICB9KSk7CiAgICB9LmJpbmQodGhpcykpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKICBwbGF5OiBmdW5jdGlvbigpewogICAgcmV0dXJuIG5ldyBFZmZlY3QuUGFyYWxsZWwoCiAgICAgIHRoaXMudHJhY2tzLm1hcChmdW5jdGlvbih0cmFjayl7CiAgICAgICAgdmFyIGlkcyA9IHRyYWNrLmdldCgnaWRzJyksIGVmZmVjdCA9IHRyYWNrLmdldCgnZWZmZWN0JyksIG9wdGlvbnMgPSB0cmFjay5nZXQoJ29wdGlvbnMnKTsKICAgICAgICB2YXIgZWxlbWVudHMgPSBbJChpZHMpIHx8ICQkKGlkcyldLmZsYXR0ZW4oKTsKICAgICAgICByZXR1cm4gZWxlbWVudHMubWFwKGZ1bmN0aW9uKGUpeyByZXR1cm4gbmV3IGVmZmVjdChlLCBPYmplY3QuZXh0ZW5kKHsgc3luYzp0cnVlIH0sIG9wdGlvbnMpKSB9KTsKICAgICAgfSkuZmxhdHRlbigpLAogICAgICB0aGlzLm9wdGlvbnMKICAgICk7CiAgfQp9KTsKCkVsZW1lbnQuQ1NTX1BST1BFUlRJRVMgPSAkdygKICAnYmFja2dyb3VuZENvbG9yIGJhY2tncm91bmRQb3NpdGlvbiBib3JkZXJCb3R0b21Db2xvciBib3JkZXJCb3R0b21TdHlsZSAnICsKICAnYm9yZGVyQm90dG9tV2lkdGggYm9yZGVyTGVmdENvbG9yIGJvcmRlckxlZnRTdHlsZSBib3JkZXJMZWZ0V2lkdGggJyArCiAgJ2JvcmRlclJpZ2h0Q29sb3IgYm9yZGVyUmlnaHRTdHlsZSBib3JkZXJSaWdodFdpZHRoIGJvcmRlclNwYWNpbmcgJyArCiAgJ2JvcmRlclRvcENvbG9yIGJvcmRlclRvcFN0eWxlIGJvcmRlclRvcFdpZHRoIGJvdHRvbSBjbGlwIGNvbG9yICcgKwogICdmb250U2l6ZSBmb250V2VpZ2h0IGhlaWdodCBsZWZ0IGxldHRlclNwYWNpbmcgbGluZUhlaWdodCAnICsKICAnbWFyZ2luQm90dG9tIG1hcmdpbkxlZnQgbWFyZ2luUmlnaHQgbWFyZ2luVG9wIG1hcmtlck9mZnNldCBtYXhIZWlnaHQgJysKICAnbWF4V2lkdGggbWluSGVpZ2h0IG1pbldpZHRoIG9wYWNpdHkgb3V0bGluZUNvbG9yIG91dGxpbmVPZmZzZXQgJyArCiAgJ291dGxpbmVXaWR0aCBwYWRkaW5nQm90dG9tIHBhZGRpbmdMZWZ0IHBhZGRpbmdSaWdodCBwYWRkaW5nVG9wICcgKwogICdyaWdodCB0ZXh0SW5kZW50IHRvcCB3aWR0aCB3b3JkU3BhY2luZyB6SW5kZXgnKTsKCkVsZW1lbnQuQ1NTX0xFTkdUSCA9IC9eKChbXCtcLV0/WzAtOVwuXSspKGVtfGV4fHB4fGlufGNtfG1tfHB0fHBjfFwlKSl8MCQvOwoKU3RyaW5nLl9fcGFyc2VTdHlsZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKU3RyaW5nLnByb3RvdHlwZS5wYXJzZVN0eWxlID0gZnVuY3Rpb24oKXsKICB2YXIgc3R5bGUsIHN0eWxlUnVsZXMgPSAkSCgpOwogIGlmIChQcm90b3R5cGUuQnJvd3Nlci5XZWJLaXQpCiAgICBzdHlsZSA9IG5ldyBFbGVtZW50KCdkaXYnLHtzdHlsZTp0aGlzfSkuc3R5bGU7CiAgZWxzZSB7CiAgICBTdHJpbmcuX19wYXJzZVN0eWxlRWxlbWVudC5pbm5lckhUTUwgPSAnPGRpdiBzdHlsZT0iJyArIHRoaXMgKyAnIj48L2Rpdj4nOwogICAgc3R5bGUgPSBTdHJpbmcuX19wYXJzZVN0eWxlRWxlbWVudC5jaGlsZE5vZGVzWzBdLnN0eWxlOwogIH0KCiAgRWxlbWVudC5DU1NfUFJPUEVSVElFUy5lYWNoKGZ1bmN0aW9uKHByb3BlcnR5KXsKICAgIGlmIChzdHlsZVtwcm9wZXJ0eV0pIHN0eWxlUnVsZXMuc2V0KHByb3BlcnR5LCBzdHlsZVtwcm9wZXJ0eV0pOwogIH0pOwoKICBpZiAoUHJvdG90eXBlLkJyb3dzZXIuSUUgJiYgdGhpcy5pbmNsdWRlKCdvcGFjaXR5JykpCiAgICBzdHlsZVJ1bGVzLnNldCgnb3BhY2l0eScsIHRoaXMubWF0Y2goL29wYWNpdHk6XHMqKCg/OjB8MSk/KD86XC5cZCopPykvKVsxXSk7CgogIHJldHVybiBzdHlsZVJ1bGVzOwp9OwoKaWYgKGRvY3VtZW50LmRlZmF1bHRWaWV3ICYmIGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUpIHsKICBFbGVtZW50LmdldFN0eWxlcyA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIHZhciBjc3MgPSBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKCQoZWxlbWVudCksIG51bGwpOwogICAgcmV0dXJuIEVsZW1lbnQuQ1NTX1BST1BFUlRJRVMuaW5qZWN0KHsgfSwgZnVuY3Rpb24oc3R5bGVzLCBwcm9wZXJ0eSkgewogICAgICBzdHlsZXNbcHJvcGVydHldID0gY3NzW3Byb3BlcnR5XTsKICAgICAgcmV0dXJuIHN0eWxlczsKICAgIH0pOwogIH07Cn0gZWxzZSB7CiAgRWxlbWVudC5nZXRTdHlsZXMgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICBlbGVtZW50ID0gJChlbGVtZW50KTsKICAgIHZhciBjc3MgPSBlbGVtZW50LmN1cnJlbnRTdHlsZSwgc3R5bGVzOwogICAgc3R5bGVzID0gRWxlbWVudC5DU1NfUFJPUEVSVElFUy5pbmplY3QoeyB9LCBmdW5jdGlvbihyZXN1bHRzLCBwcm9wZXJ0eSkgewogICAgICByZXN1bHRzW3Byb3BlcnR5XSA9IGNzc1twcm9wZXJ0eV07CiAgICAgIHJldHVybiByZXN1bHRzOwogICAgfSk7CiAgICBpZiAoIXN0eWxlcy5vcGFjaXR5KSBzdHlsZXMub3BhY2l0eSA9IGVsZW1lbnQuZ2V0T3BhY2l0eSgpOwogICAgcmV0dXJuIHN0eWxlczsKICB9Owp9CgpFZmZlY3QuTWV0aG9kcyA9IHsKICBtb3JwaDogZnVuY3Rpb24oZWxlbWVudCwgc3R5bGUpIHsKICAgIGVsZW1lbnQgPSAkKGVsZW1lbnQpOwogICAgbmV3IEVmZmVjdC5Nb3JwaChlbGVtZW50LCBPYmplY3QuZXh0ZW5kKHsgc3R5bGU6IHN0eWxlIH0sIGFyZ3VtZW50c1syXSB8fCB7IH0pKTsKICAgIHJldHVybiBlbGVtZW50OwogIH0sCiAgdmlzdWFsRWZmZWN0OiBmdW5jdGlvbihlbGVtZW50LCBlZmZlY3QsIG9wdGlvbnMpIHsKICAgIGVsZW1lbnQgPSAkKGVsZW1lbnQpOwogICAgdmFyIHMgPSBlZmZlY3QuZGFzaGVyaXplKCkuY2FtZWxpemUoKSwga2xhc3MgPSBzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgcy5zdWJzdHJpbmcoMSk7CiAgICBuZXcgRWZmZWN0W2tsYXNzXShlbGVtZW50LCBvcHRpb25zKTsKICAgIHJldHVybiBlbGVtZW50OwogIH0sCiAgaGlnaGxpZ2h0OiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKSB7CiAgICBlbGVtZW50ID0gJChlbGVtZW50KTsKICAgIG5ldyBFZmZlY3QuSGlnaGxpZ2h0KGVsZW1lbnQsIG9wdGlvbnMpOwogICAgcmV0dXJuIGVsZW1lbnQ7CiAgfQp9OwoKJHcoJ2ZhZGUgYXBwZWFyIGdyb3cgc2hyaW5rIGZvbGQgYmxpbmRVcCBibGluZERvd24gc2xpZGVVcCBzbGlkZURvd24gJysKICAncHVsc2F0ZSBzaGFrZSBwdWZmIHNxdWlzaCBzd2l0Y2hPZmYgZHJvcE91dCcpLmVhY2goCiAgZnVuY3Rpb24oZWZmZWN0KSB7CiAgICBFZmZlY3QuTWV0aG9kc1tlZmZlY3RdID0gZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucyl7CiAgICAgIGVsZW1lbnQgPSAkKGVsZW1lbnQpOwogICAgICBFZmZlY3RbZWZmZWN0LmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgZWZmZWN0LnN1YnN0cmluZygxKV0oZWxlbWVudCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfTsKICB9Cik7CgokdygnZ2V0SW5saW5lT3BhY2l0eSBmb3JjZVJlcmVuZGVyaW5nIHNldENvbnRlbnRab29tIGNvbGxlY3RUZXh0Tm9kZXMgY29sbGVjdFRleHROb2Rlc0lnbm9yZUNsYXNzIGdldFN0eWxlcycpLmVhY2goCiAgZnVuY3Rpb24oZikgeyBFZmZlY3QuTWV0aG9kc1tmXSA9IEVsZW1lbnRbZl07IH0KKTsKCkVsZW1lbnQuYWRkTWV0aG9kcyhFZmZlY3QuTWV0aG9kcyk7LyoqCiAqIEphdmFzY3JpcHQgY29kZSB0byBzdG9yZSBkYXRhIGFzIEpTT04gc3RyaW5ncyBpbiBjb29raWVzLiAKICogSXQgdXNlcyBwcm90b3R5cGUuanMgMS41LjEgKGh0dHA6Ly93d3cucHJvdG90eXBlanMub3JnKQogKiAKICogQXV0aG9yIDogTGFsaXQgUGF0ZWwKICogV2Vic2l0ZTogaHR0cDovL3d3dy5sYWxpdC5vcmcvbGFiL2pzb25jb29raWVzCiAqIExpY2Vuc2U6IENyZWF0aXZlIENvbW1vbnMgQXR0cmlidXRpb24tU2hhcmVBbGlrZSAyLjUKICogICAgICAgICAgaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbGljZW5zZXMvYnktc2EvMi41LwogKiBWZXJzaW9uOiAwLjQKICogVXBkYXRlZDogQXVnIDExLCAyMDA3IDEwOjA5YW0KICogCiAqIENobmFnZSBMb2c6CiAqICAgdiAwLjQKICogICAtICBSZW1vdmVkIGEgZXh0cmEgY29tbWEgaW4gb3B0aW9ucyAod2FzIGJyZWFraW5nIGluIElFIGFuZCBPcGVyYSkuIChUaGFua3MgSmFzb24pCiAqICAgLSAgUmVtb3ZlZCB0aGUgcGFyYW1ldGVyIG5hbWUgZnJvbSB0aGUgaW5pdGlhbGl6ZSBmdW5jdGlvbgogKiAgIC0gIENoYW5nZWQgdGhlIHdheSBleHBpcmVzIGRhdGUgd2FzIGJlaW5nIGNhbGN1bGF0ZWQuIChUaGFua3MgRGF2aWQpCiAqICAgdiAwLjMKICogICAtICBSZW1vdmVkIGRlcGVuZGFuY3kgb24ganNvbi5qcyAoaHR0cDovL3d3dy5qc29uLm9yZy9qc29uLmpzKQogKiAgIC0gIGVtcHR5KCkgZnVuY3Rpb24gb25seSBkZWxldGVzIHRoZSBjb29raWVzIHNldCBieSBDb29raWVKYXIKICovCgp2YXIgQ29va2llSmFyID0gQ2xhc3MuY3JlYXRlKHsKCS8qKgoJICogQXBwZW5kIGJlZm9yZSBhbGwgY29va2llIG5hbWVzIHRvIGRpZmZlcm50aWF0ZSB0aGVtLgoJICovCglhcHBlbmRTdHJpbmc6ICJfX0NKXyIsCgoJLyoqCgkgKiBJbml0aWFsaXplcyB0aGUgY29va2llIGphciB3aXRoIHRoZSBvcHRpb25zLgoJICovCglpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CgkJdGhpcy5vcHRpb25zID0gewoJCQlleHBpcmVzOiAzNjAwLAkJLy8gc2Vjb25kcyAoMSBocikKCQkJcGF0aDogJycsCQkJLy8gY29va2llIHBhdGgKCQkJZG9tYWluOiAnJywJCQkvLyBjb29raWUgZG9tYWluCgkJCXNlY3VyZTogJycJCQkvLyBzZWN1cmUgPwoJCX07CgkJT2JqZWN0LmV4dGVuZCh0aGlzLm9wdGlvbnMsIG9wdGlvbnMgfHwge30pOwoKCQlpZiAodGhpcy5vcHRpb25zLmV4cGlyZXMgIT0gJycpIHsKCQkJdmFyIGRhdGUgPSBuZXcgRGF0ZSgpOwoJCQlkYXRlID0gbmV3IERhdGUoZGF0ZS5nZXRUaW1lKCkgKyAodGhpcy5vcHRpb25zLmV4cGlyZXMgKiAxMDAwKSk7CgkJCXRoaXMub3B0aW9ucy5leHBpcmVzID0gJzsgZXhwaXJlcz0nICsgZGF0ZS50b0dNVFN0cmluZygpOwoJCX0KCQlpZiAodGhpcy5vcHRpb25zLnBhdGggIT0gJycpIHsKCQkJdGhpcy5vcHRpb25zLnBhdGggPSAnOyBwYXRoPScgKyBlc2NhcGUodGhpcy5vcHRpb25zLnBhdGgpOwoJCX0KCQlpZiAodGhpcy5vcHRpb25zLmRvbWFpbiAhPSAnJykgewoJCQl0aGlzLm9wdGlvbnMuZG9tYWluID0gJzsgZG9tYWluPScgKyBlc2NhcGUodGhpcy5vcHRpb25zLmRvbWFpbik7CgkJfQoJCWlmICh0aGlzLm9wdGlvbnMuc2VjdXJlID09ICdzZWN1cmUnKSB7CgkJCXRoaXMub3B0aW9ucy5zZWN1cmUgPSAnOyBzZWN1cmUnOwoJCX0gZWxzZSB7CgkJCXRoaXMub3B0aW9ucy5zZWN1cmUgPSAnJzsKCQl9Cgl9LAoKCS8qKgoJICogQWRkcyBhIG5hbWUgdmFsdWVzIHBhaXIuCgkgKi8KCXB1dDogZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKCQluYW1lID0gdGhpcy5hcHBlbmRTdHJpbmcgKyBuYW1lOwoJCWNvb2tpZSA9IHRoaXMub3B0aW9uczsKCQl2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZTsKCQlzd2l0Y2godHlwZSkgewoJCSAgY2FzZSAndW5kZWZpbmVkJzoKCQkgIGNhc2UgJ2Z1bmN0aW9uJyA6CgkJICBjYXNlICd1bmtub3duJyAgOiByZXR1cm4gZmFsc2U7CgkJICBjYXNlICdib29sZWFuJyAgOiAKCQkgIGNhc2UgJ3N0cmluZycgICA6IAoJCSAgY2FzZSAnbnVtYmVyJyAgIDogdmFsdWUgPSBTdHJpbmcodmFsdWUudG9TdHJpbmcoKSk7CgkJfQoJCXZhciBjb29raWVfc3RyID0gbmFtZSArICI9IiArIGVzY2FwZShPYmplY3QudG9KU09OKHZhbHVlKSk7CgkJdHJ5IHsKCQkJZG9jdW1lbnQuY29va2llID0gY29va2llX3N0ciArIGNvb2tpZS5leHBpcmVzICsgY29va2llLnBhdGggKyBjb29raWUuZG9tYWluICsgY29va2llLnNlY3VyZTsKCQl9IGNhdGNoIChlKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qKgoJICogUmVtb3ZlcyBhIHBhcnRpY3VsYXIgY29va2llIChuYW1lIHZhbHVlIHBhaXIpIGZvcm0gdGhlIENvb2tpZSBKYXIuCgkgKi8KCXJlbW92ZTogZnVuY3Rpb24obmFtZSkgewoJCW5hbWUgPSB0aGlzLmFwcGVuZFN0cmluZyArIG5hbWU7CgkJY29va2llID0gdGhpcy5vcHRpb25zOwoJCXRyeSB7CgkJCXZhciBkYXRlID0gbmV3IERhdGUoKTsKCQkJZGF0ZS5zZXRUaW1lKGRhdGUuZ2V0VGltZSgpIC0gKDM2MDAgKiAxMDAwKSk7CgkJCXZhciBleHBpcmVzID0gJzsgZXhwaXJlcz0nICsgZGF0ZS50b0dNVFN0cmluZygpOwoJCQlkb2N1bWVudC5jb29raWUgPSBuYW1lICsgIj0iICsgZXhwaXJlcyArIGNvb2tpZS5wYXRoICsgY29va2llLmRvbWFpbiArIGNvb2tpZS5zZWN1cmU7CgkJfSBjYXRjaCAoZSkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiB0cnVlOwoJfSwKCgkvKioKCSAqIFJldHVybiBhIHBhcnRpY3VsYXIgY29va2llIGJ5IG5hbWU7CgkgKi8KCWdldDogZnVuY3Rpb24obmFtZSkgewoJCW5hbWUgPSB0aGlzLmFwcGVuZFN0cmluZyArIG5hbWU7CgkJdmFyIGNvb2tpZXMgPSBkb2N1bWVudC5jb29raWUubWF0Y2gobmFtZSArICc9KC4qPykoO3wkKScpOwoJCWlmIChjb29raWVzKSB7CgkJCXJldHVybiAodW5lc2NhcGUoY29va2llc1sxXSkpLmV2YWxKU09OKCk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJfSwKCgkvKioKCSAqIEVtcHRpZXMgdGhlIENvb2tpZSBKYXIuIERlbGV0ZXMgYWxsIHRoZSBjb29raWVzLgoJICovCgllbXB0eTogZnVuY3Rpb24oKSB7CgkJa2V5cyA9IHRoaXMuZ2V0S2V5cygpOwoJCXNpemUgPSBrZXlzLnNpemUoKTsKCQlmb3IoaT0wOyBpPHNpemU7IGkrKykgewoJCQl0aGlzLnJlbW92ZShrZXlzW2ldKTsKCQl9Cgl9LAoKCS8qKgoJICogUmV0dXJucyBhbGwgY29va2llcyBhcyBhIHNpbmdsZSBvYmplY3QKCSAqLwoJZ2V0UGFjazogZnVuY3Rpb24oKSB7CgkJcGFjayA9IHt9OwoJCWtleXMgPSB0aGlzLmdldEtleXMoKTsKCgkJc2l6ZSA9IGtleXMuc2l6ZSgpOwoJCWZvcihpPTA7IGk8c2l6ZTsgaSsrKSB7CgkJCXBhY2tba2V5c1tpXV0gPSB0aGlzLmdldChrZXlzW2ldKTsKCQl9CgkJcmV0dXJuIHBhY2s7Cgl9LAoKCS8qKgoJICogUmV0dXJucyBhbGwga2V5cy4KCSAqLwoJZ2V0S2V5czogZnVuY3Rpb24oKSB7CgkJa2V5cyA9ICRBKCk7CgkJa2V5UmU9IC9bXj07IF0rKD89XD0pL2c7CgkJc3RyICA9IGRvY3VtZW50LmNvb2tpZTsKCQlDSlJlID0gbmV3IFJlZ0V4cCgiXiIgKyB0aGlzLmFwcGVuZFN0cmluZyk7CgkJd2hpbGUoKG1hdGNoID0ga2V5UmUuZXhlYyhzdHIpKSAhPSB1bmRlZmluZWQpIHsKCQkJaWYgKENKUmUudGVzdChtYXRjaFswXS5zdHJpcCgpKSkgewoJCQkJa2V5cy5wdXNoKG1hdGNoWzBdLnN0cmlwKCkuZ3N1YigiXiIgKyB0aGlzLmFwcGVuZFN0cmluZywiIikpOwoJCQl9CgkJfQoJCXJldHVybiBrZXlzOwoJfQp9KTsvKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqCiAqIFZlcnNpb246IE1QTCAxLjEKICoKICogVGhlIGNvbnRlbnRzIG9mIHRoaXMgZmlsZSBhcmUgc3ViamVjdCB0byB0aGUgTW96aWxsYSBQdWJsaWMgTGljZW5zZQogKiBWZXJzaW9uIDEuMSAodGhlICJMaWNlbnNlIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluCiAqIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqIGh0dHA6Ly93d3cubW96aWxsYS5vcmcvTVBMLwogKgogKiBTb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiCiAqIGJhc2lzLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcmlnaHRzIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICoKICogVGhlIE9yaWdpbmFsIENvZGUgaXMgQmVzcGluLgogKgogKiBUaGUgSW5pdGlhbCBEZXZlbG9wZXIgb2YgdGhlIE9yaWdpbmFsIENvZGUgaXMgTW96aWxsYS4KICogUG9ydGlvbnMgY3JlYXRlZCBieSB0aGUgSW5pdGlhbCBEZXZlbG9wZXIgYXJlIENvcHlyaWdodCAoQykgMjAwOQogKiB0aGUgSW5pdGlhbCBEZXZlbG9wZXIuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIENvbnRyaWJ1dG9yKHMpOgogKiAgIEJlc3BpbiBUZWFtIChiZXNwaW5AbW96aWxsYS5jb20pCiAqCiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovCgovLyA9IEJlc3BpbiA9Ci8vCi8vIFRoaXMgaXMgdGhlIHJvb3Qgb2YgaXQgYWxsLiBUaGUge3t7QmVzcGlufX19IG5hbWVzcGFjZS4KLy8gQWxsIG9mIHRoZSBKYXZhU2NyaXB0IGZvciBCZXNwaW4gd2lsbCBiZSBwbGFjZWQgaW4gdGhpcyBuYW1lc3BhY2UgbGF0ZXIuCi8vCi8vIHt7eyBCZXNwaW4udmVyc2lvbiB9fX0gaXMgdGhlIGNvcmUgdmVyc2lvbiBvZiB0aGUgQmVzcGluIHN5c3RlbQovLyB7e3sgQmVzcGluLmNvbW1hbmRsaW5lSGVpZ2h0IH19fSBpcyB0aGUgaGVpZ2h0IG9mIHRoZSBjb21tYW5kIGxpbmUKCnZhciBCZXNwaW4gPSB7CiAgIHZlcnNpb25OdW1iZXI6ICcwLjEuMScsCiAgIHZlcnNpb25Db2RlbmFtZTogJ05hdWdodHkgTmltYnVzJywKICAgY29tbWFuZGxpbmVIZWlnaHQ6IDk1LAogICAKICAgZGlzcGxheVZlcnNpb246IGZ1bmN0aW9uKGVsKSB7CiAgICAgICBpZiAoIWVsKSBlbCA9ICQoInZlcnNpb24iKTsKICAgICAgIGlmICghZWwpIHJldHVybjsKICAgICAgIGVsLmlubmVySFRNTCA9ICdWZXJzaW9uIDxzcGFuIGNsYXNzPSJ2ZXJzaW9ubnVtYmVyIj4nICsgdGhpcy52ZXJzaW9uTnVtYmVyICsgJzwvc3Bhbj4gIicgKyB0aGlzLnZlcnNpb25Db2RlbmFtZSArICciJzsKICAgfQp9OwovKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqCiAqIFZlcnNpb246IE1QTCAxLjEKICoKICogVGhlIGNvbnRlbnRzIG9mIHRoaXMgZmlsZSBhcmUgc3ViamVjdCB0byB0aGUgTW96aWxsYSBQdWJsaWMgTGljZW5zZQogKiBWZXJzaW9uIDEuMSAodGhlICJMaWNlbnNlIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluCiAqIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqIGh0dHA6Ly93d3cubW96aWxsYS5vcmcvTVBMLwogKgogKiBTb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiCiAqIGJhc2lzLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcmlnaHRzIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICoKICogVGhlIE9yaWdpbmFsIENvZGUgaXMgQmVzcGluLgogKgogKiBUaGUgSW5pdGlhbCBEZXZlbG9wZXIgb2YgdGhlIE9yaWdpbmFsIENvZGUgaXMgTW96aWxsYS4KICogUG9ydGlvbnMgY3JlYXRlZCBieSB0aGUgSW5pdGlhbCBEZXZlbG9wZXIgYXJlIENvcHlyaWdodCAoQykgMjAwOQogKiB0aGUgSW5pdGlhbCBEZXZlbG9wZXIuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIENvbnRyaWJ1dG9yKHMpOgogKiAgIEJlc3BpbiBUZWFtIChiZXNwaW5AbW96aWxsYS5jb20pCiAqCiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovCiAKLy8gPSBCb290c3RyYXAgPQovLwovLyBUaGlzIGZpbGUgaXMgdGhlIGVkaXRvciBib290c3RyYXAgY29kZSB0aGF0IGlzIGxvYWRlZCB2aWEgc2NyaXB0IHNyYwovLyBmcm9tIC9lZGl0b3IuaHRtbC4KLy8gCi8vIEl0IGhhbmRsZXMgc2V0dGluZyB1cCB0aGUgb2JqZWN0cyB0aGF0IGFyZSB0byBiZSB1c2VkIG9uIHRoZSBlZGl0b3IKLy8gYW5kIGRlYWxzIHdpdGggbGF5b3V0IGNoYW5nZXMuCgovLyAqKiB7e3sgR2xvYmFscyB9fX0KLy8KLy8gT25lIGRheSB3ZSB3aWxsIGdldCByaWQgb2YgYWxsIG9mIHRoZXNlIGJhciB0aGUgY29yZSBCZXNwaW4gLyBfIG9iamVjdC4KdmFyIF8gPSBCZXNwaW47IC8vIGFsaWFzIGF3YXkhCgp2YXIgX2VkaXRvcjsKdmFyIF9lZGl0U2Vzc2lvbjsKdmFyIF9jb21tYW5kTGluZTsKdmFyIF9maWxlczsKdmFyIF9zZXR0aW5nczsKdmFyIF9zZXJ2ZXI7CnZhciBfdG9vbGJhcjsKdmFyIF9wcm9qZWN0TGFiZWw7CnZhciBfZmlsZUxhYmVsOwp2YXIgX3NjZW5lOwoKdmFyIF9zaG93Q29sbGFiID0gX3Nob3dGaWxlcyA9IF9zaG93VGFyZ2V0ID0gZmFsc2U7IC8vIGZvciBsYXlvdXQKdmFyIF9zaG93Q29sbGFiSG90Q291bnRlciA9IDA7CgovLyAqKiB7e3sgd2luZG93LmxvYWQgdGltZSB9fX0gKioKLy8KLy8gTG9hZHMgYW5kIGNvbmZpZ3VyZXMgdGhlIG9iamVjdHMgdGhhdCB0aGUgZWRpdG9yIG5lZWRzCkVsZW1lbnQub2JzZXJ2ZSh3aW5kb3csICdsb2FkJywgZnVuY3Rpb24oKSB7ICAgIAogICAgX2VkaXRvciAgICAgID0gbmV3IEJlc3Bpbi5FZGl0b3IuQVBJKCQoJ2VkaXRvcicpKTsKICAgIF9lZGl0U2Vzc2lvbiA9IG5ldyBCZXNwaW4uU2Vzc2lvbi5FZGl0U2Vzc2lvbihfZWRpdG9yKTsKICAgIF9zZXJ2ZXIgICAgICA9IG5ldyBCZXNwaW4uU2VydmVyKCk7CiAgICBfc2V0dGluZ3MgICAgPSBuZXcgQmVzcGluLlNldHRpbmdzLkNvcmUoKTsKICAgIF9maWxlcyAgICAgICA9IG5ldyBCZXNwaW4uRmlsZVN5c3RlbSgpOwogICAgX2NvbW1hbmRMaW5lID0gbmV3IEJlc3Bpbi5Db21tYW5kTGluZS5JbnRlcmZhY2UoJCgnY29tbWFuZCcpLCBCZXNwaW4uQ29tbWFuZHMuRWRpdG9yKTsKICAgIF90b29sYmFyICAgICA9IG5ldyBCZXNwaW4uRWRpdG9yLlRvb2xiYXIoKTsKCiAgICBfdG9vbGJhci5zZXR1cERlZmF1bHQoKTsKCiAgICBfZWRpdG9yLnNldEZvY3VzKHRydWUpOwogICAgCiAgICAvLyBGb3JjZSBhIGxvZ2luIGp1c3QgaW4gY2FzZSB0aGUgdXNlciBzZXNzaW9uIGlzbid0IGFyb3VuZAogICAgX3NlcnZlci5jdXJyZW50dXNlcihpc0xvZ2dlZEluLCBpc05vdExvZ2dlZEluKTsKICAgIAogICAgLy8gU2V0IHRoZSB2ZXJzaW9uIGluZm8KICAgIEJlc3Bpbi5kaXNwbGF5VmVyc2lvbigpOwoKICAgIC8vIEdldCBnb2luZyB3aGVuIHNldHRpbmdzIGFyZSBsb2FkZWQKICAgIGRvY3VtZW50Lm9ic2VydmUoImJlc3BpbjpzZXR0aW5nczpsb2FkZWQiLCBmdW5jdGlvbihldmVudCkgewogICAgICAgIF9zZXR0aW5ncy5sb2FkU2Vzc2lvbigpOyAgLy8gbG9hZCB0aGUgbGFzdCBmaWxlIG9yIHdoYXQgaXMgcGFzc2VkIGluCiAgICAgICAgZG9SZXNpemUoKTsKICAgIH0pOwoKICAgIEVsZW1lbnQub2JzZXJ2ZSh3aW5kb3csICdyZXNpemUnLCBkb1Jlc2l6ZSk7Ci8qCiAgICBfc2NlbmUgPSBuZXcgU2NlbmUoJCgicHJvamVjdExhYmVsIikpOwoKICAgIHZhciBwYW5lbCA9IG5ldyBQYW5lbCgpOwogICAgX3NjZW5lLnJvb3QuYWRkKHBhbmVsKTsKCiAgICBfcHJvamVjdExhYmVsID0gbmV3IExhYmVsKHsgc3R5bGU6IHsKICAgICAgICBjb2xvcjogIndoaXRlIiwKICAgICAgICBmb250OiAiMTJwdCBDYWxpYnJpLCBBcmlhbCwgc2Fucy1zZXJpZiIKICAgIH19KTsKICAgIHZhciBzeW1ib2xUaGluZ2llID0gbmV3IExhYmVsKHsgdGV4dDogIjoiLCBzdHlsZTogewogICAgICAgIGNvbG9yOiAiZ3JheSIsCiAgICAgICAgZm9udDogIjEycHQgQ2FsaWJyaSwgQXJpYWwsIHNhbnMtc2VyaWYiCiAgICB9fSk7CiAgICBfZmlsZUxhYmVsID0gbmV3IExhYmVsKHsgc3R5bGU6IHsKICAgICAgICBjb2xvcjogIndoaXRlIiwKICAgICAgICBmb250OiAiMTJwdCBDYWxpYnJpLCBBcmlhbCwgc2Fucy1zZXJpZiIKICAgIH19KTsKCiAgICBwYW5lbC5hZGQoWyBfcHJvamVjdExhYmVsLCBzeW1ib2xUaGluZ2llLCBfZmlsZUxhYmVsIF0pOwogICAgcGFuZWwubGF5b3V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGQgPSB0aGlzLmQoKTsKCiAgICAgICAgdmFyIHggPSAwOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMjsgaSsrKSB7CiAgICAgICAgICAgIHZhciB3aWR0aCA9IHRoaXMuY2hpbGRyZW5baV0uZ2V0UHJlZmVycmVkV2lkdGgoZC5iLmgpOwogICAgICAgICAgICB0aGlzLmNoaWxkcmVuW2ldLmJvdW5kcyA9IHsgeDogeCwgeTogMCwgd2lkdGg6IHdpZHRoLCBoZWlnaHQ6IGQuYi5oIH07CiAgICAgICAgICAgIHggKz0gd2lkdGg7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNoaWxkcmVuWzJdLmJvdW5kcyA9IHsgeDogeCwgeTogMCwgd2lkdGg6IGQuYi53IC0gZC5pLncgLSB4LCBoZWlnaHQ6IGQuYi5oIH07CiAgICB9CgogICAgX3NjZW5lLnJlbmRlcigpOyovCn0pOwoKLy8gKioge3t7IGlzTG9nZ2VkSW4odXNlcmluZm8pIH19fSAqKgovLwovLyAqIHt7e3VzZXJpbmZvfX19IGlzIGFuIG9iamVjdCBjb250YWluaW5nIHVzZXIgc3BlY2lmaWMgaW5mbyAocHJvamVjdCBldGMpCi8vCi8vIFNhdmUgdGhlIHVzZXJzIG1hZ2ljIHByb2plY3QgaW50byB0aGUgc2Vzc2lvbgpmdW5jdGlvbiBpc0xvZ2dlZEluKHVzZXJpbmZvKSB7CiAgICBfZWRpdFNlc3Npb24udXNlcnByb2plY3QgPSB1c2VyaW5mby5wcm9qZWN0OyAvLyB0aGUgc3BlY2lhbCB1c2VyIHByb2plY3QKfQoKCi8vICoqIHt7eyBpc05vdExvZ2dlZEluKCkgfX19ICoqCi8vCi8vIFNlbmQgdGhlIHVzZXIgYmFjayB0byB0aGUgZnJvbnQgcGFnZSBhcyB0aGV5IGFyZW4ndCBsb2dnZWQgaW4uCi8vIFRoZSBzZXJ2ZXIgc2hvdWxkIHN0b3AgdGhpcyBmcm9tIGhhcHBlbmluZywgYnV0IEpVU1QgaW4gY2FzZS4KZnVuY3Rpb24gaXNOb3RMb2dnZWRJbigpIHsKICAgIF8uTmF2aWdhdGUuaG9tZSgpOyAvLyBnbyBiYWNrCn0gICAgCgovLyAqKiB7e3sgcmVjYWxjTGF5b3V0KCkgfX19ICoqCi8vCi8vIFdoZW4gYSBjaGFuZ2UgdG8gdGhlIFVJIGlzIG5lZWRlZCBkdWUgdG8gb3BlbmluZyBvciBjbG9zaW5nIGEgZmVhdHVyZQovLyAoZS5nLiBmaWxlIHZpZXcsIHNlc3Npb24gdmlldykgbW92ZSB0aGUgaXRlbXMgYXJvdW5kCmZ1bmN0aW9uIHJlY2FsY0xheW91dCgpIHsKICAgIHZhciBzdWJoZWFkZXIgPSAkKCJzdWJoZWFkZXIiKTsKICAgIHZhciBmb290ZXIgPSAkKCJmb290ZXIiKTsKICAgIHZhciBlZGl0b3IgPSAkKCJlZGl0b3IiKTsKICAgIHZhciBmaWxlcyA9ICQoImZpbGVzIik7CiAgICB2YXIgY29sbGFiID0gJCgiY29sbGFiIik7CiAgICB2YXIgdGFyZ2V0ID0gJCgidGFyZ2V0X2Jyb3dzZXJzIik7CgogICAgdmFyIG1vdmUgPSBbIHN1YmhlYWRlciwgZm9vdGVyLCBlZGl0b3IgXTsKCiAgICBpZiAoX3Nob3dGaWxlcykgewogICAgICAgIGZpbGVzLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgIG1vdmUuZWFjaChmdW5jdGlvbihpdGVtKSB7IGl0ZW0uc3R5bGUubGVmdCA9ICIyMDFweCIgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGZpbGVzLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgbW92ZS5lYWNoKGZ1bmN0aW9uKGl0ZW0pIHsgaXRlbS5zdHlsZS5sZWZ0ID0gIjAiIH0pOwogICAgfQoKICAgIG1vdmUucG9wKCk7ICAgLy8gZWRpdG9yIHNob3VsZG4ndCBoYXZlIGl0cyByaWdodC1oYW5kIHNpZGUgc2V0CgogICAgaWYgKF9zaG93Q29sbGFiKSB7CiAgICAgICAgY29sbGFiLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgIG1vdmUuZWFjaChmdW5jdGlvbihpdGVtKSB7IGl0ZW0uc3R5bGUucmlnaHQgPSAiMjAxcHgiIH0pOwogICAgfSBlbHNlIHsKICAgICAgICBjb2xsYWIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICBtb3ZlLmVhY2goZnVuY3Rpb24oaXRlbSkgeyBpdGVtLnN0eWxlLnJpZ2h0ID0gIjAiIH0pOwogICAgfQoKICAgIGlmIChfc2hvd1RhcmdldCkgewogICAgICAgIHRhcmdldC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgIH0gZWxzZSB7CiAgICAgICAgdGFyZ2V0LnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICB9CgogICAgZG9SZXNpemUoKTsKfQoKLy8gKioge3t7IGRvUmVzaXplKCkgfX19ICoqCi8vCi8vIFdoZW4gYSB1c2VyIHJlc2l6ZXMgdGhlIHdpbmRvdywgZGVhbCB3aXRoIHJlc2l6aW5nIHRoZSBjYW52YXMgYW5kIHJlcGFpbnQKZnVuY3Rpb24gZG9SZXNpemUoKSB7CiAgICB2YXIgbGVmdCA9ICQoInN1YmhlYWRlciIpLnN0eWxlLmxlZnQ7CiAgICBsZWZ0ID0gKGxlZnQgIT0gIiIpID8gcGFyc2VJbnQobGVmdCkgOiAwOwogICAgdmFyIHJpZ2h0ID0gJCgic3ViaGVhZGVyIikuc3R5bGUucmlnaHQ7CiAgICByaWdodCA9IChyaWdodCAhPSAiIikgPyBwYXJzZUludChyaWdodCkgOiAwOwoKICAgIEVsZW1lbnQud3JpdGVBdHRyaWJ1dGUoJCgnZWRpdG9yJyksIHsKICAgICAgICB3aWR0aDogd2luZG93LmlubmVyV2lkdGggLSBsZWZ0IC0gcmlnaHQsCiAgICAgICAgaGVpZ2h0OiB3aW5kb3cuaW5uZXJIZWlnaHQgLSBCZXNwaW4uY29tbWFuZGxpbmVIZWlnaHQKICAgIH0pOwoKICAgIHZhciBkID0gJCgnc3RhdHVzJykuZ2V0RGltZW5zaW9ucygpOwogICAgRWxlbWVudC53cml0ZUF0dHJpYnV0ZSgkKCdwcm9qZWN0TGFiZWwnKSwgewogICAgICAgIHdpZHRoOiBkLndpZHRoLAogICAgICAgIGhlaWdodDogZC5oZWlnaHQKICAgIH0pOwoKICAgIF9lZGl0b3IucGFpbnQoKTsKfS8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKioKICogVmVyc2lvbjogTVBMIDEuMQogKgogKiBUaGUgY29udGVudHMgb2YgdGhpcyBmaWxlIGFyZSBzdWJqZWN0IHRvIHRoZSBNb3ppbGxhIFB1YmxpYyBMaWNlbnNlCiAqIFZlcnNpb24gMS4xICh0aGUgIkxpY2Vuc2UiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4KICogY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICogaHR0cDovL3d3dy5tb3ppbGxhLm9yZy9NUEwvCiAqCiAqIFNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIKICogYmFzaXMsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyByaWdodHMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBUaGUgT3JpZ2luYWwgQ29kZSBpcyBCZXNwaW4uCiAqCiAqIFRoZSBJbml0aWFsIERldmVsb3BlciBvZiB0aGUgT3JpZ2luYWwgQ29kZSBpcyBNb3ppbGxhLgogKiBQb3J0aW9ucyBjcmVhdGVkIGJ5IHRoZSBJbml0aWFsIERldmVsb3BlciBhcmUgQ29weXJpZ2h0IChDKSAyMDA5CiAqIHRoZSBJbml0aWFsIERldmVsb3Blci4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogQ29udHJpYnV0b3Iocyk6CiAqICAgQmVzcGluIFRlYW0gKGJlc3BpbkBtb3ppbGxhLmNvbSkKICoKICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi8KCi8vID0gRXZlbnQgQnVzID0KLy8KLy8gR2xvYmFsIGhvbWUgZm9yIGV2ZW50IHdhdGNoaW5nIHdoZXJlIGl0IGRvZXNuJ3QgZml0IHVzaW5nIHRoZSBwYXR0ZXJuCi8vIG9mIGN1c3RvbSBldmVudHMgdGllZCB0byBjb21wb25lbnRzIHRoZW1zZWx2ZXMgc3VjaCBhczoKLy8KLy8gKiB7e3tCZXNwaW4uQ29tbWFuZExpbmUuRXZlbnRzfX19Ci8vICoge3t7QmVzcGluLlNldHRpbmdzLkV2ZW50c319fQoKLy8gKioge3t7IEV2ZW50OiBiZXNwaW46ZWRpdG9yOm5ld2ZpbGUgfX19ICoqCi8vIAovLyBPYnNlcnZlIGEgcmVxdWVzdCBmb3IgYSBuZXcgZmlsZSB0byBiZSBjcmVhdGVkCmRvY3VtZW50Lm9ic2VydmUoImJlc3BpbjplZGl0b3I6bmV3ZmlsZSIsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgcHJvamVjdCA9IGV2ZW50Lm1lbW8ucHJvamVjdCB8fCBfZWRpdFNlc3Npb24ucHJvamVjdDsKICAgIHZhciBuZXdmaWxlbmFtZSA9IGV2ZW50Lm1lbW8ubmV3ZmlsZW5hbWUgfHwgIm5ldy50eHQiOwoKICAgIF9maWxlcy5uZXdGaWxlKHByb2plY3QsIG5ld2ZpbGVuYW1lLCBmdW5jdGlvbigpIHsKICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOm9wZW5maWxlOm9wZW5zdWNjZXNzIiwgeyBmaWxlOiB7CiAgICAgICAgICAgIG5hbWU6IG5ld2ZpbGVuYW1lLAogICAgICAgICAgICBjb250ZW50OiAiICIsCiAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS5nZXRUaW1lKCkKICAgICAgICB9fSk7CiAgICB9KTsKfSk7CgovLyAqKiB7e3sgRXZlbnQ6IGJlc3BpbjplZGl0b3I6b3BlbmZpbGUgfX19ICoqCi8vIAovLyBPYnNlcnZlIGEgcmVxdWVzdCBmb3IgYSBmaWxlIHRvIGJlIG9wZW5lZCBhbmQgc3RhcnQgdGhlIGN5Y2xlOgovLwovLyAqIFNlbmQgZXZlbnQgdGhhdCB5b3UgYXJlIG9wZW5pbmcgdXAgc29tZXRoaW5nIChvcGVuYmVmb3JlKQovLyAqIEFzayB0aGUgZmlsZSBzeXN0ZW0gdG8gbG9hZCBhIGZpbGUgKGxvYWRGaWxlKQovLyAqIElmIHRoZSBmaWxlIGlzIGxvYWRlZCBzZW5kIGFuIG9wZW5zdWNjZXNzIGV2ZW50Ci8vICogSWYgdGhlIGZpbGUgZmFpbHMgdG8gbG9hZCwgc2VuZCBhbiBvcGVuZmFpbCBldmVudApkb2N1bWVudC5vYnNlcnZlKCJiZXNwaW46ZWRpdG9yOm9wZW5maWxlIiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciBmaWxlbmFtZSA9IGV2ZW50Lm1lbW8uZmlsZW5hbWU7CiAgICB2YXIgcHJvamVjdCAgPSBldmVudC5tZW1vLnByb2plY3QgfHwgX2VkaXRTZXNzaW9uLnByb2plY3Q7CgogICAgaWYgKF9lZGl0U2Vzc2lvbi5wYXRoID09IGZpbGVuYW1lKSByZXR1cm47IC8vIHNob3J0IGNpcmN1aXQKCiAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOm9wZW5maWxlOm9wZW5iZWZvcmUiLCB7IGZpbGVuYW1lOiBmaWxlbmFtZSB9KTsKCiAgICBfZmlsZXMubG9hZEZpbGUocHJvamVjdCwgZmlsZW5hbWUsIGZ1bmN0aW9uKGZpbGUpIHsKICAgICAgICBpZiAoIWZpbGUpIHsKICAgICAgICAgICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOmVkaXRvcjpvcGVuZmlsZTpvcGVuZmFpbCIsIHsgZmlsZW5hbWU6IGZpbGVuYW1lIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRvY3VtZW50LmZpcmUoImJlc3BpbjplZGl0b3I6b3BlbmZpbGU6b3BlbnN1Y2Nlc3MiLCB7IGZpbGU6IGZpbGUgfSk7CiAgICAgICAgfQogICAgfSk7Cn0pOwoKLy8gKioge3t7IEV2ZW50OiBiZXNwaW46ZWRpdG9yOnNhdmVmaWxlIH19fSAqKgovLyAKLy8gT2JzZXJ2ZSBhIHJlcXVlc3QgZm9yIGEgZmlsZSB0byBiZSBzYXZlZCBhbmQgc3RhcnQgdGhlIGN5Y2xlOgovLwovLyAqIFNlbmQgZXZlbnQgdGhhdCB5b3UgYXJlIGFib3V0IHRvIHNhdmUgdGhlIGZpbGUgKHNhdmViZWZvcmUpCi8vICogR2V0IHRoZSBsYXN0IG9wZXJhdGlvbiBmcm9tIHRoZSBzeW5jIGhlbHBlciBpZiBpdCBpcyB1cCBhbmQgcnVubmluZwovLyAqIEFzayB0aGUgZmlsZSBzeXN0ZW0gdG8gc2F2ZSB0aGUgZmlsZQovLyAqIENoYW5nZSB0aGUgcGFnZSB0aXRsZSB0byBoYXZlIHRoZSBuZXcgZmlsZW5hbWUKLy8gKiBUZWxsIHRoZSBjb21tYW5kIGxpbmUgdG8gc2hvdyB0aGUgZmFjdCB0aGF0IHRoZSBmaWxlIGlzIHNhdmVkCi8vCi8vIFRPRE86IE5lZWQgdG8gYWN0dWFsbHkgY2hlY2sgc2F2ZWQgc3RhdHVzIGFuZCBrbm93IGlmIHRoZSBzYXZlIHdvcmtlZAoKZG9jdW1lbnQub2JzZXJ2ZSgiYmVzcGluOmVkaXRvcjpzYXZlZmlsZSIsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgZmlsZW5hbWUgPSBldmVudC5tZW1vLmZpbGVuYW1lOwogICAgCiAgICBmaWxlbmFtZSA9IGZpbGVuYW1lIHx8IF9lZGl0U2Vzc2lvbi5wYXRoOyAvLyBkZWZhdWx0IHRvIHdoYXQgeW91IGhhdmUKCiAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOm9wZW5maWxlOnNhdmViZWZvcmUiLCB7IGZpbGVuYW1lOiBmaWxlbmFtZSB9KTsKCiAgICB2YXIgZmlsZSA9IHsKICAgICAgICBuYW1lOiBmaWxlbmFtZSwKICAgICAgICBjb250ZW50OiBfZWRpdG9yLm1vZGVsLmdldERvY3VtZW50KCksCiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLmdldFRpbWUoKQogICAgfTsKCiAgICBpZiAoX2VkaXRvci51bmRvTWFuYWdlci5zeW5jSGVscGVyKSB7IC8vIG9ubHkgaWYgb3BzIGFyZSBvbgogICAgICAgIGZpbGUubGFzdE9wID0gX2VkaXRvci51bmRvTWFuYWdlci5zeW5jSGVscGVyLmxhc3RPcDsKICAgIH0KCiAgICBfZmlsZXMuc2F2ZUZpbGUoX2VkaXRTZXNzaW9uLnByb2plY3QsIGZpbGUpOyAvLyBpdCB3aWxsIHNhdmUgYXN5bmNocm9ub3VzbHkuCiAgICAvLyBUT0RPOiBIZXJlIHdlIG5lZWQgdG8gYWRkIGluIGNsb3N1cmUgdG8gZGV0ZWN0IGVycm9ycyBhbmQgdGh1cyBmaXJlIGRpZmZlcmVudCBzdWNjZXNzIC8gZXJyb3IKCiAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOnRpdGxlY2hhbmdlIiwgeyBmaWxlbmFtZTogZmlsZW5hbWUgfSk7CgogICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOmNtZGxpbmU6c2hvd2luZm8iLCB7IG1zZzogJ1NhdmVkIGZpbGU6ICcgKyBmaWxlLm5hbWUgfSk7Cn0pOwoKCi8vID09IFNoZWxsIEV2ZW50czogSGVhZGVyLCBDaHJvbWUsIGV0YyA9PQovLwovLyAqKiB7e3sgRXZlbnQ6IGJlc3BpbjplZGl0b3I6b3BlbmZpbGU6b3BlbnN1Y2Nlc3MgfX19ICoqCi8vIAovLyBXaGVuIGEgZmlsZSBpcyBvcGVuZWQgc3VjY2Vzc2Z1bGx5IGNoYW5nZSB0aGUgcHJvamVjdCBhbmQgZmlsZSBzdGF0dXMgYXJlYS4KLy8gVGhlbiBjaGFuZ2UgdGhlIHdpbmRvdyB0aXRsZSwgYW5kIGNoYW5nZSB0aGUgVVJMIGhhc2ggYXJlYQpkb2N1bWVudC5vYnNlcnZlKCJiZXNwaW46ZWRpdG9yOm9wZW5maWxlOm9wZW5zdWNjZXNzIiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciBmaWxlID0gZXZlbnQubWVtby5maWxlOwogICAgCiAgICB2YXIgZmlsZW5hbWUgPSBmaWxlLm5hbWU7CgogICAgX3Byb2plY3RMYWJlbC5hdHRyaWJ1dGVzLnRleHQgPSBfZWRpdFNlc3Npb24ucHJvamVjdEZvckRpc3BsYXkoKTsKICAgIF9maWxlTGFiZWwuYXR0cmlidXRlcy50ZXh0ID0gZmlsZW5hbWU7CiAgICBfc2NlbmUucmVuZGVyKCk7CgogICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOmVkaXRvcjp0aXRsZWNoYW5nZSIsIHsgZmlsZW5hbWU6IGZpbGUubmFtZSB9KTsKCiAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOnVybGNoYW5nZSIsIHsgcHJvamVjdDogX2VkaXRTZXNzaW9uLnByb2plY3QsIHBhdGg6IGZpbGUubmFtZSB9KTsKfSk7CgovLyAqKiB7e3sgRXZlbnQ6IGJlc3BpbjplZGl0b3I6dGl0bGVjaGFuZ2UgfX19ICoqCi8vIAovLyBPYnNlcnZlIGEgdGl0bGUgY2hhbmdlIGV2ZW50IGFuZCB0aGVuLi4uIGNoYW5nZSB0aGUgZG9jdW1lbnQudGl0bGUhCmRvY3VtZW50Lm9ic2VydmUoImJlc3BpbjplZGl0b3I6dGl0bGVjaGFuZ2UiLCBmdW5jdGlvbihldmVudCkgewogICAgdmFyIHRpdGxlOwogICAgaWYgKGV2ZW50Lm1lbW8uZmlsZW5hbWUpIHRpdGxlID0gZXZlbnQubWVtby5maWxlbmFtZSArICcgLSBlZGl0aW5nIHdpdGggQmVzcGluJzsKICAgIGVsc2UgaWYgKGV2ZW50Lm1lbW8udGl0bGUpIHRpdGxlID0gZXZlbnQubWVtby50aXRsZTsKICAgIGVsc2UgdGl0bGUgPSAnQmVzcGluICZyYXF1bzsgQ29kZSBpbiB0aGUgQ2xvdWQnOwoKICAgIGRvY3VtZW50LnRpdGxlID0gdGl0bGU7Cn0pOwoKLy8gKioge3t7IEV2ZW50OiBiZXNwaW46ZWRpdG9yOnVybGNoYW5nZSB9fX0gKioKLy8gCi8vIE9ic2VydmUgYSB1cmxjaGFuZ2UgZXZlbnQgYW5kIHRoZW4uLi4gY2hhbmdlIHRoZSBsb2NhdGlvbiBoYXNoCmRvY3VtZW50Lm9ic2VydmUoImJlc3BpbjplZGl0b3I6dXJsY2hhbmdlIiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciBwcm9qZWN0ID0gZXZlbnQubWVtby5wcm9qZWN0OwogICAgdmFyIHBhdGggICAgPSBldmVudC5tZW1vLnBhdGg7CgogICAgZG9jdW1lbnQubG9jYXRpb24uaGFzaCA9ICJwcm9qZWN0PSIgKyBwcm9qZWN0ICsgIiZwYXRoPSIgKyBwYXRoOwp9KTsKCi8vICoqIHt7eyBFdmVudDogYmVzcGluOmNtZGxpbmU6ZXhlY3V0ZWQgfX19ICoqCi8vIAovLyBTZXQgdGhlIGxhc3QgY29tbWFuZCBpbiB0aGUgc3RhdHVzIHdpbmRvdwpkb2N1bWVudC5vYnNlcnZlKCJiZXNwaW46Y21kbGluZTpleGVjdXRlZCIsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgY29tbWFuZG5hbWUgPSBldmVudC5tZW1vLmNvbW1hbmQubmFtZTsKICAgIHZhciBhcmdzICAgICAgICA9IGV2ZW50Lm1lbW8uYXJnczsKCiAgICAkKCdtZXNzYWdlJykuaW5uZXJIVE1MID0gImxhc3QgY21kOiA8c3BhbiB0aXRsZT0nIiArIGNvbW1hbmRuYW1lICsgIiAiICsgYXJncyArICInPiIgKyBjb21tYW5kbmFtZSArICI8L3NwYW4+IjsgLy8gc2V0IHRoZSBzdGF0dXMgbWVzc2FnZSBhcmVhCn0pOwoKLy8gKioge3t7IEV2ZW50OiBiZXNwaW46ZWRpdG9yOmNvbmZpZzpydW4gfX19ICoqCi8vIAovLyBMb2FkIHRoZSB1c2VycyBjb25maWcgZmlsZQpkb2N1bWVudC5vYnNlcnZlKCJiZXNwaW46ZWRpdG9yOmNvbmZpZzpydW4iLCBmdW5jdGlvbihldmVudCkgewogICAgLy8gMS4gbG9hZCB0aGUgZmlsZQogICAgLy8gICBwcm9qZWN0OiBfZWRpdFNlc3Npb24udXNlcnByb2plY3QsCiAgICAvLyAgIGZpbGVuYW1lOiAiY29uZmlnLmpzIgogICAgLy8gMi4gVGFrZSB0aGUgY29udGVudHMgYW5kIHJ1biBlYWNoIGxpbmUgYXMgYSBjb21tYW5kIAogICAgX2ZpbGVzLmxvYWRGaWxlKF9lZGl0U2Vzc2lvbi51c2VycHJvamVjdCwgImNvbmZpZy5qcyIsIGZ1bmN0aW9uKGZpbGUpIHsKICAgICAgICB2YXIgY29udGVudHMgPSBmaWxlLmNvbnRlbnQuc3BsaXQoL1xuLyk7CgogICAgICAgIGNvbnRlbnRzLmVhY2goZnVuY3Rpb24obGluZSkgewogICAgICAgICAgICBpZiAobGluZS5zdGFydHNXaXRoKCcvJykgfHwgbGluZS5zdGFydHNXaXRoKCcjJykpIHJldHVybjsKICAgICAgICAgICAgbGluZSA9IGxpbmUucmVwbGFjZSgvIy4qJC8sICcnKTsgLy8gbnVrZSBpbmxpbmUgY29tbWVudCAoZS5nLiAidmVyc2lvbiAgICAjIGdldCB0aGUgY3VycmVudCB2ZXJzaW9uIikKICAgICAgICAgICAgdmFyIGNvbW1hbmQgPSBsaW5lLnNwbGl0KCcgJyk7CiAgICAgICAgICAgIHZhciBjb21tYW5kbmFtZSA9IGNvbW1hbmQuZmlyc3QoKTsKICAgICAgICAgICAgaWYgKF9jb21tYW5kTGluZS5oYXNDb21tYW5kKGNvbW1hbmRuYW1lKSkgewogICAgICAgICAgICAgICAgX2NvbW1hbmRMaW5lLmV4ZWN1dGVDb21tYW5kKGxpbmUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LCB0cnVlKTsKfSk7CgovLyAqKiB7e3sgRXZlbnQ6IGJlc3BpbjplZGl0b3I6cHJldmlldyB9fX0gKioKLy8gCi8vIExvYWQgdGhlIHVzZXJzIGNvbmZpZyBmaWxlCmRvY3VtZW50Lm9ic2VydmUoImJlc3BpbjplZGl0b3I6cHJldmlldyIsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgZmlsZW5hbWUgPSBldmVudC5tZW1vLmZpbGVuYW1lIHx8IF9lZGl0U2Vzc2lvbi5wYXRoOyAvLyBkZWZhdWx0IHRvIGN1cnJlbnQgcGFnZQogICAgdmFyIHByb2plY3QgID0gZXZlbnQubWVtby5wcm9qZWN0ICB8fCBfZWRpdFNlc3Npb24ucHJvamVjdDsKCiAgICAvLyBNYWtlIHN1cmUgdG8gc2F2ZSB0aGUgZmlsZSBmaXJzdAogICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOmVkaXRvcjpzYXZlZmlsZSIsIHsKICAgICAgICBmaWxlbmFtZTogZmlsZW5hbWUKICAgIH0pOwoKICAgIGlmIChmaWxlbmFtZSkKICAgICAgICB3aW5kb3cub3BlbihCZXNwaW4uUGF0aC5jb21iaW5lKCJwcmV2aWV3L2F0IiwgcHJvamVjdCwgZmlsZW5hbWUpKTsKfSk7CgovLyA9PSBFdmVudHMKLy8gCi8vICoqIHt7eyBCZXNwaW4uRXZlbnRzIH19fSAqKgovLwovLyBIZWxwZXJzIGZvciB0aGUgZXZlbnQgc3Vic3lzdGVtCkJlc3Bpbi5FdmVudHMgPSB7CgogICAgLy8gKioge3t7IEJlc3Bpbi5FdmVudHMudG9GaXJlIH19fSAqKgogICAgLy8KICAgIC8vIEdpdmVuIGFuIHt7e2V2ZW50U3RyaW5nfX19IHBhcnNlIG91dCB0aGUgYXJndW1lbnRzIGFuZCBjb25maWd1cmUgYW4gZXZlbnQgb2JqZWN0CiAgICAvLwogICAgLy8gRXhhbXBsZSBldmVudHM6CiAgICAvLwogICAgLy8gKiB7e3tiZXNwaW46Y21kbGluZTpleGVjdXRlO25hbWU9bHMsYXJncz1iZXNwaW59fX0KICAgIC8vICoge3t7YmVzcGluOmNtZGxpbmU6ZXhlY3V0ZX19fQogICAgdG9GaXJlOiBmdW5jdGlvbihldmVudFN0cmluZykgewogICAgICAgIHZhciBldmVudCA9IHt9OwogICAgICAgIGlmICghZXZlbnRTdHJpbmcuaW5kZXhPZignOycpKSB7IC8vIGp1c3QgYSBwbGFpbiBjb21tYW5kIHdpdGggbm8gYXJncwogICAgICAgICAgICBldmVudC5uYW1lID0gZXZlbnRTdHJpbmc7CiAgICAgICAgfSBlbHNlIHsgLy8gc3BsaXQgdXAgdGhlIGFyZ3MKICAgICAgICAgICAgdmFyIHBpZWNlcyA9IGV2ZW50U3RyaW5nLnNwbGl0KCc7Jyk7CiAgICAgICAgICAgIGV2ZW50Lm5hbWUgPSBwaWVjZXNbMF07CiAgICAgICAgICAgIGV2ZW50LmFyZ3MgPSBwaWVjZXNbMV0udG9RdWVyeVBhcmFtcygnLCcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICB9Cn07LyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKgogKiBWZXJzaW9uOiBNUEwgMS4xCiAqCiAqIFRoZSBjb250ZW50cyBvZiB0aGlzIGZpbGUgYXJlIHN1YmplY3QgdG8gdGhlIE1vemlsbGEgUHVibGljIExpY2Vuc2UKICogVmVyc2lvbiAxLjEgKHRoZSAiTGljZW5zZSIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbgogKiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKiBodHRwOi8vd3d3Lm1vemlsbGEub3JnL01QTC8KICoKICogU29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIgogKiBiYXNpcywgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHJpZ2h0cyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIFRoZSBPcmlnaW5hbCBDb2RlIGlzIEJlc3Bpbi4KICoKICogVGhlIEluaXRpYWwgRGV2ZWxvcGVyIG9mIHRoZSBPcmlnaW5hbCBDb2RlIGlzIE1vemlsbGEuCiAqIFBvcnRpb25zIGNyZWF0ZWQgYnkgdGhlIEluaXRpYWwgRGV2ZWxvcGVyIGFyZSBDb3B5cmlnaHQgKEMpIDIwMDkKICogdGhlIEluaXRpYWwgRGV2ZWxvcGVyLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBDb250cmlidXRvcihzKToKICogICBCZXNwaW4gVGVhbSAoYmVzcGluQG1vemlsbGEuY29tKQogKgogKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqLwoKaWYgKHR5cGVvZiBCZXNwaW4gPT0gInVuZGVmaW5lZCIpIEJlc3BpbiA9IHt9OwoKLy8gPSBDbGlwYm9hcmQgPQovLwovLyBIYW5kbGUgY2xpcGJvYXJkIG9wZXJhdGlvbnMKCi8vICoqIHt7eyBCZXNwaW4uQ2xpcGJvYXJkIH19fSAqKgovLwovLyBXcmFwIGNsaXBib2FyZCBhY2Nlc3MgdG8gZG8gdGhlIHJpZ2h0IHRoaW5nIGlmIHlvdSBoYXZlIGFjY2VzcyB0byBuYXRpdmUgY2xpcGJvYXJkCi8vIEVsc2UsIGp1c3Qgc3RvcmUgdG8gYSBsb2NhbCBjbGlwYm9hcmQuIExhbWUgSSBrbm93LgpCZXNwaW4uQ2xpcGJvYXJkID0gbmV3IGZ1bmN0aW9uKCkgewogICAgdmFyIGNsaXBkYXRhOwogICAgCiAgICByZXR1cm4gewogICAgICAgIGNvcHk6IGZ1bmN0aW9uKGNvcHl0ZXh0KSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpZiAobmV0c2NhcGUuc2VjdXJpdHkuUHJpdmlsZWdlTWFuYWdlci5lbmFibGVQcml2aWxlZ2UpIHsKICAgICAgICAgICAgICAgICAgICBuZXRzY2FwZS5zZWN1cml0eS5Qcml2aWxlZ2VNYW5hZ2VyLmVuYWJsZVByaXZpbGVnZSgiVW5pdmVyc2FsWFBDb25uZWN0Iik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNsaXBkYXRhID0gY29weXRleHQ7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgY2xpcGRhdGEgPSBjb3B5dGV4dDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHN0ciA9IENvbXBvbmVudHMuY2xhc3Nlc1siQG1vemlsbGEub3JnL3N1cHBvcnRzLXN0cmluZzsxIl0uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlSW5zdGFuY2UoQ29tcG9uZW50cy5pbnRlcmZhY2VzLm5zSVN1cHBvcnRzU3RyaW5nKTsKICAgICAgICAgICAgc3RyLmRhdGEgPSBjb3B5dGV4dDsKCiAgICAgICAgICAgIHZhciB0cmFucyA9IENvbXBvbmVudHMuY2xhc3Nlc1siQG1vemlsbGEub3JnL3dpZGdldC90cmFuc2ZlcmFibGU7MSJdLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZUluc3RhbmNlKENvbXBvbmVudHMuaW50ZXJmYWNlcy5uc0lUcmFuc2ZlcmFibGUpOwogICAgICAgICAgICBpZiAoIXRyYW5zKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICB0cmFucy5hZGREYXRhRmxhdm9yKCJ0ZXh0L3VuaWNvZGUiKTsKICAgICAgICAgICAgdHJhbnMuc2V0VHJhbnNmZXJEYXRhKCJ0ZXh0L3VuaWNvZGUiLCBzdHIsIGNvcHl0ZXh0Lmxlbmd0aCAqIDIpOwoKICAgICAgICAgICAgdmFyIGNsaXBpZCA9IENvbXBvbmVudHMuaW50ZXJmYWNlcy5uc0lDbGlwYm9hcmQ7CiAgICAgICAgICAgIHZhciBjbGlwICAgPSBDb21wb25lbnRzLmNsYXNzZXNbIkBtb3ppbGxhLm9yZy93aWRnZXQvY2xpcGJvYXJkOzEiXS5nZXRTZXJ2aWNlKGNsaXBpZCk7CiAgICAgICAgICAgIGlmICghY2xpcCkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgY2xpcC5zZXREYXRhKHRyYW5zLCBudWxsLCBjbGlwaWQua0dsb2JhbENsaXBib2FyZCk7CgogICAgICAgICAgICAvKgogICAgICAgICAgICAvLyBGbGFzaCBkb2Vzbid0IHdvcmsgYW55bW9yZSA6KAogICAgICAgICAgICBpZiAoaW5FbGVtZW50LmNyZWF0ZVRleHRSYW5nZSkgewogICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gaW5FbGVtZW50LmNyZWF0ZVRleHRSYW5nZSgpOwogICAgICAgICAgICAgICAgaWYgKHJhbmdlICYmIEJvZHlMb2FkZWQ9PTEpCiAgICAgICAgICAgICAgICAgICAgcmFuZ2UuZXhlY0NvbW1hbmQoJ0NvcHknKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBmbGFzaGNvcGllciA9ICdmbGFzaGNvcGllcic7CiAgICAgICAgICAgICAgICBpZighZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZmxhc2hjb3BpZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRpdmhvbGRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAgICAgICAgIGRpdmhvbGRlci5pZCA9IGZsYXNoY29waWVyOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZGl2aG9sZGVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGZsYXNoY29waWVyKS5pbm5lckhUTUwgPSAnJzsKCiAgICAgICAgICAgICAgICB2YXIgZGl2aW5mbyA9ICc8ZW1iZWQgc3JjPSJfY2xpcGJvYXJkLnN3ZiIgRmxhc2hWYXJzPSJjbGlwYm9hcmQ9Jytlc2NhcGUoaW5FbGVtZW50LnZhbHVlKSsnIiB3aWR0aD0iMCIgaGVpZ2h0PSIwIiB0eXBlPSJhcHBsaWNhdGlvbi94LXNob2Nrd2F2ZS1mbGFzaCI+PC9lbWJlZD4nOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZmxhc2hjb3BpZXIpLmlubmVySFRNTCA9IGRpdmluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKi8KICAgICAgICB9LAoKICAgICAgICBkYXRhOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChuZXRzY2FwZS5zZWN1cml0eS5Qcml2aWxlZ2VNYW5hZ2VyLmVuYWJsZVByaXZpbGVnZSkgewogICAgICAgICAgICAgICAgICAgIG5ldHNjYXBlLnNlY3VyaXR5LlByaXZpbGVnZU1hbmFnZXIuZW5hYmxlUHJpdmlsZWdlKCJVbml2ZXJzYWxYUENvbm5lY3QiKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNsaXBkYXRhOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNsaXBkYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY2xpcCA9IENvbXBvbmVudHMuY2xhc3Nlc1siQG1vemlsbGEub3JnL3dpZGdldC9jbGlwYm9hcmQ7MSJdLmdldFNlcnZpY2UoQ29tcG9uZW50cy5pbnRlcmZhY2VzLm5zSUNsaXBib2FyZCk7CiAgICAgICAgICAgIGlmICghY2xpcCkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgdmFyIHRyYW5zID0gQ29tcG9uZW50cy5jbGFzc2VzWyJAbW96aWxsYS5vcmcvd2lkZ2V0L3RyYW5zZmVyYWJsZTsxIl0uY3JlYXRlSW5zdGFuY2UoQ29tcG9uZW50cy5pbnRlcmZhY2VzLm5zSVRyYW5zZmVyYWJsZSk7CiAgICAgICAgICAgIGlmICghdHJhbnMpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgdHJhbnMuYWRkRGF0YUZsYXZvcigidGV4dC91bmljb2RlIik7CgogICAgICAgICAgICBjbGlwLmdldERhdGEodHJhbnMsIGNsaXAua0dsb2JhbENsaXBib2FyZCk7CgogICAgICAgICAgICB2YXIgc3RyICAgICAgID0gbmV3IE9iamVjdCgpOwogICAgICAgICAgICB2YXIgc3RyTGVuZ3RoID0gbmV3IE9iamVjdCgpOwogICAgICAgICAgICB2YXIgcGFzdGV0ZXh0ID0gIiI7CgogICAgICAgICAgICB0cmFucy5nZXRUcmFuc2ZlckRhdGEoInRleHQvdW5pY29kZSIsIHN0ciwgc3RyTGVuZ3RoKTsKICAgICAgICAgICAgaWYgKHN0cikgc3RyID0gc3RyLnZhbHVlLlF1ZXJ5SW50ZXJmYWNlKENvbXBvbmVudHMuaW50ZXJmYWNlcy5uc0lTdXBwb3J0c1N0cmluZyk7CiAgICAgICAgICAgIGlmIChzdHIpIHBhc3RldGV4dCA9IHN0ci5kYXRhLnN1YnN0cmluZygwLCBzdHJMZW5ndGgudmFsdWUgLyAyKTsKICAgICAgICAgICAgcmV0dXJuIHBhc3RldGV4dDsKICAgICAgICB9CiAgICB9Cn0oKTsKCi8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKioKICogVmVyc2lvbjogTVBMIDEuMQogKgogKiBUaGUgY29udGVudHMgb2YgdGhpcyBmaWxlIGFyZSBzdWJqZWN0IHRvIHRoZSBNb3ppbGxhIFB1YmxpYyBMaWNlbnNlCiAqIFZlcnNpb24gMS4xICh0aGUgIkxpY2Vuc2UiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4KICogY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICogaHR0cDovL3d3dy5tb3ppbGxhLm9yZy9NUEwvCiAqCiAqIFNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIKICogYmFzaXMsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyByaWdodHMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBUaGUgT3JpZ2luYWwgQ29kZSBpcyBCZXNwaW4uCiAqCiAqIFRoZSBJbml0aWFsIERldmVsb3BlciBvZiB0aGUgT3JpZ2luYWwgQ29kZSBpcyBNb3ppbGxhLgogKiBQb3J0aW9ucyBjcmVhdGVkIGJ5IHRoZSBJbml0aWFsIERldmVsb3BlciBhcmUgQ29weXJpZ2h0IChDKSAyMDA5CiAqIHRoZSBJbml0aWFsIERldmVsb3Blci4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogQ29udHJpYnV0b3Iocyk6CiAqICAgQmVzcGluIFRlYW0gKGJlc3BpbkBtb3ppbGxhLmNvbSkKICoKICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi8KCmlmICh0eXBlb2YgQmVzcGluID09ICJ1bmRlZmluZWQiKSBCZXNwaW4gPSB7fTsKaWYgKCFCZXNwaW4uQ2FudmFzKSBCZXNwaW4uQ2FudmFzID0ge307CgovLyA9IENhbnZhcyBTaGltID0KLy8KLy8gTWFrZSBjYW52YXMgd29yayB0aGUgc2FtZSBvbiB0aGUgZGlmZmVyZW50IGJyb3dzZXJzIGFuZCB0aGVpciBxdWlya3MKCi8vICoqIHt7eyBCZXNwaW4uQ2FudmFzLkZpeCB9fX0gKioKLy8KLy8gVGFrZSB0aGUgY29udGV4dCBhbmQgY2xlYW4gaXQgdXAKQmVzcGluLkNhbnZhcy5GaXggPSBmdW5jdGlvbihjdHgpIHsKICAgIC8vICogdXBncmFkZSBGaXJlZm94IDMuMC54IHRleHQgcmVuZGVyaW5nIHRvIEhUTUwgNSBzdGFuZGFyZAogICAgaWYgKCFjdHguZmlsbFRleHQgJiYgY3R4Lm1vekRyYXdUZXh0KSB7CiAgICAgICAgY3R4LmZpbGxUZXh0ID0gZnVuY3Rpb24odGV4dFRvRHJhdywgeCwgeSwgbWF4V2lkdGgpIHsKICAgICAgICAgICAgY3R4LnRyYW5zbGF0ZSh4LCB5KTsKICAgICAgICAgICAgY3R4Lm1velRleHRTdHlsZSA9IGN0eC5mb250OwogICAgICAgICAgICBjdHgubW96RHJhd1RleHQodGV4dFRvRHJhdyk7CiAgICAgICAgICAgIGN0eC50cmFuc2xhdGUoLXgsIC15KTsKICAgICAgICB9CiAgICB9CgogICAgLy8gKiBTZXR1cCBtZWFzdXJlVGV4dAogICAgaWYgKCFjdHgubWVhc3VyZVRleHQgJiYgY3R4Lm1vek1lYXN1cmVUZXh0KSB7CiAgICAgICAgY3R4Lm1lYXN1cmVUZXh0ID0gZnVuY3Rpb24odGV4dCkgewogICAgICAgICAgICBpZiAoY3R4LmZvbnQpIGN0eC5tb3pUZXh0U3R5bGUgPSBjdHguZm9udDsKICAgICAgICAgICAgdmFyIHdpZHRoID0gY3R4Lm1vek1lYXN1cmVUZXh0KHRleHQpOwogICAgICAgICAgICByZXR1cm4geyB3aWR0aDogd2lkdGggfTsKICAgICAgICB9CiAgICB9CgogICAgLy8gKiBTZXR1cCBodG1sNU1lYXN1cmVUZXh0CiAgICBpZiAoY3R4Lm1lYXN1cmVUZXh0ICYmICFjdHguaHRtbDVNZWFzdXJlVGV4dCkgewogICAgICAgIGN0eC5odG1sNU1lYXN1cmVUZXh0ID0gY3R4Lm1lYXN1cmVUZXh0OwogICAgICAgIGN0eC5tZWFzdXJlVGV4dCA9IGZ1bmN0aW9uKHRleHQpIHsKICAgICAgICAgICAgdmFyIHRleHRNZXRyaWNzID0gY3R4Lmh0bWw1TWVhc3VyZVRleHQodGV4dCk7CgogICAgICAgICAgICAvLyBmYWtlIGl0ICd0aWwgeW91IG1ha2UgaXQKICAgICAgICAgICAgdGV4dE1ldHJpY3MuYXNjZW50ID0gY3R4Lmh0bWw1TWVhc3VyZVRleHQoIm0iKS53aWR0aDsKCiAgICAgICAgICAgIHJldHVybiB0ZXh0TWV0cmljczsKICAgICAgICB9CiAgICB9CgogICAgLy8gKiBmb3Igb3RoZXIgYnJvd3NlcnMsIG5vLW9wIGF3YXkKICAgIGlmICghY3R4LmZpbGxUZXh0KSB7CiAgICAgICAgY3R4LmZpbGxUZXh0ID0gZnVuY3Rpb24oKSB7fQogICAgfQoKICAgIGlmICghY3R4Lm1lYXN1cmVUZXh0KSB7CiAgICAgICAgY3R4Lm1lYXN1cmVUZXh0ID0gZnVuY3Rpb24oKSB7IHJldHVybiAxMDsgfQogICAgfQogICAgCiAgICByZXR1cm4gY3R4Owp9Oy8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKioKICogVmVyc2lvbjogTVBMIDEuMQogKgogKiBUaGUgY29udGVudHMgb2YgdGhpcyBmaWxlIGFyZSBzdWJqZWN0IHRvIHRoZSBNb3ppbGxhIFB1YmxpYyBMaWNlbnNlCiAqIFZlcnNpb24gMS4xICh0aGUgIkxpY2Vuc2UiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4KICogY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICogaHR0cDovL3d3dy5tb3ppbGxhLm9yZy9NUEwvCiAqCiAqIFNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIKICogYmFzaXMsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyByaWdodHMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBUaGUgT3JpZ2luYWwgQ29kZSBpcyBCZXNwaW4uCiAqCiAqIFRoZSBJbml0aWFsIERldmVsb3BlciBvZiB0aGUgT3JpZ2luYWwgQ29kZSBpcyBNb3ppbGxhLgogKiBQb3J0aW9ucyBjcmVhdGVkIGJ5IHRoZSBJbml0aWFsIERldmVsb3BlciBhcmUgQ29weXJpZ2h0IChDKSAyMDA5CiAqIHRoZSBJbml0aWFsIERldmVsb3Blci4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogQ29udHJpYnV0b3Iocyk6CiAqICAgQmVzcGluIFRlYW0gKGJlc3BpbkBtb3ppbGxhLmNvbSkKICoKICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi8KCmlmICh0eXBlb2YgQmVzcGluID09ICJ1bmRlZmluZWQiKSBCZXNwaW4gPSB7fTsKCi8vID0gS2V5IEhlbHBlcnMgPQovLwovLyBIZWxwZnVsIGNvZGUgdG8gZGVhbCB3aXRoIGtleSBoYW5kbGluZyBhbmQgcHJvY2Vzc2luZwovLyBDb25zaXN0cyBvZiB0d28gY29yZSBwaWVjZXM6Ci8vCi8vICoge3t7QmVzcGluLktleX19fSBpcyBhIG1hcCBvZiBrZXlzIHRvIGtleSBjb2RlcwovLyAqIHt7e0Jlc3Bpbi5LZXkuZmlsbEFyZ3VtZW50c319fSBjb252ZXJ0cyBhIHN0cmluZyAiQ1RSTCBBIiB0byBpdHMga2V5IGFuZCBtb2RpZmllcgovLwovLyBUT0RPOiBIYXZpbmcgdGhlIGtleXMgaW4gdGhlIHNhbWUgc2NvcGUgYXMgdGhlIG1ldGhvZCBpcyByZWFsbHkgYmFkIDopCgovLyAqKiB7e3sgQmVzcGluLktleSB9fX0gKioKLy8KLy8gQWxwaGEga2V5cywgYW5kIHNwZWNpYWwga2V5cyAoRU5URVIsIEJBQ0tTUEFDRSkgaGF2ZSBrZXkgY29kZXMgdGhhdCBvdXIgY29kZSBuZWVkcyB0byBjaGVjay4KLy8gVGhpcyBnaXZlcyB5b3UgYSB3YXkgdG8gc2F5IEtleS5FTlRFUiB3aGVuIG1hdGNoaW5nIGEga2V5IGNvZGUgaW5zdGVhZCBvZiAiMTMiCgpCZXNwaW4uS2V5ID0gewoKLy8gLS0gTnVtYmVycwogIFpFUk86IDQ4LAogIE9ORTogNDksCiAgVFdPOiA1MCwKICBUSFJFRTogNTEsCiAgRk9VUjogNTIsCiAgRklWRTogNTMsCiAgU0lYOiA1NCwKICBTRVZFTjogNTUsCiAgRUlHSFQ6IDU2LAogIE5JTkU6IDU3LAogIAovLyAtLSBBbHBoYWJldAogIEE6IDY1LAogIEI6IDY2LAogIEM6IDY3LAogIEQ6IDY4LAogIEU6IDY5LAogIEY6IDcwLAogIEc6IDcxLAogIEg6IDcyLAogIEk6IDczLAogIEo6IDc0LAogIEs6IDc1LAogIEw6IDc2LAogIE06IDc3LAogIE46IDc4LAogIE86IDc5LAogIFA6IDgwLAogIFE6IDgxLAogIFI6IDgyLAogIFM6IDgzLAogIFQ6IDg0LAogIFU6IDg1LAogIFY6IDg2LAogIFc6IDg3LAogIFg6IDg4LAogIFk6IDg5LAogIFo6IDkwLAoKLy8gLS0gU3BlY2lhbCBLZXlzCiAgQkFDS1NQQUNFOiA4LAogIFRBQjogOSwKICBFTlRFUjogMTMsCiAgRVNDQVBFOiAyNywKICBFTkQ6IDM1LAogIEhPTUU6IDM2LAogIEFSUk9XX0xFRlQ6IDM3LAogIEFSUk9XX1VQOiAzOCwKICBBUlJPV19SSUdIVDogMzksCiAgQVJST1dfRE9XTjogNDAsCiAgREVMRVRFOiA0NiwKICBQQUdFX1VQOiAzMywKICBQQUdFX0RPV046IDM0LAogIFBMVVM6IDYxLAogIE1JTlVTOiAxMDksCiAgVElMREU6IDE5Mgp9OwoKLy8gKioge3t7IEJlc3Bpbi5LZXkuZmlsbEFyZ3VtZW50cyB9fX0gKioKLy8KLy8gRmlsbCBvdXQgdGhlIGFyZ3VtZW50cyBmb3IgYWN0aW9uLCBrZXksIG1vZGlmaWVycwovLwovLyB7e3tzdHJpbmd9fX0gY2FuIGJlIHNvbWV0aGluZyBsaWtlICJDVFJMIFMiCi8vIHt7e2FyZ3N9fX0gaXMgdGhlIGFyZ3MgdGhhdCB5b3Ugd2FudCB0byBtb2RpZnkuIFRoaXMgaXMgY29tbW9uIGFzIHlvdSBtYXkgYWxyZWFkeSBoYXZlIGFyZ3MuYWN0aW9uLgoKQmVzcGluLktleS5maWxsQXJndW1lbnRzID0gZnVuY3Rpb24oc3RyaW5nLCBhcmdzKSB7CiAgICB2YXIga2V5cyA9IHN0cmluZy5zcGxpdCgnICcpOwogICAgYXJncyA9IGFyZ3MgfHwge307CiAgICAKICAgIHZhciBtb2RpZmllcnMgPSBbXTsKICAgIGtleXMuZWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgIGlmIChrZXkubGVuZ3RoID4gMSkgeyAvLyBtb3JlIHRoYW4ganVzdCBhbiBhbHBoYS9udW1lcmljCiAgICAgICAgICAgbW9kaWZpZXJzLnB1c2goa2V5KTsKICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgYXJncy5rZXkgPSBrZXk7CiAgICAgICB9CiAgICB9KTsKCiAgICBpZiAobW9kaWZpZXJzLmxlbmd0aCA9PSAwKSB7IC8vIG5vbmUgaWYgdGhhdCBpcyB0cnVlCiAgICAgICAgYXJncy5tb2RpZmllcnMgPSAibm9uZSI7CiAgICB9IGVsc2UgewogICAgICAgIGFyZ3MubW9kaWZpZXJzID0gbW9kaWZpZXJzLmpvaW4oJywnKTsKICAgIH0KICAgIAogICAgcmV0dXJuIGFyZ3M7Cn0KCi8vICoqIHt7eyBCZXNwaW4uS2V5LnBhc3NUaHJvdWdoVG9Ccm93c2VyIH19fSAqKgovLwovLyBHaXZlbiB0aGUgZXZlbnQsIHJldHVybiB0cnVlIGlmIHlvdSB3YW50IHRvIGFsbG93IHRoZSBldmVudCB0byBwYXNzIHRocm91Z2ggdG8gdGhlIGJyb3dzZXIuCi8vIEZvciBleGFtcGxlLCBhbGxvdyBBcHBsZS1MIHRvIGdvIHRvIGxvY2F0aW9uLCBBcHBsZS1LIGZvciBzZWFyY2guIEFwcGxlLSMgZm9yIGEgdGFiLgovLwovLyB7e3tlfX19IEV2ZW50IHRoYXQgY2FtZSBpbnRvIGFuIHt7e29ua2V5ZG93bn19fSBoYW5kbGVyCgpCZXNwaW4uS2V5LnBhc3NUaHJvdWdoVG9Ccm93c2VyID0gZnVuY3Rpb24oZSkgewogICAgdmFyIEtleSA9IEJlc3Bpbi5LZXk7CiAgICAKICAgIGlmIChlLm1ldGFLZXkgfHwgZS5hbHRLZXkpIHsgLy8gQXBwbGUgb3IgQWx0IGtleQogICAgICAgIGlmIChbS2V5LkssIEtleS5MLCBLZXkuTiwgS2V5Lk8sIEtleS5ULCBLZXkuVywgS2V5LlBMVVMsIEtleS5NSU5VUywgS2V5LlRJTERFLAogICAgICAgICAgICAgS2V5LlpFUk8sIEtleS5PTkUsIEtleS5UV08sIEtleS5USFJFRSwgS2V5LkZPVVIsIEtleS5GSVZFLCBLZXkuU0lYLCBLZXkuU0VWRU4sIEtleS5FSUdIVCwgS2V5Lk5JTkVdLmluY2x1ZGUoZS5rZXlDb2RlKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwp9LyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKgogKiBWZXJzaW9uOiBNUEwgMS4xCiAqCiAqIFRoZSBjb250ZW50cyBvZiB0aGlzIGZpbGUgYXJlIHN1YmplY3QgdG8gdGhlIE1vemlsbGEgUHVibGljIExpY2Vuc2UKICogVmVyc2lvbiAxLjEgKHRoZSAiTGljZW5zZSIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbgogKiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKiBodHRwOi8vd3d3Lm1vemlsbGEub3JnL01QTC8KICoKICogU29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIgogKiBiYXNpcywgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHJpZ2h0cyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIFRoZSBPcmlnaW5hbCBDb2RlIGlzIEJlc3Bpbi4KICoKICogVGhlIEluaXRpYWwgRGV2ZWxvcGVyIG9mIHRoZSBPcmlnaW5hbCBDb2RlIGlzIE1vemlsbGEuCiAqIFBvcnRpb25zIGNyZWF0ZWQgYnkgdGhlIEluaXRpYWwgRGV2ZWxvcGVyIGFyZSBDb3B5cmlnaHQgKEMpIDIwMDkKICogdGhlIEluaXRpYWwgRGV2ZWxvcGVyLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBDb250cmlidXRvcihzKToKICogICBCZXNwaW4gVGVhbSAoYmVzcGluQG1vemlsbGEuY29tKQogKgogKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqLwoKLy8gPSBCZXNwaW4uVG9rZW5PYmplY3QgPQovLwovLyBHaXZlbiBhIHN0cmluZywgbWFrZSBhIHRva2VuIG9iamVjdCB0aGF0IGhvbGRzIHBvc2l0aW9ucyBhbmQgaGFzIG5hbWUgYWNjZXNzCi8vCi8vIEV4YW1wbGVzLAovLwovLyAqIGFyZ3MgPSBuZXcgQmVzcGluLlRva2VuT2JqZWN0KHVzZXJTdHJpbmcsIHsgcGFyYW1zOiBjb21tYW5kLnRha2VzLm9yZGVyLmpvaW4oJyAnKSB9KTsKLy8gKiB2YXIgdGVzdCA9IG5ldyBCZXNwaW4uVG9rZW5PYmplY3QoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImlucHV0IikudmFsdWUsIHsgCi8vCSAgICAgc3BsaXRCeTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlZ2V4IikudmFsdWUsCi8vCSAgICAgcGFyYW1zOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicGFyYW1zIikudmFsdWUKLy8gfSk7CgppZiAodHlwZW9mIEJlc3BpbiA9PSAidW5kZWZpbmVkIikgQmVzcGluID0ge307CgpCZXNwaW4uVG9rZW5PYmplY3QgPSBmdW5jdGlvbihpbnB1dCwgb3B0aW9ucykgewogICAgdGhpcy5faW5wdXQgPSBpbnB1dDsKICAgIHRoaXMuX29wdGlvbnMgPSBvcHRpb25zOwogICAgdGhpcy5fc3BsaXR0ZXJSZWdleCA9IG5ldyBSZWdFeHAodGhpcy5fb3B0aW9ucy5zcGxpdEJ5IHx8ICdcXHMrJyk7CiAgICB0aGlzLl9waWVjZXMgPSBpbnB1dC5zcGxpdCh0aGlzLl9zcGxpdHRlclJlZ2V4KTsKCiAgICBpZiAodGhpcy5fb3B0aW9ucy5wYXJhbXMpIHsgLy8gLS0gY3JlYXRlIGEgaGFzaCBmb3IgbmFtZSBiYXNlZCBhY2Nlc3MKICAgICAgICB0aGlzLl9uYW1ldG9pbmRleCA9IHt9OwogICAgICAgIHZhciBuYW1lZHBhcmFtcyA9IHRoaXMuX29wdGlvbnMucGFyYW1zLnNwbGl0KCcgJyk7CiAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCBuYW1lZHBhcmFtcy5sZW5ndGg7IHgrKykgewogICAgICAgICAgICB0aGlzLl9uYW1ldG9pbmRleFtuYW1lZHBhcmFtc1t4XV0gPSB4OwoKICAgICAgICAgICAgaWYgKCF0aGlzLl9vcHRpb25zWydub3Nob3J0Y3V0dmFsdWVzJ10pIHsgLy8gc2lkZSBzdGVwIGlmIHlvdSByZWFsbHkgZG9uJ3Qgd2FudCB0aGlzCiAgICAgICAgICAgICAgICB0aGlzW25hbWVkcGFyYW1zW3hdXSA9IHRoaXMuX3BpZWNlc1t4XTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9Cn0KCkJlc3Bpbi5Ub2tlbk9iamVjdC5wcm90b3R5cGUucGFyYW0gPSBmdW5jdGlvbihpbmRleCkgewogICAgcmV0dXJuICh0eXBlb2YgaW5kZXggPT0gIm51bWJlciIpID8gdGhpcy5fcGllY2VzW2luZGV4XSA6IHRoaXMuX3BpZWNlc1t0aGlzLl9uYW1ldG9pbmRleFtpbmRleF1dOwp9CgpCZXNwaW4uVG9rZW5PYmplY3QucHJvdG90eXBlLmxlbmd0aCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3BpZWNlcy5sZW5ndGg7Cn0KLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKgogKiBWZXJzaW9uOiBNUEwgMS4xCiAqCiAqIFRoZSBjb250ZW50cyBvZiB0aGlzIGZpbGUgYXJlIHN1YmplY3QgdG8gdGhlIE1vemlsbGEgUHVibGljIExpY2Vuc2UKICogVmVyc2lvbiAxLjEgKHRoZSAiTGljZW5zZSIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbgogKiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKiBodHRwOi8vd3d3Lm1vemlsbGEub3JnL01QTC8KICoKICogU29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIgogKiBiYXNpcywgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHJpZ2h0cyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIFRoZSBPcmlnaW5hbCBDb2RlIGlzIEJlc3Bpbi4KICoKICogVGhlIEluaXRpYWwgRGV2ZWxvcGVyIG9mIHRoZSBPcmlnaW5hbCBDb2RlIGlzIE1vemlsbGEuCiAqIFBvcnRpb25zIGNyZWF0ZWQgYnkgdGhlIEluaXRpYWwgRGV2ZWxvcGVyIGFyZSBDb3B5cmlnaHQgKEMpIDIwMDkKICogdGhlIEluaXRpYWwgRGV2ZWxvcGVyLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBDb250cmlidXRvcihzKToKICogICBCZXNwaW4gVGVhbSAoYmVzcGluQG1vemlsbGEuY29tKQogKgogKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqLwoKaWYgKHR5cGVvZiBCZXNwaW4gPT0gInVuZGVmaW5lZCIpIEJlc3BpbiA9IHt9OwppZiAoIUJlc3Bpbi5QYXRoKSBCZXNwaW4uUGF0aCA9IHt9OwoKLy8gPSBCZXNwaW4uUGF0aCA9Ci8vCi8vIERlYWwgd2l0aCBwYXRocyB0aGF0IGFyZSBzZW50IGludG8gQmVzcGluCgpCZXNwaW4uUGF0aCA9IHsKCiAgICAvLyAqKiB7e3sgQmVzcGluLlBhdGguY29tYmluZSB9fX0gKioKICAgIC8vCiAgICAvLyBUYWtlIHRoZSBnaXZlbiBhcmd1bWVudHMgYW5kIGNvbWJpbmUgdGhlbSB3aXRoIG9uZSBwYXRoIHNlcGVyYXRvcgogICAgLy8KICAgIC8vICogY29tYmluZSgiZm9vIiwgImJhciIpIC0+IGZvby9iYXIKICAgIC8vICogY29tYmluZSgiIGZvby8iLCAiL2JhciAgIikgLT4gZm9vL2JhcgogICAgY29tYmluZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOyAvLyBjbG9uZSB0byBhIHRydWUgYXJyYXkKCiAgICAgICAgdmFyIHBhdGggPSBhcmdzLmpvaW4oJy8nKTsKICAgICAgICBwYXRoID0gcGF0aC5yZXBsYWNlKC9cL1wvKy9nLCAnLycpOwogICAgICAgIHBhdGggPSBwYXRoLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7CiAgICAgICAgcmV0dXJuIHBhdGg7CiAgICB9LAoKICAgIC8vICoqIHt7eyBCZXNwaW4uUGF0aC5kaXJlY3RvcnkgfX19ICoqCiAgICAvLwogICAgLy8gR2l2ZW4gYSB7e3twYXRofX19IHJldHVybiB0aGUgZGlyZWN0b3J5CiAgICAvLwogICAgLy8gKiBkaXJlY3RvcnkoIi9wYXRoL3RvL2RpcmVjdG9yeS9maWxlLnR4dCIpIC0+IC9wYXRoL3RvL2RpcmVjdG9yeS8KICAgIC8vICogZGlyZWN0b3J5KCIvcGF0aC90by9kaXJlY3RvcnkvIikgLT4gL3BhdGgvdG8vZGlyZWN0b3J5LwogICAgLy8gKiBkaXJlY3RvcnkoImZvby50eHQiKSAtPiAiIgogICAgZGlyZWN0b3J5OiBmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgdmFyIGRpcnMgPSBwYXRoLnNwbGl0KCcvJyk7CiAgICAgICAgaWYgKGRpcnMubGVuZ3RoID09IDEpIHsgLy8gbm8gZGlyZWN0b3J5IHNvIHJldHVybiBibGFuawogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfSBlbHNlIGlmICgoZGlycy5sZW5ndGggPT0gMikgJiYgZGlycy5sYXN0KCkgPT0gIiIpIHsgLy8gYSBjb21wbGV0ZSBkaXJlY3Rvcnkgc28gcmV0dXJuIGl0CiAgICAgICAgICAgIHJldHVybiBwYXRoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBkaXJzLnNsaWNlKDAsIGRpcnMubGVuZ3RoIC0gMSkuam9pbignLycpOwogICAgICAgIH0KICAgIH0sCgogICAgLy8gKioge3t7IEJlc3Bpbi5QYXRoLmVzY2FwZSB9fX0gKioKICAgIC8vCiAgICAvLyBUaGlzIGZ1bmN0aW9uIGRvdWJsZXMgZG93biBhbmQgY2FsbHMge3t7Y29tYmluZX19fSBhbmQgdGhlbiBlc2NhcGVzIHRoZSBvdXRwdXQKICAgIGVzY2FwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGVzY2FwZSh0aGlzLmNvbWJpbmUuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9Cn07Ci8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKioKICogVmVyc2lvbjogTVBMIDEuMQogKgogKiBUaGUgY29udGVudHMgb2YgdGhpcyBmaWxlIGFyZSBzdWJqZWN0IHRvIHRoZSBNb3ppbGxhIFB1YmxpYyBMaWNlbnNlCiAqIFZlcnNpb24gMS4xICh0aGUgIkxpY2Vuc2UiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4KICogY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICogaHR0cDovL3d3dy5tb3ppbGxhLm9yZy9NUEwvCiAqCiAqIFNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIKICogYmFzaXMsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyByaWdodHMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBUaGUgT3JpZ2luYWwgQ29kZSBpcyBCZXNwaW4uCiAqCiAqIFRoZSBJbml0aWFsIERldmVsb3BlciBvZiB0aGUgT3JpZ2luYWwgQ29kZSBpcyBNb3ppbGxhLgogKiBQb3J0aW9ucyBjcmVhdGVkIGJ5IHRoZSBJbml0aWFsIERldmVsb3BlciBhcmUgQ29weXJpZ2h0IChDKSAyMDA5CiAqIHRoZSBJbml0aWFsIERldmVsb3Blci4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogQ29udHJpYnV0b3Iocyk6CiAqICAgQmVzcGluIFRlYW0gKGJlc3BpbkBtb3ppbGxhLmNvbSkKICoKICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi8KCmlmICh0eXBlb2YgQmVzcGluID09ICJ1bmRlZmluZWQiKSBCZXNwaW4gPSB7fTsKCi8vID0gVVJMQmFyID0KLy8KLy8gVVJMQmFyIHdhdGNoZXMgdGhlIGJyb3dzZXIgVVJMIG5hdmlnYXRpb24gYmFyIGZvciBjaGFuZ2VzLiAKLy8gSWYgaXQgc2VlcyBhIGNoYW5nZSBpdCB0cmllcyB0byBvcGVuIHRoZSBmaWxlCi8vIFRoZSBjb21tb24gY2FzZSBpcyB1c2luZyB0aGUgYmFjay9mb3J3YXJkIGJ1dHRvbnMKCkJlc3Bpbi5VUkxCYXIgPSB7CiAgICBsYXN0OiBkb2N1bWVudC5sb2NhdGlvbi5oYXNoLAogICAgY2hlY2s6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBoYXNoID0gZG9jdW1lbnQubG9jYXRpb24uaGFzaDsKICAgICAgICBpZiAodGhpcy5sYXN0ICE9IGhhc2gpIHsKICAgICAgICAgICAgdmFyIHVybGNoYW5nZSA9IG5ldyBCZXNwaW4uU2V0dGluZ3MuVVJMKGhhc2gpOwogICAgICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOm9wZW5maWxlIiwgeyBmaWxlbmFtZTogdXJsY2hhbmdlLmdldCgncGF0aCcpIH0pOwogICAgICAgICAgICB0aGlzLmxhc3QgPSBoYXNoOwogICAgICAgIH0KICAgIH0KfTsKCnNldEludGVydmFsKGZ1bmN0aW9uKCkgewogICAgQmVzcGluLlVSTEJhci5jaGVjay5hcHBseShCZXNwaW4uVVJMQmFyKTsKfSwgMjAwKTsKLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKgogKiBWZXJzaW9uOiBNUEwgMS4xCiAqCiAqIFRoZSBjb250ZW50cyBvZiB0aGlzIGZpbGUgYXJlIHN1YmplY3QgdG8gdGhlIE1vemlsbGEgUHVibGljIExpY2Vuc2UKICogVmVyc2lvbiAxLjEgKHRoZSAiTGljZW5zZSIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbgogKiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKiBodHRwOi8vd3d3Lm1vemlsbGEub3JnL01QTC8KICoKICogU29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIgogKiBiYXNpcywgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHJpZ2h0cyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIFRoZSBPcmlnaW5hbCBDb2RlIGlzIEJlc3Bpbi4KICoKICogVGhlIEluaXRpYWwgRGV2ZWxvcGVyIG9mIHRoZSBPcmlnaW5hbCBDb2RlIGlzIE1vemlsbGEuCiAqIFBvcnRpb25zIGNyZWF0ZWQgYnkgdGhlIEluaXRpYWwgRGV2ZWxvcGVyIGFyZSBDb3B5cmlnaHQgKEMpIDIwMDkKICogdGhlIEluaXRpYWwgRGV2ZWxvcGVyLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBDb250cmlidXRvcihzKToKICogICBCZXNwaW4gVGVhbSAoYmVzcGluQG1vemlsbGEuY29tKQogKgogKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqLwoKaWYgKHR5cGVvZiBCZXNwaW4gPT0gInVuZGVmaW5lZCIpIEJlc3BpbiA9IHt9OwoKLy8gPSBCZXNwaW4uTmF2aWdhdGUgPQovLwovLyBTaW1wbGUgd3JhcHBlciB0byBmb3JjZSBuYXZpZ2F0aW9uIHRvIGEgcHJvamVjdCBVUkwgd2l0aG91dCBhbGwgdXNpbmcgbG9jYXRpb24uaHJlZgoKLy8gKioge3t7IEJlc3Bpbi5OYXZpZ2F0ZSB9fX0gKioKLy8KLy8gbmV3IHVwIGFuIG9iamVjdCB0aGF0IHdpbGwgcmV0dXJuIHB1YmxpYyBtZXRob2RzIGFuZCBoaWRlIHByaXZhdGUgb25lcwoKQmVzcGluLk5hdmlnYXRlID0gbmV3IGZ1bmN0aW9uKCkgewoKICAgIC8vICoqIHt7eyBZdXAsIHlvdSBjYW4gYmUgcHJpdmF0ZSB9fX0gKioKICAgIC8vCiAgICAvLyBHZW5lcmljIGxvY2F0aW9uIGNoYW5nZXIKCiAgICB2YXIgZ28gPSBmdW5jdGlvbih1cmwpIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gdXJsOwogICAgfQoKICAgIAogICAgLy8gKioge3t7IFB1YmxpYyB9fX0gKioKICAgIC8vCiAgICAvLyBTaW1wbGUgbWV0aG9kcyB0byBjb25zdHJ1Y3QgVVJMcyB3aXRoaW4gQmVzcGluIGFuZCBnbyB0byB0aGVtCgogICAgcmV0dXJuIHsKICAgICAgICBkYXNoYm9hcmQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBnbygiZGFzaGJvYXJkLmh0bWwiKTsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIGhvbWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBnbygiaW5kZXguaHRtbCIpOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgcXVpY2tFZGl0OiBmdW5jdGlvbigpIHsKICAgIAkJZ28oImVkaXRvci5odG1sI25ldz10cnVlIik7CiAgICAJfSwKICAgIAkKICAgICAgICBlZGl0b3I6IGZ1bmN0aW9uKHByb2plY3QsIHBhdGgpIHsKICAgICAgICAgICAgdmFyIHVybCA9ICJlZGl0b3IuaHRtbCMiOwogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHByb2plY3QpIGFyZ3MucHVzaCgicHJvamVjdD0iICsgcHJvamVjdCk7CiAgICAgICAgICAgIGlmIChwYXRoKSBhcmdzLnB1c2goInBhdGg9IiArIHBhdGgpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID4gMCkgdXJsICs9IGFyZ3Muam9pbigiJiIpOwogICAgICAgICAgICAKICAgICAgICAgICAgZ28odXJsKTsKICAgICAgICB9CiAgICB9OwogICAgCn0oKTsvKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqCiAqIFZlcnNpb246IE1QTCAxLjEKICoKICogVGhlIGNvbnRlbnRzIG9mIHRoaXMgZmlsZSBhcmUgc3ViamVjdCB0byB0aGUgTW96aWxsYSBQdWJsaWMgTGljZW5zZQogKiBWZXJzaW9uIDEuMSAodGhlICJMaWNlbnNlIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluCiAqIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqIGh0dHA6Ly93d3cubW96aWxsYS5vcmcvTVBMLwogKgogKiBTb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiCiAqIGJhc2lzLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcmlnaHRzIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICoKICogVGhlIE9yaWdpbmFsIENvZGUgaXMgQmVzcGluLgogKgogKiBUaGUgSW5pdGlhbCBEZXZlbG9wZXIgb2YgdGhlIE9yaWdpbmFsIENvZGUgaXMgTW96aWxsYS4KICogUG9ydGlvbnMgY3JlYXRlZCBieSB0aGUgSW5pdGlhbCBEZXZlbG9wZXIgYXJlIENvcHlyaWdodCAoQykgMjAwOQogKiB0aGUgSW5pdGlhbCBEZXZlbG9wZXIuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIENvbnRyaWJ1dG9yKHMpOgogKiAgIEJlc3BpbiBUZWFtIChiZXNwaW5AbW96aWxsYS5jb20pCiAqCiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovCgppZiAodHlwZW9mIEJlc3BpbiA9PSAidW5kZWZpbmVkIikgQmVzcGluID0ge307CmlmICghQmVzcGluLkVkaXRvcikgQmVzcGluLkVkaXRvciA9IHt9OwoKLy8gPSBBY3Rpb25zID0KLy8KLy8gVGhlIGVkaXRvciBjYW4gcnVuIHZhcmlvdXMgYWN0aW9ucy4gVGhleSBhcmUgZGVmaW5lZCBoZXJlIGFuZCB5b3UgY2FuIGFkZCBvciBjaGFuZ2UgdGhlbSBkeW5hbWljYWxseS4gQ29vbCBodWg/Ci8vCi8vIEFuIGFjdGlvbiBtdXRhdGVzIHRoZSBtb2RlbCBvciBlZGl0b3Igc3RhdGUgaW4gc29tZSB3YXkuIFRoZSBvbmx5IHdheSB0aGUgZWRpdG9yIHN0YXRlIG9yIG1vZGVsIHNob3VsZCBiZSBtYW5pcHVsYXRlZCBpcyB2aWEKLy8gdGhlIGV4ZWN1dGlvbiBvZiBhY3Rpb25zLgovLwovLyBBY3Rpb25zIGludGVncmF0ZSB3aXRoIHRoZSB1bmRvIG1hbmFnZXIgYnkgaW5jbHVkaW5nIGluc3RydWN0aW9ucyBmb3IgaG93IHRvIHVuZG8gKGFuZCByZWRvKSB0aGUgYWN0aW9uLiBUaGVzZSBpbnN0cnVjdGlvbnMKLy8gdGFrZSB0aGUgZm9ybSBvZiBhIGhhc2ggY29udGFpbmluZyB0aGUgbmVjZXNzYXJ5IHN0YXRlIGZvciB1bmRvL3JlZG8uIEEga2V5ICJhY3Rpb24iIGNvcnJlc3BvbmRzIHRvIHRoZSBmdW5jdGlvbiBuYW1lIG9mIHRoZQovLyBhY3Rpb24gdGhhdCBzaG91bGQgYmUgZXhlY3V0ZWQgdG8gdW5kbyBvciByZWRvIHRoZSBvcGVyYXRpb24gYW5kIHRoZSByZW1haW5pbmcga2V5cyBjb3JyZXNwb25kIHRvIHN0YXRlIG5lY2Vzc2FyeSB0byBwZXJmb3JtCi8vIHRoZSBhY3Rpb24uIFNlZSBiZWxvdyBmb3IgdmFyaW91cyBleGFtcGxlcy4KCkJlc3Bpbi5FZGl0b3IuQWN0aW9ucyA9IENsYXNzLmNyZWF0ZSh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihlZGl0b3IpIHsKICAgICAgICB0aGlzLmVkaXRvciA9IGVkaXRvcjsKICAgICAgICB0aGlzLmlnbm9yZVJlcGFpbnRzID0gZmFsc2U7CiAgICB9LAoKICAgIC8vIHRoaXMgaXMgYSBnZW5lcmljIGhlbHBlciBtZXRob2QgdXNlZCBieSB2YXJpb3VzIGN1cnNvci1tb3ZpbmcgbWV0aG9kcwogICAgaGFuZGxlQ3Vyc29yU2VsZWN0aW9uOiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgaWYgKGFyZ3MuZXZlbnQuc2hpZnRLZXkpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmVkaXRvci5zZWxlY3Rpb24pIHRoaXMuZWRpdG9yLnNldFNlbGVjdGlvbih7IHN0YXJ0UG9zOiBCZXNwaW4uRWRpdG9yLlV0aWxzLmNvcHlQb3MoYXJncy5wb3MpIH0pOwogICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRTZWxlY3Rpb24oeyBzdGFydFBvczogdGhpcy5lZGl0b3Iuc2VsZWN0aW9uLnN0YXJ0UG9zLCBlbmRQb3M6IEJlc3Bpbi5FZGl0b3IuVXRpbHMuY29weVBvcyh0aGlzLmVkaXRvci5jdXJzb3JQb3NpdGlvbil9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRTZWxlY3Rpb24odW5kZWZpbmVkKTsKICAgICAgICB9CiAgICB9LAoKICAgIG1vdmVDdXJzb3JMZWZ0OiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgLy8gc3RhcnQgb2YgdGhlIGxpbmUgc28gbW92ZSB1cAogICAgICAgIGlmIChfc2V0dGluZ3MuaXNPbihfc2V0dGluZ3MuZ2V0KCdzdHJpY3RsaW5lcycpKSAmJiAodGhpcy5lZGl0b3IuY3Vyc29yUG9zaXRpb24uY29sID09IDApKSB7CiAgICAgICAgICAgIHZhciBvcmlnaW5hbFJvdyA9IGFyZ3MucG9zLnJvdzsKICAgICAgICAgICAgdGhpcy5tb3ZlQ3Vyc29yVXAoYXJncyk7CiAgICAgICAgICAgIGlmIChvcmlnaW5hbFJvdyA+IDApIHRoaXMubW92ZVRvTGluZUVuZChhcmdzKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmVkaXRvci5jdXJzb3JQb3NpdGlvbi5jb2wgPSBNYXRoLm1heCgwLCBhcmdzLnBvcy5jb2wgLSAxKTsKICAgICAgICB0aGlzLmhhbmRsZUN1cnNvclNlbGVjdGlvbihhcmdzKTsKICAgICAgICB0aGlzLnJlcGFpbnQoKTsKICAgIH0sCgogICAgbW92ZUN1cnNvclJpZ2h0OiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgLy8gZW5kIG9mIHRoZSBsaW5lLCBzbyBnbyB0byB0aGUgc3RhcnQgb2YgdGhlIG5leHQgbGluZQogICAgICAgIGlmIChfc2V0dGluZ3MuaXNPbihfc2V0dGluZ3MuZ2V0KCdzdHJpY3RsaW5lcycpKSAmJiAodGhpcy5lZGl0b3IuY3Vyc29yUG9zaXRpb24uY29sID49IHRoaXMuZWRpdG9yLm1vZGVsLmdldFJvd0xlbmd0aChhcmdzLnBvcy5yb3cpKSkgewogICAgICAgICAgICB2YXIgb3JpZ2luYWxSb3cgPSBhcmdzLnBvcy5yb3c7CiAgICAgICAgICAgIHRoaXMubW92ZUN1cnNvckRvd24oYXJncyk7CiAgICAgICAgICAgIGlmIChvcmlnaW5hbFJvdyA8IHRoaXMuZWRpdG9yLm1vZGVsLmdldFJvd0NvdW50KCkgLSAxKSB0aGlzLm1vdmVUb0xpbmVTdGFydChhcmdzKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5lZGl0b3IuY3Vyc29yUG9zaXRpb24uY29sID0gYXJncy5wb3MuY29sICsgMTsKICAgICAgICB0aGlzLmhhbmRsZUN1cnNvclNlbGVjdGlvbihhcmdzKTsKICAgICAgICB0aGlzLnJlcGFpbnQoKTsKICAgIH0sCgogICAgbW92ZUN1cnNvclVwOiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgdGhpcy5lZGl0b3IuY3Vyc29yUG9zaXRpb24ucm93ID0gTWF0aC5tYXgoMCwgYXJncy5wb3Mucm93IC0gMSk7CiAgICAgICAgdGhpcy5oYW5kbGVDdXJzb3JTZWxlY3Rpb24oYXJncyk7CiAgICAgICAgdGhpcy5yZXBhaW50KCk7CgogICAgICAgIGFyZ3MucG9zLnJvdyA9IHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uLnJvdzsKICAgICAgICByZXR1cm4gYXJnczsKICAgIH0sCgogICAgbW92ZUN1cnNvckRvd246IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICB0aGlzLmVkaXRvci5jdXJzb3JQb3NpdGlvbi5yb3cgPSBNYXRoLm1pbih0aGlzLmVkaXRvci5tb2RlbC5nZXRSb3dDb3VudCgpIC0gMSwgYXJncy5wb3Mucm93ICsgMSk7CiAgICAgICAgdGhpcy5oYW5kbGVDdXJzb3JTZWxlY3Rpb24oYXJncyk7CiAgICAgICAgdGhpcy5yZXBhaW50KCk7CgogICAgICAgIGFyZ3MucG9zLnJvdyA9IHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uLnJvdzsKICAgICAgICByZXR1cm4gYXJnczsKICAgIH0sCgogICAgbW92ZVRvTGluZVN0YXJ0OiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgdGhpcy5lZGl0b3IuY3Vyc29yUG9zaXRpb24uY29sID0gMDsKICAgICAgICB0aGlzLmhhbmRsZUN1cnNvclNlbGVjdGlvbihhcmdzKTsKICAgICAgICB0aGlzLnJlcGFpbnQoKTsKCiAgICAgICAgYXJncy5wb3MuY29sID0gdGhpcy5lZGl0b3IuY3Vyc29yUG9zaXRpb24uY29sOwogICAgICAgIHJldHVybiBhcmdzOwogICAgfSwKCiAgICBtb3ZlVG9MaW5lRW5kOiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgdGhpcy5lZGl0b3IuY3Vyc29yUG9zaXRpb24uY29sID0gdGhpcy5lZGl0b3IubW9kZWwuZ2V0Um93TGVuZ3RoKGFyZ3MucG9zLnJvdyk7CiAgICAgICAgdGhpcy5oYW5kbGVDdXJzb3JTZWxlY3Rpb24oYXJncyk7CiAgICAgICAgdGhpcy5yZXBhaW50KCk7CgogICAgICAgIGFyZ3MucG9zLmNvbCA9IHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uLmNvbDsKICAgICAgICByZXR1cm4gYXJnczsKICAgIH0sCgogICAgbW92ZVRvRmlsZVRvcDogZnVuY3Rpb24oYXJncykgewogICAgICAgIHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uLmNvbCA9IHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uLnJvdyA9IDA7CgogICAgICAgIHRoaXMuaGFuZGxlQ3Vyc29yU2VsZWN0aW9uKGFyZ3MpOwogICAgICAgIHRoaXMucmVwYWludCgpOwoKICAgICAgICBhcmdzLnBvcy5jb2wgPSBhcmdzLnBvcy5yb3cgPSAwOwoKICAgICAgICByZXR1cm4gYXJnczsKICAgIH0sCgogICAgbW92ZVRvRmlsZUJvdHRvbTogZnVuY3Rpb24oYXJncykgewogICAgICAgIHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uLnJvdyA9IHRoaXMuZWRpdG9yLm1vZGVsLmdldFJvd0NvdW50KCkgLSAxOwogICAgICAgIHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uLmNvbCA9IHRoaXMuZWRpdG9yLm1vZGVsLmdldFJvd0xlbmd0aChhcmdzLnBvcy5yb3cpOwoKICAgICAgICB0aGlzLmhhbmRsZUN1cnNvclNlbGVjdGlvbihhcmdzKTsKICAgICAgICB0aGlzLnJlcGFpbnQoKTsKCiAgICAgICAgYXJncy5wb3Mucm93ID0gdGhpcy5lZGl0b3IuY3Vyc29yUG9zaXRpb24ucm93OwogICAgICAgIGFyZ3MucG9zLmNvbCA9IHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uLmNvbDsKICAgICAgICByZXR1cm4gYXJnczsKICAgIH0sCgogICAgbW92ZVBhZ2VVcDogZnVuY3Rpb24oYXJncykgewogICAgICAgIHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uLnJvdyA9IE1hdGgubWF4KHRoaXMuZWRpdG9yLnVpLmZpcnN0VmlzaWJsZVJvdyAtIHRoaXMuZWRpdG9yLnVpLnZpc2libGVSb3dzLCAwKTsKCiAgICAgICAgdGhpcy5oYW5kbGVDdXJzb3JTZWxlY3Rpb24oYXJncyk7CiAgICAgICAgdGhpcy5yZXBhaW50KCk7CgogICAgICAgIHJldHVybiBhcmdzOwogICAgfSwKCiAgICBtb3ZlUGFnZURvd246IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICB0aGlzLmVkaXRvci5jdXJzb3JQb3NpdGlvbi5yb3cgPSBNYXRoLm1pbih0aGlzLmVkaXRvci5jdXJzb3JQb3NpdGlvbi5yb3cgKyB0aGlzLmVkaXRvci51aS52aXNpYmxlUm93cywgdGhpcy5lZGl0b3IubW9kZWwuZ2V0Um93Q291bnQoKSAtIDEpOwoKICAgICAgICB0aGlzLmhhbmRsZUN1cnNvclNlbGVjdGlvbihhcmdzKTsKICAgICAgICB0aGlzLnJlcGFpbnQoKTsKCiAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICB9LAoKICAgIG1vdmVXb3JkTGVmdDogZnVuY3Rpb24oYXJncykgewogICAgICAgIHZhciByb3cgPSB0aGlzLmVkaXRvci5tb2RlbC5nZXRSb3dBcnJheShhcmdzLnBvcy5yb3cpOwoKICAgICAgICBpZiAoYXJncy5wb3MuY29sID09IDApIHsgLy8gLS0gYXQgdGhlIHN0YXJ0IHRvIG1vdmUgdXAgYW5kIHRvIHRoZSBlbmQKICAgICAgICAgICAgdmFyIG5ld2FyZ3MgPSB0aGlzLm1vdmVDdXJzb3JVcChhcmdzKTsKICAgICAgICAgICAgdGhpcy5tb3ZlVG9MaW5lRW5kKG5ld2FyZ3MpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBTaG9ydCBjaXJjdWl0IGlmIGN1cnNvciBpcyBhaGVhZCBvZiBhY3R1YWwgc3BhY2VzIGluIG1vZGVsCiAgICAgICAgaWYgKHJvdy5sZW5ndGggPCBhcmdzLnBvcy5jb2wpIHsKICAgICAgICAgICAgYXJncyA9IHRoaXMubW92ZVRvTGluZUVuZChhcmdzKTsKICAgICAgICB9CiAgICAgICAgdmFyIG5ld2NvbCA9IGFyZ3MucG9zLmNvbDsKCiAgICAgICAgLy8gVGhpcyBzbHVycHMgdXAgdHJhaWxpbmcgc3BhY2VzCiAgICAgICAgdmFyIHdhc1NwYWNlcyA9IGZhbHNlOwogICAgICAgIHdoaWxlIChuZXdjb2wgPiAwKSB7CiAgICAgICAgICAgIG5ld2NvbC0tOwoKICAgICAgICAgICAgdmFyIGMgPSByb3dbbmV3Y29sXTsKICAgICAgICAgICAgdmFyIGNoYXJDb2RlID0gYy5jaGFyQ29kZUF0KDApOwogICAgICAgICAgICBpZiAoY2hhckNvZGUgPT0gMzIpIHsKICAgICAgICAgICAgICAgIHdhc1NwYWNlcyA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXdjb2wrKzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBUaGlzIGp1bXBzIHRvIHN0b3Agd29yZHMgICAgICAgIAogICAgICAgIGlmICghd2FzU3BhY2VzKSB7CiAgICAgICAgICAgIHdoaWxlIChuZXdjb2wgPiAwKSB7CiAgICAgICAgICAgICAgICBuZXdjb2wtLTsKICAgICAgICAgICAgICAgIHZhciBjID0gcm93W25ld2NvbF07CiAgICAgICAgICAgICAgICB2YXIgY2hhckNvZGUgPSBjLmNoYXJDb2RlQXQoMCk7CiAgICAgICAgICAgICAgICBpZiAoIChjaGFyQ29kZSA8IDY1KSB8fCAoY2hhckNvZGUgPiAxMjIpICkgeyAvLyBpZiB5b3UgZ2V0IHRvIGFuIGFscGhhIHlvdSBhcmUgZG9uZQogICAgICAgICAgICAgICAgICAgIGlmIChuZXdjb2wgIT0gYXJncy5wb3MuY29sIC0gMSkgbmV3Y29sKys7IC8vIHJpZ2h0IG5leHQgdG8gYSBzdG9wIGNoYXIsIG1vdmUgYmFjayBvbmUKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLmVkaXRvci5jdXJzb3JQb3NpdGlvbi5jb2wgPSBuZXdjb2w7CiAgICAgICAgdGhpcy5oYW5kbGVDdXJzb3JTZWxlY3Rpb24oYXJncyk7CiAgICAgICAgdGhpcy5yZXBhaW50KCk7CiAgICB9LAoKICAgIG1vdmVXb3JkUmlnaHQ6IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICB2YXIgcm93ID0gdGhpcy5lZGl0b3IubW9kZWwuZ2V0Um93QXJyYXkoYXJncy5wb3Mucm93KTsKCiAgICAgICAgaWYgKHJvdy5sZW5ndGggPD0gYXJncy5wb3MuY29sKSB7IC8vIC0tIGF0IHRoZSBlZGdlIHNvIGdvIHRvIHRoZSBuZXh0IGxpbmUKICAgICAgICAgICAgdGhpcy5tb3ZlQ3Vyc29yRG93bih0aGlzLm1vdmVUb0xpbmVTdGFydChhcmdzKSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBuZXdjb2wgPSBhcmdzLnBvcy5jb2w7CgogICAgICAgIC8vIFRoaXMgc2x1cnBzIHVwIGxlYWRpbmcgc3BhY2VzCiAgICAgICAgdmFyIHdhc1NwYWNlcyA9IGZhbHNlOwogICAgICAgIHdoaWxlIChuZXdjb2wgPCByb3cubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBjID0gcm93W25ld2NvbF07CiAgICAgICAgICAgIHZhciBjaGFyQ29kZSA9IGMuY2hhckNvZGVBdCgwKTsKICAgICAgICAgICAgaWYgKGNoYXJDb2RlID09IDMyKSB7CiAgICAgICAgICAgICAgICB3YXNTcGFjZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgbmV3Y29sKys7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVGhpcyBqdW1wcyB0byBzdG9wIHdvcmRzICAgICAgICAKICAgICAgICBpZiAoIXdhc1NwYWNlcykgeyAgICAgICAgCiAgICAgICAgICAgIHdoaWxlIChuZXdjb2wgPCByb3cubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBuZXdjb2wrKzsKCiAgICAgICAgICAgICAgICBpZiAocm93Lmxlbmd0aCA9PSBuZXdjb2wpIHsgLy8gb25lIG1vcmUgdG8gZ28KICAgICAgICAgICAgICAgICAgICB0aGlzLm1vdmVUb0xpbmVFbmQoYXJncyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBjID0gcm93W25ld2NvbF07CiAgICAgICAgICAgICAgICB2YXIgY2hhckNvZGUgPSBjLmNoYXJDb2RlQXQoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCAoY2hhckNvZGUgPCA2NSkgfHwgKGNoYXJDb2RlID4gMTIyKSApIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIAogICAgICAgIHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uLmNvbCA9IG5ld2NvbDsKICAgICAgICB0aGlzLmhhbmRsZUN1cnNvclNlbGVjdGlvbihhcmdzKTsKICAgICAgICB0aGlzLnJlcGFpbnQoKTsKICAgIH0sCgogICAgdW5kb1JlZG86IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICBpZiAoISBhcmdzLmV2ZW50LnNoaWZ0S2V5KSB7ICAgIC8vIGhvbGRpbmcgZG93biB0aGUgc2hpZnQga2V5IGNhdXNlcyB0aGUgdW5kbyBrZXlzdHJva2UgdG8gYmUgYSByZWRvIFRPRE86IG1vdmUgdGhpcyBsb2dpYyB0byBrZXkgaGFuZGxlcgogICAgICAgICAgICB0aGlzLnVuZG8oKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnJlZG8oKTsKICAgICAgICB9CiAgICB9LAoKICAgIHVuZG86IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZWRpdG9yLnVuZG9NYW5hZ2VyLnVuZG8oKTsKICAgIH0sCgogICAgcmVkbzogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5lZGl0b3IudW5kb01hbmFnZXIucmVkbygpOwogICAgfSwKCiAgICBzZWxlY3RBbGw6IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICAvLyBkbyBub3RoaW5nIHdpdGggYW4gZW1wdHkgZG9jCiAgICAgICAgaWYgKHRoaXMuZWRpdG9yLm1vZGVsLmdldE1heENvbHMgPT0gMCkgcmV0dXJuOwoKICAgICAgICBhcmdzLnN0YXJ0UG9zID0geyBjb2w6IDAsIHJvdzogMCB9OwogICAgICAgIGFyZ3MuZW5kUG9zID0geyBjb2w6IHRoaXMuZWRpdG9yLm1vZGVsLmdldFJvd0xlbmd0aCh0aGlzLmVkaXRvci5tb2RlbC5nZXRSb3dDb3VudCgpIC0gMSksIHJvdzogdGhpcy5lZGl0b3IubW9kZWwuZ2V0Um93Q291bnQoKSAtIDEgfTsKCiAgICAgICAgdGhpcy5zZWxlY3QoYXJncyk7CiAgICB9LAoKICAgIHNlbGVjdDogZnVuY3Rpb24oYXJncykgewogICAgICAgIGlmIChhcmdzLnN0YXJ0UG9zKSB7CiAgICAgICAgICAgIHRoaXMuZWRpdG9yLnNldFNlbGVjdGlvbih7IHN0YXJ0UG9zOiBhcmdzLnN0YXJ0UG9zLCBlbmRQb3M6IGFyZ3MuZW5kUG9zIH0pOwogICAgICAgICAgICB0aGlzLmVkaXRvci5tb3ZlQ3Vyc29yKGFyZ3MuZW5kUG9zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRTZWxlY3Rpb24odW5kZWZpbmVkKTsKICAgICAgICB9CiAgICB9LAoKICAgIC8vIFRPRE86IG5lZWRzIHVuZG8KICAgIGluc2VydFRhYjogZnVuY3Rpb24oYXJncykgewogICAgICAgIHZhciBudW1iZXJPZkNoYXJhY3RlcnMgPSBfc2V0dGluZ3MuZ2V0KCd0YWJzaXplJykgfHwgNDsgICAvLyBUT0RPOiBnbG9iYWwgbmVlZHMgZml4aW5nCiAgICAgICAgYXJncy5uZXdjaGFyID0gJyAnOwoKICAgICAgICBmb3IgKHZhciB4ID0gMDsgeCA8IG51bWJlck9mQ2hhcmFjdGVyczsgeCsrKSB7CiAgICAgICAgICAgIHRoaXMuZWRpdG9yLnVpLmFjdGlvbnMuaW5zZXJ0Q2hhcmFjdGVyKGFyZ3MpOwogICAgICAgIH0KICAgICAgICB0aGlzLnJlcGFpbnQoKTsKICAgIH0sCgogICAgY3V0U2VsZWN0aW9uOiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgdGhpcy5jb3B5U2VsZWN0aW9uKGFyZ3MpOwogICAgICAgIHRoaXMuZGVsZXRlU2VsZWN0aW9uKGFyZ3MpOwogICAgfSwKICAgIAogICAgY29weVNlbGVjdGlvbjogZnVuY3Rpb24oYXJncykgewogICAgICAgIHZhciBzZWxlY3Rpb25PYmplY3QgPSB0aGlzLmVkaXRvci5nZXRTZWxlY3Rpb24oKTsKICAgICAgICBpZiAoc2VsZWN0aW9uT2JqZWN0KSB7CiAgICAgICAgICAgIHZhciBzZWxlY3Rpb25UZXh0ID0gdGhpcy5lZGl0b3IubW9kZWwuZ2V0Q2h1bmsoc2VsZWN0aW9uT2JqZWN0KTsKICAgICAgICAgICAgaWYgKHNlbGVjdGlvblRleHQpIHsKICAgICAgICAgICAgICAgIEJlc3Bpbi5DbGlwYm9hcmQuY29weShzZWxlY3Rpb25UZXh0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgZGVsZXRlU2VsZWN0aW9uQW5kSW5zZXJ0Q2h1bms6IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICB2YXIgb2xkcXVldWVkID0gYXJncy5xdWV1ZWQ7CgogICAgICAgIGFyZ3MucXVldWVkID0gdHJ1ZTsKICAgICAgICB2YXIgc2VsZWN0aW9uID0gdGhpcy5lZGl0b3IuZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgdmFyIGNodW5rID0gdGhpcy5kZWxldGVTZWxlY3Rpb24oYXJncyk7CiAgICAgICAgYXJncy5wb3MgPSBCZXNwaW4uRWRpdG9yLlV0aWxzLmNvcHlQb3ModGhpcy5lZGl0b3IuY3Vyc29yUG9zaXRpb24pOwogICAgICAgIHZhciBlbmRQb3MgPSB0aGlzLmluc2VydENodW5rKGFyZ3MpOwoKICAgICAgICBhcmdzLnF1ZXVlZCA9IG9sZHF1ZXVlZDsKCiAgICAgICAgLy8gdW5kby9yZWRvCiAgICAgICAgYXJncy5hY3Rpb24gPSAiZGVsZXRlU2VsZWN0aW9uQW5kSW5zZXJ0Q2h1bmsiOwogICAgICAgIGFyZ3Muc2VsZWN0aW9uID0gc2VsZWN0aW9uOwogICAgICAgIHZhciByZWRvT3BlcmF0aW9uID0gYXJncwogICAgICAgIHZhciB1bmRvQXJncyA9IHsgYWN0aW9uOiAiZGVsZXRlQ2h1bmtBbmRJbnNlcnRDaHVua0FuZFNlbGVjdCIsIHBvczogQmVzcGluLkVkaXRvci5VdGlscy5jb3B5UG9zKGFyZ3MucG9zKSwgZW5kUG9zOiBlbmRQb3MsIHF1ZXVlZDogYXJncy5xdWV1ZWQsIGNodW5rOiBjaHVuayB9CiAgICAgICAgdmFyIHVuZG9PcGVyYXRpb24gPSB1bmRvQXJncwogICAgICAgIHRoaXMuZWRpdG9yLnVuZG9NYW5hZ2VyLmFkZFVuZG9PcGVyYXRpb24obmV3IEJlc3Bpbi5FZGl0b3IuVW5kb0l0ZW0odW5kb09wZXJhdGlvbiwgcmVkb09wZXJhdGlvbikpOwogICAgfSwKCiAgICBkZWxldGVDaHVua0FuZEluc2VydENodW5rQW5kU2VsZWN0OiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgdmFyIG9sZHF1ZXVlZCA9IGFyZ3MucXVldWVkOwoKICAgICAgICBhcmdzLnF1ZXVlZCA9IHRydWU7CiAgICAgICAgdGhpcy5kZWxldGVDaHVuayhhcmdzKTsKICAgICAgICB0aGlzLmluc2VydENodW5rQW5kU2VsZWN0KGFyZ3MpOwoKICAgICAgICBhcmdzLnF1ZXVlZCA9IG9sZHF1ZXVlZDsKCiAgICAgICAgLy8gdW5kby9yZWRvCiAgICAgICAgYXJncy5hY3Rpb24gPSAiZGVsZXRlQ2h1bmtBbmRJbnNlcnRDaHVua0FuZFNlbGVjdCI7CiAgICAgICAgdmFyIHJlZG9PcGVyYXRpb24gPSBhcmdzCiAgICAgICAgdmFyIHVuZG9BcmdzID0geyBhY3Rpb246ICJkZWxldGVTZWxlY3Rpb25BbmRJbnNlcnRDaHVuayIsIHBvczogQmVzcGluLkVkaXRvci5VdGlscy5jb3B5UG9zKGFyZ3MucG9zKSwgcXVldWVkOiBhcmdzLnF1ZXVlZCwgc2VsZWN0aW9uOiBhcmdzLnNlbGVjdGlvbiB9CiAgICAgICAgdmFyIHVuZG9PcGVyYXRpb24gPSB1bmRvQXJncwogICAgICAgIHRoaXMuZWRpdG9yLnVuZG9NYW5hZ2VyLmFkZFVuZG9PcGVyYXRpb24obmV3IEJlc3Bpbi5FZGl0b3IuVW5kb0l0ZW0odW5kb09wZXJhdGlvbiwgcmVkb09wZXJhdGlvbikpOwogICAgfSwKCiAgICBwYXN0ZUZyb21DbGlwYm9hcmQ6IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICB2YXIgY2xpcGJvYXJkID0gKGFyZ3MuY2xpcGJvYXJkKSA/IGFyZ3MuY2xpcGJvYXJkIDogQmVzcGluLkNsaXBib2FyZC5kYXRhKCk7CiAgICAgICAgaWYgKGNsaXBib2FyZCA9PSB1bmRlZmluZWQpIHJldHVybjsgLy8gZGFybiBpdCBjbGlwYm9hcmQhCiAgICAgICAgYXJncy5jaHVuayA9IGNsaXBib2FyZDsKICAgICAgICB0aGlzLmluc2VydENodW5rKGFyZ3MpOwogICAgfSwKCiAgICBpbnNlcnRDaHVuazogZnVuY3Rpb24oYXJncykgewogICAgICAgIGlmICh0aGlzLmVkaXRvci5zZWxlY3Rpb24pIHsKICAgICAgICAgICAgdGhpcy5kZWxldGVTZWxlY3Rpb25BbmRJbnNlcnRDaHVuayhhcmdzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcG9zID0gdGhpcy5lZGl0b3IubW9kZWwuaW5zZXJ0Q2h1bmsoQmVzcGluLkVkaXRvci5VdGlscy5jb3B5UG9zKHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uKSwgYXJncy5jaHVuayk7CiAgICAgICAgICAgIHRoaXMuZWRpdG9yLm1vdmVDdXJzb3IocG9zKTsKICAgICAgICAgICAgdGhpcy5yZXBhaW50KCk7CgogICAgICAgICAgICAvLyB1bmRvL3JlZG8KICAgICAgICAgICAgYXJncy5hY3Rpb24gPSAiaW5zZXJ0Q2h1bmsiOwogICAgICAgICAgICB2YXIgcmVkb09wZXJhdGlvbiA9IGFyZ3MKICAgICAgICAgICAgdmFyIHVuZG9BcmdzID0geyBhY3Rpb246ICJkZWxldGVDaHVuayIsIHBvczogQmVzcGluLkVkaXRvci5VdGlscy5jb3B5UG9zKGFyZ3MucG9zKSwgcXVldWVkOiBhcmdzLnF1ZXVlZCwgZW5kUG9zOiBwb3MgfQogICAgICAgICAgICB2YXIgdW5kb09wZXJhdGlvbiA9IHVuZG9BcmdzCiAgICAgICAgICAgIHRoaXMuZWRpdG9yLnVuZG9NYW5hZ2VyLmFkZFVuZG9PcGVyYXRpb24obmV3IEJlc3Bpbi5FZGl0b3IuVW5kb0l0ZW0odW5kb09wZXJhdGlvbiwgcmVkb09wZXJhdGlvbikpOwoKICAgICAgICAgICAgcmV0dXJuIHBvczsKICAgICAgICB9CiAgICB9LAoKICAgIGRlbGV0ZUNodW5rOiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgdmFyIGNodW5rID0gdGhpcy5lZGl0b3IubW9kZWwuZGVsZXRlQ2h1bmsoeyBzdGFydFBvczogYXJncy5wb3MsIGVuZFBvczogYXJncy5lbmRQb3MgfSk7CiAgICAgICAgdGhpcy5lZGl0b3IubW92ZUN1cnNvcihhcmdzLnBvcyk7CiAgICAgICAgdGhpcy5yZXBhaW50KCk7CgogICAgICAgIC8vIHVuZG8vcmVkbwogICAgICAgIGFyZ3MuYWN0aW9uID0gImRlbGV0ZUNodW5rIjsKICAgICAgICB2YXIgcmVkb09wZXJhdGlvbiA9IGFyZ3MKICAgICAgICB2YXIgdW5kb0FyZ3MgPSB7IGFjdGlvbjogImluc2VydENodW5rIiwgcG9zOiBCZXNwaW4uRWRpdG9yLlV0aWxzLmNvcHlQb3MoYXJncy5wb3MpLCBxdWV1ZWQ6IGFyZ3MucXVldWVkLCBjaHVuazogY2h1bmsgfQogICAgICAgIHZhciB1bmRvT3BlcmF0aW9uID0gdW5kb0FyZ3MKICAgICAgICB0aGlzLmVkaXRvci51bmRvTWFuYWdlci5hZGRVbmRvT3BlcmF0aW9uKG5ldyBCZXNwaW4uRWRpdG9yLlVuZG9JdGVtKHVuZG9PcGVyYXRpb24sIHJlZG9PcGVyYXRpb24pKTsKICAgIH0sCgogICAgLy9kZWxldGVMaW5lOiBmdW5jdGlvbihhcmdzKSB7CiAgICAvLyAgICB0aGlzLmVkaXRvci5saW5lcy5zcGxpY2UoYXJncy5wb3Mucm93KTsKICAgIC8vICAgIGlmIChhcmdzLnBvcy5yb3cgPj0gdGhpcy5lZGl0b3IubGluZXMubGVuZ3RoKSB0aGlzLmVkaXRvci5tb3ZlQ3Vyc29yKHsgcm93OiBhcmdzLnBvcy5yb3cgLSAxLCBjb2w6IGFyZ3MucG9zLmNvbCB9KTsKICAgIC8vICAgIHRoaXMucmVwYWludCgpOwogICAgLy99LAoKICAgIGpvaW5MaW5lOiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgaWYgKGFyZ3Muam9pbkRpcmVjdGlvbiA9PSAidXAiKSB7CiAgICAgICAgICAgIGlmIChhcmdzLnBvcy5yb3cgPT0gMCkgcmV0dXJuOwoKICAgICAgICAgICAgdmFyIG5ld2NvbCA9IHRoaXMuZWRpdG9yLm1vZGVsLmdldFJvd0xlbmd0aChhcmdzLnBvcy5yb3cgLSAxKTsKICAgICAgICAgICAgdGhpcy5lZGl0b3IubW9kZWwuam9pblJvdyhhcmdzLnBvcy5yb3cgLSAxKTsKICAgICAgICAgICAgdGhpcy5lZGl0b3IubW92ZUN1cnNvcih7IHJvdzogYXJncy5wb3Mucm93IC0gMSwgY29sOiBuZXdjb2wgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGFyZ3MucG9zLnJvdyA+PSB0aGlzLmVkaXRvci5tb2RlbC5nZXRSb3dDb3VudCgpIC0gMSkgcmV0dXJuOwoKICAgICAgICAgICAgdGhpcy5lZGl0b3IubW9kZWwuam9pblJvdyhhcmdzLnBvcy5yb3cpOwogICAgICAgIH0KCiAgICAgICAgLy8gdW5kby9yZWRvCiAgICAgICAgYXJncy5hY3Rpb24gPSAiam9pbkxpbmUiOwogICAgICAgIHZhciByZWRvT3BlcmF0aW9uID0gYXJncwogICAgICAgIHZhciB1bmRvQXJncyA9IHsgYWN0aW9uOiAibmV3bGluZSIsIHBvczogQmVzcGluLkVkaXRvci5VdGlscy5jb3B5UG9zKHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uKSwgcXVldWVkOiBhcmdzLnF1ZXVlZCB9CiAgICAgICAgdmFyIHVuZG9PcGVyYXRpb24gPSB1bmRvQXJncwogICAgICAgIHRoaXMuZWRpdG9yLnVuZG9NYW5hZ2VyLmFkZFVuZG9PcGVyYXRpb24obmV3IEJlc3Bpbi5FZGl0b3IuVW5kb0l0ZW0odW5kb09wZXJhdGlvbiwgcmVkb09wZXJhdGlvbikpOwoKICAgICAgICB0aGlzLnJlcGFpbnQoKTsKICAgIH0sCgogICAga2lsbExpbmU6IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICAvLyBzZWxlY3QgdGhlIGN1cnJlbnQgcm93CiAgICAgICAgdGhpcy5lZGl0b3Iuc2V0U2VsZWN0aW9uKHsgc3RhcnRQb3M6IHsgcm93OiBhcmdzLnBvcy5yb3csIGNvbDogMCB9LCBlbmRQb3M6IHsgcm93OiBhcmdzLnBvcy5yb3cgKyAxLCBjb2w6IDAgfSB9KTsKICAgICAgICB0aGlzLmN1dFNlbGVjdGlvbihhcmdzKTsgLy8gY3V0ICh3aWxsIHNhdmUgYW5kIHJlZG8gd2lsbCB3b3JrKQogICAgfSwKICAgIAogICAgZGVsZXRlU2VsZWN0aW9uOiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgaWYgKCF0aGlzLmVkaXRvci5zZWxlY3Rpb24pIHJldHVybjsKICAgICAgICB2YXIgc2VsZWN0aW9uID0gdGhpcy5lZGl0b3IuZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgdmFyIHN0YXJ0UG9zID0gQmVzcGluLkVkaXRvci5VdGlscy5jb3B5UG9zKHNlbGVjdGlvbi5zdGFydFBvcyk7CiAgICAgICAgdmFyIGNodW5rID0gdGhpcy5lZGl0b3IubW9kZWwuZ2V0Q2h1bmsoc2VsZWN0aW9uKTsKICAgICAgICB0aGlzLmVkaXRvci5tb2RlbC5kZWxldGVDaHVuayhzZWxlY3Rpb24pOwoKICAgICAgICAvLyB1bmRvL3JlZG8KICAgICAgICBhcmdzLmFjdGlvbiA9ICJkZWxldGVTZWxlY3Rpb24iOwogICAgICAgIHZhciByZWRvT3BlcmF0aW9uID0gYXJnczsKICAgICAgICB2YXIgdW5kb0FyZ3MgPSB7IGFjdGlvbjogImluc2VydENodW5rQW5kU2VsZWN0IiwgcG9zOiBCZXNwaW4uRWRpdG9yLlV0aWxzLmNvcHlQb3Moc3RhcnRQb3MpLCBxdWV1ZWQ6IGFyZ3MucXVldWVkLCBjaHVuazogY2h1bmsgfQogICAgICAgIHZhciB1bmRvT3BlcmF0aW9uID0gdW5kb0FyZ3MKICAgICAgICB0aGlzLmVkaXRvci51bmRvTWFuYWdlci5hZGRVbmRvT3BlcmF0aW9uKG5ldyBCZXNwaW4uRWRpdG9yLlVuZG9JdGVtKHVuZG9PcGVyYXRpb24sIHJlZG9PcGVyYXRpb24pKTsKCiAgICAgICAgLy8gc2V0dGluZyB0aGUgc2VsZWN0aW9uIHRvIHVuZGVmaW5lZCBoYXMgdG8gaGFwcGVuICphZnRlciogd2UgZW5xdWV1ZSB0aGUgdW5kb09wIG90aGVyd2lzZSByZXBsYXkgYnJlYWtzCiAgICAgICAgdGhpcy5lZGl0b3Iuc2V0U2VsZWN0aW9uKHVuZGVmaW5lZCk7CiAgICAgICAgdGhpcy5lZGl0b3IubW92ZUN1cnNvcihzdGFydFBvcyk7CiAgICAgICAgdGhpcy5yZXBhaW50KCk7CgogICAgICAgIHJldHVybiBjaHVuazsKICAgIH0sCgogICAgaW5zZXJ0Q2h1bmtBbmRTZWxlY3Q6IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICB2YXIgZW5kUG9zID0gdGhpcy5lZGl0b3IubW9kZWwuaW5zZXJ0Q2h1bmsoYXJncy5wb3MsIGFyZ3MuY2h1bmspOwoKICAgICAgICBhcmdzLmFjdGlvbiA9ICJpbnNlcnRDaHVua0FuZFNlbGVjdCI7CiAgICAgICAgdmFyIHJlZG9PcGVyYXRpb24gPSBhcmdzCiAgICAgICAgdmFyIHVuZG9BcmdzID0geyBhY3Rpb246ICJkZWxldGVTZWxlY3Rpb24iLCBwb3M6IEJlc3Bpbi5FZGl0b3IuVXRpbHMuY29weVBvcyhlbmRQb3MpLCBxdWV1ZWQ6IGFyZ3MucXVldWVkIH0KICAgICAgICB2YXIgdW5kb09wZXJhdGlvbiA9IHVuZG9BcmdzCiAgICAgICAgdGhpcy5lZGl0b3IudW5kb01hbmFnZXIuYWRkVW5kb09wZXJhdGlvbihuZXcgQmVzcGluLkVkaXRvci5VbmRvSXRlbSh1bmRvT3BlcmF0aW9uLCByZWRvT3BlcmF0aW9uKSk7CgogICAgICAgIC8vIHNldHRpbmcgdGhlIHNlbGVjdGlvbiB0byB1bmRlZmluZWQgaGFzIHRvIGhhcHBlbiAqYWZ0ZXIqIHdlIGVucXVldWUgdGhlIHVuZG9PcCBvdGhlcndpc2UgcmVwbGF5IGJyZWFrcwogICAgICAgIHRoaXMuZWRpdG9yLnNldFNlbGVjdGlvbih7IHN0YXJ0UG9zOiBhcmdzLnBvcywgZW5kUG9zOiBlbmRQb3MgfSk7CiAgICAgICAgdGhpcy5lZGl0b3IubW92ZUN1cnNvcihlbmRQb3MpOwogICAgICAgIHRoaXMucmVwYWludCgpOwogICAgfSwKCiAgICBiYWNrc3BhY2U6IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICBpZiAodGhpcy5lZGl0b3Iuc2VsZWN0aW9uKSB7CiAgICAgICAgICAgIHRoaXMuZGVsZXRlU2VsZWN0aW9uKGFyZ3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChhcmdzLnBvcy5jb2wgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5jdXJzb3JQb3NpdGlvbi5jb2wgPSBNYXRoLm1heCgwLCBhcmdzLnBvcy5jb2wgLSAxKTsKICAgICAgICAgICAgICAgIGFyZ3MucG9zLmNvbCAtPSAxOwogICAgICAgICAgICAgICAgdGhpcy5kZWxldGVDaGFyYWN0ZXIoYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhcmdzLmpvaW5EaXJlY3Rpb24gPSAidXAiOwogICAgICAgICAgICAgICAgdGhpcy5qb2luTGluZShhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgZGVsZXRlS2V5OiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgaWYgKHRoaXMuZWRpdG9yLnNlbGVjdGlvbikgewogICAgICAgICAgICB0aGlzLmRlbGV0ZVNlbGVjdGlvbihhcmdzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoYXJncy5wb3MuY29sIDwgdGhpcy5lZGl0b3IubW9kZWwuZ2V0Um93TGVuZ3RoKGFyZ3MucG9zLnJvdykpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGVsZXRlQ2hhcmFjdGVyKGFyZ3MpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYXJncy5qb2luRGlyZWN0aW9uID0gImRvd24iOwogICAgICAgICAgICAgICAgdGhpcy5qb2luTGluZShhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgZGVsZXRlQ2hhcmFjdGVyOiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgaWYgKGFyZ3MucG9zLmNvbCA8IHRoaXMuZWRpdG9yLm1vZGVsLmdldFJvd0xlbmd0aChhcmdzLnBvcy5yb3cpKSB7CiAgICAgICAgICAgIHZhciBkZWxldGVkID0gdGhpcy5lZGl0b3IubW9kZWwuZGVsZXRlQ2hhcmFjdGVycyhhcmdzLnBvcywgMSk7CiAgICAgICAgICAgIHRoaXMucmVwYWludCgpOwoKICAgICAgICAgICAgLy8gdW5kby9yZWRvCiAgICAgICAgICAgIGFyZ3MuYWN0aW9uID0gImRlbGV0ZUNoYXJhY3RlciI7CiAgICAgICAgICAgIHZhciByZWRvT3BlcmF0aW9uID0gYXJncwogICAgICAgICAgICB2YXIgdW5kb0FyZ3MgPSB7IGFjdGlvbjogImluc2VydENoYXJhY3RlciIsIHBvczogQmVzcGluLkVkaXRvci5VdGlscy5jb3B5UG9zKGFyZ3MucG9zKSwgcXVldWVkOiBhcmdzLnF1ZXVlZCwgbmV3Y2hhcjogZGVsZXRlZCB9CiAgICAgICAgICAgIHZhciB1bmRvT3BlcmF0aW9uID0gdW5kb0FyZ3MKICAgICAgICAgICAgdGhpcy5lZGl0b3IudW5kb01hbmFnZXIuYWRkVW5kb09wZXJhdGlvbihuZXcgQmVzcGluLkVkaXRvci5VbmRvSXRlbSh1bmRvT3BlcmF0aW9uLCByZWRvT3BlcmF0aW9uKSk7CiAgICAgICAgfQogICAgfSwKCiAgICBuZXdsaW5lOiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgdGhpcy5lZGl0b3IubW9kZWwuc3BsaXRSb3coYXJncy5wb3MpOwogICAgICAgIHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uLnJvdyArPSAxOwogICAgICAgIHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uLmNvbCA9IDA7CgogICAgICAgIC8vIHVuZG8vcmVkbwogICAgICAgIGFyZ3MuYWN0aW9uID0gIm5ld2xpbmUiOwogICAgICAgIHZhciByZWRvT3BlcmF0aW9uID0gYXJncwogICAgICAgIHZhciB1bmRvQXJncyA9IHsgYWN0aW9uOiAiam9pbkxpbmUiLCBqb2luRGlyZWN0aW9uOiAidXAiLCBwb3M6IEJlc3Bpbi5FZGl0b3IuVXRpbHMuY29weVBvcyh0aGlzLmVkaXRvci5jdXJzb3JQb3NpdGlvbiksIHF1ZXVlZDogYXJncy5xdWV1ZWQgfQogICAgICAgIHZhciB1bmRvT3BlcmF0aW9uID0gdW5kb0FyZ3MKICAgICAgICB0aGlzLmVkaXRvci51bmRvTWFuYWdlci5hZGRVbmRvT3BlcmF0aW9uKG5ldyBCZXNwaW4uRWRpdG9yLlVuZG9JdGVtKHVuZG9PcGVyYXRpb24sIHJlZG9PcGVyYXRpb24pKTsKCiAgICAgICAgdGhpcy5yZXBhaW50KCk7CiAgICB9LAoKICAgIC8vIGl0IHNlZW1zIGtpbmRhIHNpbGx5LCBidXQgd2hlbiB5b3UgaGF2ZSBhIHJlZ2lvbiBzZWxlY3RlZCBhbmQgeW91IGluc2VydCBhIGNoYXJhY3RlciwgSSBoYXZlIGEgc2VwYXJhdGUgYWN0aW9uIHRoYXQgaXMgaW52b2tlZC4KICAgIC8vIHRoaXMgaXMgYmVjYXVzZSBpdCdzIHJlYWxseSB0d28gb3BlcmF0aW9uczogZGVsZXRpbmcgdGhlIHNlbGVjdGVkIHJlZ2lvbiBhbmQgdGhlbiBpbnNlcnRpbmcgYSBjaGFyYWN0ZXIuIEVhY2ggb2YgdGhlc2UgdHdvCiAgICAvLyBhY3Rpb25zIGFkZHMgYW4gb3BlcmF0aW9uIHRvIHRoZSB1bmRvIHF1ZXVlLiBTbyBJIGhhdmUgdHdvIGNob2ljZXMgZm9yCiAgICBkZWxldGVTZWxlY3Rpb25BbmRJbnNlcnRDaGFyYWN0ZXI6IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICB2YXIgb2xkcXVldWVkID0gYXJncy5xdWV1ZWQ7CgogICAgICAgIGFyZ3MucXVldWVkID0gdHJ1ZTsKICAgICAgICB2YXIgY2h1bmsgPSB0aGlzLmRlbGV0ZVNlbGVjdGlvbihhcmdzKTsKICAgICAgICBhcmdzLnBvcyA9IEJlc3Bpbi5FZGl0b3IuVXRpbHMuY29weVBvcyh0aGlzLmVkaXRvci5jdXJzb3JQb3NpdGlvbik7CiAgICAgICAgdGhpcy5pbnNlcnRDaGFyYWN0ZXIoYXJncyk7CgogICAgICAgIGFyZ3MucXVldWVkID0gb2xkcXVldWVkOwoKICAgICAgICAvLyB1bmRvL3JlZG8KICAgICAgICBhcmdzLmFjdGlvbiA9ICJkZWxldGVTZWxlY3Rpb25BbmRJbnNlcnRDaGFyYWN0ZXIiOwogICAgICAgIHZhciByZWRvT3BlcmF0aW9uID0gYXJncwogICAgICAgIHZhciB1bmRvQXJncyA9IHsgYWN0aW9uOiAiZGVsZXRlQ2hhcmFjdGVyQW5kSW5zZXJ0Q2h1bmtBbmRTZWxlY3QiLCBwb3M6IEJlc3Bpbi5FZGl0b3IuVXRpbHMuY29weVBvcyhhcmdzLnBvcyksIHF1ZXVlZDogYXJncy5xdWV1ZWQsIGNodW5rOiBjaHVuayB9CiAgICAgICAgdmFyIHVuZG9PcGVyYXRpb24gPSB1bmRvQXJncwogICAgICAgIHRoaXMuZWRpdG9yLnVuZG9NYW5hZ2VyLmFkZFVuZG9PcGVyYXRpb24obmV3IEJlc3Bpbi5FZGl0b3IuVW5kb0l0ZW0odW5kb09wZXJhdGlvbiwgcmVkb09wZXJhdGlvbikpOwogICAgfSwKCiAgICBkZWxldGVDaGFyYWN0ZXJBbmRJbnNlcnRDaHVua0FuZFNlbGVjdDogZnVuY3Rpb24oYXJncykgewogICAgICAgIHZhciBvbGRxdWV1ZWQgPSBhcmdzLnF1ZXVlZDsKCiAgICAgICAgYXJncy5xdWV1ZWQgPSB0cnVlOwogICAgICAgIHRoaXMuZGVsZXRlQ2hhcmFjdGVyKGFyZ3MpOwogICAgICAgIHRoaXMuaW5zZXJ0Q2h1bmtBbmRTZWxlY3QoYXJncyk7CgogICAgICAgIGFyZ3MucXVldWVkID0gb2xkcXVldWVkOwoKICAgICAgICAvLyB1bmRvL3JlZG8KICAgICAgICBhcmdzLmFjdGlvbiA9ICJkZWxldGVDaGFyYWN0ZXJBbmRJbnNlcnRDaHVua0FuZFNlbGVjdCI7CiAgICAgICAgdmFyIHJlZG9PcGVyYXRpb24gPSBhcmdzCiAgICAgICAgdmFyIHVuZG9BcmdzID0geyBhY3Rpb246ICJkZWxldGVTZWxlY3Rpb25BbmRJbnNlcnRDaGFyYWN0ZXIiLCBwb3M6IEJlc3Bpbi5FZGl0b3IuVXRpbHMuY29weVBvcyhhcmdzLnBvcyksIHF1ZXVlZDogYXJncy5xdWV1ZWQgfQogICAgICAgIHZhciB1bmRvT3BlcmF0aW9uID0gdW5kb0FyZ3MKICAgICAgICB0aGlzLmVkaXRvci51bmRvTWFuYWdlci5hZGRVbmRvT3BlcmF0aW9uKG5ldyBCZXNwaW4uRWRpdG9yLlVuZG9JdGVtKHVuZG9PcGVyYXRpb24sIHJlZG9PcGVyYXRpb24pKTsKICAgIH0sCgogICAgaW5zZXJ0Q2hhcmFjdGVyOiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgaWYgKHRoaXMuZWRpdG9yLnNlbGVjdGlvbikgewogICAgICAgICAgICB0aGlzLmRlbGV0ZVNlbGVjdGlvbkFuZEluc2VydENoYXJhY3RlcihhcmdzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmVkaXRvci5tb2RlbC5pbnNlcnRDaGFyYWN0ZXJzKGFyZ3MucG9zLCBhcmdzLm5ld2NoYXIpOwogICAgICAgICAgICB0aGlzLmVkaXRvci5jdXJzb3JQb3NpdGlvbi5jb2wgKz0gMTsKICAgICAgICAgICAgdGhpcy5yZXBhaW50KCk7CgogICAgICAgICAgICAvLyB1bmRvL3JlZG8KICAgICAgICAgICAgYXJncy5hY3Rpb24gPSAiaW5zZXJ0Q2hhcmFjdGVyIjsKICAgICAgICAgICAgdmFyIHJlZG9PcGVyYXRpb24gPSBhcmdzCiAgICAgICAgICAgIHZhciB1bmRvQXJncyA9IHsgYWN0aW9uOiAiZGVsZXRlQ2hhcmFjdGVyIiwgcG9zOiBCZXNwaW4uRWRpdG9yLlV0aWxzLmNvcHlQb3MoYXJncy5wb3MpLCBxdWV1ZWQ6IGFyZ3MucXVldWVkIH0KICAgICAgICAgICAgdmFyIHVuZG9PcGVyYXRpb24gPSB1bmRvQXJncwogICAgICAgICAgICB0aGlzLmVkaXRvci51bmRvTWFuYWdlci5hZGRVbmRvT3BlcmF0aW9uKG5ldyBCZXNwaW4uRWRpdG9yLlVuZG9JdGVtKHVuZG9PcGVyYXRpb24sIHJlZG9PcGVyYXRpb24pKTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICBtb3ZlQ3Vyc29yUm93VG9DZW50ZXI6IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICB2YXIgc2F2ZUN1cnNvclJvdyA9IHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uLnJvdzsKICAgICAgICB2YXIgaGFsZlJvd3MgPSBNYXRoLmZsb29yKHRoaXMuZWRpdG9yLnVpLnZpc2libGVSb3dzIC8gMik7CiAgICAgICAgaWYgKHNhdmVDdXJzb3JSb3cgPiAodGhpcy5lZGl0b3IudWkuZmlyc3RWaXNpYmxlUm93ICsgaGFsZlJvd3MpKSB7IC8vIGJvdHRvbSBoYWxmLCBzbyBtb3ZlIGRvd24KICAgICAgICAgICAgdGhpcy5lZGl0b3IuY3Vyc29yUG9zaXRpb24ucm93ID0gdGhpcy5lZGl0b3IuY3Vyc29yUG9zaXRpb24ucm93ICsgaGFsZlJvd3M7CiAgICAgICAgfSBlbHNlIHsgLy8gdG9wIGhhbGYsIHNvIG1vdmUgdXAKICAgICAgICAgICAgdGhpcy5lZGl0b3IuY3Vyc29yUG9zaXRpb24ucm93ID0gdGhpcy5lZGl0b3IuY3Vyc29yUG9zaXRpb24ucm93IC0gaGFsZlJvd3M7CiAgICAgICAgfQogICAgICAgIHRoaXMuZWRpdG9yLnVpLmVuc3VyZUN1cnNvclZpc2libGUoKTsKICAgICAgICB0aGlzLmVkaXRvci5jdXJzb3JQb3NpdGlvbi5yb3cgPSBzYXZlQ3Vyc29yUm93OwogICAgfSwKCiAgICByZXBhaW50OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuaWdub3JlUmVwYWludHMpIHsKICAgICAgICAgICAgdGhpcy5lZGl0b3IudWkuZW5zdXJlQ3Vyc29yVmlzaWJsZSgpOwogICAgICAgICAgICB0aGlzLmVkaXRvci5wYWludCgpOwogICAgICAgIH0KICAgIH0KfSk7Ci8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKioKICogVmVyc2lvbjogTVBMIDEuMQogKgogKiBUaGUgY29udGVudHMgb2YgdGhpcyBmaWxlIGFyZSBzdWJqZWN0IHRvIHRoZSBNb3ppbGxhIFB1YmxpYyBMaWNlbnNlCiAqIFZlcnNpb24gMS4xICh0aGUgIkxpY2Vuc2UiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4KICogY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICogaHR0cDovL3d3dy5tb3ppbGxhLm9yZy9NUEwvCiAqCiAqIFNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIKICogYmFzaXMsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyByaWdodHMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBUaGUgT3JpZ2luYWwgQ29kZSBpcyBCZXNwaW4uCiAqCiAqIFRoZSBJbml0aWFsIERldmVsb3BlciBvZiB0aGUgT3JpZ2luYWwgQ29kZSBpcyBNb3ppbGxhLgogKiBQb3J0aW9ucyBjcmVhdGVkIGJ5IHRoZSBJbml0aWFsIERldmVsb3BlciBhcmUgQ29weXJpZ2h0IChDKSAyMDA5CiAqIHRoZSBJbml0aWFsIERldmVsb3Blci4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogQ29udHJpYnV0b3Iocyk6CiAqICAgQmVzcGluIFRlYW0gKGJlc3BpbkBtb3ppbGxhLmNvbSkKICoKICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi8KCmlmICh0eXBlb2YgQmVzcGluID09ICJ1bmRlZmluZWQiKSBCZXNwaW4gPSB7fTsKaWYgKCFCZXNwaW4uRWRpdG9yKSBCZXNwaW4uRWRpdG9yID0ge307CgovLyA9IEVkaXRvciA9Ci8vCi8vIFRoaXMgaXMgdGhlIGd1dHMuIFRoZSBtZXRhbC4gVGhlIGNvcmUgZWRpdG9yIGhhcyBtb3N0IG9mIGl0cyBjbGFzc2VzIGxpdmluZyBpbiBoZXJlOgovLwovLyAqIHt7e0Jlc3Bpbi5FZGl0b3IuQVBJfX19IDogVGhlIGVkaXRvciBBUEkgaXRzZWxmCi8vICoge3t7QmVzcGluLkVkaXRvci5VSX19fSA6IEtub3dsZWRnZSBvZiB0aGUgVUkgcGllY2VzIG9mIHRoZSBlZGl0b3IgaXMgaGVyZSwgYnVsayBvZiB0aGUgY29kZS4gcGFpbnRzIQovLyAqIHt7e0Jlc3Bpbi5FZGl0b3IuU2Nyb2xsYmFyfX19IDogVGhlIGN1c3RvbSBzY3JvbGxiYXIgKHRvIGJlIGZhY3RvcmVkIG91dCBhbmQgdXNlIFRIIHNjcm9sbGJhciBpbnN0ZWFkKQovLyAqIHt7e0Jlc3Bpbi5FZGl0b3IuU2VsZWN0aW9uSGVscGVyfX19IDogSGFuZGxlIHRleHQgc2VsZWN0aW9uCi8vICoge3t7QmVzcGluLkVkaXRvci5EZWZhdWx0RWRpdG9yS2V5TGlzdGVuZXJ9fX0gOiBLZXkgbGlzdGVuZXIgb3BlcmF0aW9ucwovLyAqIHt7e0Jlc3Bpbi5FZGl0b3IuUmVjdH19fSA6IEhlbHBlciB0byBob2xkIGEgcmVjdGFuZ2xlCi8vICoge3t7QmVzcGluLkVkaXRvci5FdmVudHN9fX0gOiBIZWxwZXIgdG8gaG9sZCBhIHJlY3RhbmdsZQovLyAqIHt7e0Jlc3Bpbi5FZGl0b3IuVXRpbHN9fX0gOiBCbG9iYnkgdXRpbGl0eSBvYmplY3QgdG8gZG8gY29tbW9uIHRoaW5ncwovLwovLyAqIHt7e0Jlc3Bpbi5FZGl0b3IuQWN0aW9uc319fSA6IFRoZSBhY3Rpb25zIHRoYXQgdGhlIGVkaXRvciBjYW4gZG8gKGNhbiBiZSBhZGRlZCB0b28pIGFyZSBhcmUgaW4gYWN0aW9ucy5qcwoKLy8gKioge3t7IEJlc3Bpbi5FZGl0b3IuU2Nyb2xsYmFyIH19fSAqKgovLwovLyBzb21lIHN0YXRlIG1nbXQuIGZvciBzY3JvbGxiYXJzOyBub3QgYSB0cnVlIGNvbXBvbmVudApCZXNwaW4uRWRpdG9yLlNjcm9sbGJhciA9IENsYXNzLmNyZWF0ZSh7CiAgICBIT1JJWk9OVEFMOiAiaG9yaXpvbnRhbCIsCiAgICBWRVJUSUNBTDogInZlcnRpY2FsIiwKICAgIE1JTklNVU1fSEFORExFX1NJWkU6IDIwLAoKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKHVpLCBvcmllbnRhdGlvbiwgcmVjdCwgdmFsdWUsIG1pbiwgbWF4LCBleHRlbnQpIHsKICAgICAgICB0aGlzLnVpID0gdWk7CiAgICAgICAgdGhpcy5vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOyAvLyAiaG9yaXpvbnRhbCIgb3IgInZlcnRpY2FsIgogICAgICAgIHRoaXMucmVjdCA9IHJlY3Q7ICAgICAgIC8vIHBvc2l0aW9uL3NpemUgb2YgdGhlIHNjcm9sbGJhciB0cmFjawogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsgICAgIC8vIGN1cnJlbnQgb2Zmc2V0IHZhbHVlCiAgICAgICAgdGhpcy5taW4gPSBtaW47ICAgICAgICAgLy8gbWluaW11bSBvZmZzZXQgdmFsdWUKICAgICAgICB0aGlzLm1heCA9IG1heDsgICAgICAgICAvLyBtYXhpbXVtIG9mZnNldCB2YWx1ZQogICAgICAgIHRoaXMuZXh0ZW50ID0gZXh0ZW50OyAgIC8vIHNpemUgb2YgdGhlIGN1cnJlbnQgdmlzaWJsZSBzdWJzZXQKCiAgICAgICAgdGhpcy5tb3VzZWRvd25TY3JlZW5Qb2ludDsgICAgLy8gdXNlZCBmb3Igc2Nyb2xsIGJhciBkcmFnZ2luZyB0cmFja2luZzsgcG9pbnQgYXQgd2hpY2ggdGhlIG1vdXNlZG93biBmaXJzdCBvY2N1cnJlZAogICAgICAgIHRoaXMubW91c2Vkb3duVmFsdWU7ICAgICAgICAgIC8vIHZhbHVlIGF0IHRpbWUgb2Ygc2Nyb2xsIGRyYWcgc3RhcnQKICAgIH0sCgogICAgLy8gcmV0dXJuIGEgUmVjdCBmb3IgdGhlIHNjcm9sbGJhciBoYW5kbGUKICAgIGdldEhhbmRsZUJvdW5kczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHN4ID0gKHRoaXMuaXNIKCkpID8gdGhpcy5yZWN0LnggOiB0aGlzLnJlY3QueTsKICAgICAgICB2YXIgc3cgPSAodGhpcy5pc0goKSkgPyB0aGlzLnJlY3QudyA6IHRoaXMucmVjdC5oOwoKICAgICAgICB2YXIgc211bHRpcGxlID0gdGhpcy5leHRlbnQgLyAodGhpcy5tYXggKyB0aGlzLmV4dGVudCk7CiAgICAgICAgdmFyIGFzdyA9IHNtdWx0aXBsZSAqIHN3OwogICAgICAgIGlmIChhc3cgPCB0aGlzLk1JTklNVU1fSEFORExFX1NJWkUpIGFzdyA9IHRoaXMuTUlOSU1VTV9IQU5ETEVfU0laRTsKCiAgICAgICAgc3ggKz0gKHN3IC0gYXN3KSAqICh0aGlzLnZhbHVlIC8gKHRoaXMubWF4IC0gdGhpcy5taW4pKTsKCiAgICAgICAgcmV0dXJuICh0aGlzLmlzSCgpKSA/IG5ldyBCZXNwaW4uRWRpdG9yLlJlY3QoTWF0aC5mbG9vcihzeCksIHRoaXMucmVjdC55LCBhc3csIHRoaXMucmVjdC5oKSA6IG5ldyBCZXNwaW4uRWRpdG9yLlJlY3QodGhpcy5yZWN0LngsIHN4LCB0aGlzLnJlY3QudywgYXN3KTsKICAgIH0sCgogICAgaXNIOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gKCEodGhpcy5vcmllbnRhdGlvbiA9PSB0aGlzLlZFUlRJQ0FMKSk7CiAgICB9LAoKICAgIGZpeFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA8IHRoaXMubWluKSB2YWx1ZSA9IHRoaXMubWluOwogICAgICAgIGlmICh2YWx1ZSA+IHRoaXMubWF4KSB2YWx1ZSA9IHRoaXMubWF4OwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCgogICAgb25tb3VzZXdoZWVsOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdGhpcy5zZXRWYWx1ZSh0aGlzLnZhbHVlICsgKGUuZGV0YWlsICogdGhpcy51aS5saW5lSGVpZ2h0KSk7CiAgICB9LAoKICAgIG9ubW91c2Vkb3duOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdmFyIGNsaWVudFkgPSBlLmNsaWVudFkgLSB0aGlzLnVpLmdldFRvcE9mZnNldCgpOwogICAgICAgIHZhciBjbGllbnRYID0gZS5jbGllbnRYIC0gdGhpcy51aS5nZXRMZWZ0T2Zmc2V0KCk7CgogICAgICAgIHZhciBiYXIgPSB0aGlzLmdldEhhbmRsZUJvdW5kcygpOwogICAgICAgIGlmIChiYXIuY29udGFpbnMoeyB4OiBjbGllbnRYLCB5OiBjbGllbnRZIH0pKSB7CiAgICAgICAgICAgIHRoaXMubW91c2Vkb3duU2NyZWVuUG9pbnQgPSAodGhpcy5pc0goKSkgPyBlLnNjcmVlblggOiBlLnNjcmVlblk7CiAgICAgICAgICAgIHRoaXMubW91c2Vkb3duVmFsdWUgPSB0aGlzLnZhbHVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBwID0gKHRoaXMuaXNIKCkpID8gY2xpZW50WCA6IGNsaWVudFk7CiAgICAgICAgICAgIHZhciBiMSA9ICh0aGlzLmlzSCgpKSA/IGJhci54IDogYmFyLnk7CiAgICAgICAgICAgIHZhciBiMiA9ICh0aGlzLmlzSCgpKSA/IGJhci54MiA6IGJhci55MjsKCiAgICAgICAgICAgIGlmIChwIDwgYjEpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodGhpcy52YWx1ZSAtPSB0aGlzLmV4dGVudCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocCA+IGIyKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldFZhbHVlKHRoaXMudmFsdWUgKz0gdGhpcy5leHRlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICBvbm1vdXNldXA6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB0aGlzLm1vdXNlZG93blNjcmVlblBvaW50ID0gbnVsbDsKICAgICAgICB0aGlzLm1vdXNlZG93blZhbHVlID0gbnVsbDsKICAgICAgICBpZiAodGhpcy52YWx1ZUNoYW5nZWQpIHRoaXMudmFsdWVDaGFuZ2VkKCk7IC8vIG1ha2UgdGhlIFVJIHJlc3BvbnNpdmUgd2hlbiB0aGUgdXNlciByZWxlYXNlcyB0aGUgbW91c2UgYnV0dG9uIChpbiBjYXNlIGFycm93IG5vIGxvbmdlciBob3ZlcnMgb3ZlciBzY3JvbGxiYXIpCiAgICB9LAoKICAgIG9ubW91c2Vtb3ZlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgaWYgKHRoaXMubW91c2Vkb3duU2NyZWVuUG9pbnQpIHsKICAgICAgICAgICAgdmFyIGRpZmYgPSAoKHRoaXMuaXNIKCkpID8gZS5zY3JlZW5YIDogZS5zY3JlZW5ZKSAtIHRoaXMubW91c2Vkb3duU2NyZWVuUG9pbnQ7CiAgICAgICAgICAgIHZhciBtdWx0aXBsaWVyID0gZGlmZiAvICh0aGlzLmlzSCgpID8gdGhpcy5yZWN0LncgOiB0aGlzLnJlY3QuaCk7CiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodGhpcy5tb3VzZWRvd25WYWx1ZSArIE1hdGguZmxvb3IoKCh0aGlzLm1heCArIHRoaXMuZXh0ZW50KSAtIHRoaXMubWluKSAqIG11bHRpcGxpZXIpKTsKICAgICAgICB9CiAgICB9LAoKICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgPSB0aGlzLmZpeFZhbHVlKHZhbHVlKTsKICAgICAgICBpZiAodGhpcy52YWx1ZUNoYW5nZWQpIHRoaXMudmFsdWVDaGFuZ2VkKCk7CiAgICB9Cn0pOwoKLy8gKioge3t7IEJlc3Bpbi5FZGl0b3IuUmVjdCB9fX0gKioKLy8KLy8gdHJlYXQgYXMgaW1tdXRhYmxlIChwcmV0dHkgcGxlYXNlKQpCZXNwaW4uRWRpdG9yLlJlY3QgPSBDbGFzcy5jcmVhdGUoewogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oeCwgeSwgdywgaCkgewogICAgICAgIHRoaXMueCA9IHg7CiAgICAgICAgdGhpcy55ID0geTsKICAgICAgICB0aGlzLncgPSB3OwogICAgICAgIHRoaXMuaCA9IGg7CiAgICAgICAgdGhpcy54MiA9IHggKyB3OwogICAgICAgIHRoaXMueTIgPSB5ICsgaDsKICAgIH0sCgogICAgLy8gaW5jbHVzaXZlIG9mIGJvdW5kaW5nIGxpbmVzCiAgICBjb250YWluczogZnVuY3Rpb24ocG9pbnQpIHsKICAgICAgICBpZiAoIXRoaXMueCkgcmV0dXJuIGZhbHNlOwogICAgICAgIHJldHVybiAoKHRoaXMueCA8PSBwb2ludC54KSAmJiAoKHRoaXMueCArIHRoaXMudykgPj0gcG9pbnQueCkgJiYgKHRoaXMueSA8PSBwb2ludC55KSAmJiAoKHRoaXMueSArIHRoaXMuaCkgPj0gcG9pbnQueSkpOwogICAgfQp9KTsKCi8vICoqIHt7eyBCZXNwaW4uRWRpdG9yLlNlbGVjdGlvbkhlbHBlciB9fX0gKioKCkJlc3Bpbi5FZGl0b3IuU2VsZWN0aW9uSGVscGVyID0gQ2xhc3MuY3JlYXRlKHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGVkaXRvcikgewogICAgICAgIHRoaXMuZWRpdG9yID0gZWRpdG9yOwogICAgfSwKCiAgICAvLyByZXR1cm5zIGFuIG9iamVjdCB3aXRoIHRoZSBzdGFydENvbCBhbmQgZW5kQ29sIG9mIHRoZSBzZWxlY3Rpb24uIElmIHRoZSBjb2wgaXMgLTEgb24gdGhlIGVuZFBvcywgdGhlIHNlbGVjdGlvbiBnb2VzIGZvciB0aGUgZW50aXJlIGxpbmUKICAgIC8vIHJldHVybnMgdW5kZWZpbmVkIGlmIHRoZSByb3cgaGFzIG5vIHNlbGVjdGlvbgogICAgZ2V0Um93U2VsZWN0aW9uUG9zaXRpb25zOiBmdW5jdGlvbihyb3dJbmRleCkgewogICAgICAgIHZhciBzdGFydENvbDsKICAgICAgICB2YXIgZW5kQ29sOwoKICAgICAgICB2YXIgc2VsZWN0aW9uID0gdGhpcy5lZGl0b3IuZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgaWYgKCFzZWxlY3Rpb24pIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgaWYgKChzZWxlY3Rpb24uZW5kUG9zLnJvdyA8IHJvd0luZGV4KSB8fCAoc2VsZWN0aW9uLnN0YXJ0UG9zLnJvdyA+IHJvd0luZGV4KSkgcmV0dXJuIHVuZGVmaW5lZDsKCiAgICAgICAgc3RhcnRDb2wgPSAoc2VsZWN0aW9uLnN0YXJ0UG9zLnJvdyA8IHJvd0luZGV4KSA/IDAgOiBzZWxlY3Rpb24uc3RhcnRQb3MuY29sOwogICAgICAgIGVuZENvbCA9IChzZWxlY3Rpb24uZW5kUG9zLnJvdyA+IHJvd0luZGV4KSA/IC0xIDogc2VsZWN0aW9uLmVuZFBvcy5jb2w7CgogICAgICAgIHJldHVybiB7IHN0YXJ0Q29sOiBzdGFydENvbCwgZW5kQ29sOiBlbmRDb2wgfQogICAgfQp9KTsKCi8vICoqIHt7eyBCZXNwaW4uRWRpdG9yLlV0aWxzIH19fSAqKgovLwovLyBNZXNzIHdpdGggcG9zaXRpb25zIG1haW5seQpCZXNwaW4uRWRpdG9yLlV0aWxzID0gewogICAgYXJnc1dpdGhQb3M6IGZ1bmN0aW9uKG9sZFBvcykgewogICAgICAgIHJldHVybiB7IHBvczogQmVzcGluLkVkaXRvci5VdGlscy5jb3B5UG9zKG9sZFBvcyB8fCBfZWRpdG9yLmN1cnNvclBvc2l0aW9uKSB9OyAgICAKICAgIH0sCiAgICAKICAgIGNvcHlQb3M6IGZ1bmN0aW9uKG9sZFBvcykgewogICAgICAgIHJldHVybiB7IHJvdzogb2xkUG9zLnJvdywgY29sOiBvbGRQb3MuY29sIH07CiAgICB9LAoKICAgIHBvc0VxdWFsczogZnVuY3Rpb24ocG9zMSwgcG9zMikgewogICAgICAgIGlmIChwb3MxID09IHBvczIpIHJldHVybiB0cnVlOwogICAgICAgIGlmICghcG9zMSB8fCAhcG9zMikgcmV0dXJuIGZhbHNlOwogICAgICAgIHJldHVybiAocG9zMS5jb2wgPT0gcG9zMi5jb2wpICYmIChwb3MxLnJvdyA9PSBwb3MyLnJvdyk7CiAgICB9LAoKICAgIGRpZmZPYmplY3RzOiBmdW5jdGlvbihvMSwgbzIpIHsKICAgICAgICB2YXIgZGlmZnMgPSB7fTsKCiAgICAgICAgaWYgKCFvMSB8fCAhbzIpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgCiAgICAgICAgZm9yICh2YXIga2V5IGluIG8xKSB7CiAgICAgICAgICAgIGlmIChvMltrZXldKSB7CiAgICAgICAgICAgICAgICBpZiAobzFba2V5XSAhPSBvMltrZXldKSB7CiAgICAgICAgICAgICAgICAgICAgZGlmZnNba2V5XSA9IG8xW2tleV0gKyAiID0+ICIgKyBvMltrZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGlmZnNba2V5XSA9ICJvMTogIiArIGtleSArICIgPSAiICsgbzFba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIga2V5MiBpbiBvMikgewogICAgICAgICAgICBpZiAoIW8xW2tleTJdKSB7CiAgICAgICAgICAgICAgICBkaWZmc1trZXkyXSA9ICJvMjogIiArIGtleTIgKyAiID0gIiArIG8yW2tleTJdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBkaWZmczsKICAgIH0KfQoKLy8gKioge3t7IEJlc3Bpbi5FZGl0b3IuRGVmYXVsdEVkaXRvcktleUxpc3RlbmVyIH19fSAqKgovLyAKLy8gQ29yZSBrZXkgbGlzdGVuZXIgdG8gZGVjaWRlIHdoaWNoIGFjdGlvbnMgdG8gcnVuCkJlc3Bpbi5FZGl0b3IuRGVmYXVsdEVkaXRvcktleUxpc3RlbmVyID0gQ2xhc3MuY3JlYXRlKHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGVkaXRvcikgewogICAgICAgIHRoaXMuZWRpdG9yID0gZWRpdG9yOwogICAgICAgIHRoaXMuYWN0aW9ucyA9IGVkaXRvci51aS5hY3Rpb25zOwogICAgICAgIHRoaXMuc2tpcEtleXByZXNzID0gZmFsc2U7CgogICAgICAgIHRoaXMuZGVmYXVsdEtleU1hcCA9IHt9OwoKICAgICAgICAvLyBBbGxvdyBmb3IgbXVsdGlwbGUga2V5IG1hcHMgdG8gYmUgZGVmaW5lZAogICAgICAgIHRoaXMua2V5TWFwID0gdGhpcy5kZWZhdWx0S2V5TWFwOwogICAgfSwKCiAgICBiaW5kS2V5OiBmdW5jdGlvbihrZXlDb2RlLCBtZXRhS2V5LCBjdHJsS2V5LCBhbHRLZXksIHNoaWZ0S2V5LCBhY3Rpb24pIHsKICAgICAgICB0aGlzLmRlZmF1bHRLZXlNYXBbW2tleUNvZGUsIG1ldGFLZXksIGN0cmxLZXksIGFsdEtleSwgc2hpZnRLZXldXSA9IAogICAgICAgICAgICAodHlwZW9mIGFjdGlvbiA9PSAic3RyaW5nIikgPwogICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7IAogICAgICAgICAgICAgICAgICAgIHZhciB0b0ZpcmUgPSBCZXNwaW4uRXZlbnRzLnRvRmlyZShhY3Rpb24pOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmZpcmUodG9GaXJlLm5hbWUsIHRvRmlyZS5hcmdzKTsKICAgICAgICAgICAgICAgIH0gOiBhY3Rpb24uYmluZCh0aGlzLmFjdGlvbnMpOwogICAgfSwKCiAgICBiaW5kS2V5U3RyaW5nOiBmdW5jdGlvbihtb2RpZmllcnMsIGtleUNvZGUsIGFjdGlvbikgewogICAgICAgIHZhciBjdHJsS2V5ID0gKG1vZGlmaWVycy50b1VwcGVyQ2FzZSgpLmluZGV4T2YoIkNUUkwiKSAhPSAtMSk7CiAgICAgICAgdmFyIGFsdEtleSA9IChtb2RpZmllcnMudG9VcHBlckNhc2UoKS5pbmRleE9mKCJBTFQiKSAhPSAtMSk7CiAgICAgICAgdmFyIG1ldGFLZXkgPSAobW9kaWZpZXJzLnRvVXBwZXJDYXNlKCkuaW5kZXhPZigiTUVUQSIpICE9IC0xKSB8fCAobW9kaWZpZXJzLnRvVXBwZXJDYXNlKCkuaW5kZXhPZigiQVBQTEUiKSAhPSAtMSkgfHwgKG1vZGlmaWVycy50b1VwcGVyQ2FzZSgpLmluZGV4T2YoIkNNRCIpICE9IC0xKTsKICAgICAgICB2YXIgc2hpZnRLZXkgPSAobW9kaWZpZXJzLnRvVXBwZXJDYXNlKCkuaW5kZXhPZigiU0hJRlQiKSAhPSAtMSk7CiAgICAgICAgcmV0dXJuIHRoaXMuYmluZEtleShrZXlDb2RlLCBtZXRhS2V5LCBjdHJsS2V5LCBhbHRLZXksIHNoaWZ0S2V5LCBhY3Rpb24pOwogICAgfSwKICAgIAogICAgYmluZEtleVN0cmluZ1NlbGVjdGFibGU6IGZ1bmN0aW9uKG1vZGlmaWVycywga2V5Q29kZSwgYWN0aW9uKSB7CiAgICAgICAgdGhpcy5iaW5kS2V5U3RyaW5nKG1vZGlmaWVycywga2V5Q29kZSwgYWN0aW9uKTsKICAgICAgICB0aGlzLmJpbmRLZXlTdHJpbmcoIlNISUZUICIgKyBtb2RpZmllcnMsIGtleUNvZGUsIGFjdGlvbik7CiAgICB9LAoKICAgIG9ua2V5ZG93bjogZnVuY3Rpb24oZSkgewogICAgICAgIHZhciBoYW5kbGVkID0gX2NvbW1hbmRMaW5lLmhhbmRsZUNvbW1hbmRMaW5lRm9jdXMoZSk7CiAgICAgICAgaWYgKGhhbmRsZWQpIHJldHVybiBmYWxzZTsKCiAgICAgICAgdmFyIGFyZ3MgPSB7IGV2ZW50OiBlLCBwb3M6IEJlc3Bpbi5FZGl0b3IuVXRpbHMuY29weVBvcyh0aGlzLmVkaXRvci5jdXJzb3JQb3NpdGlvbikgfQogICAgICAgIHRoaXMuc2tpcEtleXByZXNzID0gZmFsc2U7CiAgICAgICAgdGhpcy5yZXR1cm5WYWx1ZSA9IGZhbHNlOwoKICAgICAgICB2YXIgYWN0aW9uID0gdGhpcy5rZXlNYXBbW2Uua2V5Q29kZSwgZS5tZXRhS2V5LCBlLmN0cmxLZXksIGUuYWx0S2V5LCBlLnNoaWZ0S2V5XV07CgogICAgICAgIHZhciBoYXNBY3Rpb24gPSBmYWxzZTsKCiAgICAgICAgaWYgKHR5cGVvZiBhY3Rpb24gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBoYXNBY3Rpb24gPSB0cnVlOwogICAgICAgICAgICBhY3Rpb24oYXJncyk7CiAgICAgICAgICAgIHRoaXMubGFzdEFjdGlvbiA9IGFjdGlvbjsKICAgICAgICB9CgogICAgICAgIGlmIChlLm1ldGFLZXkgfHwgZS5jdHJsS2V5IHx8IGUuYWx0S2V5KSB7CiAgICAgICAgICAgIHRoaXMuc2tpcEtleXByZXNzID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5yZXR1cm5WYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGlmIChoYXNBY3Rpb24gfHwgIUJlc3Bpbi5LZXkucGFzc1Rocm91Z2hUb0Jyb3dzZXIoZSkpIEV2ZW50LnN0b3AoZSk7IC8vIHN0b3AgZ29pbmcsIGJ1dCBhbGxvdyBzcGVjaWFsIHN0cm9rZXMgdG8gZ2V0IHRvIHRoZSBicm93c2VyCiAgICAgICAgfQoKICAgIH0sCgogICAgb25rZXlwcmVzczogZnVuY3Rpb24oZSkgewogICAgICAgIHZhciBoYW5kbGVkID0gX2NvbW1hbmRMaW5lLmhhbmRsZUNvbW1hbmRMaW5lRm9jdXMoZSk7CiAgICAgICAgaWYgKGhhbmRsZWQpIHJldHVybiBmYWxzZTsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5za2lwS2V5cHJlc3MpIHJldHVybiB0aGlzLnJldHVyblZhbHVlOwoKICAgICAgICB2YXIgYXJncyA9IHsgZXZlbnQ6IGUsIHBvczogQmVzcGluLkVkaXRvci5VdGlscy5jb3B5UG9zKHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uKSB9OwogICAgICAgIHZhciBhY3Rpb25zID0gdGhpcy5lZGl0b3IudWkuYWN0aW9uczsKCiAgICAgICAgLy8gT25seSBhbGxvdyBhc2NpaSB0aHJvdWdoCiAgICAgICAgaWYgKChlLmNoYXJDb2RlID49IDMyKSAmJiAoZS5jaGFyQ29kZSA8PSAxMjYpKSB7CiAgICAgICAgICAgIGFyZ3MubmV3Y2hhciA9IFN0cmluZy5mcm9tQ2hhckNvZGUoZS5jaGFyQ29kZSk7CiAgICAgICAgICAgIGFjdGlvbnMuaW5zZXJ0Q2hhcmFjdGVyKGFyZ3MpOwogICAgICAgIH0gZWxzZSB7IC8vIEFsbG93IHVzZXIgdG8gbW92ZSB3aXRoIHRoZSBhcnJvdyBjb250aW51b3VzbHkKICAgICAgICAgICAgdmFyIGFjdGlvbiA9IHRoaXMua2V5TWFwW1tlLmtleUNvZGUsIGUubWV0YUtleSwgZS5jdHJsS2V5LCBlLmFsdEtleSwgZS5zaGlmdEtleV1dOwoKICAgICAgICAgICAgaWYgKHRoaXMubGFzdEFjdGlvbiA9PSBhY3Rpb24pIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmxhc3RBY3Rpb247CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFjdGlvbiA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgIGFjdGlvbihhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgRXZlbnQuc3RvcChlKTsKICAgIH0KfSk7CgoKLy8gKioge3t7IEJlc3Bpbi5FZGl0b3IuVUkgfX19ICoqCi8vCi8vIEhvbGRzIHRoZSBVSS4gVGhlIGVkaXRvciBpdHNlbGYsIHRoZSBzeW50YXggaGlnaGxpZ2h0ZXIsIHRoZSBhY3Rpb25zLCBhbmQgbW9yZQpCZXNwaW4uRWRpdG9yLlVJID0gQ2xhc3MuY3JlYXRlKHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGVkaXRvcikgewogICAgICAgIHRoaXMuZWRpdG9yID0gZWRpdG9yOwogICAgICAgIHRoaXMuc3ludGF4TW9kZWwgPSBuZXcgQmVzcGluLlN5bnRheC5Nb2RlbChlZGl0b3IpOwogICAgICAgIHRoaXMuc2VsZWN0aW9uSGVscGVyID0gbmV3IEJlc3Bpbi5FZGl0b3IuU2VsZWN0aW9uSGVscGVyKGVkaXRvcik7CiAgICAgICAgdGhpcy5hY3Rpb25zID0gbmV3IEJlc3Bpbi5FZGl0b3IuQWN0aW9ucyhlZGl0b3IpOwoKICAgICAgICB0aGlzLnRvZ2dsZUN1cnNvckZ1bGxSZXBhaW50Q291bnRlciA9IDA7ICAgIC8vIHRyYWNrcyBob3cgbWFueSBjdXJzb3IgdG9nZ2xlcyBzaW5jZSB0aGUgbGFzdCBmdWxsIHJlcGFpbnQKCiAgICAgICAgLy8gdGhlc2UgdHdvIGNhbnZhc2VzIGFyZSB1c2VkIGFzIGJ1ZmZlcnMgZm9yIHRoZSBzY3JvbGxiYXIgaW1hZ2VzLCB3aGljaCBhcmUgdGhlbiBjb21wb3NpdGVkIG9udG8gdGhlCiAgICAgICAgLy8gbWFpbiBjb2RlIHZpZXcuIHdlIGNvdWxkIGhhdmUgc2F2ZWQgb3Vyc2VsdmVzIHNvbWUgbWlzZXJ5IGJ5IGp1c3QgcHJlcmVuZGVyaW5nIHNsaWNlcyBvZiB0aGUgc2Nyb2xsYmFycyBhbmQKICAgICAgICAvLyBjb21iaW5pbmcgdGhlbSBsaWtlIHNhbmUgcGVvcGxlLCBidXQuLi4gbWVoCiAgICAgICAgdGhpcy5ob3Jpem9udGFsU2Nyb2xsQ2FudmFzID0gbmV3IEVsZW1lbnQoImNhbnZhcyIpOwogICAgICAgIHRoaXMudmVydGljYWxTY3JvbGxDYW52YXMgPSBuZXcgRWxlbWVudCgiY2FudmFzIik7CgogICAgICAgIHRoaXMuR1VUVEVSX1dJRFRIID0gNTQ7CiAgICAgICAgdGhpcy5MSU5FX0hFSUdIVCA9IDIzOwogICAgICAgIHRoaXMuR1VUVEVSX0lOU0VUUyA9IHsgdG9wOiAwLCBsZWZ0OiA2LCByaWdodDogMCwgYm90dG9tOiA2IH0KICAgICAgICB0aGlzLkxJTkVfSU5TRVRTID0geyB0b3A6IDAsIGxlZnQ6IDUsIHJpZ2h0OiAwLCBib3R0b206IDYgfQogICAgICAgIHRoaXMuRkFMTEJBQ0tfQ0hBUkFDVEVSX1dJRFRIID0gMTA7CiAgICAgICAgdGhpcy5OSUJfV0lEVEggPSAxNTsKICAgICAgICB0aGlzLk5JQl9JTlNFVFMgPSB7IHRvcDogTWF0aC5mbG9vcih0aGlzLk5JQl9XSURUSCAvIDIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogTWF0aC5mbG9vcih0aGlzLk5JQl9XSURUSCAvIDIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHQ6IE1hdGguZmxvb3IodGhpcy5OSUJfV0lEVEggLyAyKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvdHRvbTogTWF0aC5mbG9vcih0aGlzLk5JQl9XSURUSCAvIDIpIH0KICAgICAgICB0aGlzLk5JQl9BUlJPV19JTlNFVFMgPSB7IHRvcDogMywgbGVmdDogMywgcmlnaHQ6IDMsIGJvdHRvbTogNSB9CgogICAgICAgIHRoaXMubGluZUhlaWdodDsgICAgICAgIC8vIHJlc2VydmVkIGZvciB3aGVuIGxpbmUgaGVpZ2h0IGlzIGNhbGN1bGF0ZWQgZHluYW1pY2FsbHkgaW5zdGVhZCBvZiB3aXRoIGEgY29uc3RhbnQ7IHNldCBmaXJzdCB0aW1lIGEgcGFpbnQgb2NjdXJzCiAgICAgICAgdGhpcy5jaGFyV2lkdGg7ICAgICAgICAgLy8gc2V0IGZpcnN0IHRpbWUgYSBwYWludCBvY2N1cnMKICAgICAgICB0aGlzLnZpc2libGVSb3dzOyAgICAgICAvLyB0aGUgbnVtYmVyIG9mIHJvd3MgdmlzaWJsZSBpbiB0aGUgZWRpdG9yOyBzZXQgZWFjaCB0aW1lIGEgcGFpbnQgb2NjdXJzCiAgICAgICAgdGhpcy5maXJzdFZpc2libGVSb3c7ICAgLy8gZmlyc3Qgcm93IHRoYXQgaXMgdmlzaWJsZSBpbiB0aGUgZWRpdG9yOyBzZXQgZWFjaCB0aW1lIGEgcGFpbnQgb2NjdXJzCiAgICAgICAgdGhpcy5uaWJ1cDsgICAgICAgICAgICAgLy8gcmVjdAogICAgICAgIHRoaXMubmliZG93bjsgICAgICAgICAgIC8vIHJlY3QKICAgICAgICB0aGlzLm5pYmxlZnQ7ICAgICAgICAgICAvLyByZWN0CiAgICAgICAgdGhpcy5uaWJyaWdodDsgICAgICAgICAgLy8gcmVjdAoKICAgICAgICB0aGlzLnNlbGVjdE1vdXNlRG93blBvczsgICAgICAgIC8vIHBvc2l0aW9uIHdoZW4gdGhlIHVzZXIgbW91c2VkIGRvd24KCiAgICAgICAgdGhpcy54b2Zmc2V0ID0gMDsgICAgICAgLy8gbnVtYmVyIG9mIHBpeGVscyB0byB0cmFuc2xhdGUgdGhlIGNhbnZhcyBmb3Igc2Nyb2xsaW5nCiAgICAgICAgdGhpcy55b2Zmc2V0ID0gMDsKCiAgICAgICAgdGhpcy5zaG93Q3Vyc29yID0gdHJ1ZTsKCiAgICAgICAgdGhpcy5vdmVyWFNjcm9sbEJhciA9IGZhbHNlOwogICAgICAgIHRoaXMub3ZlcllTY3JvbGxCYXIgPSBmYWxzZTsKICAgICAgICB0aGlzLmhhc0ZvY3VzID0gZmFsc2U7CgogICAgICAgIHZhciBzb3VyY2UgPSB0aGlzLmVkaXRvci5jb250YWluZXI7CiAgICAgICAgRXZlbnQub2JzZXJ2ZShzb3VyY2UsICJtb3VzZW1vdmUiLCB0aGlzLmhhbmRsZVNjcm9sbEJhcnMuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzKSk7CiAgICAgICAgRXZlbnQub2JzZXJ2ZShzb3VyY2UsICJtb3VzZW91dCIsIHRoaXMuaGFuZGxlU2Nyb2xsQmFycy5iaW5kQXNFdmVudExpc3RlbmVyKHRoaXMpKTsKICAgICAgICBFdmVudC5vYnNlcnZlKHNvdXJjZSwgImNsaWNrIiwgdGhpcy5oYW5kbGVTY3JvbGxCYXJzLmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcykpOwogICAgICAgIEV2ZW50Lm9ic2VydmUoc291cmNlLCAibW91c2Vkb3duIiwgdGhpcy5oYW5kbGVTY3JvbGxCYXJzLmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcykpOwoKICAgICAgICBFdmVudC5vYnNlcnZlKHNvdXJjZSwgIm1vdXNlZG93biIsIHRoaXMubW91c2VEb3duU2VsZWN0LmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcykpOwogICAgICAgIEV2ZW50Lm9ic2VydmUoc291cmNlLCAibW91c2Vtb3ZlIiwgdGhpcy5tb3VzZU1vdmVTZWxlY3QuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzKSk7CiAgICAgICAgRXZlbnQub2JzZXJ2ZShzb3VyY2UsICJtb3VzZXVwIiwgdGhpcy5tb3VzZVVwU2VsZWN0LmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcykpOwoKICAgICAgICAvLyBwYWludGluZyBvcHRpbWl6YXRpb24gc3RhdGUKICAgICAgICB0aGlzLmxhc3RMaW5lQ291bnQgPSAwOwogICAgICAgIHRoaXMubGFzdEN1cnNvclBvcyA9IG51bGw7CiAgICAgICAgdGhpcy5sYXN0eG9mZnNldCA9IDA7CiAgICAgICAgdGhpcy5sYXN0eW9mZnNldCA9IDA7CgogICAgICAgIHRoaXMueHNjcm9sbGJhciA9IG5ldyBCZXNwaW4uRWRpdG9yLlNjcm9sbGJhcih0aGlzLCAiaG9yaXpvbnRhbCIpOwogICAgICAgIHRoaXMueHNjcm9sbGJhci52YWx1ZUNoYW5nZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy54b2Zmc2V0ID0gLXRoaXMueHNjcm9sbGJhci52YWx1ZTsKICAgICAgICAgICAgdGhpcy5lZGl0b3IucGFpbnQoKTsKICAgICAgICB9LmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcyk7CiAgICAgICAgRXZlbnQub2JzZXJ2ZSh3aW5kb3csICJtb3VzZW1vdmUiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMueHNjcm9sbGJhci5vbm1vdXNlbW92ZShlKTsKICAgICAgICB9LmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcykpOwogICAgICAgIEV2ZW50Lm9ic2VydmUod2luZG93LCAibW91c2V1cCIsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhpcy54c2Nyb2xsYmFyLm9ubW91c2V1cChlKTsKICAgICAgICB9LmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcykpOwoKICAgICAgICB0aGlzLnlzY3JvbGxiYXIgPSBuZXcgQmVzcGluLkVkaXRvci5TY3JvbGxiYXIodGhpcywgInZlcnRpY2FsIik7CiAgICAgICAgdGhpcy55c2Nyb2xsYmFyLnZhbHVlQ2hhbmdlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnlvZmZzZXQgPSAtdGhpcy55c2Nyb2xsYmFyLnZhbHVlOwogICAgICAgICAgICB0aGlzLmVkaXRvci5wYWludCgpOwogICAgICAgIH0uYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzKTsKICAgICAgICBFdmVudC5vYnNlcnZlKHdpbmRvdywgIm1vdXNlbW92ZSIsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhpcy55c2Nyb2xsYmFyLm9ubW91c2Vtb3ZlKGUpOwogICAgICAgIH0uYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzKSk7CiAgICAgICAgRXZlbnQub2JzZXJ2ZSh3aW5kb3csICJtb3VzZXVwIiwgZnVuY3Rpb24oZSkgewogICAgICAgICAgICB0aGlzLnlzY3JvbGxiYXIub25tb3VzZXVwKGUpOwogICAgICAgIH0uYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzKSk7CiAgICAgICAgRXZlbnQub2JzZXJ2ZSh3aW5kb3csICJET01Nb3VzZVNjcm9sbCIsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhpcy55c2Nyb2xsYmFyLm9ubW91c2V3aGVlbChlKTsKICAgICAgICB9LmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcykpOwoKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyB0aGlzLnRvZ2dsZUN1cnNvcih0aGlzKSB9LmJpbmQodGhpcyksIDI1MCk7CiAgICB9LAoKICAgIC8vIGNvbCBpcyAtMSBpZiB1c2VyIGNsaWNrZWQgaW4gZ3V0dGVyOyBjbGlja2luZyBiZWxvdyBsYXN0IGxpbmUgbWFwcyB0byBsYXN0IGxpbmUKICAgIGNvbnZlcnRDbGllbnRQb2ludFRvQ3Vyc29yUG9pbnQ6IGZ1bmN0aW9uKHBvcykgewogICAgICAgIHZhciB4LCB5OwoKICAgICAgICBpZiAoeSA+ICh0aGlzLmxpbmVIZWlnaHQgKiB0aGlzLmVkaXRvci5tb2RlbC5nZXRSb3dDb3VudCgpKSkgewogICAgICAgICAgICB5ID0gdGhpcy5lZGl0b3IubW9kZWwuZ2V0Um93Q291bnQoKSAtIDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHR5ID0gcG9zLnk7CiAgICAgICAgICAgIHkgPSBNYXRoLmZsb29yKHR5IC8gdGhpcy5saW5lSGVpZ2h0KTsKICAgICAgICB9CgogICAgICAgIGlmIChwb3MueCA8PSAodGhpcy5HVVRURVJfV0lEVEggKyB0aGlzLkxJTkVfSU5TRVRTLmxlZnQpKSB7CiAgICAgICAgICAgIHggPSAtMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdHggPSBwb3MueCAtIHRoaXMuR1VUVEVSX1dJRFRIIC0gdGhpcy5MSU5FX0lOU0VUUy5sZWZ0OwogICAgICAgICAgICB4ID0gTWF0aC5mbG9vcih0eCAvIHRoaXMuY2hhcldpZHRoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFdpdGggc3RyaWNsaW5lcyB0dXJuZWQgb24sIGRvbid0IHNlbGVjdCBwYXN0IHRoZSBlbmQgb2YgdGhlIGxpbmUKICAgICAgICAgICAgaWYgKF9zZXR0aW5ncy5pc09uKF9zZXR0aW5ncy5nZXQoJ3N0cmljdGxpbmVzJykpKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF4Y29sID0gdGhpcy5lZGl0b3IubW9kZWwuZ2V0Um93TGVuZ3RoKHkpOwogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh4ID49IG1heGNvbCkgewogICAgICAgICAgICAgICAgICAgIHggPSB0aGlzLmVkaXRvci5tb2RlbC5nZXRSb3dMZW5ndGgoeSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsgY29sOiB4LCByb3c6IHkgfTsKICAgIH0sCgogICAgbW91c2VEb3duU2VsZWN0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgdmFyIGNsaWVudFkgPSBlLmNsaWVudFkgLSB0aGlzLmdldFRvcE9mZnNldCgpOwogICAgICAgIHZhciBjbGllbnRYID0gZS5jbGllbnRYIC0gdGhpcy5nZXRMZWZ0T2Zmc2V0KCk7CgogICAgICAgIGlmICh0aGlzLm92ZXJYU2Nyb2xsQmFyIHx8IHRoaXMub3ZlcllTY3JvbGxCYXIpIHJldHVybjsKCiAgICAgICAgaWYgKGUuc2hpZnRLZXkpIHsKICAgICAgICAgICAgdGhpcy5zZWxlY3RNb3VzZURvd25Qb3MgPSAodGhpcy5lZGl0b3Iuc2VsZWN0aW9uKSA/IHRoaXMuZWRpdG9yLnNlbGVjdGlvbi5zdGFydFBvcyA6IHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uOwogICAgICAgICAgICB0aGlzLnNldFNlbGVjdGlvbihlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcG9pbnQgPSB7IHg6IGNsaWVudFgsIHk6IGNsaWVudFkgfTsKICAgICAgICAgICAgcG9pbnQueCArPSBNYXRoLmFicyh0aGlzLnhvZmZzZXQpOwogICAgICAgICAgICBwb2ludC55ICs9IE1hdGguYWJzKHRoaXMueW9mZnNldCk7CgogICAgICAgICAgICBpZiAoKHRoaXMueHNjcm9sbGJhci5yZWN0LmNvbnRhaW5zKHBvaW50KSkgfHwgKHRoaXMueXNjcm9sbGJhci5yZWN0LmNvbnRhaW5zKHBvaW50KSkpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5zZWxlY3RNb3VzZURvd25Qb3MgPSB0aGlzLmNvbnZlcnRDbGllbnRQb2ludFRvQ3Vyc29yUG9pbnQocG9pbnQpOwogICAgICAgIH0KICAgIH0sCgogICAgbW91c2VNb3ZlU2VsZWN0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgdGhpcy5zZXRTZWxlY3Rpb24oZSk7CiAgICB9LAoKICAgIG1vdXNlVXBTZWxlY3Q6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB0aGlzLnNldFNlbGVjdGlvbihlKTsKICAgICAgICB0aGlzLnNlbGVjdE1vdXNlRG93blBvcyA9IHVuZGVmaW5lZDsKICAgIH0sCgogICAgc2V0U2VsZWN0aW9uOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdmFyIGNsaWVudFkgPSBlLmNsaWVudFkgLSB0aGlzLmdldFRvcE9mZnNldCgpOwogICAgICAgIHZhciBjbGllbnRYID0gZS5jbGllbnRYIC0gdGhpcy5nZXRMZWZ0T2Zmc2V0KCk7CgogICAgICAgIGlmICghdGhpcy5zZWxlY3RNb3VzZURvd25Qb3MpIHJldHVybjsKCiAgICAgICAgdmFyIGRvd24gPSBCZXNwaW4uRWRpdG9yLlV0aWxzLmNvcHlQb3ModGhpcy5zZWxlY3RNb3VzZURvd25Qb3MpOwoKICAgICAgICB2YXIgcG9pbnQgPSB7IHg6IGNsaWVudFgsIHk6IGNsaWVudFkgfTsKICAgICAgICBwb2ludC54ICs9IE1hdGguYWJzKHRoaXMueG9mZnNldCk7CiAgICAgICAgcG9pbnQueSArPSBNYXRoLmFicyh0aGlzLnlvZmZzZXQpOwogICAgICAgIHZhciB1cCA9IHRoaXMuY29udmVydENsaWVudFBvaW50VG9DdXJzb3JQb2ludChwb2ludCk7CgogICAgICAgIGlmIChkb3duLmNvbCA9PSAtMSkgZG93bi5jb2wgPSAwOwogICAgICAgIGlmICh1cC5jb2wgPT0gLTEpIHVwLmNvbCA9IDA7CgogICAgICAgIGlmICghQmVzcGluLkVkaXRvci5VdGlscy5wb3NFcXVhbHMoZG93biwgdXApKSB7CiAgICAgICAgICAgIHRoaXMuZWRpdG9yLnNldFNlbGVjdGlvbih7IHN0YXJ0UG9zOiBkb3duLCBlbmRQb3M6IHVwIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChlLmRldGFpbCA9PSAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRTZWxlY3Rpb24odW5kZWZpbmVkKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlLmRldGFpbCA9PSAyKSB7CiAgICAgICAgICAgICAgICB2YXIgcm93ID0gdGhpcy5lZGl0b3IubW9kZWwucm93c1tkb3duLnJvd107CiAgICAgICAgICAgICAgICB2YXIgY3Vyc29yQXQgPSByb3dbZG93bi5jb2xdOwogICAgICAgICAgICAgICAgaWYgKCFjdXJzb3JBdCB8fCBjdXJzb3JBdC5jaGFyQXQoMCkgPT0gJyAnKSB7IC8vIGVtcHR5IHNwYWNlCiAgICAgICAgICAgICAgICAgICAgLy8gRm9yIG5vdywgZG9uJ3Qgc2VsZWN0IGFueXRoaW5nLCBidXQgdGhpbmsgYWJvdXQgY29weWluZyBUZXh0bWF0ZSBhbmQgZ3JhYmJpbmcgYXJvdW5kIGl0CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGFydFBvcyA9IHVwID0gdGhpcy5lZGl0b3IubW9kZWwuZmluZEJlZm9yZShkb3duLnJvdywgZG93bi5jb2wpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZhciBlbmRQb3MgPSB0aGlzLmVkaXRvci5tb2RlbC5maW5kQWZ0ZXIoZG93bi5yb3csIGRvd24uY29sKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRTZWxlY3Rpb24oeyBzdGFydFBvczogc3RhcnRQb3MsIGVuZFBvczogZW5kUG9zIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGUuZGV0YWlsID4gMikgewogICAgICAgICAgICAgICAgLy8gc2VsZWN0IHRoZSBsaW5lCiAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRTZWxlY3Rpb24oeyBzdGFydFBvczogeyByb3c6IGRvd24ucm93LCBjb2w6IDAgfSwgZW5kUG9zOiB7IHJvdzogZG93bi5yb3cgKyAxLCBjb2w6IDAgfSB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5lZGl0b3IubW92ZUN1cnNvcih1cCk7CiAgICAgICAgdGhpcy5lZGl0b3IucGFpbnQoKTsKICAgIH0sCgogICAgdG9nZ2xlQ3Vyc29yOiBmdW5jdGlvbih1aSkgewogICAgICAgIHVpLnNob3dDdXJzb3IgPSAhdWkuc2hvd0N1cnNvcjsKCiAgICAgICAgaWYgKCsrdGhpcy50b2dnbGVDdXJzb3JGdWxsUmVwYWludENvdW50ZXIgPiAwKSB7CiAgICAgICAgICAgIHRoaXMudG9nZ2xlQ3Vyc29yRnVsbFJlcGFpbnRDb3VudGVyID0gMDsKICAgICAgICAgICAgdWkuZWRpdG9yLnBhaW50KHRydWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVpLmVkaXRvci5wYWludCgpOwogICAgICAgIH0KCiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsgdWkudG9nZ2xlQ3Vyc29yKHVpKSB9LCAyNTApOwogICAgfSwKCiAgICBlbnN1cmVDdXJzb3JWaXNpYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoKCF0aGlzLmxpbmVIZWlnaHQpIHx8ICghdGhpcy5jaGFyV2lkdGgpKSByZXR1cm47ICAgIC8vIGNhbid0IGRvIG11Y2ggd2l0aG91dCB0aGVzZQoKICAgICAgICB2YXIgeSA9IHRoaXMubGluZUhlaWdodCAqIHRoaXMuZWRpdG9yLmN1cnNvclBvc2l0aW9uLnJvdzsKICAgICAgICB2YXIgeCA9IHRoaXMuY2hhcldpZHRoICogdGhpcy5lZGl0b3IuY3Vyc29yUG9zaXRpb24uY29sOwoKICAgICAgICB2YXIgY2hlaWdodCA9IHRoaXMuZ2V0SGVpZ2h0KCk7CiAgICAgICAgdmFyIGN3aWR0aCA9IHRoaXMuZ2V0V2lkdGgoKSAtIHRoaXMuR1VUVEVSX1dJRFRIOwoKICAgICAgICBpZiAoTWF0aC5hYnModGhpcy55b2Zmc2V0KSA+IHkpIHsgICAgICAgICAgICAgICAvLyBjdXJyZW50IHJvdyBiZWZvcmUgdG9wLW1vc3QgdmlzaWJsZSByb3cKICAgICAgICAgICAgdGhpcy55b2Zmc2V0ID0gLXk7CiAgICAgICAgfSBlbHNlIGlmICgoTWF0aC5hYnModGhpcy55b2Zmc2V0KSArIGNoZWlnaHQpIDwgKHkgKyB0aGlzLmxpbmVIZWlnaHQpKSB7ICAgICAgIC8vIGN1cnJlbnQgcm93IGFmdGVyIGJvdHRvbS1tb3N0IHZpc2libGUgcm93CiAgICAgICAgICAgIHRoaXMueW9mZnNldCA9IC0oKHkgKyB0aGlzLmxpbmVIZWlnaHQpIC0gY2hlaWdodCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoTWF0aC5hYnModGhpcy54b2Zmc2V0KSA+IHgpIHsgICAgICAgICAgICAgICAvLyBjdXJyZW50IGNvbCBiZWZvcmUgbGVmdC1tb3N0IHZpc2libGUgY29sCiAgICAgICAgICAgIHRoaXMueG9mZnNldCA9IC14OwogICAgICAgIH0gZWxzZSBpZiAoKE1hdGguYWJzKHRoaXMueG9mZnNldCkgKyBjd2lkdGgpIDwgKHggKyAodGhpcy5jaGFyV2lkdGggKiAyKSkpIHsgLy8gY3VycmVudCBjb2wgYWZ0ZXIgcmlnaHQtbW9zdCB2aXNpYmxlIGNvbAogICAgICAgICAgICB0aGlzLnhvZmZzZXQgPSAtKCh4ICsgKHRoaXMuY2hhcldpZHRoICogMikpIC0gY3dpZHRoKTsKICAgICAgICB9CiAgICB9LAoKICAgIGhhbmRsZUZvY3VzOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdGhpcy5lZGl0b3IubW9kZWwuY2xlYXIoKTsKICAgICAgICB0aGlzLmVkaXRvci5tb2RlbC5pbnNlcnRDaGFyYWN0ZXJzKHsgcm93OiAwLCBjb2w6IDB9LCBlLnR5cGUpOwogICAgfSwKICAgIAogICAgaGFuZGxlU2Nyb2xsQmFyczogZnVuY3Rpb24oZSkgewogICAgICAgIHZhciBjbGllbnRZID0gZS5jbGllbnRZIC0gdGhpcy5nZXRUb3BPZmZzZXQoKTsKICAgICAgICB2YXIgY2xpZW50WCA9IGUuY2xpZW50WCAtIHRoaXMuZ2V0TGVmdE9mZnNldCgpOwoKICAgICAgICB2YXIgb2xkWCA9IHRoaXMub3ZlclhTY3JvbGxCYXI7CiAgICAgICAgdmFyIG9sZFkgPSB0aGlzLm92ZXJZU2Nyb2xsQmFyOwogICAgICAgIHZhciBzY3JvbGxlZCA9IGZhbHNlOwoKICAgICAgICB2YXIgdyA9IHRoaXMuZWRpdG9yLmNvbnRhaW5lci5jbGllbnRXaWR0aDsKICAgICAgICB2YXIgaCA9IHRoaXMuZWRpdG9yLmNvbnRhaW5lci5jbGllbnRIZWlnaHQ7CiAgICAgICAgdmFyIHN4ID0gdyAtIHRoaXMuTklCX1dJRFRIIC0gdGhpcy5OSUJfSU5TRVRTLnJpZ2h0OyAgICAvLyB4IHN0YXJ0IG9mIHRoZSB2ZXJ0LiBzY3JvbGwgYmFyCiAgICAgICAgdmFyIHN5ID0gaCAtIHRoaXMuTklCX1dJRFRIIC0gdGhpcy5OSUJfSU5TRVRTLmJvdHRvbTsgICAvLyB5IHN0YXJ0IG9mIHRoZSBob3IuIHNjcm9sbCBiYXIKCiAgICAgICAgdmFyIHAgPSB7IHg6IGNsaWVudFgsIHk6Y2xpZW50WSB9OwoKICAgICAgICBpZiAoZS50eXBlID09ICJtb3VzZWRvd24iKSB7CiAgICAgICAgICAgIC8vIGRpc3BhdGNoIHRvIHRoZSBzY3JvbGxiYXJzCiAgICAgICAgICAgIGlmICgodGhpcy54c2Nyb2xsYmFyKSAmJiAodGhpcy54c2Nyb2xsYmFyLnJlY3QuY29udGFpbnMocCkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnhzY3JvbGxiYXIub25tb3VzZWRvd24oZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKHRoaXMueXNjcm9sbGJhcikgJiYgKHRoaXMueXNjcm9sbGJhci5yZWN0LmNvbnRhaW5zKHApKSkgewogICAgICAgICAgICAgICAgdGhpcy55c2Nyb2xsYmFyLm9ubW91c2Vkb3duKGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoZS50eXBlID09ICJtb3VzZW91dCIpIHsKICAgICAgICAgICAgdGhpcy5vdmVyWFNjcm9sbEJhciA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm92ZXJZU2Nyb2xsQmFyID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoKGUudHlwZSA9PSAibW91c2Vtb3ZlIikgfHwgKGUudHlwZSA9PSAiY2xpY2siKSkgewogICAgICAgICAgICB0aGlzLm92ZXJZU2Nyb2xsQmFyID0gcC54ID4gc3g7CiAgICAgICAgICAgIHRoaXMub3ZlclhTY3JvbGxCYXIgPSBwLnkgPiBzeTsKICAgICAgICB9CgogICAgICAgIGlmIChlLnR5cGUgPT0gImNsaWNrIikgewogICAgICAgICAgICBpZiAoRXZlbnQuaXNMZWZ0Q2xpY2soZSkpIHsKCiAgICAgICAgICAgICAgICB2YXIgYnV0dG9uOwogICAgICAgICAgICAgICAgaWYgKHRoaXMubmlidXAuY29udGFpbnMocCkpIHsKICAgICAgICAgICAgICAgICAgICBidXR0b24gPSAidXAiOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLm5pYmRvd24uY29udGFpbnMocCkpIHsKICAgICAgICAgICAgICAgICAgICBidXR0b24gPSAiZG93biI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubmlibGVmdC5jb250YWlucyhwKSkgewogICAgICAgICAgICAgICAgICAgIGJ1dHRvbiA9ICJsZWZ0IjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5uaWJyaWdodC5jb250YWlucyhwKSkgewogICAgICAgICAgICAgICAgICAgIGJ1dHRvbiA9ICJyaWdodCI7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGJ1dHRvbiA9PSAidXAiKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy55b2Zmc2V0ICs9IHRoaXMubGluZUhlaWdodDsKICAgICAgICAgICAgICAgICAgICBzY3JvbGxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGJ1dHRvbiA9PSAiZG93biIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnlvZmZzZXQgLT0gdGhpcy5saW5lSGVpZ2h0OwogICAgICAgICAgICAgICAgICAgIHNjcm9sbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYnV0dG9uID09ICJsZWZ0IikgewogICAgICAgICAgICAgICAgICAgIHRoaXMueG9mZnNldCArPSB0aGlzLmNoYXJXaWR0aCAqIDI7CiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChidXR0b24gPT0gInJpZ2h0IikgewogICAgICAgICAgICAgICAgICAgIHRoaXMueG9mZnNldCAtPSB0aGlzLmNoYXJXaWR0aCAqIDI7CiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoKG9sZFggIT0gdGhpcy5vdmVyWFNjcm9sbEJhcikgfHwgKG9sZFkgIT0gdGhpcy5vdmVyWVNjcm9sbEJhcikgfHwgc2Nyb2xsZWQpIHRoaXMuZWRpdG9yLnBhaW50KCk7CiAgICB9LAoKICAgIGluc3RhbGxLZXlMaXN0ZW5lcjogZnVuY3Rpb24obGlzdGVuZXIpIHsKICAgICAgICB2YXIgS2V5ID0gQmVzcGluLktleTsgLy8gYWxpYXMKCiAgICAgICAgaWYgKHRoaXMub2xka2V5ZG93bikgRXZlbnQuc3RvcE9ic2VydmluZyhkb2N1bWVudCwgImtleWRvd24iLCB0aGlzLm9sZGtleWRvd24pOwogICAgICAgIGlmICh0aGlzLm9sZGtleXByZXNzKSBFdmVudC5zdG9wT2JzZXJ2aW5nKGRvY3VtZW50LCAia2V5cHJlc3MiLCB0aGlzLm9sZGtleXByZXNzKTsKCiAgICAgICAgdGhpcy5vbGRrZXlkb3duID0gbGlzdGVuZXIub25rZXlkb3duLmJpbmRBc0V2ZW50TGlzdGVuZXIobGlzdGVuZXIpOwogICAgICAgIHRoaXMub2xka2V5cHJlc3MgPSBsaXN0ZW5lci5vbmtleXByZXNzLmJpbmRBc0V2ZW50TGlzdGVuZXIobGlzdGVuZXIpOwoKICAgICAgICBFdmVudC5vYnNlcnZlKGRvY3VtZW50LCAia2V5ZG93biIsIHRoaXMub2xka2V5ZG93bik7CiAgICAgICAgRXZlbnQub2JzZXJ2ZShkb2N1bWVudCwgImtleXByZXNzIiwgdGhpcy5vbGRrZXlwcmVzcyk7CgogICAgICAgIC8vIE1vZGlmaWVycywgS2V5LCBBY3Rpb24KICAgICAgICAKICAgICAgICBsaXN0ZW5lci5iaW5kS2V5U3RyaW5nU2VsZWN0YWJsZSgiIiwgS2V5LkFSUk9XX0xFRlQsIHRoaXMuYWN0aW9ucy5tb3ZlQ3Vyc29yTGVmdCk7CiAgICAgICAgbGlzdGVuZXIuYmluZEtleVN0cmluZ1NlbGVjdGFibGUoIiIsIEtleS5BUlJPV19SSUdIVCwgdGhpcy5hY3Rpb25zLm1vdmVDdXJzb3JSaWdodCk7CiAgICAgICAgbGlzdGVuZXIuYmluZEtleVN0cmluZ1NlbGVjdGFibGUoIiIsIEtleS5BUlJPV19VUCwgdGhpcy5hY3Rpb25zLm1vdmVDdXJzb3JVcCk7CiAgICAgICAgbGlzdGVuZXIuYmluZEtleVN0cmluZ1NlbGVjdGFibGUoIiIsIEtleS5BUlJPV19ET1dOLCB0aGlzLmFjdGlvbnMubW92ZUN1cnNvckRvd24pOwoKICAgICAgICBsaXN0ZW5lci5iaW5kS2V5U3RyaW5nU2VsZWN0YWJsZSgiQUxUIiwgS2V5LkFSUk9XX0xFRlQsIHRoaXMuYWN0aW9ucy5tb3ZlV29yZExlZnQpOwogICAgICAgIGxpc3RlbmVyLmJpbmRLZXlTdHJpbmdTZWxlY3RhYmxlKCJBTFQiLCBLZXkuQVJST1dfUklHSFQsIHRoaXMuYWN0aW9ucy5tb3ZlV29yZFJpZ2h0KTsKCiAgICAgICAgbGlzdGVuZXIuYmluZEtleVN0cmluZ1NlbGVjdGFibGUoIiIsIEtleS5IT01FLCB0aGlzLmFjdGlvbnMubW92ZVRvTGluZVN0YXJ0KTsKICAgICAgICBsaXN0ZW5lci5iaW5kS2V5U3RyaW5nU2VsZWN0YWJsZSgiQVBQTEUiLCBLZXkuQVJST1dfTEVGVCwgdGhpcy5hY3Rpb25zLm1vdmVUb0xpbmVTdGFydCk7CiAgICAgICAgbGlzdGVuZXIuYmluZEtleVN0cmluZ1NlbGVjdGFibGUoIiIsIEtleS5FTkQsIHRoaXMuYWN0aW9ucy5tb3ZlVG9MaW5lRW5kKTsKICAgICAgICBsaXN0ZW5lci5iaW5kS2V5U3RyaW5nU2VsZWN0YWJsZSgiQVBQTEUiLCBLZXkuQVJST1dfUklHSFQsIHRoaXMuYWN0aW9ucy5tb3ZlVG9MaW5lRW5kKTsKCiAgICAgICAgbGlzdGVuZXIuYmluZEtleVN0cmluZygiQ1RSTCIsIEtleS5LLCB0aGlzLmFjdGlvbnMua2lsbExpbmUpOwogICAgICAgIGxpc3RlbmVyLmJpbmRLZXlTdHJpbmcoIkNUUkwiLCBLZXkuTCwgdGhpcy5hY3Rpb25zLm1vdmVDdXJzb3JSb3dUb0NlbnRlcik7CgogICAgICAgIGxpc3RlbmVyLmJpbmRLZXlTdHJpbmcoIiIsIEtleS5CQUNLU1BBQ0UsIHRoaXMuYWN0aW9ucy5iYWNrc3BhY2UpOwogICAgICAgIGxpc3RlbmVyLmJpbmRLZXlTdHJpbmcoIiIsIEtleS5ERUxFVEUsIHRoaXMuYWN0aW9ucy5kZWxldGVLZXkpOwogICAgICAgIGxpc3RlbmVyLmJpbmRLZXlTdHJpbmcoIiIsIEtleS5FTlRFUiwgdGhpcy5hY3Rpb25zLm5ld2xpbmUpOwogICAgICAgIGxpc3RlbmVyLmJpbmRLZXlTdHJpbmcoIiIsIEtleS5UQUIsIHRoaXMuYWN0aW9ucy5pbnNlcnRUYWIpOwoKICAgICAgICBsaXN0ZW5lci5iaW5kS2V5U3RyaW5nKCJBUFBMRSIsIEtleS5BLCB0aGlzLmFjdGlvbnMuc2VsZWN0QWxsKTsKICAgICAgICBsaXN0ZW5lci5iaW5kS2V5U3RyaW5nKCJDVFJMIiwgS2V5LkEsIHRoaXMuYWN0aW9ucy5zZWxlY3RBbGwpOwoKICAgICAgICBsaXN0ZW5lci5iaW5kS2V5U3RyaW5nKCJBUFBMRSIsIEtleS5aLCB0aGlzLmFjdGlvbnMudW5kb1JlZG8pOwogICAgICAgIGxpc3RlbmVyLmJpbmRLZXlTdHJpbmcoIkNUUkwiLCBLZXkuWiwgdGhpcy5hY3Rpb25zLnVuZG9SZWRvKTsKCiAgICAgICAgbGlzdGVuZXIuYmluZEtleVN0cmluZygiQVBQTEUiLCBLZXkuQywgdGhpcy5hY3Rpb25zLmNvcHlTZWxlY3Rpb24pOwogICAgICAgIGxpc3RlbmVyLmJpbmRLZXlTdHJpbmcoIkNUUkwiLCBLZXkuQywgdGhpcy5hY3Rpb25zLmNvcHlTZWxlY3Rpb24pOwoKICAgICAgICBsaXN0ZW5lci5iaW5kS2V5U3RyaW5nKCJBUFBMRSIsIEtleS5WLCB0aGlzLmFjdGlvbnMucGFzdGVGcm9tQ2xpcGJvYXJkKTsKICAgICAgICBsaXN0ZW5lci5iaW5kS2V5U3RyaW5nKCJDVFJMIiwgS2V5LlYsIHRoaXMuYWN0aW9ucy5wYXN0ZUZyb21DbGlwYm9hcmQpOwoKICAgICAgICBsaXN0ZW5lci5iaW5kS2V5U3RyaW5nKCJBUFBMRSIsIEtleS5YLCB0aGlzLmFjdGlvbnMuY3V0U2VsZWN0aW9uKTsKICAgICAgICBsaXN0ZW5lci5iaW5kS2V5U3RyaW5nKCJDVFJMIiwgS2V5LlgsIHRoaXMuYWN0aW9ucy5jdXRTZWxlY3Rpb24pOwoKICAgICAgICBsaXN0ZW5lci5iaW5kS2V5U3RyaW5nU2VsZWN0YWJsZSgiQVBQTEUiLCBLZXkuQVJST1dfVVAsIHRoaXMuYWN0aW9ucy5tb3ZlVG9GaWxlVG9wKTsKICAgICAgICBsaXN0ZW5lci5iaW5kS2V5U3RyaW5nU2VsZWN0YWJsZSgiQVBQTEUiLCBLZXkuQVJST1dfRE9XTiwgdGhpcy5hY3Rpb25zLm1vdmVUb0ZpbGVCb3R0b20pOwogICAgICAgIAogICAgICAgIGxpc3RlbmVyLmJpbmRLZXlTdHJpbmdTZWxlY3RhYmxlKCIiLCBLZXkuUEFHRV9VUCwgdGhpcy5hY3Rpb25zLm1vdmVQYWdlVXApOwogICAgICAgIGxpc3RlbmVyLmJpbmRLZXlTdHJpbmdTZWxlY3RhYmxlKCIiLCBLZXkuUEFHRV9ET1dOLCB0aGlzLmFjdGlvbnMubW92ZVBhZ2VEb3duKTsKCiAgICAgICAgLy8gT3RoZXIga2V5IGJpbmRpbmdzIGNhbiBiZSBmb3VuZCBpbiBjb21tYW5kcyB0aGVtc2VsdmVzLgogICAgICAgIC8vIEZvciBleGFtcGxlLCB0aGlzOgogICAgICAgIC8vIGxpc3RlbmVyLmJpbmRLZXlTdHJpbmcoIkNUUkwgU0hJRlQiLCBLZXkuTiwgImJlc3BpbjplZGl0b3I6bmV3ZmlsZSIpOwogICAgICAgIC8vIGhhcyBiZWVuIG1vdmVkIHRvIHRoZSAnbmV3ZmlsZScgY29tbWFuZCB3aXRoS2V5CiAgICB9LAoKICAgIGdldFdpZHRoOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZWRpdG9yLmNhbnZhcy5wYXJlbnROb2RlOwogICAgICAgIHJldHVybiBwYXJzZUludChlbGVtZW50LmdldEF0dHJpYnV0ZSgid2lkdGgiKSk7CiAgICB9LAoKICAgIGdldEhlaWdodDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVkaXRvci5jYW52YXMucGFyZW50Tm9kZTsKICAgICAgICByZXR1cm4gcGFyc2VJbnQoZWxlbWVudC5nZXRBdHRyaWJ1dGUoImhlaWdodCIpKTsKICAgIH0sCgogICAgZ2V0VG9wT2Zmc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5lZGl0b3IuY2FudmFzLnBhcmVudE5vZGUub2Zmc2V0VG9wOwogICAgfSwKCiAgICBnZXRMZWZ0T2Zmc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5lZGl0b3IuY2FudmFzLnBhcmVudE5vZGUub2Zmc2V0TGVmdDsKICAgIH0sCgogICAgZ2V0Q2hhcldpZHRoOiBmdW5jdGlvbihjdHgpIHsKICAgICAgICBpZiAoY3R4Lm1lYXN1cmVUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBjdHgubWVhc3VyZVRleHQoIk0iKS53aWR0aDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdGhpcy5GQUxMQkFDS19DSEFSQUNURVJfV0lEVEg7CiAgICAgICAgfQogICAgfSwKCiAgICBnZXRMaW5lSGVpZ2h0OiBmdW5jdGlvbihjdHgpIHsKICAgICAgICB2YXIgbGggPSAtMTsKICAgICAgICBpZiAoY3R4Lm1lYXN1cmVUZXh0KSB7CiAgICAgICAgICAgIHZhciB0ID0gY3R4Lm1lYXN1cmVUZXh0KCJNIik7CiAgICAgICAgICAgIGlmICh0LmFzY2VudCkgbGggPSBNYXRoLmZsb29yKHQuYXNjZW50ICogMi44KTsKICAgICAgICB9CiAgICAgICAgaWYgKGxoID09IC0xKSBsaCA9IHRoaXMuTElORV9IRUlHSFQ7CiAgICAgICAgcmV0dXJuIGxoOwogICAgfSwKCiAgICAvLyAqKiB7e3sgcGFpbnQgfX19ICoqCiAgICAvLwogICAgLy8gVGhpcyBpcyB3aGVyZSB0aGUgZWRpdG9yIGlzIHBhaW50ZWQgZnJvbSBoZWFkIHRvIHRvZS4gVGhlIG9wdGlvbmFsICJmdWxsUmVmcmVzaCIgYXJndW1lbnQgdHJpZ2dlcnMgYSBjb21wbGV0ZSByZXBhaW50CiAgICAvLyBvZiB0aGUgZWRpdG9yIGNhbnZhczsgb3RoZXJ3aXNlLCBwaXRpZnVsIHRyaWNrcyBhcmUgdXNlZCB0byBkcmF3IGFzIGxpdHRsZSBhcyBwb3NzaWJsZS4KICAgIHBhaW50OiBmdW5jdGlvbihjdHgsIGZ1bGxSZWZyZXNoKSB7CiAgICAgICAgLy8gREVDTEFSRSBWQVJJQUJMRVMKCiAgICAgICAgLy8gdGhlc2UgYXJlIGNvbnZlbmllbmNlIHJlZmVyZW5jZXMgc28gd2UgZG9uJ3QgaGF2ZSB0byB0eXBlIHNvIG11Y2gKICAgICAgICB2YXIgYyA9ICQodGhpcy5lZGl0b3IuY2FudmFzKTsKICAgICAgICB2YXIgdGhlbWUgPSB0aGlzLmVkaXRvci50aGVtZTsKICAgICAgICB2YXIgZWQgPSB0aGlzLmVkaXRvcjsKCiAgICAgICAgLy8gdGhlc2UgYXJlIGNvbW1vbmx5IHVzZWQgdGhyb3VnaG91dCB0aGUgcmVuZGVyaW5nIHByb2Nlc3Mgc28gYXJlIGRlZmluZWQgdXAgaGVyZSB0byBtYWtlIGl0IGNsZWFyIHRoZXkgYXJlIHNoYXJlZAogICAgICAgIHZhciB4LCB5OwogICAgICAgIHZhciBjeTsKICAgICAgICB2YXIgY3VycmVudExpbmU7CiAgICAgICAgdmFyIGxhc3RMaW5lVG9SZW5kZXI7CgogICAgICAgIHZhciBSZWN0ID0gQmVzcGluLkVkaXRvci5SZWN0OwoKCiAgICAgICAgLy8gU0VUVVAgU1RBVEUKCiAgICAgICAgdmFyIHJlZnJlc2hDYW52YXMgPSBmdWxsUmVmcmVzaDsgICAgICAgIC8vIGlmIHRoZSB1c2VyIGV4cGxpY2l0bHkgcmVxdWVzdHMgYSBmdWxsIHJlZnJlc2gsIGdpdmUgaXQgdG8gJ2VtCgogICAgICAgIGlmICghcmVmcmVzaENhbnZhcykgcmVmcmVzaENhbnZhcyA9ICh0aGlzLnNlbGVjdE1vdXNlRG93blBvcyk7CgogICAgICAgIGlmICghcmVmcmVzaENhbnZhcykgcmVmcmVzaENhbnZhcyA9ICh0aGlzLmxhc3RMaW5lQ291bnQgIT0gZWQubW9kZWwuZ2V0Um93Q291bnQoKSk7ICAvLyBpZiB0aGUgbGluZSBjb3VudCBoYXMgY2hhbmdlZCwgZnVsbCByZWZyZXNoCgogICAgICAgIHRoaXMubGFzdExpbmVDb3VudCA9IGVkLm1vZGVsLmdldFJvd0NvdW50KCk7ICAgICAgICAvLyBzYXZlIHRoZSBudW1iZXIgb2YgbGluZXMgZm9yIHRoZSBuZXh0IHRpbWUgcGFpbnQKCiAgICAgICAgLy8gZ2V0IHRoZSBsaW5lIGFuZCBjaGFyYWN0ZXIgbWV0cmljczsgY2FsY3VsYXRlZCBmb3IgZWFjaCBwYWludCBiZWNhdXNlIHRoaXMgdmFsdWUgY2FuIGNoYW5nZSBhdCBydW4tdGltZQogICAgICAgIGN0eC5mb250ID0gdGhlbWUubGluZU51bWJlckZvbnQ7CiAgICAgICAgdGhpcy5jaGFyV2lkdGggPSB0aGlzLmdldENoYXJXaWR0aChjdHgpOwogICAgICAgIHRoaXMubGluZUhlaWdodCA9IHRoaXMuZ2V0TGluZUhlaWdodChjdHgpOwoKICAgICAgICAvLyBjd2lkdGggYW5kIGNoZWlnaHQgYXJlIHNldCB0byB0aGUgZGltZW5zaW9ucyBvZiB0aGUgcGFyZW50IG5vZGUgb2YgdGhlIGNhbnZhcyBlbGVtZW50OyB3ZSdsbCByZXNpemUgdGhlIGNhbnZhcyBlbGVtZW50CiAgICAgICAgLy8gaXRzZWxmIGEgbGl0dGxlIGJpdCBsYXRlciBpbiB0aGlzIGZ1bmN0aW9uCiAgICAgICAgdmFyIGN3aWR0aCA9IHRoaXMuZ2V0V2lkdGgoKTsKICAgICAgICB2YXIgY2hlaWdodCA9IHRoaXMuZ2V0SGVpZ2h0KCk7CgogICAgICAgIHZhciB2aXJ0dWFsaGVpZ2h0ID0gdGhpcy5saW5lSGVpZ2h0ICogZWQubW9kZWwuZ2V0Um93Q291bnQoKTsgICAgLy8gZnVsbCBoZWlnaHQgYmFzZWQgb24gY29udGVudAogICAgICAgIHZhciB2aXJ0dWFsd2lkdGggPSB0aGlzLmNoYXJXaWR0aCAqIChNYXRoLm1heChlZC5tb2RlbC5nZXRNYXhDb2xzKCksIGVkLmN1cnNvclBvc2l0aW9uLmNvbCkgKyAyKTsgICAgICAgLy8gZnVsbCB3aWR0aCBiYXNlZCBvbiBjb250ZW50IHBsdXMgYSBsaXR0bGUgcGFkZGluZwoKICAgICAgICAvLyBhZGp1c3QgdGhlIHNjcm9sbGluZyBvZmZzZXRzIGlmIG5lY2Vzc2FyeTsgbmVnYXRpdmUgdmFsdWVzIGFyZSBnb29kLCBpbmRpY2F0ZSBzY3JvbGxpbmcgZG93biBvciB0byB0aGUgcmlnaHQgKHdlIGxvb2sgZm9yIG92ZXJmbG93cyBvbiB0aGVzZSBsYXRlciBvbikKICAgICAgICAvLyBwb3NpdGl2ZSB2YWx1ZXMgYXJlIGJhZDsgdGhleSBpbmRpY2F0ZSBzY3JvbGxpbmcgdXAgcGFzdCB0aGUgZmlyc3QgbGluZSBvciB0byB0aGUgbGVmdCBwYXN0IHRoZSBmaXJzdCBjb2x1bW4KICAgICAgICBpZiAodGhpcy54b2Zmc2V0ID4gMCkgdGhpcy54b2Zmc2V0ID0gMDsKICAgICAgICBpZiAodGhpcy55b2Zmc2V0ID4gMCkgdGhpcy55b2Zmc2V0ID0gMDsKCiAgICAgICAgLy8gdGhlc2UgbmV4dCB0d28gYmxvY2tzIG1ha2Ugc3VyZSB3ZSBkb24ndCBzY3JvbGwgdG9vIGZhciBpbiBlaXRoZXIgdGhlIHggb3IgeSBheGlzCiAgICAgICAgaWYgKHRoaXMueG9mZnNldCA8IDApIHsKICAgICAgICAgICAgaWYgKChNYXRoLmFicyh0aGlzLnhvZmZzZXQpKSA+ICh2aXJ0dWFsd2lkdGggLSAoY3dpZHRoIC0gdGhpcy5HVVRURVJfV0lEVEgpKSkgdGhpcy54b2Zmc2V0ID0gKGN3aWR0aCAtIHRoaXMuR1VUVEVSX1dJRFRIKSAtIHZpcnR1YWx3aWR0aDsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMueW9mZnNldCA8IDApIHsKICAgICAgICAgICAgaWYgKChNYXRoLmFicyh0aGlzLnlvZmZzZXQpKSA+ICh2aXJ0dWFsaGVpZ2h0IC0gY2hlaWdodCkpIHRoaXMueW9mZnNldCA9IGNoZWlnaHQgLSB2aXJ0dWFsaGVpZ2h0OwogICAgICAgIH0KCiAgICAgICAgLy8gaWYgdGhlIGN1cnJlbnQgc2Nyb2xsZWQgcG9zaXRpb25zIGFyZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIHBvc2l0aW9ucyB3ZSB1c2VkIGZvciB0aGUgbGFzdCBwYWludCwgcmVmcmVzaCB0aGUgZW50aXJlIGNhbnZhcwogICAgICAgIGlmICgodGhpcy54b2Zmc2V0ICE9IHRoaXMubGFzdHhvZmZzZXQpIHx8ICh0aGlzLnlvZmZzZXQgIT0gdGhpcy5sYXN0eW9mZnNldCkpIHsKICAgICAgICAgICAgcmVmcmVzaENhbnZhcyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMubGFzdHhvZmZzZXQgPSB0aGlzLnhvZmZzZXQ7CiAgICAgICAgICAgIHRoaXMubGFzdHlvZmZzZXQgPSB0aGlzLnlvZmZzZXQ7CiAgICAgICAgfQoKICAgICAgICAvLyB0aGVzZSBhcmUgYm9vbGVhbiB2YWx1ZXMgaW5kaWNhdGluZyB3aGV0aGVyIHRoZSB4IGFuZCB5IChpLmUuLCBob3Jpem9udGFsIG9yIHZlcnRpY2FsKSBzY3JvbGwgYmFycyBhcmUgdmlzaWJsZQogICAgICAgIHZhciB4c2Nyb2xsID0gKChjd2lkdGggLSB0aGlzLkdVVFRFUl9XSURUSCkgPCB2aXJ0dWFsd2lkdGgpOwogICAgICAgIHZhciB5c2Nyb2xsID0gKGNoZWlnaHQgPCB2aXJ0dWFsaGVpZ2h0KTsKCiAgICAgICAgLy8gdGhlIHNjcm9sbCBiYXJzIGFyZSByZW5kZXJlZCBvZmYtc2NyZWVuIGludG8gdGhlaXIgb3duIGNhbnZhcyBpbnN0YW5jZXM7IHRoZXNlIHZhbHVlcyBhcmUgdXNlZCBpbiB0d28gd2F5cyBhcyBwYXJ0IG9mCiAgICAgICAgLy8gdGhpcyBwcm9jZXNzOgogICAgICAgIC8vICAgMS4gdGhlIHggcG9zaXRpb24gb2YgdGhlIHZlcnRpY2FsIHNjcm9sbCBiYXIgaW1hZ2Ugd2hlbiBwYWludGVkIG9udG8gdGhlIGNhbnZhcyBhbmQgdGhlIHkgcG9zaXRpb24gb2YgdGhlIGhvcml6b250YWwKICAgICAgICAvLyAgICAgIHNjcm9sbCBiYXIgaW1hZ2UgKGJvdGggaW1hZ2VzIHNwYW4gMTAwJSBvZiB0aGUgd2lkdGgvaGVpZ2h0IGluIHRoZSBvdGhlciBkaW1lbnNpb24pCiAgICAgICAgLy8gICAyLiB0aGUgYW1vdW50ICogLTEgdG8gdHJhbnNsYXRlIHRoZSBvZmYtc2NyZWVuIGNhbnZhc2VzIHVzZWQgYnkgdGhlIHNjcm9sbGJhcnM7IHRoaXMgbGV0cyB1cyBmbGlwIGJhY2sgdG8gcmVuZGVyaW5nCiAgICAgICAgLy8gICAgICB0aGUgc2Nyb2xsIGJhcnMgZGlyZWN0bHkgb24gdGhlIGNhbnZhcyB3aXRoIHJlbGF0aXZlIGVhc2UgKGJ5IG9taXR0ZWQgdGhlIHRyYW5zbGF0aW9ucyBhbmQgcGFzc2luZyBpbiB0aGUgbWFpbiBjb250ZXh0CiAgICAgICAgLy8gICAgICByZWZlcmVuY2UgaW5zdGVhZCBvZiB0aGUgb2ZmLXNjcmVlbiBjYW52YXMgY29udGV4dCkKICAgICAgICB2YXIgdmVydGljYWx4ID0gY3dpZHRoIC0gdGhpcy5OSUJfV0lEVEggLSB0aGlzLk5JQl9JTlNFVFMucmlnaHQgLSAyOwogICAgICAgIHZhciBob3Jpem9udGFseSA9IGNoZWlnaHQgLSB0aGlzLk5JQl9XSURUSCAtIHRoaXMuTklCX0lOU0VUUy5ib3R0b20gLSAyOwoKICAgICAgICAvLyB0aGVzZSBhcmUgYm9vbGVhbiB2YWx1ZXMgdGhhdCBpbmRpY2F0ZSB3aGV0aGVyIHNwZWNpYWwgbGl0dGxlICJuaWJzIiBzaG91bGQgYmUgZGlzcGxheWVkIGluZGljYXRpbmcgbW9yZSBjb250ZW50IHRvIHRoZQogICAgICAgIC8vIGxlZnQsIHJpZ2h0LCB0b3AsIG9yIGJvdHRvbQogICAgICAgIHZhciBzaG93TGVmdFNjcm9sbE5pYiA9ICh4c2Nyb2xsICYmICh0aGlzLnhvZmZzZXQgIT0gMCkpOwogICAgICAgIHZhciBzaG93UmlnaHRTY3JvbGxOaWIgPSAoeHNjcm9sbCAmJiAodGhpcy54b2Zmc2V0ID4gKChjd2lkdGggLSB0aGlzLkdVVFRFUl9XSURUSCkgLSB2aXJ0dWFsd2lkdGgpKSk7CiAgICAgICAgdmFyIHNob3dVcFNjcm9sbE5pYiA9ICh5c2Nyb2xsICYmICh0aGlzLnlvZmZzZXQgIT0gMCkpOwogICAgICAgIHZhciBzaG93RG93blNjcm9sbE5pYiA9ICh5c2Nyb2xsICYmICh0aGlzLnlvZmZzZXQgPiAoY2hlaWdodCAtIHZpcnR1YWxoZWlnaHQpKSk7CgogICAgICAgIC8vIGNoZWNrIGFuZCBzZWUgaWYgdGhlIGNhbnZhcyBpcyB0aGUgc2FtZSBzaXplIGFzIGl0cyBpbW1lZGlhdGUgcGFyZW50IGluIHRoZSBET007IGlmIG5vdCwgcmVzaXplIHRoZSBjYW52YXMKICAgICAgICBpZiAoKChjLnJlYWRBdHRyaWJ1dGUoIndpZHRoIikpICE9IGN3aWR0aCkgfHwgKGMucmVhZEF0dHJpYnV0ZSgiaGVpZ2h0IikgIT0gY2hlaWdodCkpIHsKICAgICAgICAgICAgcmVmcmVzaENhbnZhcyA9IHRydWU7ICAgLy8gaWYgdGhlIGNhbnZhcyBjaGFuZ2VzIHNpemUsIHdlJ2xsIG5lZWQgYSBmdWxsIHJlcGFpbnQKICAgICAgICAgICAgYy53cml0ZUF0dHJpYnV0ZSh7IHdpZHRoOiBjd2lkdGgsIGhlaWdodDogY2hlaWdodCB9KTsKICAgICAgICB9CgogICAgICAgIC8vIElGIFlPVSBXQU5UIFRPIEZPUkNFIEEgQ09NUExFVEUgUkVQQUlOVCBPRiBUSEUgQ0FOVkFTIE9OIEVWRVJZIFBBSU5ULCBVTkNPTU1FTlQgVEhFIEZPTExPV0lORyBMSU5FOgogICAgICAgIC8vcmVmcmVzaENhbnZhcyA9IHRydWU7CgogICAgICAgIC8vIFNUQVJUIFJFTkRFUklORwoKICAgICAgICAvLyBpZiB3ZSdyZSBub3QgZG9pbmcgYSBmdWxsIHJlcGFpbnQsIHdvcmsgb3V0IHdoaWNoIHJvd3MgYXJlICJkaXJ0eSIgYW5kIG5lZWQgdG8gYmUgcmVwYWludGVkCiAgICAgICAgaWYgKCFyZWZyZXNoQ2FudmFzKSB7CiAgICAgICAgICAgIHZhciBkaXJ0eSA9IGVkLm1vZGVsLmdldERpcnR5Um93cygpOwoKICAgICAgICAgICAgLy8gaWYgdGhlIGN1cnNvciBoYXMgY2hhbmdlZCByb3dzIHNpbmNlIHRoZSBsYXN0IHBhaW50LCBjb25zaWRlciB0aGUgcHJldmlvdXMgcm93IGRpcnR5CiAgICAgICAgICAgIGlmICgodGhpcy5sYXN0Q3Vyc29yUG9zKSAmJiAodGhpcy5sYXN0Q3Vyc29yUG9zLnJvdyAhPSBlZC5jdXJzb3JQb3NpdGlvbi5yb3cpKSBkaXJ0eVt0aGlzLmxhc3RDdXJzb3JQb3Mucm93XSA9IHRydWU7CgogICAgICAgICAgICAvLyB3ZSBhbHdheXMgcmVwYWludCB0aGUgY3VycmVudCBsaW5lCiAgICAgICAgICAgIGRpcnR5W2VkLmN1cnNvclBvc2l0aW9uLnJvd10gPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gc2F2ZSB0aGlzIHN0YXRlIGZvciB0aGUgbmV4dCBwYWludCBhdHRlbXB0IChzZWUgYWJvdmUgZm9yIHVzYWdlKQogICAgICAgIHRoaXMubGFzdEN1cnNvclBvcyA9IEJlc3Bpbi5FZGl0b3IuVXRpbHMuY29weVBvcyhlZC5jdXJzb3JQb3NpdGlvbik7CgogICAgICAgIC8vIGlmIHdlJ3JlIGRvaW5nIGEgZnVsbCByZXBhaW50Li4uCiAgICAgICAgaWYgKHJlZnJlc2hDYW52YXMpIHsKICAgICAgICAgICAgLy8gLi4ucGFpbnQgdGhlIGJhY2tncm91bmQgY29sb3Igb3ZlciB0aGUgd2hvbGUgY2FudmFzIGFuZC4uLgogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gdGhlbWUuYmFja2dyb3VuZFN0eWxlOwogICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgYy53aWR0aCwgYy5oZWlnaHQpOwoKICAgICAgICAgICAgLy8gLi4ucGFpbnQgdGhlIGd1dHRlciAKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IHRoZW1lLmd1dHRlclN0eWxlOwogICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgdGhpcy5HVVRURVJfV0lEVEgsIGMuaGVpZ2h0KTsKICAgICAgICB9CgogICAgICAgIC8vIHRyYW5zbGF0ZSB0aGUgY2FudmFzIGJhc2VkIG9uIHRoZSBzY3JvbGxiYXIgcG9zaXRpb247IGZvciBub3csIGp1c3QgdHJhbnNsYXRlIHRoZSB2ZXJ0aWNhbCBheGlzCiAgICAgICAgY3R4LnNhdmUoKTsgLy8gdGFrZSBzbmFwc2hvdCBvZiBjdXJyZW50IGNvbnRleHQgc3RhdGUgc28gd2UgY2FuIHJvbGwgYmFjayBsYXRlciBvbgogICAgICAgIGN0eC50cmFuc2xhdGUoMCwgdGhpcy55b2Zmc2V0KTsKCiAgICAgICAgLy8gb25seSBwYWludCB0aG9zZSBsaW5lcyB0aGF0IGNhbiBiZSB2aXNpYmxlCiAgICAgICAgdGhpcy52aXNpYmxlUm93cyA9IE1hdGguY2VpbChjaGVpZ2h0IC8gdGhpcy5saW5lSGVpZ2h0KTsKICAgICAgICB0aGlzLmZpcnN0VmlzaWJsZVJvdyA9IE1hdGguZmxvb3IoTWF0aC5hYnModGhpcy55b2Zmc2V0IC8gdGhpcy5saW5lSGVpZ2h0KSk7CiAgICAgICAgbGFzdExpbmVUb1JlbmRlciA9IHRoaXMuZmlyc3RWaXNpYmxlUm93ICsgdGhpcy52aXNpYmxlUm93czsKICAgICAgICBpZiAobGFzdExpbmVUb1JlbmRlciA+IChlZC5tb2RlbC5nZXRSb3dDb3VudCgpIC0gMSkpIGxhc3RMaW5lVG9SZW5kZXIgPSBlZC5tb2RlbC5nZXRSb3dDb3VudCgpIC0gMTsKCiAgICAgICAgLy8gcGFpbnQgdGhlIGxpbmUgbnVtYmVycwogICAgICAgIGlmIChyZWZyZXNoQ2FudmFzKSB7CiAgICAgICAgICAgIHkgPSAodGhpcy5saW5lSGVpZ2h0ICogdGhpcy5maXJzdFZpc2libGVSb3cpOwogICAgICAgICAgICBmb3IgKGN1cnJlbnRMaW5lID0gdGhpcy5maXJzdFZpc2libGVSb3c7IGN1cnJlbnRMaW5lIDw9IGxhc3RMaW5lVG9SZW5kZXI7IGN1cnJlbnRMaW5lKyspIHsKICAgICAgICAgICAgICAgIHggPSB0aGlzLkdVVFRFUl9JTlNFVFMubGVmdDsKICAgICAgICAgICAgICAgIGN5ID0geSArICh0aGlzLmxpbmVIZWlnaHQgLSB0aGlzLkxJTkVfSU5TRVRTLmJvdHRvbSk7CgogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IHRoZW1lLmxpbmVOdW1iZXJDb2xvcjsKICAgICAgICAgICAgICAgIGN0eC5maWxsVGV4dChjdXJyZW50TGluZSArIDEsIHgsIGN5KTsKCiAgICAgICAgICAgICAgICB5ICs9IHRoaXMubGluZUhlaWdodDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gYW5kIG5vdyB3ZSdyZSByZWFkeSB0byB0cmFuc2xhdGUgdGhlIGhvcml6b250YWwgYXhpczsgd2hpbGUgd2UncmUgYXQgaXQsIHdlJ2xsIHNldHVwIGEgY2xpcCB0byBwcmV2ZW50IGFueSBkcmF3aW5nIG91dHNpZGUKICAgICAgICAvLyBvZiBjb2RlIGVkaXRvciByZWdpb24gaXRzZWxmIChwcm90ZWN0aW5nIHRoZSBndXR0ZXIpLiB0aGlzIGNsaXAgaXMgaW1wb3J0YW50IHRvIHByZXZlbnQgdGV4dCBmcm9tIGJsZWVkaW5nIGludG8gdGhlIGd1dHRlci4KICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgucmVjdCh0aGlzLkdVVFRFUl9XSURUSCwgLXRoaXMueW9mZnNldCwgY3dpZHRoIC0gdGhpcy5HVVRURVJfV0lEVEgsIGNoZWlnaHQpOwogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICBjdHgudHJhbnNsYXRlKHRoaXMueG9mZnNldCwgMCk7CiAgICAgICAgY3R4LmNsaXAoKTsKCiAgICAgICAgLy8gY2FsY3VsYXRlIHRoZSBmaXJzdCBhbmQgbGFzdCB2aXNpYmxlIGNvbHVtbnMgb24gdGhlIHNjcmVlbjsgdGhlc2UgdmFsdWVzIHdpbGwgYmUgdXNlZCB0byB0cnkgYW5kIGF2b2lkIHBhaW50aW5nIHRleHQKICAgICAgICAvLyB0aGF0IHRoZSB1c2VyIGNhbid0IGFjdHVhbGx5IHNlZQogICAgICAgIHZhciBmaXJzdENvbHVtbiA9IE1hdGguZmxvb3IoTWF0aC5hYnModGhpcy54b2Zmc2V0IC8gdGhpcy5jaGFyV2lkdGgpKTsKICAgICAgICB2YXIgbGFzdENvbHVtbiA9IGZpcnN0Q29sdW1uICsgKE1hdGguY2VpbCgoY3dpZHRoIC0gdGhpcy5HVVRURVJfV0lEVEgpIC8gdGhpcy5jaGFyV2lkdGgpKTsKCiAgICAgICAgLy8gcGFpbnQgdGhlIGxpbmUgY29udGVudCBhbmQgemVicmEgc3RyaXBlcwogICAgICAgIHkgPSAodGhpcy5saW5lSGVpZ2h0ICogdGhpcy5maXJzdFZpc2libGVSb3cpOwogICAgICAgIHZhciBjYzsgLy8gdGhlIHN0YXJ0aW5nIGNvbHVtbiBvZiB0aGUgY3VycmVudCByZWdpb24gaW4gdGhlIHJlZ2lvbiByZW5kZXIgbG9vcCBiZWxvdwogICAgICAgIHZhciBjZTsgLy8gdGhlIGVuZGluZyBjb2x1bW4gaW4gdGhlIHNhbWUgbG9vcAogICAgICAgIHZhciByaTsgLy8gY291bnRlciB2YXJpYWJsZSB1c2VkIGZvciB0aGUgc2FtZSBsb29wCiAgICAgICAgdmFyIHJlZ2lvbmxlbjsgIC8vIGxlbmd0aCBvZiB0aGUgdGV4dCBpbiB0aGUgcmVnaW9uOyB1c2VkIGluIHRoZSBzYW1lIGxvb3AKICAgICAgICB2YXIgdHgsIHR3OwogICAgICAgIGZvciAoY3VycmVudExpbmUgPSB0aGlzLmZpcnN0VmlzaWJsZVJvdzsgY3VycmVudExpbmUgPD0gbGFzdExpbmVUb1JlbmRlcjsgY3VycmVudExpbmUrKykgewogICAgICAgICAgICB4ID0gdGhpcy5HVVRURVJfV0lEVEg7CgogICAgICAgICAgICAvLyBpZiB3ZSBhcmVuJ3QgcmVwYWludGluZyB0aGUgZW50aXJlIGNhbnZhcy4uLgogICAgICAgICAgICBpZiAoIXJlZnJlc2hDYW52YXMpIHsKICAgICAgICAgICAgICAgIC8vIC4uLmRvbid0IGJvdGhlciBwYWludGluZyB0aGUgbGluZSB1bmxlc3MgaXQgaXMgImRpcnR5IiAoc2VlIGFib3ZlIGZvciBkaXJ0eSBjaGVja2luZykKICAgICAgICAgICAgICAgIGlmICghZGlydHlbY3VycmVudExpbmVdKSB7CiAgICAgICAgICAgICAgICAgICAgeSArPSB0aGlzLmxpbmVIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gc2V0dXAgYSBjbGlwIGZvciB0aGUgY3VycmVudCBsaW5lIG9ubHk7IHRoaXMgbWFrZXMgZHJhd2luZyBqdXN0IHRoYXQgcGllY2Ugb2YgdGhlIHNjcm9sbGJhciBlYXN5CiAgICAgICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4LnJlY3QoeCArIChNYXRoLmFicyh0aGlzLnhvZmZzZXQpKSwgeSwgY3dpZHRoLCB0aGlzLmxpbmVIZWlnaHQpOwogICAgICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4LmNsaXAoKTsKCiAgICAgICAgICAgICAgICBpZiAoKGN1cnJlbnRMaW5lICUgMikgPT0gMSkgeyAvLyBvbmx5IHJlcGFpbnQgdGhlIGxpbmUgYmFja2dyb3VuZCBpZiB0aGUgemVicmEgc3RyaXBlIHdvbid0IGJlIHBhaW50ZWQgaW50byBpdAogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSB0aGVtZS5iYWNrZ3JvdW5kU3R5bGU7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KHggKyAoTWF0aC5hYnModGhpcy54b2Zmc2V0KSksIHksIGN3aWR0aCwgdGhpcy5saW5lSGVpZ2h0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKChjdXJyZW50TGluZSAlIDIpID09IDApIHsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSB0aGVtZS56ZWJyYVN0cmlwZUNvbG9yOwogICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KHggKyAoTWF0aC5hYnModGhpcy54b2Zmc2V0KSksIHksIGN3aWR0aCwgdGhpcy5saW5lSGVpZ2h0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgeCArPSB0aGlzLkxJTkVfSU5TRVRTLmxlZnQ7CiAgICAgICAgICAgIGN5ID0geSArICh0aGlzLmxpbmVIZWlnaHQgLSB0aGlzLkxJTkVfSU5TRVRTLmJvdHRvbSk7CgogICAgICAgICAgICAvLyBwYWludCB0aGUgc2VsZWN0aW9uIGJhciBpZiB0aGUgbGluZSBoYXMgc2VsZWN0aW9ucwogICAgICAgICAgICB2YXIgc2VsZWN0aW9ucyA9IHRoaXMuc2VsZWN0aW9uSGVscGVyLmdldFJvd1NlbGVjdGlvblBvc2l0aW9ucyhjdXJyZW50TGluZSk7CiAgICAgICAgICAgIGlmIChzZWxlY3Rpb25zKSB7CiAgICAgICAgICAgICAgICB0eCA9IHggKyAoc2VsZWN0aW9ucy5zdGFydENvbCAqIHRoaXMuY2hhcldpZHRoKTsKICAgICAgICAgICAgICAgIHR3ID0gKHNlbGVjdGlvbnMuZW5kQ29sID09IC0xKSA/IChsYXN0Q29sdW1uIC0gZmlyc3RDb2x1bW4pICogdGhpcy5jaGFyV2lkdGggOiAoc2VsZWN0aW9ucy5lbmRDb2wgLSBzZWxlY3Rpb25zLnN0YXJ0Q29sKSAqIHRoaXMuY2hhcldpZHRoOwogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IHRoZW1lLmVkaXRvclNlbGVjdGVkVGV4dEJhY2tncm91bmQ7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QodHgsIHksIHR3LCB0aGlzLmxpbmVIZWlnaHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyB0aGUgZm9sbG93aW5nIHR3byBjaHVua3Mgb2YgY29kZSBkbyB0aGUgc2FtZSB0aGluZzsgb25seSBvbmUgc2hvdWxkIGJlIHVuY29tbWVudGVkIGF0IGEgdGltZQoKICAgICAgICAgICAgLy8gQ0hVTksgMTogdGhpcyBjb2RlIGp1c3QgcmVuZGVycyB0aGUgbGluZSB3aXRoIHdoaXRlIHRleHQgYW5kIGlzIGZvciB0ZXN0aW5nCi8vICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICJ3aGl0ZSI7Ci8vICAgICAgICAgICAgY3R4LmZpbGxUZXh0KHRoaXMuZWRpdG9yLm1vZGVsLmdldFJvd0FycmF5KGN1cnJlbnRMaW5lKS5qb2luKCIiKSwgeCwgY3kpOwoKICAgICAgICAgICAgLy8gQ0hVTksgMjogdGhpcyBjb2RlIHVzZXMgbmV3IHRoZSBTeW50YXhNb2RlbCBBUEkgdG8gYXR0ZW1wdCB0byByZW5kZXIgYSBsaW5lIHdpdGggZmV3ZXIgcGFzc2VzIHRoYW4gdGhlIGNvbG9yIGhlbHBlciBBUEkKICAgICAgICAgICAgdmFyIGxpbmVJbmZvID0gdGhpcy5zeW50YXhNb2RlbC5nZXRTeW50YXhTdHlsZXMoY3VycmVudExpbmUsIHRoaXMuZWRpdG9yLmxhbmd1YWdlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAocmkgPSAwOyByaSA8IGxpbmVJbmZvLnJlZ2lvbnMubGVuZ3RoOyByaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgc3R5bGVJbmZvID0gbGluZUluZm8ucmVnaW9uc1tyaV07CgogICAgICAgICAgICAgICAgZm9yICh2YXIgc3R5bGUgaW4gc3R5bGVJbmZvKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZUluZm8uaGFzT3duUHJvcGVydHkoc3R5bGUpKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHRoaXNMaW5lID0gIiI7CgogICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZUFycmF5ID0gc3R5bGVJbmZvW3N0eWxlXTsKICAgICAgICAgICAgICAgICAgICB2YXIgY3VycmVudENvbHVtbiA9IDA7IC8vIGN1cnJlbnQgY29sdW1uLCBpbmNsdXNpdmUKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBzaSA9IDA7IHNpIDwgc3R5bGVBcnJheS5sZW5ndGg7IHNpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gc3R5bGVBcnJheVtzaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIDsgY3VycmVudENvbHVtbiA8IHJhbmdlLnN0YXJ0OyBjdXJyZW50Q29sdW1uKyspIHRoaXNMaW5lICs9ICIgIjsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc0xpbmUgKz0gbGluZUluZm8udGV4dC5zdWJzdHJpbmcocmFuZ2Uuc3RhcnQsIHJhbmdlLnN0b3ApOwogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Q29sdW1uID0gcmFuZ2Uuc3RvcDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSB0aGlzLmVkaXRvci50aGVtZVtzdHlsZV0gfHwgIndoaXRlIjsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFRleHQodGhpc0xpbmUsIHgsIGN5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFyZWZyZXNoQ2FudmFzKSB7CiAgICAgICAgICAgICAgICBjdHguZHJhd0ltYWdlKHRoaXMudmVydGljYWxTY3JvbGxDYW52YXMsIHZlcnRpY2FseCArIE1hdGguYWJzKHRoaXMueG9mZnNldCksIE1hdGguYWJzKHRoaXMueW9mZnNldCkpOwogICAgICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgeSArPSB0aGlzLmxpbmVIZWlnaHQ7CiAgICAgICAgfQoKICAgICAgICAvLyBwYWludCB0aGUgY3Vyc29yCiAgICAgICAgaWYgKHRoaXMuZWRpdG9yLmZvY3VzKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNob3dDdXJzb3IpIHsKICAgICAgICAgICAgICAgIGlmIChlZC50aGVtZS5jdXJzb3JUeXBlID09ICJ1bmRlcmxpbmUiKSB7CiAgICAgICAgICAgICAgICAgICAgeCA9IHRoaXMuR1VUVEVSX1dJRFRIICsgdGhpcy5MSU5FX0lOU0VUUy5sZWZ0ICsgZWQuY3Vyc29yUG9zaXRpb24uY29sICogdGhpcy5jaGFyV2lkdGg7CiAgICAgICAgICAgICAgICAgICAgeSA9IChlZC5jdXJzb3JQb3NpdGlvbi5yb3cgKiB0aGlzLmxpbmVIZWlnaHQpICsgKHRoaXMubGluZUhlaWdodCAtIDUpOwogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBlZC50aGVtZS5jdXJzb3JTdHlsZTsKICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoeCwgeSwgdGhpcy5jaGFyV2lkdGgsIDMpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB4ID0gdGhpcy5HVVRURVJfV0lEVEggKyB0aGlzLkxJTkVfSU5TRVRTLmxlZnQgKyBlZC5jdXJzb3JQb3NpdGlvbi5jb2wgKiB0aGlzLmNoYXJXaWR0aDsKICAgICAgICAgICAgICAgICAgICB5ID0gKGVkLmN1cnNvclBvc2l0aW9uLnJvdyAqIHRoaXMubGluZUhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGVkLnRoZW1lLmN1cnNvclN0eWxlOwogICAgICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCh4LCB5LCAxLCB0aGlzLmxpbmVIZWlnaHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgeCA9IHRoaXMuR1VUVEVSX1dJRFRIICsgdGhpcy5MSU5FX0lOU0VUUy5sZWZ0ICsgZWQuY3Vyc29yUG9zaXRpb24uY29sICogdGhpcy5jaGFyV2lkdGg7CiAgICAgICAgICAgIHkgPSAoZWQuY3Vyc29yUG9zaXRpb24ucm93ICogdGhpcy5saW5lSGVpZ2h0KTsKCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBlZC50aGVtZS51bmZvY3VzZWRDdXJzb3JGaWxsU3R5bGU7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGVkLnRoZW1lLnVuZm9jdXNlZEN1cnNvclN0cm9rZVN0eWxlOwogICAgICAgICAgICBjdHguZmlsbFJlY3QoeCwgeSwgdGhpcy5jaGFyV2lkdGgsIHRoaXMubGluZUhlaWdodCk7CiAgICAgICAgICAgIGN0eC5zdHJva2VSZWN0KHgsIHksIHRoaXMuY2hhcldpZHRoLCB0aGlzLmxpbmVIZWlnaHQpOwogICAgICAgIH0KCiAgICAgICAgLy8gc2Nyb2xsIGJhcnMgLSB4IGF4aXMKICAgICAgICBjdHgucmVzdG9yZSgpOwoKICAgICAgICAvLyBzY3JvbGxiYXJzIC0geSBheGlzCiAgICAgICAgY3R4LnJlc3RvcmUoKTsKCiAgICAgICAgLy8gcGFpbnQgc2Nyb2xsIGJhcnMgdW5sZXNzIHdlIGRvbid0IG5lZWQgdG8gOi0pCiAgICAgICAgaWYgKCFyZWZyZXNoQ2FudmFzKSByZXR1cm47CgogICAgICAgIC8vIHRlbXBvcmFyeSBkaXNhYmxlIG9mIHNjcm9sbGJhcnMKICAgICAgICAvL2lmICh0aGlzLnhzY3JvbGxiYXIucmVjdCkgcmV0dXJuOwoKICAgICAgICBpZiAodGhpcy5ob3Jpem9udGFsU2Nyb2xsQ2FudmFzLndpZHRoICE9IGN3aWR0aCkgdGhpcy5ob3Jpem9udGFsU2Nyb2xsQ2FudmFzLndpZHRoID0gY3dpZHRoOwogICAgICAgIGlmICh0aGlzLmhvcml6b250YWxTY3JvbGxDYW52YXMuaGVpZ2h0ICE9IHRoaXMuTklCX1dJRFRIICsgNCkgdGhpcy5ob3Jpem9udGFsU2Nyb2xsQ2FudmFzLmhlaWdodCA9IHRoaXMuTklCX1dJRFRIICsgNDsKCiAgICAgICAgaWYgKHRoaXMudmVydGljYWxTY3JvbGxDYW52YXMuaGVpZ2h0ICE9IGNoZWlnaHQpIHRoaXMudmVydGljYWxTY3JvbGxDYW52YXMuaGVpZ2h0ID0gY2hlaWdodDsKICAgICAgICBpZiAodGhpcy52ZXJ0aWNhbFNjcm9sbENhbnZhcy53aWR0aCAhPSB0aGlzLk5JQl9XSURUSCArIDQpIHRoaXMudmVydGljYWxTY3JvbGxDYW52YXMud2lkdGggPSB0aGlzLk5JQl9XSURUSCArIDQ7CgogICAgICAgIHZhciBoY3R4ID0gdGhpcy5ob3Jpem9udGFsU2Nyb2xsQ2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICAgICAgaGN0eC5jbGVhclJlY3QoMCwgMCwgdGhpcy5ob3Jpem9udGFsU2Nyb2xsQ2FudmFzLndpZHRoLCB0aGlzLmhvcml6b250YWxTY3JvbGxDYW52YXMuaGVpZ2h0KTsKICAgICAgICBoY3R4LnNhdmUoKTsKCiAgICAgICAgdmFyIHZjdHggPSB0aGlzLnZlcnRpY2FsU2Nyb2xsQ2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICAgICAgdmN0eC5jbGVhclJlY3QoMCwgMCwgdGhpcy52ZXJ0aWNhbFNjcm9sbENhbnZhcy53aWR0aCwgdGhpcy52ZXJ0aWNhbFNjcm9sbENhbnZhcy5oZWlnaHQpOwogICAgICAgIHZjdHguc2F2ZSgpOwoKICAgICAgICB2YXIgeXRoZW1lcyA9ICh0aGlzLm92ZXJZU2Nyb2xsQmFyKSB8fCAodGhpcy55c2Nyb2xsYmFyLm1vdXNlZG93blZhbHVlICE9IG51bGwpID8KICAgICAgICAgICAgICAgICAgICAgIHsgbjogZWQudGhlbWUuZnVsbE5pYlN0eWxlLCBhOiBlZC50aGVtZS5mdWxsTmliQXJyb3dTdHlsZSwgczogZWQudGhlbWUuZnVsbE5pYlN0cm9rZVN0eWxlIH0gOgogICAgICAgICAgICAgICAgICAgICAgeyBuOiBlZC50aGVtZS5wYXJ0aWFsTmliU3R5bGUsIGE6IGVkLnRoZW1lLnBhcnRpYWxOaWJBcnJvd1N0eWxlLCBzOiBlZC50aGVtZS5wYXJ0aWFsTmliU3Ryb2tlU3R5bGUgfTsKICAgICAgICB2YXIgeHRoZW1lcyA9ICh0aGlzLm92ZXJYU2Nyb2xsQmFyKSB8fCAodGhpcy54c2Nyb2xsYmFyLm1vdXNlZG93blZhbHVlICE9IG51bGwpID8KICAgICAgICAgICAgICAgICAgICAgIHsgbjogZWQudGhlbWUuZnVsbE5pYlN0eWxlLCBhOiBlZC50aGVtZS5mdWxsTmliQXJyb3dTdHlsZSwgczogZWQudGhlbWUuZnVsbE5pYlN0cm9rZVN0eWxlIH0gOgogICAgICAgICAgICAgICAgICAgICAgeyBuOiBlZC50aGVtZS5wYXJ0aWFsTmliU3R5bGUsIGE6IGVkLnRoZW1lLnBhcnRpYWxOaWJBcnJvd1N0eWxlLCBzOiBlZC50aGVtZS5wYXJ0aWFsTmliU3Ryb2tlU3R5bGUgfTsKCiAgICAgICAgdmFyIG1pZHBvaW50ID0gTWF0aC5mbG9vcih0aGlzLk5JQl9XSURUSCAvIDIpOwoKICAgICAgICB0aGlzLm5pYnVwID0gbmV3IFJlY3QoY3dpZHRoIC0gdGhpcy5OSUJfSU5TRVRTLnJpZ2h0IC0gdGhpcy5OSUJfV0lEVEgsCiAgICAgICAgICAgICAgICB0aGlzLk5JQl9JTlNFVFMudG9wLCB0aGlzLk5JQl9XSURUSCwgdGhpcy5OSUJfV0lEVEgpOwoKICAgICAgICB0aGlzLm5pYmRvd24gPSBuZXcgUmVjdChjd2lkdGggLSB0aGlzLk5JQl9JTlNFVFMucmlnaHQgLSB0aGlzLk5JQl9XSURUSCwKICAgICAgICAgICAgICAgIGNoZWlnaHQgLSAodGhpcy5OSUJfV0lEVEggKiAyKSAtICh0aGlzLk5JQl9JTlNFVFMuYm90dG9tICogMiksCiAgICAgICAgICAgICAgICB0aGlzLk5JQl9JTlNFVFMudG9wLAogICAgICAgICAgICAgICAgdGhpcy5OSUJfV0lEVEgsIHRoaXMuTklCX1dJRFRIKTsKCiAgICAgICAgdGhpcy5uaWJsZWZ0ID0gbmV3IFJlY3QodGhpcy5HVVRURVJfV0lEVEggKyB0aGlzLk5JQl9JTlNFVFMubGVmdCwgY2hlaWdodCAtIHRoaXMuTklCX0lOU0VUUy5ib3R0b20gLSB0aGlzLk5JQl9XSURUSCwKICAgICAgICAgICAgICAgIHRoaXMuTklCX1dJRFRILCB0aGlzLk5JQl9XSURUSCk7CgogICAgICAgIHRoaXMubmlicmlnaHQgPSBuZXcgUmVjdChjd2lkdGggLSAodGhpcy5OSUJfSU5TRVRTLnJpZ2h0ICogMikgLSAodGhpcy5OSUJfV0lEVEggKiAyKSwKICAgICAgICAgICAgICAgIGNoZWlnaHQgLSB0aGlzLk5JQl9JTlNFVFMuYm90dG9tIC0gdGhpcy5OSUJfV0lEVEgsCiAgICAgICAgICAgICAgICB0aGlzLk5JQl9XSURUSCwgdGhpcy5OSUJfV0lEVEgpOwoKICAgICAgICB2Y3R4LnRyYW5zbGF0ZSgtdmVydGljYWx4LCAwKTsKICAgICAgICBoY3R4LnRyYW5zbGF0ZSgwLCAtaG9yaXpvbnRhbHkpOwoKICAgICAgICBpZiAoeHNjcm9sbCAmJiAoKHRoaXMub3ZlclhTY3JvbGxCYXIpIHx8ICh0aGlzLnhzY3JvbGxiYXIubW91c2Vkb3duVmFsdWUgIT0gbnVsbCkpKSB7CiAgICAgICAgICAgIGhjdHguc2F2ZSgpOwoKICAgICAgICAgICAgaGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgaGN0eC5yZWN0KHRoaXMubmlibGVmdC54ICsgbWlkcG9pbnQgKyAyLCAwLCB0aGlzLm5pYnJpZ2h0LnggLSB0aGlzLm5pYmxlZnQueCAtIDEsIGNoZWlnaHQpOyAvLyB5IHBvaW50cyBkb24ndCBtYXR0ZXIKICAgICAgICAgICAgaGN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgaGN0eC5jbGlwKCk7CgogICAgICAgICAgICBoY3R4LmZpbGxTdHlsZSA9IGVkLnRoZW1lLnNjcm9sbFRyYWNrRmlsbFN0eWxlOwogICAgICAgICAgICBoY3R4LmZpbGxSZWN0KHRoaXMubmlibGVmdC54LCB0aGlzLm5pYmxlZnQueSAtIDEsIHRoaXMubmlicmlnaHQueDIgLSB0aGlzLm5pYmxlZnQueCwgdGhpcy5uaWJsZWZ0LmggKyAxKTsKCiAgICAgICAgICAgIGhjdHguc3Ryb2tlU3R5bGUgPSBlZC50aGVtZS5zY3JvbGxUcmFja1N0cm9rZVN0eWxlOwogICAgICAgICAgICBoY3R4LnN0cm9rZVJlY3QodGhpcy5uaWJsZWZ0LngsIHRoaXMubmlibGVmdC55IC0gMSwgdGhpcy5uaWJyaWdodC54MiAtIHRoaXMubmlibGVmdC54LCB0aGlzLm5pYmxlZnQuaCArIDEpOwoKICAgICAgICAgICAgaGN0eC5yZXN0b3JlKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoeXNjcm9sbCAmJiAoKHRoaXMub3ZlcllTY3JvbGxCYXIpIHx8ICh0aGlzLnlzY3JvbGxiYXIubW91c2Vkb3duVmFsdWUgIT0gbnVsbCkpKSB7CiAgICAgICAgICAgIHZjdHguc2F2ZSgpOwoKICAgICAgICAgICAgdmN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgdmN0eC5yZWN0KDAsIHRoaXMubmlidXAueSArIG1pZHBvaW50ICsgMiwgY3dpZHRoLCB0aGlzLm5pYmRvd24ueSAtIHRoaXMubmlidXAueSAtIDEpOyAvLyB4IHBvaW50cyBkb24ndCBtYXR0ZXIKICAgICAgICAgICAgdmN0eC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgdmN0eC5jbGlwKCk7CgogICAgICAgICAgICB2Y3R4LmZpbGxTdHlsZSA9IGVkLnRoZW1lLnNjcm9sbFRyYWNrRmlsbFN0eWxlOwogICAgICAgICAgICB2Y3R4LmZpbGxSZWN0KHRoaXMubmlidXAueCAtIDEsIHRoaXMubmlidXAueSwgdGhpcy5uaWJ1cC53ICsgMSwgdGhpcy5uaWJkb3duLnkyIC0gdGhpcy5uaWJ1cC55KTsKCiAgICAgICAgICAgIHZjdHguc3Ryb2tlU3R5bGUgPSBlZC50aGVtZS5zY3JvbGxUcmFja1N0cm9rZVN0eWxlOwogICAgICAgICAgICB2Y3R4LnN0cm9rZVJlY3QodGhpcy5uaWJ1cC54IC0gMSwgdGhpcy5uaWJ1cC55LCB0aGlzLm5pYnVwLncgKyAxLCB0aGlzLm5pYmRvd24ueTIgLSB0aGlzLm5pYnVwLnkpOwoKICAgICAgICAgICAgdmN0eC5yZXN0b3JlKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoeXNjcm9sbCkgewogICAgICAgICAgICAvLyB1cCBhcnJvdwogICAgICAgICAgICBpZiAoKHNob3dVcFNjcm9sbE5pYikgfHwgKHRoaXMub3ZlcllTY3JvbGxCYXIpIHx8ICh0aGlzLnlzY3JvbGxiYXIubW91c2Vkb3duVmFsdWUgIT0gbnVsbCkpIHsKICAgICAgICAgICAgICAgIHZjdHguc2F2ZSgpOwogICAgICAgICAgICAgICAgdmN0eC50cmFuc2xhdGUodGhpcy5uaWJ1cC54ICsgbWlkcG9pbnQsIHRoaXMubmlidXAueSArIG1pZHBvaW50KTsKICAgICAgICAgICAgICAgIHRoaXMucGFpbnROaWIodmN0eCwgeXRoZW1lcy5uLCB5dGhlbWVzLmEsIHl0aGVtZXMucyk7CiAgICAgICAgICAgICAgICB2Y3R4LnJlc3RvcmUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZG93biBhcnJvdwogICAgICAgICAgICBpZiAoKHNob3dEb3duU2Nyb2xsTmliKSB8fCAodGhpcy5vdmVyWVNjcm9sbEJhcikgfHwgKHRoaXMueXNjcm9sbGJhci5tb3VzZWRvd25WYWx1ZSAhPSBudWxsKSkgewogICAgICAgICAgICAgICAgdmN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICB2Y3R4LnRyYW5zbGF0ZSh0aGlzLm5pYmRvd24ueCArIG1pZHBvaW50LCB0aGlzLm5pYmRvd24ueSArIG1pZHBvaW50KTsKICAgICAgICAgICAgICAgIHZjdHgucm90YXRlKE1hdGguUEkpOwogICAgICAgICAgICAgICAgdGhpcy5wYWludE5pYih2Y3R4LCB5dGhlbWVzLm4sIHl0aGVtZXMuYSwgeXRoZW1lcy5zKTsKICAgICAgICAgICAgICAgIHZjdHgucmVzdG9yZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoeHNjcm9sbCkgewogICAgICAgICAgICAvLyBsZWZ0IGFycm93CiAgICAgICAgICAgIGlmICgoc2hvd0xlZnRTY3JvbGxOaWIpIHx8ICh0aGlzLm92ZXJYU2Nyb2xsQmFyKSB8fCAodGhpcy54c2Nyb2xsYmFyLm1vdXNlZG93blZhbHVlICE9IG51bGwpKSB7CiAgICAgICAgICAgICAgICBoY3R4LnNhdmUoKTsKICAgICAgICAgICAgICAgIGhjdHgudHJhbnNsYXRlKHRoaXMubmlibGVmdC54ICsgbWlkcG9pbnQsIHRoaXMubmlibGVmdC55ICsgbWlkcG9pbnQpOwogICAgICAgICAgICAgICAgaGN0eC5yb3RhdGUoTWF0aC5QSSAqIDEuNSk7CiAgICAgICAgICAgICAgICB0aGlzLnBhaW50TmliKGhjdHgsIHh0aGVtZXMubiwgeHRoZW1lcy5hLCB4dGhlbWVzLnMpOwogICAgICAgICAgICAgICAgaGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHJpZ2h0IGFycm93CiAgICAgICAgICAgIGlmICgoc2hvd1JpZ2h0U2Nyb2xsTmliKSB8fCAodGhpcy5vdmVyWFNjcm9sbEJhcikgfHwgKHRoaXMueHNjcm9sbGJhci5tb3VzZWRvd25WYWx1ZSAhPSBudWxsKSkgewogICAgICAgICAgICAgICAgaGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBoY3R4LnRyYW5zbGF0ZSh0aGlzLm5pYnJpZ2h0LnggKyBtaWRwb2ludCwgdGhpcy5uaWJyaWdodC55ICsgbWlkcG9pbnQpOwogICAgICAgICAgICAgICAgaGN0eC5yb3RhdGUoTWF0aC5QSSAqIDAuNSk7CiAgICAgICAgICAgICAgICB0aGlzLnBhaW50TmliKGhjdHgsIHh0aGVtZXMubiwgeHRoZW1lcy5hLCB4dGhlbWVzLnMpOwogICAgICAgICAgICAgICAgaGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIHRoZSBiYXIKICAgICAgICB2YXIgc3ggPSB0aGlzLm5pYmxlZnQueDIgKyA0OwogICAgICAgIHZhciBzdyA9IHRoaXMubmlicmlnaHQueCAtIHRoaXMubmlibGVmdC54MiAtIDk7CiAgICAgICAgdGhpcy54c2Nyb2xsYmFyLnJlY3QgPSBuZXcgUmVjdChzeCwgdGhpcy5uaWJsZWZ0LnkgLSAxLCBzdywgdGhpcy5uaWJsZWZ0LmggKyAxKTsKICAgICAgICB0aGlzLnhzY3JvbGxiYXIudmFsdWUgPSAtdGhpcy54b2Zmc2V0OwogICAgICAgIHRoaXMueHNjcm9sbGJhci5taW4gPSAwOwogICAgICAgIHRoaXMueHNjcm9sbGJhci5tYXggPSB2aXJ0dWFsd2lkdGggLSAoY3dpZHRoIC0gdGhpcy5HVVRURVJfV0lEVEgpOwogICAgICAgIHRoaXMueHNjcm9sbGJhci5leHRlbnQgPSBjd2lkdGggLSB0aGlzLkdVVFRFUl9XSURUSDsKCiAgICAgICAgaWYgKHhzY3JvbGwpIHsKICAgICAgICAgICAgdmFyIGZ1bGxvbnhiYXIgPSAoKCh0aGlzLm92ZXJYU2Nyb2xsQmFyKSAmJiAodmlydHVhbHdpZHRoID4gY3dpZHRoKSkgfHwgKCh0aGlzLnhzY3JvbGxiYXIpICYmICh0aGlzLnhzY3JvbGxiYXIubW91c2Vkb3duVmFsdWUgIT0gbnVsbCkpKTsKICAgICAgICAgICAgaWYgKCFmdWxsb254YmFyKSBoY3R4Lmdsb2JhbEFscGhhID0gMC4zOwogICAgICAgICAgICB0aGlzLnBhaW50U2Nyb2xsYmFyKGhjdHgsIHRoaXMueHNjcm9sbGJhcik7CiAgICAgICAgICAgIGhjdHguZ2xvYmFsQWxwaGEgPSAxLjA7CiAgICAgICAgfQoKICAgICAgICB2YXIgc3kgPSB0aGlzLm5pYnVwLnkyICsgNDsKICAgICAgICB2YXIgc2ggPSB0aGlzLm5pYmRvd24ueSAtIHRoaXMubmlidXAueTIgLSA5OwogICAgICAgIHRoaXMueXNjcm9sbGJhci5yZWN0ID0gbmV3IFJlY3QodGhpcy5uaWJ1cC54IC0gMSwgc3ksIHRoaXMubmlidXAudyArIDEsIHNoKTsKICAgICAgICB0aGlzLnlzY3JvbGxiYXIudmFsdWUgPSAtdGhpcy55b2Zmc2V0OwogICAgICAgIHRoaXMueXNjcm9sbGJhci5taW4gPSAwOwogICAgICAgIHRoaXMueXNjcm9sbGJhci5tYXggPSB2aXJ0dWFsaGVpZ2h0IC0gY2hlaWdodDsKICAgICAgICB0aGlzLnlzY3JvbGxiYXIuZXh0ZW50ID0gY2hlaWdodDsKCiAgICAgICAgaWYgKHlzY3JvbGwpIHsKICAgICAgICAgICAgdmFyIGZ1bGxvbnliYXIgPSAoKHRoaXMub3ZlcllTY3JvbGxCYXIpICYmICh2aXJ0dWFsaGVpZ2h0ID4gY2hlaWdodCkpIHx8ICgodGhpcy55c2Nyb2xsYmFyKSAmJiAodGhpcy55c2Nyb2xsYmFyLm1vdXNlZG93blZhbHVlICE9IG51bGwpKTsKICAgICAgICAgICAgaWYgKCFmdWxsb255YmFyKSB2Y3R4Lmdsb2JhbEFscGhhID0gMC4zOwogICAgICAgICAgICB0aGlzLnBhaW50U2Nyb2xsYmFyKHZjdHgsIHRoaXMueXNjcm9sbGJhcik7CiAgICAgICAgICAgIHZjdHguZ2xvYmFsQWxwaGEgPSAxOwogICAgICAgIH0KCiAgICAgICAgLy8gY29tcG9zaXRlIHRoZSBzY3JvbGxiYXJzCiAgICAgICAgY3R4LmRyYXdJbWFnZSh0aGlzLnZlcnRpY2FsU2Nyb2xsQ2FudmFzLCB2ZXJ0aWNhbHgsIDApOwogICAgICAgIGN0eC5kcmF3SW1hZ2UodGhpcy5ob3Jpem9udGFsU2Nyb2xsQ2FudmFzLCAwLCBob3Jpem9udGFseSk7CiAgICAgICAgaGN0eC5yZXN0b3JlKCk7CiAgICAgICAgdmN0eC5yZXN0b3JlKCk7CgogICAgICAgIC8vIGNsZWFyIHRoZSB1bnVzdWVkIG5pYnMKICAgICAgICBpZiAoIXNob3dVcFNjcm9sbE5pYikgdGhpcy5uaWJ1cCA9IG5ldyBSZWN0KCk7CiAgICAgICAgaWYgKCFzaG93RG93blNjcm9sbE5pYikgdGhpcy5uaWJkb3duID0gbmV3IFJlY3QoKTsKICAgICAgICBpZiAoIXNob3dMZWZ0U2Nyb2xsTmliKSB0aGlzLm5pYmxlZnQgPSBuZXcgUmVjdCgpOwogICAgICAgIGlmICghc2hvd1JpZ2h0U2Nyb2xsTmliKSB0aGlzLm5pYnJpZ2h0ID0gbmV3IFJlY3QoKTsKICAgIH0sCgogICAgcGFpbnRTY3JvbGxiYXI6IGZ1bmN0aW9uKGN0eCwgc2Nyb2xsYmFyKSB7CiAgICAgICAgdmFyIGJhciA9IHNjcm9sbGJhci5nZXRIYW5kbGVCb3VuZHMoKTsKICAgICAgICB2YXIgYWxwaGEgPSAoY3R4Lmdsb2JhbEFscGhhKSA/IGN0eC5nbG9iYWxBbHBoYSA6IDE7CgogICAgICAgIGlmICghc2Nyb2xsYmFyLmlzSCgpKSB7CiAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgIGN0eC50cmFuc2xhdGUoYmFyLnggKyBNYXRoLmZsb29yKGJhci53IC8gMiksIGJhci55ICsgTWF0aC5mbG9vcihiYXIuaCAvIDIpKTsKICAgICAgICAgICAgY3R4LnJvdGF0ZShNYXRoLlBJICogMS41KTsKICAgICAgICAgICAgY3R4LnRyYW5zbGF0ZSgtKGJhci54ICsgTWF0aC5mbG9vcihiYXIudyAvIDIpKSwgLShiYXIueSArIE1hdGguZmxvb3IoYmFyLmggLyAyKSkpOwoKICAgICAgICAgICAgLy8gaWYgd2UncmUgdmVydGljYWwsIHRoZSBiYXIgbmVlZHMgdG8gYmUgcmUtd29ya2VkIGEgYml0CiAgICAgICAgICAgIGJhciA9IG5ldyBCZXNwaW4uRWRpdG9yLlJlY3QoYmFyLnggLSBNYXRoLmZsb29yKGJhci5oIC8gMikgKyBNYXRoLmZsb29yKGJhci53IC8gMiksCiAgICAgICAgICAgICAgICAgICAgYmFyLnkgKyBNYXRoLmZsb29yKGJhci5oIC8gMikgLSBNYXRoLmZsb29yKGJhci53IC8gMiksIGJhci5oLCBiYXIudyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgaGFsZmhlaWdodCA9IGJhci5oIC8gMjsKCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5hcmMoYmFyLnggKyBoYWxmaGVpZ2h0LCBiYXIueSArIGhhbGZoZWlnaHQsIGhhbGZoZWlnaHQsIE1hdGguUEkgLyAyLCAzICogKE1hdGguUEkgLyAyKSwgZmFsc2UpOwogICAgICAgIGN0eC5hcmMoYmFyLngyIC0gaGFsZmhlaWdodCwgYmFyLnkgKyBoYWxmaGVpZ2h0LCBoYWxmaGVpZ2h0LCAzICogKE1hdGguUEkgLyAyKSwgTWF0aC5QSSAvIDIsIGZhbHNlKTsKICAgICAgICBjdHgubGluZVRvKGJhci54ICsgaGFsZmhlaWdodCwgYmFyLnkgKyBiYXIuaCk7CiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwoKICAgICAgICB2YXIgZ3JhZGllbnQgPSBjdHguY3JlYXRlTGluZWFyR3JhZGllbnQoYmFyLngsIGJhci55LCBiYXIueCwgYmFyLnkgKyBiYXIuaCk7CiAgICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKDAsIHRoaXMuZWRpdG9yLnRoZW1lLnNjcm9sbEJhckZpbGxHcmFkaWVudFRvcFN0YXJ0LnN1YigiJWEiLCBhbHBoYSkpOwogICAgICAgIGdyYWRpZW50LmFkZENvbG9yU3RvcCgwLjQsIHRoaXMuZWRpdG9yLnRoZW1lLnNjcm9sbEJhckZpbGxHcmFkaWVudFRvcFN0b3Auc3ViKCIlYSIsIGFscGhhKSk7CiAgICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKDAuNDEsIHRoaXMuZWRpdG9yLnRoZW1lLnNjcm9sbEJhckZpbGxTdHlsZS5zdWIoIiVhIiwgYWxwaGEpKTsKICAgICAgICBncmFkaWVudC5hZGRDb2xvclN0b3AoMC44LCB0aGlzLmVkaXRvci50aGVtZS5zY3JvbGxCYXJGaWxsR3JhZGllbnRCb3R0b21TdGFydC5zdWIoIiVhIiwgYWxwaGEpKTsKICAgICAgICBncmFkaWVudC5hZGRDb2xvclN0b3AoMSwgdGhpcy5lZGl0b3IudGhlbWUuc2Nyb2xsQmFyRmlsbEdyYWRpZW50Qm90dG9tU3RvcC5zdWIoIiVhIiwgYWxwaGEpKTsKICAgICAgICBjdHguZmlsbFN0eWxlID0gZ3JhZGllbnQ7CiAgICAgICAgY3R4LmZpbGwoKTsKCiAgICAgICAgY3R4LnNhdmUoKTsKICAgICAgICBjdHguY2xpcCgpOwoKICAgICAgICBjdHguZmlsbFN0eWxlID0gdGhpcy5lZGl0b3IudGhlbWUuc2Nyb2xsQmFyRmlsbFN0eWxlLnN1YigiJWEiLCBhbHBoYSk7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oYmFyLnggKyAoaGFsZmhlaWdodCAqIDAuNCksIGJhci55ICsgKGhhbGZoZWlnaHQgKiAwLjYpKTsKICAgICAgICBjdHgubGluZVRvKGJhci54ICsgKGhhbGZoZWlnaHQgKiAwLjkpLCBiYXIueSArIChiYXIuaCAqIDAuNCkpOwogICAgICAgIGN0eC5saW5lVG8oYmFyLngsIGJhci55ICsgKGJhci5oICogMC40KSk7CiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oYmFyLnggKyBiYXIudyAtIChoYWxmaGVpZ2h0ICogMC40KSwgYmFyLnkgKyAoaGFsZmhlaWdodCAqIDAuNikpOwogICAgICAgIGN0eC5saW5lVG8oYmFyLnggKyBiYXIudyAtIChoYWxmaGVpZ2h0ICogMC45KSwgYmFyLnkgKyAoYmFyLmggKiAwLjQpKTsKICAgICAgICBjdHgubGluZVRvKGJhci54ICsgYmFyLncsIGJhci55ICsgKGJhci5oICogMC40KSk7CiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5maWxsKCk7CgogICAgICAgIGN0eC5yZXN0b3JlKCk7CgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHguYXJjKGJhci54ICsgaGFsZmhlaWdodCwgYmFyLnkgKyBoYWxmaGVpZ2h0LCBoYWxmaGVpZ2h0LCBNYXRoLlBJIC8gMiwgMyAqIChNYXRoLlBJIC8gMiksIGZhbHNlKTsKICAgICAgICBjdHguYXJjKGJhci54MiAtIGhhbGZoZWlnaHQsIGJhci55ICsgaGFsZmhlaWdodCwgaGFsZmhlaWdodCwgMyAqIChNYXRoLlBJIC8gMiksIE1hdGguUEkgLyAyLCBmYWxzZSk7CiAgICAgICAgY3R4LmxpbmVUbyhiYXIueCArIGhhbGZoZWlnaHQsIGJhci55ICsgYmFyLmgpOwogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKCiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gdGhpcy5lZGl0b3IudGhlbWUuc2Nyb2xsVHJhY2tTdHJva2VTdHlsZTsKICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgIGlmICghc2Nyb2xsYmFyLmlzSCgpKSB7CiAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgfQogICAgfSwKCiAgICBwYWludE5pYjogZnVuY3Rpb24oY3R4LCBuaWJTdHlsZSwgYXJyb3dTdHlsZSwgc3Ryb2tlU3R5bGUpIHsKICAgICAgICB2YXIgbWlkcG9pbnQgPSBNYXRoLmZsb29yKHRoaXMuTklCX1dJRFRIIC8gMik7CgogICAgICAgIGN0eC5maWxsU3R5bGUgPSBuaWJTdHlsZTsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4LmFyYygwLCAwLCBNYXRoLmZsb29yKHRoaXMuTklCX1dJRFRIIC8gMiksIDAsIE1hdGguUEkgKiAyLCB0cnVlKTsKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBzdHJva2VTdHlsZTsKICAgICAgICBjdHguc3Ryb2tlKCk7CgogICAgICAgIGN0eC5maWxsU3R5bGUgPSBhcnJvd1N0eWxlOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKDAsIC1taWRwb2ludCArIHRoaXMuTklCX0FSUk9XX0lOU0VUUy50b3ApOwogICAgICAgIGN0eC5saW5lVG8oLW1pZHBvaW50ICsgdGhpcy5OSUJfQVJST1dfSU5TRVRTLmxlZnQsIG1pZHBvaW50IC0gdGhpcy5OSUJfQVJST1dfSU5TRVRTLmJvdHRvbSk7CiAgICAgICAgY3R4LmxpbmVUbyhtaWRwb2ludCAtIHRoaXMuTklCX0FSUk9XX0lOU0VUUy5yaWdodCwgbWlkcG9pbnQgLSB0aGlzLk5JQl9BUlJPV19JTlNFVFMuYm90dG9tKTsKICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgY3R4LmZpbGwoKTsKICAgIH0KfSk7CgovLyAqKiB7e3sgQmVzcGluLkVkaXRvci5BUEkgfX19ICoqCi8vCi8vIFRoZSByb290IG9iamVjdC4gVGhpcyBpcyB0aGUgQVBJIHRoYXQgb3RoZXJzIHNob3VsZCBiZSBhYmxlIHRvIHVzZQoKQmVzcGluLkVkaXRvci5BUEkgPSBDbGFzcy5jcmVhdGUoewogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oY29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5jb250YWluZXIgPSBjb250YWluZXI7CiAgICAgICAgdGhpcy5tb2RlbCA9IG5ldyBCZXNwaW4uRWRpdG9yLkRvY3VtZW50TW9kZWwoKTsKCiAgICAgICAgJChjb250YWluZXIpLmlubmVySFRNTCA9ICI8Y2FudmFzIGlkPSdjYW52YXMnIG1vei1vcGFxdWU9J3RydWUnIHRhYmluZGV4PSctMSc+PC9jYW52YXM+IjsKICAgICAgICB0aGlzLmNhbnZhcyA9ICQoY29udGFpbmVyKS5jaGlsZEVsZW1lbnRzKClbMF07CgogICAgICAgIHRoaXMudWkgPSBuZXcgQmVzcGluLkVkaXRvci5VSSh0aGlzKTsKICAgICAgICB0aGlzLnRoZW1lID0gQmVzcGluLlRoZW1lc1snZGVmYXVsdCddOyAvLyBzZXQgdGhlIGRlZmF1bHQgd2hpY2ggaXMgaW4gdGhlbWVzLmpzIChDb2ZmZWUpCiAgICAgICAgdGhpcy5jdXJzb3JQb3NpdGlvbiA9IHsgcm93OiAwLCBjb2w6IDAgfQogICAgICAgIHRoaXMuZWRpdG9yS2V5TGlzdGVuZXIgPSBuZXcgQmVzcGluLkVkaXRvci5EZWZhdWx0RWRpdG9yS2V5TGlzdGVuZXIodGhpcyk7CiAgICAgICAgdGhpcy51bmRvTWFuYWdlciA9IG5ldyBCZXNwaW4uRWRpdG9yLlVuZG9NYW5hZ2VyKHRoaXMpOwogICAgICAgIHRoaXMuY3VzdG9tRXZlbnRzID0gbmV3IEJlc3Bpbi5FZGl0b3IuRXZlbnRzKHRoaXMpOwoKICAgICAgICB0aGlzLnVpLmluc3RhbGxLZXlMaXN0ZW5lcih0aGlzLmVkaXRvcktleUxpc3RlbmVyKTsKCiAgICAgICAgdGhpcy5tb2RlbC5pbnNlcnRDaGFyYWN0ZXJzKHtyb3c6IDAsIGNvbDogMH0sICIgIik7CgogICAgICAgIEV2ZW50Lm9ic2VydmUodGhpcy5jYW52YXMsICJibHVyIiwgIGZ1bmN0aW9uKGUpIHsgdGhpcy5zZXRGb2N1cyhmYWxzZSk7IH0uYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzKSk7CiAgICAgICAgRXZlbnQub2JzZXJ2ZSh0aGlzLmNhbnZhcywgImZvY3VzIiwgZnVuY3Rpb24oZSkgeyB0aGlzLnNldEZvY3VzKHRydWUpOyAgfS5iaW5kQXNFdmVudExpc3RlbmVyKHRoaXMpKTsKCiAgICAgICAgdGhpcy5wYWludCgpOwogICAgfSwKCiAgICBtb3ZlQ3Vyc29yOiBmdW5jdGlvbihuZXdwb3MpIHsKICAgICAgICB2YXIgcm93ID0gTWF0aC5taW4obmV3cG9zLnJvdywgdGhpcy5tb2RlbC5nZXRSb3dDb3VudCgpIC0gMSk7IC8vIGxhc3Qgcm93IGlmIHlvdSBnbyBvdmVyCiAgICAgICAgaWYgKHJvdyA8IDApIHJvdyA9IDA7IC8vIGNhbid0IG1vdmUgbmVnYXRpdmUgb2ZmIHNjcmVlbgogICAgICAgIHRoaXMuY3Vyc29yUG9zaXRpb24gPSB7IHJvdzogcm93LCBjb2w6IG5ld3Bvcy5jb2wgfTsKICAgIH0sCgogICAgLy8gZW5zdXJlcyB0aGF0IHRoZSBzdGFydCBwb3NpdGlvbiBpcyBiZWZvcmUgdGhlIGVuZCBwb3NpdGlvbjsgcmVhZGluZyBkaXJlY3RseSBmcm9tIHRoZSBzZWxlY3Rpb24gcHJvcGVydHkgbWFrZXMgbm8gc3VjaCBndWFyYW50ZWUKICAgIGdldFNlbGVjdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLnNlbGVjdGlvbikgcmV0dXJuIHVuZGVmaW5lZDsKCiAgICAgICAgdmFyIHN0YXJ0UG9zID0gdGhpcy5zZWxlY3Rpb24uc3RhcnRQb3M7CiAgICAgICAgdmFyIGVuZFBvcyA9IHRoaXMuc2VsZWN0aW9uLmVuZFBvczsKCiAgICAgICAgLy8gZW5zdXJlIHRoYXQgdGhlIHN0YXJ0IHBvc2l0aW9uIGlzIGFsd2F5cyBiZWZvcmUgdGhhbiB0aGUgZW5kIHBvc2l0aW9uCiAgICAgICAgaWYgKChlbmRQb3Mucm93IDwgc3RhcnRQb3Mucm93KSB8fCAoKGVuZFBvcy5yb3cgPT0gc3RhcnRQb3Mucm93KSAmJiAoZW5kUG9zLmNvbCA8IHN0YXJ0UG9zLmNvbCkpKSB7CiAgICAgICAgICAgIHZhciBmb28gPSBzdGFydFBvczsKICAgICAgICAgICAgc3RhcnRQb3MgPSBlbmRQb3M7CiAgICAgICAgICAgIGVuZFBvcyA9IGZvbzsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7IHN0YXJ0UG9zOiBCZXNwaW4uRWRpdG9yLlV0aWxzLmNvcHlQb3Moc3RhcnRQb3MpLCBlbmRQb3M6IEJlc3Bpbi5FZGl0b3IuVXRpbHMuY29weVBvcyhlbmRQb3MpIH0KICAgIH0sCgogICAgc2V0U2VsZWN0aW9uOiBmdW5jdGlvbihzZWxlY3Rpb24pIHsKICAgICAgICB0aGlzLnNlbGVjdGlvbiA9IHNlbGVjdGlvbjsKICAgICAgICBpZiAodGhpcy51bmRvTWFuYWdlci5zeW5jSGVscGVyKSB0aGlzLnVuZG9NYW5hZ2VyLnN5bmNIZWxwZXIucXVldWVTZWxlY3Qoc2VsZWN0aW9uKTsKICAgIH0sCgogICAgcGFpbnQ6IGZ1bmN0aW9uKGZ1bGxSZWZyZXNoKSB7CiAgICAgICAgdmFyIGN0eCA9IEJlc3Bpbi5DYW52YXMuRml4KHRoaXMuY2FudmFzLmdldENvbnRleHQoIjJkIikpOwogICAgICAgIHRoaXMudWkucGFpbnQoY3R4LCBmdWxsUmVmcmVzaCk7CiAgICB9LAoKICAgIGNoYW5nZUtleUxpc3RlbmVyOiBmdW5jdGlvbihuZXdLZXlMaXN0ZW5lcikgewogICAgICAgIHRoaXMudWkuaW5zdGFsbEtleUxpc3RlbmVyKG5ld0tleUxpc3RlbmVyKTsKICAgICAgICB0aGlzLmVkaXRvcktleUxpc3RlbmVyID0gbmV3S2V5TGlzdGVuZXI7CiAgICB9LAoKICAgIC8vIHRoaXMgZG9lcyBub3Qgc2V0IGZvY3VzIHRvIHRoZSBlZGl0b3I7IGl0IGluZGljYXRlcyB0aGF0IGZvY3VzIGhhcyBiZWVuIHNldCB0byB0aGUgdW5kZXJseWluZyBjYW52YXMKICAgIHNldEZvY3VzOiBmdW5jdGlvbihmb2N1cykgewogICAgICAgIHRoaXMuZm9jdXMgPSBmb2N1czsKICAgIH0KfSk7CgovLyAqKiB7e3sgQmVzcGluLkVkaXRvci5FdmVudHMgfX19ICoqCi8vCi8vIEhhbmRsZSBjdXN0b20gZXZlbnRzIGFpbWVkIGF0LCBhbmQgZm9yIHRoZSBlZGl0b3IKQmVzcGluLkVkaXRvci5FdmVudHMgPSBDbGFzcy5jcmVhdGUoewogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWRpdG9yKSB7CiAgICAgICAgdGhpcy5lZGl0b3IgPSBlZGl0b3I7CgogICAgICAgIGRvY3VtZW50Lm9ic2VydmUoImJlc3BpbjplZGl0b3I6b3BlbmZpbGU6b3BlbnN1Y2Nlc3MiLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICB2YXIgZmlsZSA9IGV2ZW50Lm1lbW8uZmlsZTsKCiAgICAgICAgICAgIGVkaXRvci5tb2RlbC5pbnNlcnREb2N1bWVudChmaWxlLmNvbnRlbnQpOwogICAgICAgICAgICBlZGl0b3IubW92ZUN1cnNvcih7IHJvdzogMCwgY29sOiAwIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyAtLSBmaXJlIGFuIGV2ZW50IGhlcmUgYW5kIHlvdSBjYW4gcnVuIGFueSBlZGl0b3IgYWN0aW9uCiAgICAgICAgZG9jdW1lbnQub2JzZXJ2ZSgiYmVzcGluOmVkaXRvcjpkb2FjdGlvbiIsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBhY3Rpb24gPSBldmVudC5tZW1vLmFjdGlvbjsKICAgICAgICAgICAgdmFyIGFyZ3MgICA9IGV2ZW50Lm1lbW8uYXJncyB8fCBCZXNwaW4uRWRpdG9yLlV0aWxzLmFyZ3NXaXRoUG9zKCk7CgogICAgICAgICAgICBpZiAoYWN0aW9uKSBlZGl0b3IudWkuYWN0aW9uc1thY3Rpb25dKGFyZ3MpOwogICAgICAgIH0pOwoKICAgICAgICAvLyAtLSBmaXJlIGFuIGV2ZW50IHRvIHNldHVwIGFueSBuZXcgb3IgcmVwbGFjZSBhY3Rpb25zCiAgICAgICAgZG9jdW1lbnQub2JzZXJ2ZSgiYmVzcGluOmVkaXRvcjpzZXRhY3Rpb24iLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICB2YXIgYWN0aW9uID0gZXZlbnQubWVtby5hY3Rpb247CiAgICAgICAgICAgIHZhciBjb2RlICAgPSBldmVudC5tZW1vLmNvZGU7CiAgICAgICAgICAgIGlmIChhY3Rpb24gJiYgT2JqZWN0LmlzRnVuY3Rpb24oY29kZSkpIGVkaXRvci51aS5hY3Rpb25zW2FjdGlvbl0gPSBjb2RlOwogICAgICAgIH0pOwoKICAgICAgICAvLyAtLSBhZGQga2V5IGxpc3RlbmVycwogICAgICAgIC8vIGUuZy4gYmluZGtleSBjdHJsIGIgbW92ZUN1cnNvckxlZnQKICAgICAgICBkb2N1bWVudC5vYnNlcnZlKCJiZXNwaW46ZWRpdG9yOmJpbmRrZXkiLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICB2YXIgbW9kaWZpZXJzID0gZXZlbnQubWVtby5tb2RpZmllcnMgfHwgJyc7CiAgICAgICAgICAgIGlmICghZXZlbnQubWVtby5rZXkpIHJldHVybjsKCiAgICAgICAgICAgIHZhciBrZXlDb2RlID0gQmVzcGluLktleVtldmVudC5tZW1vLmtleS50b1VwcGVyQ2FzZSgpXTsKCiAgICAgICAgICAgIC8vIC0tIHRyeSBhbiBlZGl0b3IgYWN0aW9uIGZpcnN0LCBlbHNlIGZpcmUgYXdheSBhdCB0aGUgZXZlbnQgYnVzCiAgICAgICAgICAgIHZhciBhY3Rpb24gPSBlZGl0b3IudWkuYWN0aW9uc1tldmVudC5tZW1vLmFjdGlvbl0gfHwgZXZlbnQubWVtby5hY3Rpb247CgogICAgICAgICAgICBpZiAoa2V5Q29kZSAmJiBhY3Rpb24pIHsKICAgICAgICAgICAgICAgIGVkaXRvci5lZGl0b3JLZXlMaXN0ZW5lci5iaW5kS2V5U3RyaW5nKG1vZGlmaWVycywga2V5Q29kZSwgYWN0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgIH0KfSk7Ci8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKioKICogVmVyc2lvbjogTVBMIDEuMQogKgogKiBUaGUgY29udGVudHMgb2YgdGhpcyBmaWxlIGFyZSBzdWJqZWN0IHRvIHRoZSBNb3ppbGxhIFB1YmxpYyBMaWNlbnNlCiAqIFZlcnNpb24gMS4xICh0aGUgIkxpY2Vuc2UiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4KICogY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICogaHR0cDovL3d3dy5tb3ppbGxhLm9yZy9NUEwvCiAqCiAqIFNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIKICogYmFzaXMsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyByaWdodHMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBUaGUgT3JpZ2luYWwgQ29kZSBpcyBCZXNwaW4uCiAqCiAqIFRoZSBJbml0aWFsIERldmVsb3BlciBvZiB0aGUgT3JpZ2luYWwgQ29kZSBpcyBNb3ppbGxhLgogKiBQb3J0aW9ucyBjcmVhdGVkIGJ5IHRoZSBJbml0aWFsIERldmVsb3BlciBhcmUgQ29weXJpZ2h0IChDKSAyMDA5CiAqIHRoZSBJbml0aWFsIERldmVsb3Blci4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogQ29udHJpYnV0b3Iocyk6CiAqICAgQmVzcGluIFRlYW0gKGJlc3BpbkBtb3ppbGxhLmNvbSkKICoKICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi8KCmlmICh0eXBlb2YgQmVzcGluID09ICJ1bmRlZmluZWQiKSBCZXNwaW4gPSB7fTsKaWYgKCFCZXNwaW4uRWRpdG9yKSBCZXNwaW4uRWRpdG9yID0ge307CgovLyA9IE1vZGVsID0KLy8KLy8gVGhlIGVkaXRvciBoYXMgYSBtb2RlbCBvZiB0aGUgZGF0YSB0aGF0IGl0IHdvcmtzIHdpdGguIAovLyBUaGlzIHJlcHJlc2VudGF0aW9uIGlzIGVuY2Fwc3VsYXRlZCBpbiBCZXNwaW4uRWRpdG9yLkRvY3VtZW50TW9kZWwKCkJlc3Bpbi5FZGl0b3IuRG9jdW1lbnRNb2RlbCA9IENsYXNzLmNyZWF0ZSh7CgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yb3dzID0gW107CiAgICB9LAoKICAgIGdldERpcnR5Um93czogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGRyID0gKHRoaXMuZGlydHlSb3dzKSA/IHRoaXMuZGlydHlSb3dzIDogW107CiAgICAgICAgdGhpcy5kaXJ0eVJvd3MgPSBudWxsOwogICAgICAgIHJldHVybiBkcjsKICAgIH0sCgogICAgc2V0Um93RGlydHk6IGZ1bmN0aW9uKHJvdykgewogICAgICAgIGlmICghdGhpcy5kaXJ0eVJvd3MpIHRoaXMuZGlydHlSb3dzID0gbmV3IEFycmF5KHRoaXMucm93cy5sZW5ndGgpOwogICAgICAgIHRoaXMuZGlydHlSb3dzW3Jvd10gPSB0cnVlOwogICAgfSwKCiAgICBzZXRSb3dBcnJheTogZnVuY3Rpb24ocm93SW5kZXgsIHJvdykgewogICAgICAgIGlmICghT2JqZWN0LmlzQXJyYXkocm93KSkgewogICAgICAgICAgICByb3cgPSByb3cuc3BsaXQoJycpOwogICAgICAgIH0KICAgICAgICB0aGlzLnJvd3Nbcm93SW5kZXhdID0gcm93OwogICAgfSwKCiAgICAvLyBnZXRzIHRoZSByb3cgYXJyYXkgZm9yIHRoZSBzcGVjaWZpZWQgcm93LCBjcmVhdGluZyBpdCBhbmQgYW55IGludGVybWVkaWF0ZSByb3dzIGFzIG5lY2Vzc2FyeQogICAgZ2V0Um93QXJyYXk6IGZ1bmN0aW9uKHJvd0luZGV4KSB7CiAgICAgICAgd2hpbGUgKHRoaXMucm93cy5sZW5ndGggPD0gcm93SW5kZXgpIHRoaXMucm93cy5wdXNoKFtdKTsKICAgICAgICByZXR1cm4gdGhpcy5yb3dzW3Jvd0luZGV4XTsKICAgIH0sCgogICAgLy8gZ2V0cyB0aGUgbnVtYmVyIG9mIGNoYXJhY3RlcnMgaW4gdGhlIHBhc3NlZCByb3cKICAgIGdldFJvd0xlbmd0aDogZnVuY3Rpb24ocm93SW5kZXgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRSb3dBcnJheShyb3dJbmRleCkubGVuZ3RoOwogICAgfSwKCiAgICAvLyBjaGVja3MgaWYgdGhlcmUgaXMgYSByb3cgYXQgdGhlIHNwZWNpZmllZCBpbmRleDsgdXNlZnVsIGJlY2F1c2UgZ2V0Um93QXJyYXkoKSBjcmVhdGVzIHJvd3MgYXMgbmVjZXNzYXJ5CiAgICBoYXNSb3c6IGZ1bmN0aW9uKHJvd0luZGV4KSB7CiAgICAgICAgcmV0dXJuICh0aGlzLnJvd3Nbcm93SW5kZXhdKTsKICAgIH0sCgogICAgLy8gd2lsbCBpbnNlcnQgYmxhbmsgc3BhY2VzIGlmIHBhc3NlZCBjb2wgaXMgcGFzdCB0aGUgZW5kIG9mIHBhc3NlZCByb3cKICAgIGluc2VydENoYXJhY3RlcnM6IGZ1bmN0aW9uKHBvcywgc3RyaW5nKSB7CiAgICAgICAgdmFyIHJvdyA9IHRoaXMuZ2V0Um93QXJyYXkocG9zLnJvdyk7CiAgICAgICAgd2hpbGUgKHJvdy5sZW5ndGggPCBwb3MuY29sKSByb3cucHVzaCgiICIpOwoKICAgICAgICB2YXIgbmV3cm93ID0gKHBvcy5jb2wgPiAwKSA/IHJvdy5zcGxpY2UoMCwgcG9zLmNvbCkgOiBbXTsKICAgICAgICBuZXdyb3cgPSBuZXdyb3cuY29uY2F0KHN0cmluZy5zcGxpdCgiIikpOwogICAgICAgIHRoaXMucm93c1twb3Mucm93XSA9IG5ld3Jvdy5jb25jYXQocm93KTsKCiAgICAgICAgdGhpcy5zZXRSb3dEaXJ0eShwb3Mucm93KTsKICAgIH0sCgogICAgZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBmaWxlID0gW107CiAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLmdldFJvd0NvdW50KCk7IHgrKykgewogICAgICAgICAgICBmaWxlW3hdID0gdGhpcy5nZXRSb3dBcnJheSh4KS5qb2luKCcnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZpbGUuam9pbigiXG4iKTsKICAgIH0sCgogICAgaW5zZXJ0RG9jdW1lbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgdmFyIHJvd3MgPSBjb250ZW50LnNwbGl0KCJcbiIpOwogICAgICAgIGZvciAodmFyIHggPSAwOyB4IDwgcm93cy5sZW5ndGg7IHgrKykgewogICAgICAgICAgICB0aGlzLmluc2VydENoYXJhY3RlcnMoeyByb3c6IHgsIGNvbDogMCB9LCByb3dzW3hdKTsKICAgICAgICB9CiAgICB9LAoKICAgIGNoYW5nZUVhY2hSb3c6IGZ1bmN0aW9uKGNoYW5nZUZ1bmN0aW9uKSB7CiAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLmdldFJvd0NvdW50KCk7IHgrKykgewogICAgICAgICAgICB2YXIgcm93ID0gdGhpcy5nZXRSb3dBcnJheSh4KTsKICAgICAgICAgICAgcm93ID0gY2hhbmdlRnVuY3Rpb24ocm93KTsKICAgICAgICAgICAgdGhpcy5zZXRSb3dBcnJheSh4LCByb3cpOwogICAgICAgIH0KICAgIH0sCgogICAgcmVwbGFjZTogZnVuY3Rpb24oc2VhcmNoLCByZXBsYWNlKSB7CiAgICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5nZXRSb3dDb3VudCgpOyB4KyspIHsKICAgICAgICB2YXIgbGluZSA9IHRoaXMuZ2V0Um93QXJyYXkoeCkuam9pbignJyk7CgogICAgICAgIGlmIChsaW5lLm1hdGNoKHNlYXJjaCkpIHsKICAgICAgICAgIHZhciByZWdleCA9IG5ldyBSZWdFeHAoc2VhcmNoLCAiZyIpOwogICAgICAgICAgdmFyIG5ld2xpbmUgPSBsaW5lLnJlcGxhY2UocmVnZXgsIHJlcGxhY2UpOwogICAgICAgICAgaWYgKG5ld2xpbmUgIT0gbGluZSkgewogICAgICAgICAgICB0aGlzLnJvd3NbeF0gPSBuZXdsaW5lLnNwbGl0KCcnKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLy8gd2lsbCBzaWxlbnRseSBhZGp1c3QgdGhlIGxlbmd0aCBhcmd1bWVudCBpZiBpbnZhbGlkCiAgICBkZWxldGVDaGFyYWN0ZXJzOiBmdW5jdGlvbihwb3MsIGxlbmd0aCkgewogICAgICAgIHZhciByb3cgPSB0aGlzLmdldFJvd0FycmF5KHBvcy5yb3cpOwogICAgICAgIHZhciBkaWZmID0gKHBvcy5jb2wgKyBsZW5ndGggLSAxKSAtIHJvdy5sZW5ndGg7CiAgICAgICAgaWYgKGRpZmYgPiAwKSBsZW5ndGggLT0gZGlmZjsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgICB0aGlzLnNldFJvd0RpcnR5KHBvcy5yb3cpOwogICAgICAgICAgICByZXR1cm4gcm93LnNwbGljZShwb3MuY29sLCBsZW5ndGgpLmpvaW4oIiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gIiI7CiAgICB9LAoKICAgIGNsZWFyOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJvd3MgPSBbXTsKICAgIH0sCgogICAgZGVsZXRlUm93czogZnVuY3Rpb24ocm93LCBjb3VudCkgewogICAgICAgIHZhciBkaWZmID0gKHJvdyArIGNvdW50IC0gMSkgLSB0aGlzLnJvd3MubGVuZ3RoOwogICAgICAgIGlmIChkaWZmID4gMCkgY291bnQgLT0gZGlmZjsKICAgICAgICBpZiAoY291bnQgPiAwKSB0aGlzLnJvd3Muc3BsaWNlKHJvdywgY291bnQpOwogICAgfSwKCiAgICAvLyBzcGxpdHMgdGhlIHBhc3NlZCByb3cgYXQgdGhlIGNvbCBzcGVjaWZpZWQsIHB1dHRpbmcgdGhlIHJpZ2h0LWhhbGYgb24gYSBuZXcgbGluZSBiZW5lYXRoIHRoZSBwYXNlZCByb3cKICAgIHNwbGl0Um93OiBmdW5jdGlvbihwb3MpIHsKICAgICAgICB2YXIgcm93ID0gdGhpcy5nZXRSb3dBcnJheShwb3Mucm93KTsKCiAgICAgICAgdmFyIG5ld1JvdzsKICAgICAgICBpZiAocG9zLmNvbCA8IHJvdy5sZW5ndGgpIHsKICAgICAgICAgICAgbmV3Um93ID0gcm93LnNwbGljZShwb3MuY29sKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdSb3cgPSBbXTsKICAgICAgICB9CgogICAgICAgIGlmIChwb3Mucm93ID09ICh0aGlzLnJvd3MubGVuZ3RoIC0gMSkpIHsKICAgICAgICAgICAgdGhpcy5yb3dzLnB1c2gobmV3Um93KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbmV3Um93cyA9IHRoaXMucm93cy5zcGxpY2UoMCwgcG9zLnJvdyArIDEpOwogICAgICAgICAgICBuZXdSb3dzLnB1c2gobmV3Um93KTsKICAgICAgICAgICAgbmV3Um93cyA9IG5ld1Jvd3MuY29uY2F0KHRoaXMucm93cyk7CiAgICAgICAgICAgIHRoaXMucm93cyA9IG5ld1Jvd3M7CiAgICAgICAgfQogICAgfSwKCiAgICAvLyBqb2lucyB0aGUgcGFzc2VkIHJvdyB3aXRoIHRoZSByb3cgYmVuZWF0aCBpdAogICAgam9pblJvdzogZnVuY3Rpb24ocm93SW5kZXgpIHsKICAgICAgICBpZiAocm93ID49IHRoaXMucm93cy5sZW5ndGggLSAxKSByZXR1cm47CiAgICAgICAgdmFyIHJvdyA9IHRoaXMuZ2V0Um93QXJyYXkocm93SW5kZXgpOwogICAgICAgIHRoaXMucm93c1tyb3dJbmRleF0gPSByb3cuY29uY2F0KHRoaXMucm93c1tyb3dJbmRleCArIDFdKTsKICAgICAgICB0aGlzLnJvd3Muc3BsaWNlKHJvd0luZGV4ICsgMSwgMSk7CiAgICB9LAoKICAgIC8vIHJldHVybnMgdGhlIG1heGltdW0gbnVtYmVyIG9mIGNvbHVtbnMgYWNyb3NzIGFsbCByb3dzCiAgICBnZXRNYXhDb2xzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY29scyA9IDA7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnJvd3MubGVuZ3RoOyBpKyspIGNvbHMgPSBNYXRoLm1heChjb2xzLCB0aGlzLnJvd3NbaV0ubGVuZ3RoKTsKICAgICAgICByZXR1cm4gY29sczsKICAgIH0sCgogICAgLy8gcmV0dXJucyB0aGUgbnVtYmVyIG9mIHJvd3MgaW4gdGhlIG1vZGVsCiAgICBnZXRSb3dDb3VudDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucm93cy5sZW5ndGg7CiAgICB9LAoKICAgIC8vIHJldHVybnMgYSAiY2h1bmsiOiBhIHN0cmluZyByZXByZXNlbnRpbmcgYSBwYXJ0IG9mIHRoZSBkb2N1bWVudCB3aXRoIFxuIGNoYXJhY3RlcnMgcmVwcmVzZW50aW5nIGVuZCBvZiBsaW5lCiAgICBnZXRDaHVuazogZnVuY3Rpb24oc2VsZWN0aW9uKSB7CiAgICAgICAgdmFyIHN0YXJ0UG9zID0gc2VsZWN0aW9uLnN0YXJ0UG9zOwogICAgICAgIHZhciBlbmRQb3MgPSBzZWxlY3Rpb24uZW5kUG9zOwoKICAgICAgICB2YXIgc3RhcnRDb2wsIGVuZENvbDsKICAgICAgICB2YXIgY2h1bmsgPSAiIjsKCiAgICAgICAgLy8gZ2V0IHRoZSBmaXJzdCBsaW5lCiAgICAgICAgc3RhcnRDb2wgPSBzdGFydFBvcy5jb2w7CiAgICAgICAgdmFyIHJvdyA9IHRoaXMuZ2V0Um93QXJyYXkoc3RhcnRQb3Mucm93KTsKICAgICAgICBlbmRDb2wgPSAoZW5kUG9zLnJvdyA9PSBzdGFydFBvcy5yb3cpID8gZW5kUG9zLmNvbCA6IHJvdy5sZW5ndGg7CiAgICAgICAgaWYgKGVuZENvbCA+IHJvdy5sZW5ndGgpIGVuZENvbCA9IHJvdy5sZW5ndGg7CiAgICAgICAgY2h1bmsgKz0gcm93LmpvaW4oIiIpLnN1YnN0cmluZyhzdGFydENvbCwgZW5kQ29sKTsKCiAgICAgICAgLy8gZ2V0IG1pZGRsZSBsaW5lcywgaWYgYW55CiAgICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0UG9zLnJvdyArIDE7IGkgPCBlbmRQb3Mucm93OyBpKyspIHsKICAgICAgICAgICAgY2h1bmsgKz0gIlxuIjsKICAgICAgICAgICAgY2h1bmsgKz0gdGhpcy5nZXRSb3dBcnJheShpKS5qb2luKCIiKTsKICAgICAgICB9CgogICAgICAgIC8vIGdldCB0aGUgZW5kIGxpbmUKICAgICAgICBpZiAoc3RhcnRQb3Mucm93ICE9IGVuZFBvcy5yb3cpIHsKICAgICAgICAgICAgc3RhcnRDb2wgPSAwOwogICAgICAgICAgICBlbmRDb2wgPSBlbmRQb3MuY29sOwogICAgICAgICAgICByb3cgPSB0aGlzLmdldFJvd0FycmF5KGVuZFBvcy5yb3cpOwogICAgICAgICAgICBpZiAoZW5kQ29sID4gcm93Lmxlbmd0aCkgZW5kQ29sID0gcm93Lmxlbmd0aDsKICAgICAgICAgICAgY2h1bmsgKz0gIlxuIiArIHJvdy5qb2luKCIiKS5zdWJzdHJpbmcoc3RhcnRDb2wsIGVuZENvbCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY2h1bms7CiAgICB9LAoKICAgIC8vIGRlbGV0ZXMgdGhlIHRleHQgYmV0d2VlbiB0aGUgc3RhcnRQb3MgYW5kIGVuZFBvcywgam9pbmluZyBhcyBuZWNlc3NhcnkuIHN0YXJ0UG9zIGFuZCBlbmRQb3MgYXJlIGluY2x1c2l2ZQogICAgZGVsZXRlQ2h1bms6IGZ1bmN0aW9uKHNlbGVjdGlvbikgewogICAgICAgIHZhciBjaHVuayA9IHRoaXMuZ2V0Q2h1bmsoc2VsZWN0aW9uKTsKCiAgICAgICAgdmFyIHN0YXJ0UG9zID0gc2VsZWN0aW9uLnN0YXJ0UG9zOwogICAgICAgIHZhciBlbmRQb3MgPSBzZWxlY3Rpb24uZW5kUG9zOwoKICAgICAgICB2YXIgc3RhcnRDb2wsIGVuZENvbDsKCiAgICAgICAgLy8gZ2V0IHRoZSBmaXJzdCBsaW5lCiAgICAgICAgc3RhcnRDb2wgPSBzdGFydFBvcy5jb2w7CiAgICAgICAgdmFyIHJvdyA9IHRoaXMuZ2V0Um93QXJyYXkoc3RhcnRQb3Mucm93KTsKICAgICAgICBlbmRDb2wgPSAoZW5kUG9zLnJvdyA9PSBzdGFydFBvcy5yb3cpID8gZW5kUG9zLmNvbCA6IHJvdy5sZW5ndGg7CiAgICAgICAgaWYgKGVuZENvbCA+IHJvdy5sZW5ndGgpIGVuZENvbCA9IHJvdy5sZW5ndGg7CiAgICAgICAgdGhpcy5kZWxldGVDaGFyYWN0ZXJzKHsgcm93OiBzdGFydFBvcy5yb3csIGNvbDogc3RhcnRDb2x9LCBlbmRDb2wgLSBzdGFydENvbCk7CgogICAgICAgIC8vIGdldCB0aGUgZW5kIGxpbmUKICAgICAgICBpZiAoc3RhcnRQb3Mucm93ICE9IGVuZFBvcy5yb3cpIHsKICAgICAgICAgICAgc3RhcnRDb2wgPSAwOwogICAgICAgICAgICBlbmRDb2wgPSBlbmRQb3MuY29sOwogICAgICAgICAgICByb3cgPSB0aGlzLmdldFJvd0FycmF5KGVuZFBvcy5yb3cpOwogICAgICAgICAgICBpZiAoZW5kQ29sID4gcm93Lmxlbmd0aCkgZW5kQ29sID0gcm93Lmxlbmd0aDsKICAgICAgICAgICAgdGhpcy5kZWxldGVDaGFyYWN0ZXJzKHsgcm93OiBlbmRQb3Mucm93LCBjb2w6IHN0YXJ0Q29sfSwgZW5kQ29sIC0gc3RhcnRDb2wpOwogICAgICAgIH0KCiAgICAgICAgLy8gcmVtb3ZlIGFueSBsaW5lcyBpbi1iZXR3ZWVuCiAgICAgICAgaWYgKChlbmRQb3Mucm93IC0gc3RhcnRQb3Mucm93KSA+IDEpIHRoaXMuZGVsZXRlUm93cyhzdGFydFBvcy5yb3cgKyAxLCBlbmRQb3Mucm93IC0gc3RhcnRQb3Mucm93IC0gMSk7CgogICAgICAgIC8vIGpvaW4gdGhlIHJvd3MKICAgICAgICBpZiAoZW5kUG9zLnJvdyAhPSBzdGFydFBvcy5yb3cpIHRoaXMuam9pblJvdyhzdGFydFBvcy5yb3cpOwoKICAgICAgICByZXR1cm4gY2h1bms7CiAgICB9LAoKICAgIC8vIGluc2VydHMgdGhlIGNodW5rIGFuZCByZXR1cm5zIHRoZSBlbmRpbmcgcG9zaXRpb24KICAgIGluc2VydENodW5rOiBmdW5jdGlvbihwb3MsIGNodW5rKSB7CiAgICAgICAgdmFyIGxpbmVzID0gY2h1bmsuc3BsaXQoIlxuIik7CiAgICAgICAgdmFyIGNwb3MgPSBCZXNwaW4uRWRpdG9yLlV0aWxzLmNvcHlQb3MocG9zKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHRoaXMuaW5zZXJ0Q2hhcmFjdGVycyhjcG9zLCBsaW5lc1tpXSk7CiAgICAgICAgICAgIGNwb3MuY29sID0gY3Bvcy5jb2wgKyBsaW5lc1tpXS5sZW5ndGg7CgogICAgICAgICAgICBpZiAoaSA8IGxpbmVzLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3BsaXRSb3coY3Bvcyk7CiAgICAgICAgICAgICAgICBjcG9zLmNvbCA9IDA7CiAgICAgICAgICAgICAgICBjcG9zLnJvdyA9IGNwb3Mucm93ICsgMTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gY3BvczsKICAgIH0sCiAgICAKICAgIGZpbmRCZWZvcmU6IGZ1bmN0aW9uKHJvdywgY29sLCBjb21wYXJhdG9yKSB7CiAgICAgICAgdmFyIGxpbmUgPSB0aGlzLmdldFJvd0FycmF5KHJvdyk7CiAgICAgICAgaWYgKCFPYmplY3QuaXNGdW5jdGlvbihjb21wYXJhdG9yKSkgY29tcGFyYXRvciA9IGZ1bmN0aW9uKGxldHRlcikgeyAvLyBkZWZhdWx0IHRvIG5vbiBhbHBoYQogICAgICAgICAgICBpZiAobGV0dGVyLmNoYXJBdCgwKSA9PSAnICcpIHJldHVybiB0cnVlOwogICAgICAgICAgICB2YXIgbGV0dGVyQ29kZSA9IGxldHRlci5jaGFyQ29kZUF0KDApOwogICAgICAgICAgICByZXR1cm4gKGxldHRlckNvZGUgPCA0OCkgfHwgKGxldHRlckNvZGUgPiAxMjIpOyAvLyBhbHBoYSBvbmx5CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICB3aGlsZSAoY29sID4gMCkgewogICAgICAgICAgICB2YXIgbGV0dGVyID0gbGluZVtjb2xdOwogICAgICAgICAgICBpZiAoIWxldHRlcikgY29udGludWU7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoY29tcGFyYXRvcihsZXR0ZXIpKSB7CiAgICAgICAgICAgICAgICBjb2wrKzsgLy8gbW92ZSBpdCBiYWNrCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29sLS07CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiB7IHJvdzogcm93LCBjb2w6IGNvbCB9OwogICAgfSwKCiAgICBmaW5kQWZ0ZXI6IGZ1bmN0aW9uKHJvdywgY29sLCBjb21wYXJhdG9yKSB7CiAgICAgICAgdmFyIGxpbmUgPSB0aGlzLmdldFJvd0FycmF5KHJvdyk7CiAgICAgICAgaWYgKCFPYmplY3QuaXNGdW5jdGlvbihjb21wYXJhdG9yKSkgY29tcGFyYXRvciA9IGZ1bmN0aW9uKGxldHRlcikgeyAvLyBkZWZhdWx0IHRvIG5vbiBhbHBoYQogICAgICAgICAgICBpZiAobGV0dGVyLmNoYXJBdCgwKSA9PSAnICcpIHJldHVybiB0cnVlOwogICAgICAgICAgICB2YXIgbGV0dGVyQ29kZSA9IGxldHRlci5jaGFyQ29kZUF0KDApOwogICAgICAgICAgICByZXR1cm4gKGxldHRlckNvZGUgPCA0OCkgfHwgKGxldHRlckNvZGUgPiAxMjIpOyAvLyBhbHBoYSBvbmx5CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICB3aGlsZSAoY29sIDwgbGluZS5sZW5ndGgpIHsKICAgICAgICAgICAgY29sKys7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgbGV0dGVyID0gbGluZVtjb2xdOwogICAgICAgICAgICBpZiAoIWxldHRlcikgY29udGludWU7CgogICAgICAgICAgICBpZiAoY29tcGFyYXRvcihsZXR0ZXIpKSBicmVhazsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsgcm93OiByb3csIGNvbDogY29sIH07CiAgICB9Cgp9KTsvKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqCiAqIFZlcnNpb246IE1QTCAxLjEKICoKICogVGhlIGNvbnRlbnRzIG9mIHRoaXMgZmlsZSBhcmUgc3ViamVjdCB0byB0aGUgTW96aWxsYSBQdWJsaWMgTGljZW5zZQogKiBWZXJzaW9uIDEuMSAodGhlICJMaWNlbnNlIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluCiAqIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqIGh0dHA6Ly93d3cubW96aWxsYS5vcmcvTVBMLwogKgogKiBTb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiCiAqIGJhc2lzLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcmlnaHRzIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICoKICogVGhlIE9yaWdpbmFsIENvZGUgaXMgQmVzcGluLgogKgogKiBUaGUgSW5pdGlhbCBEZXZlbG9wZXIgb2YgdGhlIE9yaWdpbmFsIENvZGUgaXMgTW96aWxsYS4KICogUG9ydGlvbnMgY3JlYXRlZCBieSB0aGUgSW5pdGlhbCBEZXZlbG9wZXIgYXJlIENvcHlyaWdodCAoQykgMjAwOQogKiB0aGUgSW5pdGlhbCBEZXZlbG9wZXIuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIENvbnRyaWJ1dG9yKHMpOgogKiAgIEJlc3BpbiBUZWFtIChiZXNwaW5AbW96aWxsYS5jb20pCiAqCiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovCgppZiAodHlwZW9mIEJlc3BpbiA9PSAidW5kZWZpbmVkIikgQmVzcGluID0ge307CmlmICghQmVzcGluLkVkaXRvcikgQmVzcGluLkVkaXRvciA9IHt9OwoKLy8gPSBUb29sYmFyID0KLy8KLy8gVGhlIGVkaXRvciBoYXMgdGhlIG5vdGlvbiBvZiBhIHRvb2xiYXIgd2hpY2ggYXJlIGNvbXBvbmVudHMgdGhhdCBjYW4gZHJpdmUgdGhlIGVkaXRvciBmcm9tIG91dHNpZGUgb2YgaXRzZWxmCi8vIFN1Y2ggZXhhbXBsZXMgYXJlIGNvbGxhYm9yYXRpb24gdmlld3MsIGZpbGUgYnJvd3NlciwgdW5kby9yZWRvLCBjdXQvY29weS9wYXN0ZSBhbmQgbW9yZS4KCkJlc3Bpbi5FZGl0b3IuVG9vbGJhciA9IENsYXNzLmNyZWF0ZSh7CiAgICBERUZBVUxUX1RPT0xCQVI6IFsiY29sbGFib3JhdGlvbiIsICJmaWxlcyIsICJkYXNoYm9hcmQiLCAidGFyZ2V0X2Jyb3dzZXJzIiwgCiAgICAgICAgICAgICAgICAgICAgICAic2F2ZSIsICJ1bmRvIiwgInJlZG8iLCAiY3V0IiwgImNvcHkiLCAicGFzdGUiLCAicHJldmlldyIsICJmb250c2l6ZSJdLAogICAgRk9OVF9TSVpFUzogewogICAgICAgIDE6IDgsICAvLyBzbWFsbAogICAgICAgIDI6IDEwLCAvLyBtZWRpdW0KICAgICAgICAzOiAxNCAgLy8gbGFyZ2UKICAgIH0sCgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWRpdG9yKSB7CiAgICAgICAgdGhpcy5lZGl0b3IgPSBlZGl0b3IgfHwgX2VkaXRvcjsKICAgICAgICB0aGlzLmN1cnJlbnRGb250U2l6ZSA9IDI7CiAgICB9LAogICAgCiAgICBzZXR1cDogZnVuY3Rpb24odHlwZSwgZWwpIHsKICAgICAgICBpZiAoT2JqZWN0LmlzRnVuY3Rpb24odGhpcy5jb21wb25lbnRzW3R5cGVdKSkgdGhpcy5jb21wb25lbnRzW3R5cGVdKHRoaXMsIGVsKTsKICAgIH0sCgogICAgLyoKICAgICAqIEdvIHRocm91Z2ggdGhlIGRlZmF1bHQgbGlzdCBhbmQgdHJ5IHRvIGhpdGNoIG9udG8gdGhlIERPTSBlbGVtZW50CiAgICAgKi8KICAgIHNldHVwRGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5ERUZBVUxUX1RPT0xCQVIuZWFjaChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgIHZhciBpdGVtX2VsID0gJCgidG9vbGJhcl8iICsgaXRlbSk7CiAgICAgICAgICAgIGlmIChpdGVtX2VsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldHVwKGl0ZW0sIGl0ZW1fZWwpOwogICAgICAgICAgICB9CiAgICAgICAgfS5iaW5kKHRoaXMpKTsKICAgIH0sCiAgICAKICAgIGNvbXBvbmVudHM6IHsKICAgICAgICBjb2xsYWJvcmF0aW9uOiBmdW5jdGlvbih0b29sYmFyLCBlbCkgewogICAgICAgICAgICB2YXIgY29sbGFiID0gJChlbCkgfHwgJCgidG9vbGJhcl9jb2xsYWJvcmF0aW9uIik7CiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZShjb2xsYWIsICdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgX3Nob3dDb2xsYWIgPSAhX3Nob3dDb2xsYWI7CiAgICAgICAgICAgICAgICBjb2xsYWIuc3JjID0gImltYWdlcy8iICsgKCAoX3Nob3dDb2xsYWIpID8gImljbl9jb2xsYWJfb24ucG5nIiA6IChfc2hvd0NvbGxhYkhvdENvdW50ZXIgPT0gMCkgPyAiaWNuX2NvbGxhYl9vZmYucG5nIiA6ICJpY25fY29sbGFiX3dhdGNoaW5nLnBuZyIgKTsKICAgICAgICAgICAgICAgIGlmIChPYmplY3QuaXNGdW5jdGlvbihyZWNhbGNMYXlvdXQpKSByZWNhbGNMYXlvdXQoKTsgLy8gdG9kbyBmaXgKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZShjb2xsYWIsICdtb3VzZW92ZXInLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGNvbGxhYi5zdHlsZS5jdXJzb3IgPSAicG9pbnRlciI7CiAgICAgICAgICAgICAgICBjb2xsYWIuc3JjID0gImltYWdlcy9pY25fY29sbGFiX29uLnBuZyI7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBFbGVtZW50Lm9ic2VydmUoY29sbGFiLCAnbW91c2VvdXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGNvbGxhYi5zdHlsZS5jdXJzb3IgPSAiZGVmYXVsdCI7CiAgICAgICAgICAgICAgICBjb2xsYWIuc3JjID0gImltYWdlcy9pY25fY29sbGFiX29mZi5wbmciOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIGZpbGVzOiBmdW5jdGlvbih0b29sYmFyLCBlbCkgewogICAgICAgICAgICB2YXIgZmlsZXMgPSAkKGVsKSB8fCAkKCJ0b29sYmFyX2ZpbGVzIik7CiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZShmaWxlcywgJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBfc2hvd0ZpbGVzID0gIV9zaG93RmlsZXM7CiAgICAgICAgICAgICAgICBmaWxlcy5zcmMgPSAiaW1hZ2VzLyIgKyAoIChfc2hvd0ZpbGVzKSA/ICJpY25fZmlsZXNfb24ucG5nIiA6ICJpY25fZmlsZXNfb2ZmLnBuZyIgKTsKICAgICAgICAgICAgICAgIGlmIChPYmplY3QuaXNGdW5jdGlvbihyZWNhbGNMYXlvdXQpKSByZWNhbGNMYXlvdXQoKTsgLy8gdG9kbyBmaXgKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZShmaWxlcywgJ21vdXNlb3ZlcicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZmlsZXMuc3R5bGUuY3Vyc29yID0gInBvaW50ZXIiOwogICAgICAgICAgICAgICAgZmlsZXMuc3JjID0gImltYWdlcy9pY25fZmlsZXNfb24ucG5nIjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZShmaWxlcywgJ21vdXNlb3V0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBmaWxlcy5zdHlsZS5jdXJzb3IgPSAiZGVmYXVsdCI7CiAgICAgICAgICAgICAgICBmaWxlcy5zcmMgPSAiaW1hZ2VzL2ljbl9maWxlc19vZmYucG5nIjsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgZGFzaGJvYXJkOiBmdW5jdGlvbih0b29sYmFyLCBlbCkgewogICAgICAgICAgICB2YXIgZGFzaGJvYXJkID0gJChlbCkgfHwgJCgidG9vbGJhcl9kYXNoYm9hcmQiKTsKICAgICAgICAgICAgRWxlbWVudC5vYnNlcnZlKGRhc2hib2FyZCwgJ21vdXNlb3ZlcicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZGFzaGJvYXJkLnN0eWxlLmN1cnNvciA9ICJwb2ludGVyIjsKICAgICAgICAgICAgICAgIGRhc2hib2FyZC5zcmMgPSAiaW1hZ2VzL2ljbl9kYXNoYm9hcmRfb24ucG5nIjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZShkYXNoYm9hcmQsICdtb3VzZW91dCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZGFzaGJvYXJkLnN0eWxlLmN1cnNvciA9ICJkZWZhdWx0IjsKICAgICAgICAgICAgICAgIGRhc2hib2FyZC5zcmMgPSAiaW1hZ2VzL2ljbl9kYXNoYm9hcmRfb2ZmLnBuZyI7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgdGFyZ2V0X2Jyb3dzZXJzOiBmdW5jdGlvbih0b29sYmFyLCBlbCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0ID0gJChlbCkgfHwgJCgidG9vbGJhcl90YXJnZXRfYnJvd3NlcnMiKTsKICAgICAgICAgICAgRWxlbWVudC5vYnNlcnZlKHRhcmdldCwgJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBfc2hvd1RhcmdldCA9ICFfc2hvd1RhcmdldDsKICAgICAgICAgICAgICAgIHRhcmdldC5zcmMgPSAiaW1hZ2VzLyIgKyAoIChfc2hvd1RhcmdldCkgPyAiaWNuX3RhcmdldF9vbi5wbmciIDogImljbl90YXJnZXRfb2ZmLnBuZyIgKTsKICAgICAgICAgICAgICAgIGlmIChPYmplY3QuaXNGdW5jdGlvbihyZWNhbGNMYXlvdXQpKSByZWNhbGNMYXlvdXQoKTsgLy8gdG9kbyBmaXgKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZSh0YXJnZXQsICdtb3VzZW92ZXInLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRhcmdldC5zdHlsZS5jdXJzb3IgPSAicG9pbnRlciI7CiAgICAgICAgICAgICAgICB0YXJnZXQuc3JjID0gImltYWdlcy9pY25fdGFyZ2V0X29uLnBuZyI7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBFbGVtZW50Lm9ic2VydmUodGFyZ2V0LCAnbW91c2VvdXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRhcmdldC5zdHlsZS5jdXJzb3IgPSAiZGVmYXVsdCI7CiAgICAgICAgICAgICAgICB0YXJnZXQuc3JjID0gImltYWdlcy9pY25fdGFyZ2V0X29mZi5wbmciOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBzYXZlOiBmdW5jdGlvbih0b29sYmFyLCBlbCkgewogICAgICAgICAgICB2YXIgc2F2ZSA9ICQoZWwpIHx8ICQoInRvb2xiYXJfc2F2ZSIpOwogICAgICAgICAgICBFbGVtZW50Lm9ic2VydmUoc2F2ZSwgJ21vdXNlZG93bicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2F2ZS5zcmMgPSAiaW1hZ2VzL2ljbl9zYXZlX29uLnBuZyI7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgRWxlbWVudC5vYnNlcnZlKHNhdmUsICdtb3VzZXVwJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzYXZlLnNyYyA9ICJpbWFnZXMvaWNuX3NhdmUucG5nIjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBFbGVtZW50Lm9ic2VydmUoc2F2ZSwgJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOnNhdmVmaWxlIik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIHVuZG86IGZ1bmN0aW9uKHRvb2xiYXIsIGVsKSB7CiAgICAgICAgICAgIHZhciB1bmRvID0gJChlbCkgfHwgJCgidG9vbGJhcl91bmRvIik7CiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZSh1bmRvLCAnbW91c2Vkb3duJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB1bmRvLnNyYyA9ICJpbWFnZXMvaWNuX3VuZG9fb24ucG5nIjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBFbGVtZW50Lm9ic2VydmUodW5kbywgJ21vdXNldXAnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHVuZG8uc3JjID0gImltYWdlcy9pY25fdW5kby5wbmciOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZSh1bmRvLCAnY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRvb2xiYXIuZWRpdG9yLnVpLmFjdGlvbnMudW5kbygpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICByZWRvOiBmdW5jdGlvbih0b29sYmFyLCBlbCkgewogICAgICAgICAgICB2YXIgcmVkbyA9ICQoZWwpIHx8ICQoInRvb2xiYXJfdW5kbyIpOwoKICAgICAgICAgICAgRWxlbWVudC5vYnNlcnZlKHJlZG8sICdtb3VzZWRvd24nLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJlZG8uc3JjID0gImltYWdlcy9pY25fcmVkb19vbi5wbmciOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZShyZWRvLCAnbW91c2V1cCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmVkby5zcmMgPSAiaW1hZ2VzL2ljbl9yZWRvLnBuZyI7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgRWxlbWVudC5vYnNlcnZlKHJlZG8sICdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdG9vbGJhci5lZGl0b3IudWkuYWN0aW9ucy5yZWRvKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgY3V0OiBmdW5jdGlvbih0b29sYmFyLCBlbCkgewogICAgICAgICAgICB2YXIgY3V0ID0gJChlbCkgfHwgJCgidG9vbGJhcl9jdXQiKTsKCiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZShjdXQsICdtb3VzZWRvd24nLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGN1dC5zcmMgPSAiaW1hZ2VzL2ljbl9jdXRfb24ucG5nIjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBFbGVtZW50Lm9ic2VydmUoY3V0LCAnbW91c2V1cCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY3V0LnNyYyA9ICJpbWFnZXMvaWNuX2N1dC5wbmciOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZShjdXQsICdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdG9vbGJhci5lZGl0b3IudWkuYWN0aW9ucy5jdXRTZWxlY3Rpb24oQmVzcGluLkVkaXRvci5VdGlscy5hcmdzV2l0aFBvcygpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgY29weTogZnVuY3Rpb24odG9vbGJhciwgZWwpIHsKICAgICAgICAgICAgdmFyIGNvcHkgPSAkKGVsKSB8fCAkKCJ0b29sYmFyX2NvcHkiKTsKCiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZShjb3B5LCAnbW91c2Vkb3duJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjb3B5LnNyYyA9ICJpbWFnZXMvaWNuX2NvcHlfb24ucG5nIjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBFbGVtZW50Lm9ic2VydmUoY29weSwgJ21vdXNldXAnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGNvcHkuc3JjID0gImltYWdlcy9pY25fY29weS5wbmciOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZShjb3B5LCAnY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRvb2xiYXIuZWRpdG9yLnVpLmFjdGlvbnMuY29weVNlbGVjdGlvbihCZXNwaW4uRWRpdG9yLlV0aWxzLmFyZ3NXaXRoUG9zKCkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBwYXN0ZTogZnVuY3Rpb24odG9vbGJhciwgZWwpIHsKICAgICAgICAgICAgdmFyIHBhc3RlID0gJChlbCkgfHwgJCgidG9vbGJhcl9wYXN0ZSIpOwoKICAgICAgICAgICAgRWxlbWVudC5vYnNlcnZlKHBhc3RlLCAnbW91c2Vkb3duJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBwYXN0ZS5zcmMgPSAiaW1hZ2VzL2ljbl9wYXN0ZV9vbi5wbmciOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZShwYXN0ZSwgJ21vdXNldXAnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHBhc3RlLnNyYyA9ICJpbWFnZXMvaWNuX3Bhc3RlLnBuZyI7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgRWxlbWVudC5vYnNlcnZlKHBhc3RlLCAnY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRvb2xiYXIuZWRpdG9yLnVpLmFjdGlvbnMucGFzdGVGcm9tQ2xpcGJvYXJkKEJlc3Bpbi5FZGl0b3IuVXRpbHMuYXJnc1dpdGhQb3MoKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8vIGhpc3Rvcnk6IGZ1bmN0aW9uKHRvb2xiYXIsIGVsKSB7CiAgICAgICAgLy8gICAgIHZhciBoaXN0b3J5ID0gJChlbCkgfHwgJCgidG9vbGJhcl9oaXN0b3J5Iik7CiAgICAgICAgLy8gICAgIAogICAgICAgIC8vICAgICBFbGVtZW50Lm9ic2VydmUoaGlzdG9yeSwgJ21vdXNlZG93bicsIGZ1bmN0aW9uKCkgewogICAgICAgIC8vICAgICAgICAgaGlzdG9yeS5zcmMgPSAiaW1hZ2VzL2ljbl9oaXN0b3J5X29uLnBuZyI7CiAgICAgICAgLy8gICAgIH0pOwogICAgICAgIC8vIAogICAgICAgIC8vICAgICBFbGVtZW50Lm9ic2VydmUoaGlzdG9yeSwgJ21vdXNldXAnLCBmdW5jdGlvbigpIHsKICAgICAgICAvLyAgICAgICAgIGhpc3Rvcnkuc3JjID0gImltYWdlcy9pY25faGlzdG9yeS5wbmciOwogICAgICAgIC8vICAgICB9KTsKICAgICAgICAvLyAgICAgCiAgICAgICAgLy8gICAgIEVsZW1lbnQub2JzZXJ2ZShoaXN0b3J5LCAnY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICAvLyAgICAgICAgIGNvbnNvbGUubG9nKCJjbGlja2VkIG9uIGhpc3RvcnkgdG9vbGJhciBpY29uIik7CiAgICAgICAgLy8gICAgIH0pOwogICAgICAgIC8vIH0sCgogICAgICAgIHByZXZpZXc6IGZ1bmN0aW9uKHRvb2xiYXIsIGVsKSB7CiAgICAgICAgICAgIHZhciBwcmV2aWV3ID0gJChlbCkgfHwgJCgidG9vbGJhcl9wcmV2aWV3Iik7CiAgICAgICAgICAgIAogICAgICAgICAgICBFbGVtZW50Lm9ic2VydmUocHJldmlldywgJ21vdXNlZG93bicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcHJldmlldy5zcmMgPSAiaW1hZ2VzL2ljbl9wcmV2aWV3X29uLnBuZyI7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgRWxlbWVudC5vYnNlcnZlKHByZXZpZXcsICdtb3VzZXVwJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBwcmV2aWV3LnNyYyA9ICJpbWFnZXMvaWNuX3ByZXZpZXcucG5nIjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBFbGVtZW50Lm9ic2VydmUocHJldmlldywgJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOnByZXZpZXciKTsgLy8gdXNlIGRlZmF1bHQgZmlsZSAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgZm9udHNpemU6IGZ1bmN0aW9uKHRvb2xiYXIsIGVsKSB7CiAgICAgICAgICAgIHZhciBmb250c2l6ZSA9ICQoZWwpIHx8ICQoInRvb2xiYXJfZm9udHNpemUiKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIEVsZW1lbnQub2JzZXJ2ZShmb250c2l6ZSwgJ21vdXNlZG93bicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZm9udHNpemUuc3JjID0gImltYWdlcy9pY25fZm9udHNpemVfb24ucG5nIjsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBFbGVtZW50Lm9ic2VydmUoZm9udHNpemUsICdtb3VzZXVwJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBmb250c2l6ZS5zcmMgPSAiaW1hZ2VzL2ljbl9mb250c2l6ZS5wbmciOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIENoYW5nZSB0aGUgZm9udCBzaXplIGJldHdlZW4gdGhlIHNtYWxsLCBtZWRpdW0sIGFuZCBsYXJnZSBzZXR0aW5ncwogICAgICAgICAgICBFbGVtZW50Lm9ic2VydmUoZm9udHNpemUsICdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdG9vbGJhci5jdXJyZW50Rm9udFNpemUgPSAodG9vbGJhci5jdXJyZW50Rm9udFNpemUgPiAyKSA/IDEgOiB0b29sYmFyLmN1cnJlbnRGb250U2l6ZSArIDE7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46c2V0dGluZ3M6c2V0OmZvbnRzaXplIiwgeyB2YWx1ZTogdG9vbGJhci5GT05UX1NJWkVTW3Rvb2xiYXIuY3VycmVudEZvbnRTaXplXSB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQp9KTsvKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqCiAqIFZlcnNpb246IE1QTCAxLjEKICoKICogVGhlIGNvbnRlbnRzIG9mIHRoaXMgZmlsZSBhcmUgc3ViamVjdCB0byB0aGUgTW96aWxsYSBQdWJsaWMgTGljZW5zZQogKiBWZXJzaW9uIDEuMSAodGhlICJMaWNlbnNlIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluCiAqIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqIGh0dHA6Ly93d3cubW96aWxsYS5vcmcvTVBMLwogKgogKiBTb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiCiAqIGJhc2lzLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcmlnaHRzIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICoKICogVGhlIE9yaWdpbmFsIENvZGUgaXMgQmVzcGluLgogKgogKiBUaGUgSW5pdGlhbCBEZXZlbG9wZXIgb2YgdGhlIE9yaWdpbmFsIENvZGUgaXMgTW96aWxsYS4KICogUG9ydGlvbnMgY3JlYXRlZCBieSB0aGUgSW5pdGlhbCBEZXZlbG9wZXIgYXJlIENvcHlyaWdodCAoQykgMjAwOQogKiB0aGUgSW5pdGlhbCBEZXZlbG9wZXIuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIENvbnRyaWJ1dG9yKHMpOgogKiAgIEJlc3BpbiBUZWFtIChiZXNwaW5AbW96aWxsYS5jb20pCiAqCiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovCgppZiAodHlwZW9mIEJlc3BpbiA9PSAidW5kZWZpbmVkIikgQmVzcGluID0ge307CgovLyA9IFRoZW1lcyA9Ci8vCi8vIFRoZSBlZGl0b3IgY2FuIGJlIHN0eWxlZCB3aXRoIFRoZW1lcy4gVGhpcyB3aWxsIGJlY29tZSBDU1Mgc29vbiwgYnV0IGZvciBub3cgaXMgSlNPTgoKQmVzcGluLlRoZW1lcyA9IHt9OwoKLy8gKiogQ29mZmVlIFRoZW1lICoqCkJlc3Bpbi5UaGVtZXMuY29mZmVlID0gewogICAgYmFja2dyb3VuZFN0eWxlOiAiIzJBMjExQyIsCiAgICBndXR0ZXJTdHlsZTogIiM0YzRhNDEiLAogICAgbGluZU51bWJlckNvbG9yOiAiI2U1YzEzOCIsCiAgICBsaW5lTnVtYmVyRm9udDogIjEwcHQgTW9uYWNvLCBMdWNpZGEgQ29uc29sZSwgbW9ub3NwYWNlIiwKICAgIHplYnJhU3RyaXBlQ29sb3I6ICIjMkEyMTFDIiwKICAgIGVkaXRvclRleHRDb2xvcjogInJnYigyMzAsIDIzMCwgMjMwKSIsCiAgICBlZGl0b3JTZWxlY3RlZFRleHRDb2xvcjogInJnYigyNDAsIDI0MCwgMjQwKSIsCiAgICBlZGl0b3JTZWxlY3RlZFRleHRCYWNrZ3JvdW5kOiAiIzUyNkRBNSIsCiAgICBjdXJzb3JTdHlsZTogIiM4NzlhZmYiLAogICAgY3Vyc29yVHlwZTogImliZWFtIiwgICAgICAgLy8gb25lIG9mICJ1bmRlcmxpbmUiIG9yICJpYmVhbSIKICAgIHVuZm9jdXNlZEN1cnNvclN0cm9rZVN0eWxlOiAiI0ZGMDAzMyIsCiAgICB1bmZvY3VzZWRDdXJzb3JGaWxsU3R5bGU6ICIjNzMxNzFFIiwKICAgIHBhcnRpYWxOaWJTdHlsZTogInJnYmEoMTAwLCAxMDAsIDEwMCwgMC4zKSIsCiAgICBwYXJ0aWFsTmliQXJyb3dTdHlsZTogInJnYmEoMjU1LCAyNTUsIDI1NSwgMC4zKSIsCiAgICBwYXJ0aWFsTmliU3Ryb2tlU3R5bGU6ICJyZ2JhKDE1MCwgMTUwLCAxNTAsIDAuMykiLAogICAgZnVsbE5pYlN0eWxlOiAicmdiKDEwMCwgMTAwLCAxMDApIiwKICAgIGZ1bGxOaWJBcnJvd1N0eWxlOiAicmdiKDI1NSwgMjU1LCAyNTUpIiwKICAgIGZ1bGxOaWJTdHJva2VTdHlsZTogInJnYigxNTAsIDE1MCwgMTUwKSIsCiAgICBzY3JvbGxUcmFja0ZpbGxTdHlsZTogInJnYmEoNTAsIDUwLCA1MCwgMC44KSIsCiAgICBzY3JvbGxUcmFja1N0cm9rZVN0eWxlOiAicmdiKDE1MCwgMTUwLCAxNTApIiwKICAgIHNjcm9sbEJhckZpbGxTdHlsZTogInJnYmEoMCwgMCwgMCwgJWEpIiwKICAgIHNjcm9sbEJhckZpbGxHcmFkaWVudFRvcFN0YXJ0OiAicmdiYSg5MCwgOTAsIDkwLCAlYSkiLAogICAgc2Nyb2xsQmFyRmlsbEdyYWRpZW50VG9wU3RvcDogInJnYmEoNDAsIDQwLCA0MCwgJWEpIiwKICAgIHNjcm9sbEJhckZpbGxHcmFkaWVudEJvdHRvbVN0YXJ0OiAicmdiYSgyMiwgMjIsIDIyLCAlYSkiLAogICAgc2Nyb2xsQmFyRmlsbEdyYWRpZW50Qm90dG9tU3RvcDogInJnYmEoNDQsIDQ0LCA0NCwgJWEpIiwKCiAgICAvLyBzeW50YXggZGVmaW5pdGlvbnMKICAgIHBsYWluOiAiI2JkYWU5ZCIsCiAgICBrZXl3b3JkOiAiIzQyYThlZCIsCiAgICBzdHJpbmc6ICIjMDM5YTBhIiwKICAgIGNvbW1lbnQ6ICIjNjY2NjY2IiwKICAgICdjLWNvbW1lbnQnOiAiIzY2NjY2NiIsCiAgICBwdW5jdHVhdGlvbjogIiM4ODg4ODgiLAogICAgYXR0cmlidXRlOiAiI0JGOTQ2NCIsCiAgICB0ZXN0OiAicmdiKDI1NSwwLDApIiwKICAgIGNkYXRhOiAiI2JkYWU5ZCIsCiAgICAiYXR0cmlidXRlLXZhbHVlIjogIiMwMzlhMGEiLAogICAgdGFnOiAiIzQ2YThlZCIsCiAgICBjb2xvcjogIiNjNDY0NmIiLAogICAgInRhZy1uYW1lIjogIiM0NmE4ZWQiLAogICAgdmFsdWU6ICIjMDM5YTBhIiwKICAgIGltcG9ydGFudDogIiM5OTAwMDAiLAogICAgc2l6ZXM6ICIjOTkwMDAwIiwKICAgIGNzc2NsYXNzOiAiI0JGOTQ2NCIsCiAgICBjc3NpZDogIiM0NmE4ZWQiCn0KLy8gKiogQ29mZmVlIFplYnJhIFRoZW1lICoqCkJlc3Bpbi5UaGVtZXMuY29mZmVlemVicmEgPSBuZXcgSGFzaChCZXNwaW4uVGhlbWVzLmNvZmZlZSkudG9PYmplY3QoKTsKQmVzcGluLlRoZW1lcy5jb2ZmZWV6ZWJyYS56ZWJyYVN0cmlwZUNvbG9yID0gJyNGRkZGRkYnOwoKLy8gKiogV2hpdGUgVGhlbWUgKioKQmVzcGluLlRoZW1lcy53aGl0ZSA9IHsKICAgIGJhY2tncm91bmRTdHlsZTogIiNGRkZGRkYiLAogICAgZ3V0dGVyU3R5bGU6ICIjZDJkMmQyIiwKICAgIGxpbmVOdW1iZXJDb2xvcjogIiM4ODg4ODgiLAogICAgbGluZU51bWJlckZvbnQ6ICIxMHB0IE1vbmFjbywgTHVjaWRhIENvbnNvbGUsIG1vbm9zcGFjZSIsCiAgICB6ZWJyYVN0cmlwZUNvbG9yOiAiI0ZGRkZGRiIsCiAgICBlZGl0b3JUZXh0Q29sb3I6ICIjMDAwMDAwIiwKICAgIGVkaXRvclNlbGVjdGVkVGV4dENvbG9yOiAicmdiKDI0MCwgMjQwLCAyNDApIiwKICAgIGVkaXRvclNlbGVjdGVkVGV4dEJhY2tncm91bmQ6ICIjNGQ5N2ZmIiwKICAgIGN1cnNvclN0eWxlOiAiIzg3OWFmZiIsCiAgICBjdXJzb3JUeXBlOiAiaWJlYW0iLCAgICAgICAvLyBvbmUgb2YgInVuZGVybGluZSIgb3IgImliZWFtIgogICAgdW5mb2N1c2VkQ3Vyc29yU3Ryb2tlU3R5bGU6ICIjRkYwMDMzIiwKICAgIHVuZm9jdXNlZEN1cnNvckZpbGxTdHlsZTogIiM3MzE3MUUiLAogICAgcGFydGlhbE5pYlN0eWxlOiAicmdiYSgxMDAsIDEwMCwgMTAwLCAwLjMpIiwKICAgIHBhcnRpYWxOaWJBcnJvd1N0eWxlOiAicmdiYSgyNTUsIDI1NSwgMjU1LCAwLjMpIiwKICAgIHBhcnRpYWxOaWJTdHJva2VTdHlsZTogInJnYmEoMTUwLCAxNTAsIDE1MCwgMC4zKSIsCiAgICBmdWxsTmliU3R5bGU6ICJyZ2IoMTAwLCAxMDAsIDEwMCkiLAogICAgZnVsbE5pYkFycm93U3R5bGU6ICJyZ2IoMjU1LCAyNTUsIDI1NSkiLAogICAgZnVsbE5pYlN0cm9rZVN0eWxlOiAicmdiKDE1MCwgMTUwLCAxNTApIiwKICAgIHNjcm9sbFRyYWNrRmlsbFN0eWxlOiAicmdiYSg1MCwgNTAsIDUwLCAwLjgpIiwKICAgIHNjcm9sbFRyYWNrU3Ryb2tlU3R5bGU6ICJyZ2IoMTUwLCAxNTAsIDE1MCkiLAogICAgc2Nyb2xsQmFyRmlsbFN0eWxlOiAicmdiYSgwLCAwLCAwLCAlYSkiLAogICAgc2Nyb2xsQmFyRmlsbEdyYWRpZW50VG9wU3RhcnQ6ICJyZ2JhKDkwLCA5MCwgOTAsICVhKSIsCiAgICBzY3JvbGxCYXJGaWxsR3JhZGllbnRUb3BTdG9wOiAicmdiYSg0MCwgNDAsIDQwLCAlYSkiLAogICAgc2Nyb2xsQmFyRmlsbEdyYWRpZW50Qm90dG9tU3RhcnQ6ICJyZ2JhKDIyLCAyMiwgMjIsICVhKSIsCiAgICBzY3JvbGxCYXJGaWxsR3JhZGllbnRCb3R0b21TdG9wOiAicmdiYSg0NCwgNDQsIDQ0LCAlYSkiLAoKICAgIC8vIHN5bnRheCBkZWZpbml0aW9ucwogICAgcGxhaW46ICIjYmRhZTlkIiwKICAgIGtleXdvcmQ6ICIjMDAwMGZmIiwKICAgIHN0cmluZzogIiMwMzY5MDciLAogICAgY29tbWVudDogIiMwMDY2ZmYiLAogICAgJ2MtY29tbWVudCc6ICIjMDA2NmZmIiwKICAgIHB1bmN0dWF0aW9uOiAiIzg4ODg4OCIsCiAgICBhdHRyaWJ1dGU6ICIjQkY5NDY0IiwKICAgIHRlc3Q6ICJyZ2IoMjU1LDAsMCkiLAogICAgY2RhdGE6ICIjYmRhZTlkIiwKICAgICJhdHRyaWJ1dGUtdmFsdWUiOiAiI0JGOTQ2NCIsCiAgICB0YWc6ICIjYmRhZTlkIiwKICAgICJ0YWctbmFtZSI6ICIjYmRhZTlkIiwKICAgIHZhbHVlOiAiI0JGOTQ2NCIsCiAgICBpbXBvcnRhbnQ6ICIjOTkwMDAwIgp9CgovLyAqKiBXaGl0ZSBaZWJyYSBUaGVtZSAqKgpCZXNwaW4uVGhlbWVzLndoaXRlemVicmEgPSBuZXcgSGFzaChCZXNwaW4uVGhlbWVzLndoaXRlKS50b09iamVjdCgpOwpCZXNwaW4uVGhlbWVzLndoaXRlemVicmEuemVicmFTdHJpcGVDb2xvciA9ICcjRUFFQUVBJzsKCi8vICoqIEJsYWNrIFRoZW1lICoqCkJlc3Bpbi5UaGVtZXMuYmxhY2sgPSB7CiAgICBiYWNrZ3JvdW5kU3R5bGU6ICIjMDAwMDAwIiwKICAgIGd1dHRlclN0eWxlOiAiI2QyZDJkMiIsCiAgICBsaW5lTnVtYmVyQ29sb3I6ICIjODg4ODg4IiwKICAgIGxpbmVOdW1iZXJGb250OiAiMTBwdCBNb25hY28sIEx1Y2lkYSBDb25zb2xlLCBtb25vc3BhY2UiLAogICAgemVicmFTdHJpcGVDb2xvcjogIiMwMDAwMDAiLCAvLyIjMTExMTExIiwKICAgIGVkaXRvclRleHRDb2xvcjogInJnYigyMzAsIDIzMCwgMjMwKSIsCiAgICBlZGl0b3JTZWxlY3RlZFRleHRDb2xvcjogInJnYigyNDAsIDI0MCwgMjQwKSIsCiAgICBlZGl0b3JTZWxlY3RlZFRleHRCYWNrZ3JvdW5kOiAiIzI0M2I3NSIsCiAgICBjdXJzb3JTdHlsZTogIiM4NzlhZmYiLAogICAgY3Vyc29yVHlwZTogImliZWFtIiwgICAgICAgLy8gb25lIG9mICJ1bmRlcmxpbmUiIG9yICJpYmVhbSIKICAgIHVuZm9jdXNlZEN1cnNvclN0cm9rZVN0eWxlOiAiI0ZGMDAzMyIsCiAgICB1bmZvY3VzZWRDdXJzb3JGaWxsU3R5bGU6ICIjNzMxNzFFIiwKICAgIHBhcnRpYWxOaWJTdHlsZTogInJnYmEoMTAwLCAxMDAsIDEwMCwgMC4zKSIsCiAgICBwYXJ0aWFsTmliQXJyb3dTdHlsZTogInJnYmEoMjU1LCAyNTUsIDI1NSwgMC4zKSIsCiAgICBwYXJ0aWFsTmliU3Ryb2tlU3R5bGU6ICJyZ2JhKDE1MCwgMTUwLCAxNTAsIDAuMykiLAogICAgZnVsbE5pYlN0eWxlOiAicmdiKDEwMCwgMTAwLCAxMDApIiwKICAgIGZ1bGxOaWJBcnJvd1N0eWxlOiAicmdiKDI1NSwgMjU1LCAyNTUpIiwKICAgIGZ1bGxOaWJTdHJva2VTdHlsZTogInJnYigxNTAsIDE1MCwgMTUwKSIsCiAgICBzY3JvbGxUcmFja0ZpbGxTdHlsZTogInJnYmEoNTAsIDUwLCA1MCwgMC44KSIsCiAgICBzY3JvbGxUcmFja1N0cm9rZVN0eWxlOiAicmdiKDE1MCwgMTUwLCAxNTApIiwKICAgIHNjcm9sbEJhckZpbGxTdHlsZTogInJnYmEoMCwgMCwgMCwgJWEpIiwKICAgIHNjcm9sbEJhckZpbGxHcmFkaWVudFRvcFN0YXJ0OiAicmdiYSg5MCwgOTAsIDkwLCAlYSkiLAogICAgc2Nyb2xsQmFyRmlsbEdyYWRpZW50VG9wU3RvcDogInJnYmEoNDAsIDQwLCA0MCwgJWEpIiwKICAgIHNjcm9sbEJhckZpbGxHcmFkaWVudEJvdHRvbVN0YXJ0OiAicmdiYSgyMiwgMjIsIDIyLCAlYSkiLAogICAgc2Nyb2xsQmFyRmlsbEdyYWRpZW50Qm90dG9tU3RvcDogInJnYmEoNDQsIDQ0LCA0NCwgJWEpIiwKCiAgICAvLyBzeW50YXggZGVmaW5pdGlvbnMKICAgIHBsYWluOiAiI2JkYWU5ZCIsCiAgICBwcmVwcm9jZXNzb3I6ICJyZ2IoMTAwLDEwMCwxMDApIiwKICAgIGtleXdvcmQ6ICIjNDJhOGVkIiwKICAgIHN0cmluZzogIiMwMzlhMGEiLAogICAgY29tbWVudDogIiM2NjY2NjYiLAogICAgJ2MtY29tbWVudCc6ICIjNjY2NjY2IiwKICAgIHB1bmN0dWF0aW9uOiAiIzg4ODg4OCIsCiAgICBhdHRyaWJ1dGU6ICIjQkY5NDY0IiwKICAgIHRlc3Q6ICJyZ2IoMjU1LDAsMCkiLAogICAgY2RhdGE6ICIjYmRhZTlkIiwKICAgICJhdHRyaWJ1dGUtdmFsdWUiOiAiI0JGOTQ2NCIsCiAgICB0YWc6ICIjYmRhZTlkIiwKICAgICJ0YWctbmFtZSI6ICIjYmRhZTlkIiwKICAgIHZhbHVlOiAiI0JGOTQ2NCIsCiAgICBpbXBvcnRhbnQ6ICIjOTkwMDAwIgp9Ci8vICoqIEJsYWNrIFplYnJhIFRoZW1lICoqCkJlc3Bpbi5UaGVtZXMuYmxhY2t6ZWJyYSA9IG5ldyBIYXNoKEJlc3Bpbi5UaGVtZXMuYmxhY2spLnRvT2JqZWN0KCk7CkJlc3Bpbi5UaGVtZXMuYmxhY2t6ZWJyYS56ZWJyYVN0cmlwZUNvbG9yID0gJyMxMTExMTEnOwoKLy8gKiogU2V0dXAgdGhlIGRlZmF1bHQgKioKQmVzcGluLlRoZW1lc1snZGVmYXVsdCddID0gQmVzcGluLlRoZW1lcy5jb2ZmZWU7LyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKgogKiBWZXJzaW9uOiBNUEwgMS4xCiAqCiAqIFRoZSBjb250ZW50cyBvZiB0aGlzIGZpbGUgYXJlIHN1YmplY3QgdG8gdGhlIE1vemlsbGEgUHVibGljIExpY2Vuc2UKICogVmVyc2lvbiAxLjEgKHRoZSAiTGljZW5zZSIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbgogKiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKiBodHRwOi8vd3d3Lm1vemlsbGEub3JnL01QTC8KICoKICogU29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIgogKiBiYXNpcywgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHJpZ2h0cyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIFRoZSBPcmlnaW5hbCBDb2RlIGlzIEJlc3Bpbi4KICoKICogVGhlIEluaXRpYWwgRGV2ZWxvcGVyIG9mIHRoZSBPcmlnaW5hbCBDb2RlIGlzIE1vemlsbGEuCiAqIFBvcnRpb25zIGNyZWF0ZWQgYnkgdGhlIEluaXRpYWwgRGV2ZWxvcGVyIGFyZSBDb3B5cmlnaHQgKEMpIDIwMDkKICogdGhlIEluaXRpYWwgRGV2ZWxvcGVyLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBDb250cmlidXRvcihzKToKICogICBCZXNwaW4gVGVhbSAoYmVzcGluQG1vemlsbGEuY29tKQogKgogKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqLwoKaWYgKHR5cGVvZiBCZXNwaW4gPT0gInVuZGVmaW5lZCIpIEJlc3BpbiA9IHt9OwppZiAoIUJlc3Bpbi5FZGl0b3IpIEJlc3Bpbi5FZGl0b3IgPSB7fTsKCi8vID0gVW5kbyBIYW5kbGluZyA9Ci8vCi8vIEhhbmRsZSB0aGUgdW5kby9yZWRvIHF1ZXVlcyBmb3IgdGhlIGVkaXRvcgoKLy8gKioge3t7IEJlc3Bpbi5FZGl0b3IuVW5kb01hbmFnZXIgfX19ICoqCi8vCi8vIFJ1biB0aGUgdW5kby9yZWRvIHN0YWNrCkJlc3Bpbi5FZGl0b3IuVW5kb01hbmFnZXIgPSBDbGFzcy5jcmVhdGUoewogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWRpdG9yKSB7CiAgICAgICAgdGhpcy5lZGl0b3IgPSBlZGl0b3I7CiAgICAgICAgdGhpcy51bmRvU3RhY2sgPSBbXTsKICAgICAgICB0aGlzLnJlZG9TdGFjayA9IFtdOwogICAgICAgIHRoaXMuc3luY0hlbHBlciA9IHVuZGVmaW5lZDsKICAgIH0sCgogICAgbWF4VW5kb0xlbmd0aDogMTAwLAoKICAgIGNhblVuZG86IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuZG9TdGFjay5sZW5ndGggPiAwOwogICAgfSwKCiAgICB1bmRvOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy51bmRvU3RhY2subGVuZ3RoID09IDApIHJldHVybjsKICAgICAgICB2YXIgaXRlbSA9IHRoaXMudW5kb1N0YWNrLnBvcCgpOwoKICAgICAgICB0aGlzLmVkaXRvci5tb3ZlQ3Vyc29yKGl0ZW0udW5kb09wLnBvcyk7CiAgICAgICAgaXRlbS51bmRvKCk7CiAgICAgICAgdGhpcy5yZWRvU3RhY2sucHVzaChpdGVtKTsKCiAgICAgICAgaWYgKHRoaXMuc3luY0hlbHBlcikgdGhpcy5zeW5jSGVscGVyLnVuZG8oKTsKICAgIH0sCgogICAgcmVkbzogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMucmVkb1N0YWNrLmxlbmd0aCA9PSAwKSByZXR1cm47CiAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLnJlZG9TdGFjay5wb3AoKTsKCiAgICAgICAgdGhpcy5lZGl0b3IubW92ZUN1cnNvcihpdGVtLnJlZG9PcC5wb3MpOwogICAgICAgIGl0ZW0ucmVkbygpOwogICAgICAgIHRoaXMudW5kb1N0YWNrLnB1c2goaXRlbSk7CgogICAgICAgIGlmICh0aGlzLnN5bmNIZWxwZXIpIHRoaXMuc3luY0hlbHBlci5yZWRvKCk7CiAgICB9LAoKICAgIGFkZFVuZG9PcGVyYXRpb246IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICBpZiAoaXRlbS51bmRvT3AucXVldWVkKSByZXR1cm47CgogICAgICAgIGlmICh0aGlzLnJlZG9TdGFjay5sZW5ndGggPiAwKSB0aGlzLnJlZG9TdGFjayA9IFtdOwoKICAgICAgICB3aGlsZSAodGhpcy51bmRvU3RhY2subGVuZ3RoICsgMSA+IHRoaXMubWF4VW5kb0xlbmd0aCkgewogICAgICAgICAgICB0aGlzLnVuZG9TdGFjay5zaGlmdCgpOwogICAgICAgIH0KICAgICAgICB0aGlzLnVuZG9TdGFjay5wdXNoKGl0ZW0pOwogICAgICAgIGl0ZW0uZWRpdG9yID0gdGhpcy5lZGl0b3I7CgogICAgICAgIC8vIHByZXZlbnQgdW5kbyBvcGVyYXRpb25zIGZyb20gcGxhY2luZyB0aGVtc2VsdmVzIGJhY2sgaW4gdGhlIHVuZG8gc3RhY2sKICAgICAgICBpdGVtLnVuZG9PcC5xdWV1ZWQgPSB0cnVlOwogICAgICAgIGl0ZW0ucmVkb09wLnF1ZXVlZCA9IHRydWU7CgogICAgICAgIGlmICh0aGlzLnN5bmNIZWxwZXIpIHRoaXMuc3luY0hlbHBlci5xdWV1ZVVuZG9PcChpdGVtKTsKICAgIH0KfSk7CgovLyAqKiB7e3sgQmVzcGluLkVkaXRvci5VbmRvTWFuYWdlciB9fX0gKioKLy8KLy8gVGhlIGNvcmUgb3BlcmF0aW9uIGNvbnRhaW5zIHR3byBlZGl0IG9wZXJhdGlvbnM7IG9uZSBmb3IgdW5kb2luZyBhbiBvcGVyYXRpb24sIGFuZCB0aGUgb3RoZXIgZm9yIHJlZG9pbmcgaXQKQmVzcGluLkVkaXRvci5VbmRvSXRlbSA9IENsYXNzLmNyZWF0ZSh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbih1bmRvT3AsIHJlZG9PcCkgewogICAgICAgIHRoaXMudW5kb09wID0gdW5kb09wOwogICAgICAgIHRoaXMucmVkb09wID0gcmVkb09wOwogICAgfSwKCiAgICB1bmRvOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmVkaXRvci51aS5hY3Rpb25zW3RoaXMudW5kb09wLmFjdGlvbl0odGhpcy51bmRvT3ApOwogICAgfSwKCiAgICByZWRvOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmVkaXRvci51aS5hY3Rpb25zW3RoaXMucmVkb09wLmFjdGlvbl0odGhpcy5yZWRvT3ApOwogICAgfQp9KTsvKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqCiAqIFZlcnNpb246IE1QTCAxLjEKICoKICogVGhlIGNvbnRlbnRzIG9mIHRoaXMgZmlsZSBhcmUgc3ViamVjdCB0byB0aGUgTW96aWxsYSBQdWJsaWMgTGljZW5zZQogKiBWZXJzaW9uIDEuMSAodGhlICJMaWNlbnNlIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluCiAqIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqIGh0dHA6Ly93d3cubW96aWxsYS5vcmcvTVBMLwogKgogKiBTb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiCiAqIGJhc2lzLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcmlnaHRzIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICoKICogVGhlIE9yaWdpbmFsIENvZGUgaXMgQmVzcGluLgogKgogKiBUaGUgSW5pdGlhbCBEZXZlbG9wZXIgb2YgdGhlIE9yaWdpbmFsIENvZGUgaXMgTW96aWxsYS4KICogUG9ydGlvbnMgY3JlYXRlZCBieSB0aGUgSW5pdGlhbCBEZXZlbG9wZXIgYXJlIENvcHlyaWdodCAoQykgMjAwOQogKiB0aGUgSW5pdGlhbCBEZXZlbG9wZXIuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIENvbnRyaWJ1dG9yKHMpOgogKiAgIEJlc3BpbiBUZWFtIChiZXNwaW5AbW96aWxsYS5jb20pCiAqCiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovCgovLyA9IFN5bnRheCBIaWdobGlnaHRpbmcgPQovLwovLyBNb2R1bGUgZm9yIGRlYWxpbmcgd2l0aCB0aGUgc3ludGF4IGhpZ2hsaWdodGluZy4KLy8KLy8gVGhlIGNvcmUgbW9kZWwgdGFsa3MgdG8gc3BlY2lmaWMgZW5naW5lcyB0byBkbyB0aGUgd29yayBhbmQgdGhlbiBwYWNrYWdlcyBpdCB1cCB0byBzZW5kIHRvIHRoZSBlZGl0b3IuIAoKaWYgKHR5cGVvZiBCZXNwaW4gPT0gInVuZGVmaW5lZCIpIEJlc3BpbiA9IHt9OwppZiAoIUJlc3Bpbi5TeW50YXgpIEJlc3Bpbi5TeW50YXggPSB7fTsKCgovLyAqKiB7e3sgQmVzcGluLlN5bnRheC5Nb2RlbCB9fX0gKioKLy8KLy8gVHJhY2tzIHN5bnRheCBoaWdobGlnaHRpbmcgZGF0YSBvbiBhIHBlci1saW5lIGJhc2lzLgoKQmVzcGluLlN5bnRheC5Nb2RlbCA9IENsYXNzLmNyZWF0ZSh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihlZGl0b3IpIHsKICAgICAgICB0aGlzLmVkaXRvciA9IGVkaXRvcjsKICAgICAgICB0aGlzLmxpbmVDYWNoZSA9IFtdOwogICAgICAgIHRoaXMubGluZU1ldGFJbmZvID0gW107CiAgICAgICAgdGhpcy5zeW50YXhUeXBlID0gIiI7CiAgICB9LAogICAgCiAgICAvLyAqKiB7e3sgTWV0YSBJbmZvIH19fSAqKgogICAgLy8KICAgIC8vIFdlIHN0b3JlIG1ldGEgaW5mbyBvbiB0aGUgbGluZXMsIHN1Y2ggYXMgdGhlIGZhY3QgdGhhdCBpdCBpcyBpbiBhIG11bHRpbGluZSBjb21tZW50CiAgICBzZXRMaW5lTWV0YUluZm86IGZ1bmN0aW9uKGxpbmVOdW1iZXIsIG1ldGEpIHsKICAgICAgICB0aGlzLmxpbmVNZXRhSW5mb1tsaW5lTnVtYmVyXSA9IG1ldGE7CiAgICB9LAogICAgCiAgICBnZXRMaW5lTWV0YUluZm86IGZ1bmN0aW9uKGxpbmVOdW1iZXIpIHsKICAgICAgICByZXR1cm4gdGhpcy5saW5lTWV0YUluZm9bbGluZU51bWJlcl07CiAgICB9LAoKICAgIC8vICoqIHt7eyBDYWNoaW5nIH19fSAqKgogICAgLy8KICAgIC8vIE9wdGlvbmFsbHksIGtlZXAgYSBjYWNoZSBvZiB0aGUgaGlnaGxpZ2h0ZWQgbW9kZWwKICAgIGludmFsaWRhdGVDYWNoZTogZnVuY3Rpb24obGluZU51bWJlcikgewogICAgICAgIGRlbGV0ZSB0aGlzLmxpbmVDYWNoZVtsaW5lTnVtYmVyXTsKICAgIH0sCgogICAgaW52YWxpZGF0ZUVudGlyZUNhY2hlOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmxpbmVDYWNoZSA9IFtdOwogICAgfSwKICAgIAogICAgYWRkVG9DYWNoZTogZnVuY3Rpb24obGluZU51bWJlciwgbGluZSkgewogICAgICAgIHRoaXMubGluZUNhY2hlW2xpbmVOdW1iZXJdID0gbGluZTsKICAgIH0sCiAgICAKICAgIGdldEZyb21DYWNoZTogZnVuY3Rpb24obGluZU51bWJlcikgewogICAgICAgIHJldHVybiB0aGlzLmxpbmVDYWNoZVtsaW5lTnVtYmVyXTsKICAgIH0sCiAgICAKICAgIG1lcmdlU3ludGF4UmVzdWx0czogZnVuY3Rpb24ocmVnaW9ucykgewogICAgICAgIC8vIFRPIEJFIENPTVBMRVRFRAogICAgICAgIC8vIFRoaXMgZnVuY3Rpb24gaGFzIHRvIHRha2UgdGhlIHJlZ2lvbnMgYW5kIHRha2Ugc3ViIHBpZWNlcyBhbmQgdGllIHRoZW0gaW50byB0aGUgZnVsbCBsaW5lCiAgICAgICAgLy8gRm9yIGV4YW1wbGUsIGltYWdpbmUgYW4gSFRNTCBlbmdpbmUgdGhhdCBzZWVzIDxzY3JpcHQ+Li4uLjwvc2NyaXB0PgogICAgICAgIC8vIEl0IHdpbGwgcGFzcyAuLi4uIGludG8gdGhlIEphdmFTY3JpcHQgZW5naW5lIGFuZCB0YWtlIHRob3NlIHJlc3VsdHMgd2l0aCBhIGJhc2Ugb2YgMCBhbmQgcmV0dXJuIHRoZSByZWFsIGxvY2F0aW9uCiAgICAgICAgdmFyIGJhc2UgPSAwOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVnaW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgcmVnaW9uID0gcmVnaW9uW2ldOwogICAgICAgICAgICAvL2Jhc2UgKz0gcmVnaW9uLgogICAgICAgIH0KICAgIH0sCgogICAgLy8gLS0gTWFpbiBBUEkKICAgIC8vICoqIHt7eyBnZXRTeW50YXhTdHlsZXMgfX19ICoqCiAgICAvLwogICAgLy8gVGhpcyBpcyB0aGUgbWFpbiBBUEkuCiAgICAvLwogICAgLy8gR2l2ZW4gdGhlIGxpbmUgbnVtYmVyIGFuZCBzeW50YXggdHlwZSAoZS5nLiBjc3MsIGpzLCBodG1sKSBodW50IGRvd24gdGhlIGVuZ2luZSwgYXNrIGl0IHRvIHN5bnRheCBoaWdobGlnaHQsIGFuZCByZXR1cm4gdGhlIHJlZ2lvbnMKICAgIGdldFN5bnRheFN0eWxlczogZnVuY3Rpb24obGluZU51bWJlciwgc3ludGF4VHlwZSkgewogICAgICAgIGlmICh0aGlzLnN5bnRheFR5cGUgIT0gc3ludGF4VHlwZSkgewogICAgICAgICAgICB0aGlzLmludmFsaWRhdGVFbnRpcmVDYWNoZSgpOwogICAgICAgICAgICB0aGlzLmVuZ2luZSA9IEJlc3Bpbi5TeW50YXguRW5naW5lUmVzb2x2ZXIucmVzb2x2ZShzeW50YXhUeXBlKTsKICAgICAgICAgICAgdGhpcy5zeW50YXhUeXBlID0gc3ludGF4VHlwZTsKICAgICAgICB9IGVsc2UgeyAvLyBQb3NzaWJsZSBmb3IgY2FjaGluZyB0byBiZSByZWFsIGhlcmUKICAgICAgICAgICAgLy8gdmFyIGNhY2hlZCA9IHRoaXMuZ2V0RnJvbUNhY2hlKGxpbmVOdW1iZXIpOwogICAgICAgICAgICAvLyBpZiAoY2FjaGVkKSByZXR1cm4gY2FjaGVkOyAgICAgICAgICAgIAogICAgICAgIH0KCiAgICAgICAgLy8gR2V0IHRoZSByb3cgY29udGVudHMgYXMgb25lIHN0cmluZwogICAgICAgIHZhciBsaW5lID0gdGhpcy5lZGl0b3IubW9kZWwuZ2V0Um93QXJyYXkobGluZU51bWJlcikuam9pbigiIik7CgogICAgICAgIHZhciBzeW50YXhSZXN1bHQgPSB7IC8vIHNldHVwIHRoZSByZXN1bHQKICAgICAgICAgICAgdGV4dDogbGluZSwKICAgICAgICAgICAgcmVnaW9uczogW10KICAgICAgICB9OwogICAgICAgIAogICAgICAgIC8vIHdlIGhhdmUgdGhlIGFiaWxpdHkgdG8gaGF2ZSBzdWJ0eXBlcyB3aXRoaW4gdGhlIG1haW4gcGFyc2VyCiAgICAgICAgLy8gRS5nLiBIVE1MIGNhbiBoYXZlIEphdmFTY3JpcHQgb3IgQ1NTIHdpdGhpbgogICAgICAgIGlmICh0eXBlb2YgdGhpcy5lbmdpbmVbJ2lubmVydHlwZXMnXSA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBzeW50YXhUeXBlcyA9IHRoaXMuZW5naW5lLmlubmVydHlwZXMobGluZSk7CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN5bnRheFR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IHN5bnRheFR5cGVzW2ldOwogICAgICAgICAgICAgICAgdmFyIG1ldGEgPSB7IGluTXVsdGlMaW5lQ29tbWVudDogdGhpcy5pbk11bHRpTGluZUNvbW1lbnQoKSwgb2Zmc2V0OiB0eXBlLnN0YXJ0IH07IC8vIHBhc3MgaW4gYW4gb2Zmc2V0CiAgICAgICAgICAgICAgICB2YXIgcGllY2VSZWdpb25zID0gW107CiAgICAgICAgICAgICAgICB2YXIgZnJvbVJlc29sdmVyID0gQmVzcGluLlN5bnRheC5FbmdpbmVSZXNvbHZlci5oaWdobGlnaHQodHlwZS50eXBlLCBsaW5lLnN1YnN0cmluZyh0eXBlLnN0YXJ0LCB0eXBlLnN0b3ApLCBtZXRhKTsKICAgICAgICAgICAgICAgIGlmIChmcm9tUmVzb2x2ZXIubWV0YSAmJiAoaSA9PSBzeW50YXhUeXBlcy5sZW5ndGggLSAxKSApewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0TGluZU1ldGFJbmZvKGxpbmVOdW1iZXIsIGZyb21SZXNvbHZlci5tZXRhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBpZWNlUmVnaW9ucy5wdXNoKGZyb21SZXNvbHZlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3ludGF4UmVzdWx0LnJlZ2lvbnMucHVzaCh0aGlzLm1lcmdlU3ludGF4UmVzdWx0cyhwaWVjZVJlZ2lvbnMpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbWV0YSA9IChsaW5lTnVtYmVyID4gMCkgPyB0aGlzLmdldExpbmVNZXRhSW5mbyhsaW5lTnVtYmVyIC0gMSkgOiB7fTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHRoaXMuZW5naW5lLmhpZ2hsaWdodChsaW5lLCBtZXRhKTsKICAgICAgICAgICAgdGhpcy5zZXRMaW5lTWV0YUluZm8obGluZU51bWJlciwgcmVzdWx0Lm1ldGEpOwogICAgICAgICAgICBzeW50YXhSZXN1bHQucmVnaW9ucy5wdXNoKHJlc3VsdC5yZWdpb25zKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGhpcy5hZGRUb0NhY2hlKGxpbmVOdW1iZXIsIHN5bnRheFJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHN5bnRheFJlc3VsdDsKICAgIH0KfSk7CgovLyAqKiB7e3sgQmVzcGluLlN5bnRheC5FbmdpbmVSZXNvbHZlciB9fX0gKioKLy8KLy8gVGhlIHJlc29sdmVyIGhvbGRzIHRoZSBlbmdpbmVzIHRoYXQgYXJlIGF2YWlsYWJsZSB0byBkbyB0aGUgYWN0dWFsIHN5bnRheCBoaWdobGlnaHRpbmcKLy8KLy8gSXQgaG9sZHMgYSBkZWZhdWx0IGVuZ2luZSB0aGF0IHJldHVybnMgdGhlIGxpbmUgYmFjayBpbiB0aGUgY2xlYXIKCkJlc3Bpbi5TeW50YXguRW5naW5lUmVzb2x2ZXIgPSBuZXcgZnVuY3Rpb24oKSB7CiAgdmFyIGVuZ2luZXMgPSB7fTsKICAKICAvLyAqKiB7e3sgTm9vcFN5bnRheEVuZ2luZSB9fX0gKioKICAvLwogIC8vIFJldHVybiBhIHBsYWluIHJlZ2lvbiB0aGF0IGlzIHRoZSBlbnRpcmUgbGluZQogIHZhciBOb29wU3ludGF4RW5naW5lID0gewogICAgICBoaWdobGlnaHQ6IGZ1bmN0aW9uKGxpbmUsIG1ldGEpIHsKICAgICAgICAgIHJldHVybiB7IHJlZ2lvbnM6IHsKICAgICAgICAgICAgICBwbGFpbjogW3sKICAgICAgICAgICAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgICAgICAgICAgIHN0b3A6IGxpbmUubGVuZ3RoCiAgICAgICAgICAgICAgfV0KICAgICAgICAgIH0gfQogICAgICB9CiAgICAgIC8vaW5uZXJzeW50YXg6IGZ1bmN0aW9uKCkge30sCiAgfQogIAogIHJldHVybiB7CiAgICAgIC8vICoqIHt7eyBoaWdobGlnaHQgfX19ICoqCiAgICAgIC8vCiAgICAgIC8vIEEgaGlnaCBsZXZlbCBoaWdobGlnaHQgZnVuY3Rpb24gdGhhdCB1c2VzIHRoZSB7e3t0eXBlfX19IHRvIGdldCB0aGUgZW5naW5lLCBhbmQgYXNrcyBpdCB0byBoaWdobGlnaHQKICAgICAgaGlnaGxpZ2h0OiBmdW5jdGlvbih0eXBlLCBsaW5lLCBtZXRhKSB7CiAgICAgICAgICB0aGlzLnJlc29sdmUodHlwZSkuaGlnaGxpZ2h0KGxpbmUsIG1ldGEpOwogICAgICB9LAoKICAgICAgLy8gKioge3t7IHJlZ2lzdGVyIH19fSAqKgogICAgICAvLwogICAgICAvLyBFbmdpbmVzIHJlZ2lzdGVyIHRoZW1zZWx2ZXMsIAogICAgICAvLyBlLmcuIHt7e0Jlc3Bpbi5TeW50YXguRW5naW5lUmVzb2x2ZXIucmVnaXN0ZXIobmV3IEJlc3Bpbi5TeW50YXguQ1NTU3ludGF4RW5naW5lKCksIFsnY3NzJ10pO319fQogICAgICByZWdpc3RlcjogZnVuY3Rpb24oc3ludGF4RW5naW5lLCB0eXBlcykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0eXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGVuZ2luZXNbdHlwZXNbaV1dID0gc3ludGF4RW5naW5lOwogICAgICAgICAgfQogICAgICB9LAoKICAgICAgLy8gKioge3t7IHJlc29sdmUgfX19ICoqCiAgICAgIC8vCiAgICAgIC8vIEh1bnQgZG93biB0aGUgZW5naW5lIGZvciB0aGUgZ2l2ZW4ge3t7dHlwZX19fSAoZS5nLiBjc3MsIGpzLCBodG1sKSBvciByZXR1cm4gdGhlIHt7e05vb3BTeW50YXhFbmdpbmV9fX0KICAgICAgcmVzb2x2ZTogZnVuY3Rpb24odHlwZSkgewogICAgICAgICAgcmV0dXJuIGVuZ2luZXNbdHlwZV0gfHwgTm9vcFN5bnRheEVuZ2luZTsKICAgICAgfSAgICAgIAogIH0gIAp9KCk7Ci8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKioKICogVmVyc2lvbjogTVBMIDEuMQogKgogKiBUaGUgY29udGVudHMgb2YgdGhpcyBmaWxlIGFyZSBzdWJqZWN0IHRvIHRoZSBNb3ppbGxhIFB1YmxpYyBMaWNlbnNlCiAqIFZlcnNpb24gMS4xICh0aGUgIkxpY2Vuc2UiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4KICogY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICogaHR0cDovL3d3dy5tb3ppbGxhLm9yZy9NUEwvCiAqCiAqIFNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIKICogYmFzaXMsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyByaWdodHMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBUaGUgT3JpZ2luYWwgQ29kZSBpcyBCZXNwaW4uCiAqCiAqIFRoZSBJbml0aWFsIERldmVsb3BlciBvZiB0aGUgT3JpZ2luYWwgQ29kZSBpcyBNb3ppbGxhLgogKiBQb3J0aW9ucyBjcmVhdGVkIGJ5IHRoZSBJbml0aWFsIERldmVsb3BlciBhcmUgQ29weXJpZ2h0IChDKSAyMDA5CiAqIHRoZSBJbml0aWFsIERldmVsb3Blci4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogQ29udHJpYnV0b3Iocyk6CiAqICAgQmVzcGluIFRlYW0gKGJlc3BpbkBtb3ppbGxhLmNvbSkKICoKICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi8KCi8vID0gSmF2YVNjcmlwdCBTeW50YXggSGlnaGxpZ2h0aW5nIEltcGxlbWVudGF0aW9uID0KLy8KLy8gTW9kdWxlIGZvciBzeW50YXggaGlnaGxpZ2h0aW5nIEphdmFTY3JpcHQuCgppZiAodHlwZW9mIEJlc3BpbiA9PSAidW5kZWZpbmVkIikgQmVzcGluID0ge307CmlmICghQmVzcGluLlN5bnRheCkgQmVzcGluLlN5bnRheCA9IHt9OwoKLy8gKioge3t7IEJlc3Bpbi5TeW50YXguSmF2YVNjcmlwdFN5bnRheEVuZ2luZSB9fX0gKioKLy8KLy8gVHJhY2tzIHN5bnRheCBoaWdobGlnaHRpbmcgZGF0YSBvbiBhIHBlci1saW5lIGJhc2lzLiBUaGlzIGlzIGEgcXVpY2stYW5kLWRpcnR5IGltcGxlbWVudGF0aW9uIHRoYXQKLy8gc3VwcG9ydHMgZml2ZSBiYXNpYyBoaWdobGlnaHRzOiBrZXl3b3JkcywgcHVuY3R1YXRpb24sIHN0cmluZ3MsIGNvbW1lbnRzLCBhbmQgImV2ZXJ5dGhpbmcgZWxzZSIsIGFsbAovLyBsdW1wZWQgaW50byBvbmUgbGFzdCBidWNrZXQuCgpCZXNwaW4uU3ludGF4LkphdmFTY3JpcHRDb25zdGFudHMgPSB7CiAgICBDX1NUWUxFX0NPTU1FTlQ6ICJjLWNvbW1lbnQiLAogICAgTElORV9DT01NRU5UOiAiY29tbWVudCIsCiAgICBTVFJJTkc6ICJzdHJpbmciLAogICAgS0VZV09SRDogImtleXdvcmQiLAogICAgUFVOQ1RVQVRJT046ICJwdW5jdHVhdGlvbiIsCiAgICBPVEhFUjogInBsYWluIgp9CgpCZXNwaW4uU3ludGF4LkphdmFTY3JpcHRTeW50YXhFbmdpbmUgPSBDbGFzcy5jcmVhdGUoewogICAga2V5d29yZHM6ICdhYnN0cmFjdCBib29sZWFuIGJyZWFrIGJ5dGUgY2FzZSBjYXRjaCBjaGFyIGNsYXNzIGNvbnN0IGNvbnRpbnVlIGRlYnVnZ2VyICcgKwogICAgICAgICAgICAgICAgICAgICdkZWZhdWx0IGRlbGV0ZSBkbyBkb3VibGUgZWxzZSBlbnVtIGV4cG9ydCBleHRlbmRzIGZhbHNlIGZpbmFsIGZpbmFsbHkgZmxvYXQgJyArCiAgICAgICAgICAgICAgICAgICAgJ2ZvciBmdW5jdGlvbiBnb3RvIGlmIGltcGxlbWVudHMgaW1wb3J0IGluIGluc3RhbmNlb2YgaW50IGludGVyZmFjZSBsb25nIG5hdGl2ZSAnICsKICAgICAgICAgICAgICAgICAgICAnbmV3IG51bGwgcGFja2FnZSBwcml2YXRlIHByb3RlY3RlZCBwdWJsaWMgcmV0dXJuIHNob3J0IHN0YXRpYyBzdXBlciBzd2l0Y2ggJyArCiAgICAgICAgICAgICAgICAgICAgJ3N5bmNocm9uaXplZCB0aGlzIHRocm93IHRocm93cyB0cmFuc2llbnQgdHJ1ZSB0cnkgdHlwZW9mIHZhciB2b2lkIHZvbGF0aWxlIHdoaWxlIHdpdGgnLnNwbGl0KCIgIiksCgogICAgcHVuY3R1YXRpb246ICd7IH0gPiA8IC8gKyAtICUgKiAuICwgOyAoICkgPyA6ID0gIiBcJycuc3BsaXQoIiAiKSwKCiAgICBoaWdobGlnaHQ6IGZ1bmN0aW9uKGxpbmUsIG1ldGEpIHsKICAgICAgICBpZiAoIW1ldGEpIG1ldGEgPSB7fTsKCiAgICAgICAgdmFyIEsgPSBCZXNwaW4uU3ludGF4LkphdmFTY3JpcHRDb25zdGFudHM7ICAgIC8vIGFsaWFzaW5nIHRoZSBjb25zdGFudHMgZm9yIHNob3J0ZXIgcmVmZXJlbmNlIDstKQoKICAgICAgICB2YXIgcmVnaW9ucyA9IHt9OyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjb250YWlucyB0aGUgaW5kaXZpZHVhbCBzdHlsZSB0eXBlcyBhcyBrZXlzLCB3aXRoIGFycmF5IG9mIHN0YXJ0L3N0b3AgcG9zaXRpb25zIGFzIHZhbHVlCgogICAgICAgIC8vIGN1cnJlbnQgc3RhdGUsIG1haW50YWluZWQgYXMgd2UgcGFyc2UgdGhyb3VnaCBlYWNoIGNoYXJhY3RlciBpbiB0aGUgbGluZTsgdmFsdWVzIGF0IGFueSB0aW1lIHNob3VsZCBiZSBjb25zaXN0ZW50CiAgICAgICAgdmFyIGN1cnJlbnRTdHlsZSA9IChtZXRhLmluTXVsdGlsaW5lQ29tbWVudCkgPyBLLkNfU1RZTEVfQ09NTUVOVCA6IHVuZGVmaW5lZDsKICAgICAgICB2YXIgY3VycmVudFJlZ2lvbiA9IHt9OyAvLyBzaG91bGQgYWx3YXlzIGhhdmUgYSBzdGFydCBwcm9wZXJ0eSBmb3IgYSBub24tYmxhbmsgYnVmZmVyCiAgICAgICAgdmFyIGJ1ZmZlciA9ICIiOwoKICAgICAgICAvLyB0aGVzZSBwcm9wZXJ0aWVzIGFyZSByZWxhdGVkIHRvIHRoZSBwYXJzZXIgc3RhdGUgYWJvdmUgYnV0IGFyZSBzcGVjaWFsIGNhc2VzCiAgICAgICAgdmFyIHN0cmluZ0NoYXIgPSAiIjsgICAgLy8gdGhlIGNoYXJhY3RlciB1c2VkIHRvIHN0YXJ0IHRoZSBjdXJyZW50IHN0cmluZwogICAgICAgIHZhciBtdWx0aWxpbmUgPSBtZXRhLmluTXVsdGlsaW5lQ29tbWVudDsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5lLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBjID0gbGluZS5jaGFyQXQoaSk7CgogICAgICAgICAgICAvLyBjaGVjayBpZiB3ZSdyZSBpbiBhIGNvbW1lbnQgYW5kIHdoZXRoZXIgdGhpcyBjaGFyYWN0ZXIgZW5kcyB0aGUgY29tbWVudAogICAgICAgICAgICBpZiAoY3VycmVudFN0eWxlID09IEsuQ19TVFlMRV9DT01NRU5UKSB7CiAgICAgICAgICAgICAgICBpZiAoYyA9PSAiLyIgJiYgYnVmZmVyLmVuZHNXaXRoKCIqIikpIHsgLy8gaGFzIHRoZSBjLXN0eWxlIGNvbW1lbnQganVzdCBlbmRlZD8KICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmVnaW9uLnN0b3AgPSBpICsgMTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZFJlZ2lvbihyZWdpb25zLCBjdXJyZW50U3R5bGUsIGN1cnJlbnRSZWdpb24pOwogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRSZWdpb24gPSB7fTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3R5bGUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgbXVsdGlsaW5lID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gIiI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChidWZmZXIgPT0gIiIpIGN1cnJlbnRSZWdpb24gPSB7IHN0YXJ0OiBpIH07CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyICs9IGM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmlzV2hpdGVTcGFjZU9yUHVuY3R1YXRpb24oYykpIHsKICAgICAgICAgICAgICAgIC8vIGNoZWNrIGlmIHdlJ3JlIGluIGEgc3RyaW5nCiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFN0eWxlID09IEsuU1RSSU5HKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhpcyBpcyBub3QgYW4gdW5lc2NhcGVkIGVuZCBxdW90ZSAoZWl0aGVyIGEgc2luZ2xlIHF1b3RlIG9yIGRvdWJsZSBxdW90ZSB0byBtYXRjaCBob3cgdGhlIHN0cmluZyBzdGFydGVkKSB0aGVuIGtlZXAgZ29pbmcKICAgICAgICAgICAgICAgICAgICBpZiAoICEgKGMgPT0gc3RyaW5nQ2hhciAmJiAhYnVmZmVyLmVuZHNXaXRoKCJcXCIpKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnVmZmVyID09ICIiKSBjdXJyZW50UmVnaW9uID0geyBzdGFydDogaSB9OwogICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIgKz0gYzsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBidWZmZXIgaXMgZnVsbCwgYWRkIGl0IHRvIHRoZSByZWdpb25zCiAgICAgICAgICAgICAgICBpZiAoYnVmZmVyICE9ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFJlZ2lvbi5zdG9wID0gaTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRTdHlsZSAhPSBLLlNUUklORykgeyAgIC8vIGlmIHRoaXMgaXMgYSBzdHJpbmcsIHdlJ3JlIGFsbCBzZXQgdG8gYWRkIGl0OyBpZiBub3QsIGZpZ3VyZSBvdXQgaWYgaXRzIGEga2V5d29yZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5rZXl3b3Jkcy5pbmRleE9mKGJ1ZmZlcikgIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBidWZmZXIgY29udGFpbnMgYSBrZXl3b3JkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3R5bGUgPSBLLktFWVdPUkQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3R5bGUgPSBLLk9USEVSOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkUmVnaW9uKHJlZ2lvbnMsIGN1cnJlbnRTdHlsZSwgY3VycmVudFJlZ2lvbik7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFJlZ2lvbiA9IHt9OwogICAgICAgICAgICAgICAgICAgIHN0cmluZ0NoYXIgPSAiIjsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSAiIjsKICAgICAgICAgICAgICAgICAgICAvLyBpIGRvbid0IGNsZWFyIHRoZSBjdXJyZW50IHN0eWxlIGhlcmUgc28gSSBjYW4gY2hlY2sgaWYgaXQgd2FzIGEgc3RyaW5nIGJlbG93CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNQdW5jdHVhdGlvbihjKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjID09ICIqIiAmJiBpID4gMCAmJiAobGluZS5jaGFyQXQoaSAtIDEpID09ICIvIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBwcmV2aW91cyByZWdpb24gaW4gdGhlIHB1bmN0dWF0aW9uIGJ1Y2tldCwgd2hpY2ggaXMgYSBmb3J3YXJkIHNsYXNoCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZ2lvbnNbSy5QVU5DVFVBVElPTl0ucG9wKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgaW4gYSBjLXN0eWxlIGNvbW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgbXVsdGlsaW5lID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFN0eWxlID0gSy5DX1NUWUxFX0NPTU1FTlQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRSZWdpb24gPSB7IHN0YXJ0OiBpIC0gMSB9OwogICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSAiLyoiOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGNoZWNrIGZvciBhIGxpbmUgY29tbWVudDsgdGhpcyBlbmRzIHRoZSBwYXJzaW5nIGZvciB0aGUgcmVzdCBvZiB0aGUgbGluZQogICAgICAgICAgICAgICAgICAgIGlmIChjID09ICcvJyAmJiBpID4gMCAmJiAobGluZS5jaGFyQXQoaSAtIDEpID09ICcvJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFJlZ2lvbiA9IHsgc3RhcnQ6IGkgLSAxLCBzdG9wOiBsaW5lLmxlbmd0aCB9OwogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3R5bGUgPSBLLkxJTkVfQ09NTUVOVDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRSZWdpb24ocmVnaW9ucywgY3VycmVudFN0eWxlLCBjdXJyZW50UmVnaW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTdHlsZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFJlZ2lvbiA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsgICAgICAvLyBvbmNlIHdlIGdldCBhIGxpbmUgY29tbWVudCwgd2UncmUgZG9uZSEKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGFkZCBhbiBhZC1ob2MgcmVnaW9uIGZvciBqdXN0IHRoaXMgb25lIHB1bmN0dWF0aW9uIGNoYXJhY3RlcgogICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkUmVnaW9uKHJlZ2lvbnMsIEsuUFVOQ1RVQVRJT04sIHsgc3RhcnQ6IGksIHN0b3A6IGkgKyAxIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGZpbmQgb3V0IGlmIHRoZSBjdXJyZW50IHF1b3RlIGlzIHRoZSBlbmQgb3IgdGhlIGJlZ2lubmluZyBvZiB0aGUgc3RyaW5nCiAgICAgICAgICAgICAgICBpZiAoKGMgPT0gIiciIHx8IGMgPT0gJyInKSAmJiAoY3VycmVudFN0eWxlICE9IEsuU1RSSU5HKSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTdHlsZSA9IEsuU1RSSU5HOwogICAgICAgICAgICAgICAgICAgIHN0cmluZ0NoYXIgPSBjOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3R5bGUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChidWZmZXIgPT0gIiIpIGN1cnJlbnRSZWdpb24gPSB7IHN0YXJ0OiBpIH07CiAgICAgICAgICAgIGJ1ZmZlciArPSBjOwogICAgICAgIH0KCiAgICAgICAgLy8gY2hlY2sgZm9yIGEgdHJhaWxpbmcgY2hhcmFjdGVyIGluc2lkZSBvZiBhIHN0cmluZyBvciBhIGNvbW1lbnQKICAgICAgICBpZiAoYnVmZmVyICE9ICIiKSB7CiAgICAgICAgICAgIGlmICghY3VycmVudFN0eWxlKSBjdXJyZW50U3R5bGUgPSBLLk9USEVSOwogICAgICAgICAgICBjdXJyZW50UmVnaW9uLnN0b3AgPSBsaW5lLmxlbmd0aDsKICAgICAgICAgICAgdGhpcy5hZGRSZWdpb24ocmVnaW9ucywgY3VycmVudFN0eWxlLCBjdXJyZW50UmVnaW9uKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7IHJlZ2lvbnM6IHJlZ2lvbnMsIG1ldGE6IHsgaW5NdWx0aWxpbmVDb21tZW50OiBtdWx0aWxpbmUgfSB9OwogICAgfSwKCiAgICBhZGRSZWdpb246IGZ1bmN0aW9uKHJlZ2lvbnMsIHR5cGUsIGRhdGEpIHsKICAgICAgICBpZiAoIXJlZ2lvbnNbdHlwZV0pIHJlZ2lvbnNbdHlwZV0gPSBbXTsKICAgICAgICByZWdpb25zW3R5cGVdLnB1c2goZGF0YSk7CiAgICB9LAoKICAgIGlzV2hpdGVTcGFjZU9yUHVuY3R1YXRpb246IGZ1bmN0aW9uKGNoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaXNQdW5jdHVhdGlvbihjaCkgfHwgdGhpcy5pc1doaXRlU3BhY2UoY2gpOwogICAgfSwKCiAgICBpc1B1bmN0dWF0aW9uOiBmdW5jdGlvbihjaCkgewogICAgICAgIHJldHVybiB0aGlzLnB1bmN0dWF0aW9uLmluZGV4T2YoY2gpICE9IC0xOwogICAgfSwKCiAgICBpc1doaXRlU3BhY2U6IGZ1bmN0aW9uKGNoKSB7CiAgICAgICAgcmV0dXJuIGNoID09ICIgIjsKICAgIH0KfSk7CgovLyBSZWdpc3RlcgpCZXNwaW4uU3ludGF4LkVuZ2luZVJlc29sdmVyLnJlZ2lzdGVyKG5ldyBCZXNwaW4uU3ludGF4LkphdmFTY3JpcHRTeW50YXhFbmdpbmUoKSwgWydqcycsICdqYXZhc2NyaXB0JywgJ2VjbWFzY3JpcHQnXSk7LyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKgogKiBWZXJzaW9uOiBNUEwgMS4xCiAqCiAqIFRoZSBjb250ZW50cyBvZiB0aGlzIGZpbGUgYXJlIHN1YmplY3QgdG8gdGhlIE1vemlsbGEgUHVibGljIExpY2Vuc2UKICogVmVyc2lvbiAxLjEgKHRoZSAiTGljZW5zZSIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbgogKiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKiBodHRwOi8vd3d3Lm1vemlsbGEub3JnL01QTC8KICoKICogU29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIgogKiBiYXNpcywgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHJpZ2h0cyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIFRoZSBPcmlnaW5hbCBDb2RlIGlzIEJlc3Bpbi4KICoKICogVGhlIEluaXRpYWwgRGV2ZWxvcGVyIG9mIHRoZSBPcmlnaW5hbCBDb2RlIGlzIE1vemlsbGEuCiAqIFBvcnRpb25zIGNyZWF0ZWQgYnkgdGhlIEluaXRpYWwgRGV2ZWxvcGVyIGFyZSBDb3B5cmlnaHQgKEMpIDIwMDkKICogdGhlIEluaXRpYWwgRGV2ZWxvcGVyLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBDb250cmlidXRvcihzKToKICogICBCZXNwaW4gVGVhbSAoYmVzcGluQG1vemlsbGEuY29tKQogKgogKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqLwoKLy8gPSBDU1MgU3ludGF4IEhpZ2hsaWdodGluZyBJbXBsZW1lbnRhdGlvbiA9Ci8vCi8vIFlvdSBjYW4gZ3Vlc3Mgd2hhdCB0aGlzIGRvZXMuIDstKQoKaWYgKHR5cGVvZiBCZXNwaW4gPT0gInVuZGVmaW5lZCIpIEJlc3BpbiA9IHt9OwppZiAoIUJlc3Bpbi5TeW50YXgpIEJlc3Bpbi5TeW50YXggPSB7fTsKCi8vICoqIHt7eyBCZXNwaW4uU3ludGF4LkNTU1N5bnRheEVuZ2luZSB9fX0gKioKLy8KLy8gVHJhY2tzIHN5bnRheCBoaWdobGlnaHRpbmcgZGF0YSBvbiBhIHBlci1saW5lIGJhc2lzLiBUaGlzIGlzIGEgcXVpY2stYW5kLWRpcnR5IGltcGxlbWVudGF0aW9uIHRoYXQKLy8gZG9lcyB0aGUgcmlnaHQgdGhpbmcgZm9yIGtleS92YWx1ZSBwYWlycywgIzAwMDAwMCwgYW5kIHRoZSBsaWtlLgovLyBEb2Vzbid0IGFjdHVhbGx5IGdyb2sgdGhlIHpvbmVzIG9mICJwcm9wZXJ0eWtleTogcHJvcGVydHl2YWx1ZSIgYXMgaXQgc2hvdWxkLgoKQmVzcGluLlN5bnRheC5Db25zdGFudHMgPSB7CiAgICBDX1NUWUxFX0NPTU1FTlQ6ICJjLWNvbW1lbnQiLAogICAgU1RSSU5HOiAic3RyaW5nIiwKICAgIEtFWVdPUkQ6ICJrZXl3b3JkIiwKICAgIFBVTkNUVUFUSU9OOiAicHVuY3R1YXRpb24iLAogICAgT1RIRVI6ICJwbGFpbiIsCiAgICBOQU1FOiAiYXR0cmlidXRlLW5hbWUiLAogICAgVkFMVUU6ICJhdHRyaWJ1dGUtdmFsdWUiLAogICAgSU1QT1JUQU5UOiAiaW1wb3J0YW50IiwKICAgIENPTE9SOiAiY29sb3IiLAogICAgU0laRVM6ICJzaXplcyIsCiAgICBJRDogImNzc2lkIiwKICAgIENPTE9SX09SX0lEOiAiY29sb3Jfb3JfaWQiCn0KCkJlc3Bpbi5TeW50YXguQ1NTU3ludGF4RW5naW5lID0gQ2xhc3MuY3JlYXRlKHsgICAgCglrZXl3b3JkczogWydhc2NlbnQnLCAnYXppbXV0aCcsICdiYWNrZ3JvdW5kLWF0dGFjaG1lbnQnLCAnYmFja2dyb3VuZC1jb2xvcicsICdiYWNrZ3JvdW5kLWltYWdlJywgJ2JhY2tncm91bmQtcG9zaXRpb24nLCAKCSAgICAnYmFja2dyb3VuZC1yZXBlYXQnLCAnYmFja2dyb3VuZCcsICdiYXNlbGluZScsICdiYm94JywgJ2JvcmRlci1jb2xsYXBzZScsICdib3JkZXItY29sb3InLCAnYm9yZGVyLXNwYWNpbmcnLCAnYm9yZGVyLXN0eWxlJywKCSAgICAnYm9yZGVyLXRvcCcsICdib3JkZXItcmlnaHQnLCAnYm9yZGVyLWJvdHRvbScsICdib3JkZXItbGVmdCcsICdib3JkZXItdG9wLWNvbG9yJywgJ2JvcmRlci1yaWdodC1jb2xvcicsICdib3JkZXItYm90dG9tLWNvbG9yJywKCSAgICAnYm9yZGVyLWxlZnQtY29sb3InLCAnYm9yZGVyLXRvcC1zdHlsZScsICdib3JkZXItcmlnaHQtc3R5bGUnLCAnYm9yZGVyLWJvdHRvbS1zdHlsZScsICdib3JkZXItbGVmdC1zdHlsZScsICdib3JkZXItdG9wLXdpZHRoJywKCSAgICAnYm9yZGVyLXJpZ2h0LXdpZHRoJywgJ2JvcmRlci1ib3R0b20td2lkdGgnLCAnYm9yZGVyLWxlZnQtd2lkdGgnLCAnYm9yZGVyLXdpZHRoJywgJ2JvcmRlcicsICdjYXAtaGVpZ2h0JywgJ2NhcHRpb24tc2lkZScsICdjZW50ZXJsaW5lJywKCSAgICAnY2xlYXInLCAnY2xpcCcsICdjb2xvcicsICdjb250ZW50JywgJ2NvdW50ZXItaW5jcmVtZW50JywgJ2NvdW50ZXItcmVzZXQnLCAnY3VlLWFmdGVyJywgJ2N1ZS1iZWZvcmUnLCAnY3VlJywgJ2N1cnNvcicsICdkZWZpbml0aW9uLXNyYycsIAoJICAgICdkZXNjZW50JywgJ2RpcmVjdGlvbicsICdkaXNwbGF5JywgJ2VsZXZhdGlvbicsICdlbXB0eS1jZWxscycsICdmbG9hdCcsICdmb250LXNpemUtYWRqdXN0JywgJ2ZvbnQtZmFtaWx5JywgJ2ZvbnQtc2l6ZScsICdmb250LXN0cmV0Y2gnLAoJICAgICdmb250LXN0eWxlJywgJ2ZvbnQtdmFyaWFudCcsICdmb250LXdlaWdodCcsICdmb250JywgJ2hlaWdodCcsICdsZXR0ZXItc3BhY2luZycsICdsaW5lLWhlaWdodCcsICdsaXN0LXN0eWxlLWltYWdlJywgJ2xpc3Qtc3R5bGUtcG9zaXRpb24nLCAgCgkgICAgJ2xpc3Qtc3R5bGUtdHlwZScsICdsaXN0LXN0eWxlJywgJ21hcmdpbi10b3AnLCAnbWFyZ2luLXJpZ2h0JywgJ21hcmdpbi1ib3R0b20nLCAnbWFyZ2luLWxlZnQnLCAnbWFyZ2luJywgJ21hcmtlci1vZmZzZXQnLCAnbWFya3MnLCAnbWF0aGxpbmUnLAoJICAgICdtYXgtaGVpZ2h0JywnbWF4LXdpZHRoJywgJ21pbi1oZWlnaHQnLCAnbWluLXdpZHRoJywgJ29ycGhhbnMnLCAnb3V0bGluZS1jb2xvcicsICdvdXRsaW5lLXN0eWxlJywgJ291dGxpbmUtd2lkdGgnLCAnb3V0bGluZScsICdvdmVyZmxvdycsIAoJICAgICdwYWRkaW5nLXRvcCcsICdwYWRkaW5nLXJpZ2h0JywgJ3BhZGRpbmctYm90dG9tJywgJ3BhZGRpbmctbGVmdCcsICdwYWRkaW5nJywgJ3BhZ2UnLCAncGFnZS1icmVhay1hZnRlcicsICdwYWdlLWJyZWFrLWJlZm9yZScsIAoJICAgICdwYWdlLWJyZWFrLWluc2lkZScsICdwYXVzZScsICdwYXVzZS1hZnRlcicsICdwYXVzZS1iZWZvcmUnLCAncGl0Y2gnLCAncGl0Y2gtcmFuZ2UnLCAncGxheS1kdXJpbmcnLCAncG9zaXRpb24nLAogICAgICAgICdxdW90ZXMnLCAncmljaG5lc3MnLCAnc2l6ZScsICdzbG9wZScsICdzcmMnLCAnc3BlYWstaGVhZGVyJywgJ3NwZWFrLW51bWVyYWwnLCAnc3BlYWstcHVuY3R1YXRpb24nLCAnc3BlYWsnLCAnc3BlZWNoLXJhdGUnLCAnc3RlbWgnLCAnc3RlbXYnLCAgIAogICAgICAgICdzdHJlc3MnLCAndGFibGUtbGF5b3V0JywgJ3RleHQtYWxpZ24nLCAndGV4dC1kZWNvcmF0aW9uJywgJ3RleHQtaW5kZW50JywgJ3RleHQtc2hhZG93JywgJ3RleHQtdHJhbnNmb3JtJywgJ3VuaWNvZGUtYmlkaScsICd1bmljb2RlLXJhbmdlJywgCiAgICAgICAgJ3VuaXRzLXBlci1lbScsICd2ZXJ0aWNhbC1hbGlnbicsICd2aXNpYmlsaXR5JywgJ3ZvaWNlLWZhbWlseScsICd2b2x1bWUnLCAnd2hpdGUtc3BhY2UnLCAnd2lkb3dzJywgJ3dpZHRoJywgJ3dpZHRocycsICd3b3JkLXNwYWNpbmcnLCAKICAgICAgICAneC1oZWlnaHQnLCAnei1pbmRleCddLAoKCXZhbHVlczoJWydhYm92ZScsICdhYnNvbHV0ZScsICdhbGwnLCAnYWx3YXlzJywgJ2FxdWEnLCAnYXJtZW5pYW4nLCAnYXR0cicsICdhdXJhbCcsICdhdXRvJywgJ2F2b2lkJywgJ2Jhc2VsaW5lJywgJ2JlaGluZCcsICdiZWxvdycsIAoJICAgICAgICAnYmlkaS1vdmVycmlkZScsICdibGFjaycsICdibGluaycsICdibG9jaycsICdibHVlJywgJ2JvbGQnLCAnYm9sZGVyJywgJ2JvdGgnLCAnYm90dG9tJywgJ2JyYWlsbGUnLCAnY2FwaXRhbGl6ZScsICdjYXB0aW9uJywgCgkgICAgICAgICdjZW50ZXInLCAnY2VudGVyLWxlZnQnLCAnY2VudGVyLXJpZ2h0JywgJ2NpcmNsZScsICdjbG9zZS1xdW90ZScsICdjb2RlJywgJ2NvbGxhcHNlJywgJ2NvbXBhY3QnLCAnY29uZGVuc2VkJywKCQkJJ2NvbnRpbnVvdXMnLCAnY291bnRlcicsICdjb3VudGVycycsICdjcm9wJywgJ2Nyb3NzJywgJ2Nyb3NzaGFpcicsICdjdXJzaXZlJywgJ2Rhc2hlZCcsICdkZWNpbWFsJywgJ2RlY2ltYWwtbGVhZGluZy16ZXJvJywgJ2RlZmF1bHQnLAoJCQknZGlnaXRzJywgJ2Rpc2MnLCAnZG90dGVkJywgJ2RvdWJsZScsICdlbWJlZCcsICdlbWJvc3NlZCcsICdlLXJlc2l6ZScsICdleHBhbmRlZCcsICdleHRyYS1jb25kZW5zZWQnLCAnZXh0cmEtZXhwYW5kZWQnLCAnZmFudGFzeScsIAoJCQknZmFyLWxlZnQnLCAnZmFyLXJpZ2h0JywgJ2Zhc3QnLCAnZmFzdGVyJywgJ2ZpeGVkJywgJ2Zvcm1hdCcsICdmdWNoc2lhJywgJ2dyYXknLCAnZ3JlZW4nLCAnZ3Jvb3ZlJywgJ2hhbmRoZWxkJywgJ2hlYnJldycsICdoZWxwJywKCQkJJ2hpZGRlbicsICdoaWRlJywgJ2hpZ2gnLCAnaGlnaGVyJywgJ2ljb24nLCAnaW5saW5lLXRhYmxlJywgJ2lubGluZScsICdpbnNldCcsICdpbnNpZGUnLCAnaW52ZXJ0JywKCQkJJ2l0YWxpYycsICdqdXN0aWZ5JywgJ2xhbmRzY2FwZScsICdsYXJnZScsICdsYXJnZXInLCAnbGVmdC1zaWRlJywgJ2xlZnQnLCAnbGVmdHdhcmRzJywgJ2xldmVsJywgJ2xpZ2h0ZXInLCAnbGltZScsICdsaW5lLXRocm91Z2gnLAoJCQknbGlzdC1pdGVtJywgJ2xvY2FsJywgJ2xvdWQnLCAnbG93ZXItYWxwaGEnLCAnbG93ZXJjYXNlJywgJ2xvd2VyLWdyZWVrJywgJ2xvd2VyLWxhdGluJywgJ2xvd2VyLXJvbWFuJywgJ2xvd2VyJywgJ2xvdycsICdsdHInLCAnbWFya2VyJywKCQkJJ21hcm9vbicsICdtZWRpdW0nLCAnbWVzc2FnZS1ib3gnLCAnbWlkZGxlJywgJ21peCcsICdtb3ZlJywgJ25hcnJvd2VyJywgJ25hdnknLCAnbmUtcmVzaXplJywgJ25vLWNsb3NlLXF1b3RlJywgJ25vbmUnLCAnbm8tb3Blbi1xdW90ZScsIAoJCQknbm8tcmVwZWF0JywgJ25vcm1hbCcsICdub3dyYXAnLCAnbi1yZXNpemUnLCAnbnctcmVzaXplJywgJ29ibGlxdWUnLCAnb2xpdmUnLCAnb25jZScsICdvcGVuLXF1b3RlJywgJ291dHNldCcsICdvdXRzaWRlJywgJ292ZXJsaW5lJywKCQkJJ3BvaW50ZXInLCAncG9ydHJhaXQnLCAncHJlJywgJ3ByaW50JywgJ3Byb2plY3Rpb24nLCAncHVycGxlJywgJ3JlZCcsICdyZWxhdGl2ZScsICdyZXBlYXQnLCAncmVwZWF0LXgnLCAncmVwZWF0LXknLCAncmdiJywgJ3JpZGdlJywKCQkJJ3JpZ2h0JywgJ3JpZ2h0LXNpZGUnLCAncmlnaHR3YXJkcycsICdydGwnLCAncnVuLWluJywgJ3NjcmVlbicsICdzY3JvbGwnLCAnc2VtaS1jb25kZW5zZWQnLCAnc2VtaS1leHBhbmRlZCcsICdzZXBhcmF0ZScsICdzZS1yZXNpemUnLAoJCQknc2hvdycsICdzaWxlbnQnLCAnc2lsdmVyJywgJ3Nsb3dlcicsICdzbG93JywgJ3NtYWxsJywgJ3NtYWxsLWNhcHMnLCAnc21hbGwtY2FwdGlvbicsICdzbWFsbGVyJywgJ3NvZnQnLCAnc29saWQnLCAnc3BlZWNoJywgJ3NwZWxsLW91dCcsCgkJCSdzcXVhcmUnLCAncy1yZXNpemUnLCAnc3RhdGljJywgJ3N0YXR1cy1iYXInLCAnc3ViJywgJ3N1cGVyJywgJ3N3LXJlc2l6ZScsICd0YWJsZS1jYXB0aW9uJywgJ3RhYmxlLWNlbGwnLCAndGFibGUtY29sdW1uJywKCQkJJ3RhYmxlLWNvbHVtbi1ncm91cCcsICd0YWJsZS1mb290ZXItZ3JvdXAnLCAndGFibGUtaGVhZGVyLWdyb3VwJywgJ3RhYmxlLXJvdycsICd0YWJsZS1yb3ctZ3JvdXAnLCAndGVhbCcsICd0ZXh0LWJvdHRvbScsICd0ZXh0LXRvcCcsCgkJCSd0aGljaycsICd0aGluJywgJ3RvcCcsICd0cmFuc3BhcmVudCcsICd0dHknLCAndHYnLCAndWx0cmEtY29uZGVuc2VkJywgJ3VsdHJhLWV4cGFuZGVkJywgJ3VuZGVybGluZScsICd1cHBlci1hbHBoYScsICd1cHBlcmNhc2UnLAoJCQkndXBwZXItbGF0aW4nLCAndXBwZXItcm9tYW4nLCAndXJsJywgJ3Zpc2libGUnLCAnd2FpdCcsICd3aGl0ZScsICd3aWRlcicsICd3LXJlc2l6ZScsICd4LWZhc3QnLCAneC1oaWdoJywgJ3gtbGFyZ2UnLCAneC1sb3VkJywgJ3gtbG93JywKCQkJJ3gtc2xvdycsICd4LXNtYWxsJywgJ3gtc29mdCcsICd4eC1sYXJnZScsICd4eC1zbWFsbCcsICd5ZWxsb3cnLCAKCQkJJ21vbm9zcGFjZScsICd0YWhvbWEnLCAndmVyZGFuYScsICdhcmlhbCcsICdoZWx2ZXRpY2EnLCAnc2Fucy1zZXJpZicsICdzZXJpZiddLAkKCQkJCglzaXplUmVnZXg6ICIoPzplbXxwdHxweHwlKSIsCgogICAgaW1wb3J0YW50OiAnIWltcG9ydGFudCcsCgogICAgcHVuY3R1YXRpb246ICd7IH0gLyArICogLiAsIDsgKCApID8gOiA9ICIgXCcnLnNwbGl0KCIgIiksCgogICAgaGlnaGxpZ2h0OiBmdW5jdGlvbihsaW5lLCBtZXRhKSB7CiAgICAgICAgdmFyIEsgPSBCZXNwaW4uU3ludGF4LkNvbnN0YW50czsgICAgLy8gYWxpYXNpbmcgdGhlIGNvbnN0YW50cyBmb3Igc2hvcnRlciByZWZlcmVuY2UgOy0pCgogICAgICAgIHZhciByZWdpb25zID0ge307ICAvLyBjb250YWlucyB0aGUgaW5kaXZpZHVhbCBzdHlsZSB0eXBlcyBhcyBrZXlzLCB3aXRoIGFycmF5IG9mIHN0YXJ0L3N0b3AgcG9zaXRpb25zIGFzIHZhbHVlCiAgICAgICAgCiAgICAgICAgaWYgKCFtZXRhKSBtZXRhID0ge307IC8vIG1heSBub3QgZ2V0IGl0IGZpcnN0IHRpbWUKCiAgICAgICAgLy8gY3VycmVudCBzdGF0ZSwgbWFpbnRhaW5lZCBhcyB3ZSBwYXJzZSB0aHJvdWdoIGVhY2ggY2hhcmFjdGVyIGluIHRoZSBsaW5lOyB2YWx1ZXMgYXQgYW55IHRpbWUgc2hvdWxkIGJlIGNvbnNpc3RlbnQKICAgICAgICB2YXIgY3VycmVudFN0eWxlID0gKG1ldGEuaW5NdWx0aWxpbmVDb21tZW50KSA/IEsuQ19TVFlMRV9DT01NRU5UIDogdW5kZWZpbmVkOwogICAgICAgIHZhciBjdXJyZW50UmVnaW9uID0ge307IC8vIHNob3VsZCBhbHdheXMgaGF2ZSBhIHN0YXJ0IHByb3BlcnR5IGZvciBhIG5vbi1ibGFuayBidWZmZXIKICAgICAgICB2YXIgYnVmZmVyID0gIiI7CgogICAgICAgIC8vIHRoZXNlIHByb3BlcnRpZXMgYXJlIHJlbGF0ZWQgdG8gdGhlIHBhcnNlciBzdGF0ZSBhYm92ZSBidXQgYXJlIHNwZWNpYWwgY2FzZXMKICAgICAgICB2YXIgc3RyaW5nQ2hhciA9ICIiOyAgICAvLyB0aGUgY2hhcmFjdGVyIHVzZWQgdG8gc3RhcnQgdGhlIGN1cnJlbnQgc3RyaW5nCiAgICAgICAgdmFyIG11bHRpbGluZSA9IG1ldGEuaW5NdWx0aWxpbmVDb21tZW50OyAgLy8gdGhpcyBsaW5lIGNvbnRhaW5zIGFuIHVudGVybWluYXRlZCBtdWx0aS1saW5lIGNvbW1lbnQKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5lLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBjID0gbGluZS5jaGFyQXQoaSk7CgogICAgICAgICAgICAvLyBjaGVjayBpZiB3ZSdyZSBpbiBhIGNvbW1lbnQgYW5kIHdoZXRoZXIgdGhpcyBjaGFyYWN0ZXIgZW5kcyB0aGUgY29tbWVudAogICAgICAgICAgICBpZiAoY3VycmVudFN0eWxlID09IEsuQ19TVFlMRV9DT01NRU5UKSB7CiAgICAgICAgICAgICAgICBpZiAoYyA9PSAiLyIgJiYgYnVmZmVyLmVuZHNXaXRoKCIqIikpIHsgLy8gaGFzIHRoZSBjLXN0eWxlIGNvbW1lbnQganVzdCBlbmRlZD8KICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmVnaW9uLnN0b3AgPSBpICsgMTsgLy8gZ2V0IHRoZSBmaW5hbCAvIHRvbwogICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkUmVnaW9uKHJlZ2lvbnMsIGN1cnJlbnRTdHlsZSwgY3VycmVudFJlZ2lvbik7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFJlZ2lvbiA9IHt9OwogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTdHlsZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBtdWx0aWxpbmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSAiIjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1ZmZlciA9PSAiIikgY3VycmVudFJlZ2lvbiA9IHsgc3RhcnQ6IGkgfTsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgKz0gYzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gY2hlY2sgaWYgd2UgaGF2ZSBhIGhhc2ggY2hhcmFjdGVyCiAgICAgICAgICAgIGlmICh0aGlzLmlzSGFzaENoYXIoYykpIHsKICAgICAgICAgICAgICAgICBjdXJyZW50U3R5bGUgPSBLLkNPTE9SX09SX0lEOwogICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgaWYgKGJ1ZmZlciA9PSAiIikgY3VycmVudFJlZ2lvbiA9IHsgc3RhcnQ6IGkgfTsKICAgICAgICAgICAgICAgICBidWZmZXIgKz0gYzsKICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAoKICAgICAgICAgICAgaWYgKHRoaXMuaXNXaGl0ZVNwYWNlT3JQdW5jdHVhdGlvbihjKSkgewogICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgd2UncmUgaW4gYSBzdHJpbmcKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50U3R5bGUgPT0gSy5TVFJJTkcpIHsKICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGlzIGlzIG5vdCBhbiB1bmVzY2FwZWQgZW5kIHF1b3RlIChlaXRoZXIgYSBzaW5nbGUgcXVvdGUgb3IgZG91YmxlIHF1b3RlIHRvIG1hdGNoIGhvdyB0aGUgc3RyaW5nIHN0YXJ0ZWQpIHRoZW4ga2VlcCBnb2luZwogICAgICAgICAgICAgICAgICAgIGlmICggISAoYyA9PSBzdHJpbmdDaGFyICYmICFidWZmZXIuZW5kc1dpdGgoIlxcIikpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChidWZmZXIgPT0gIiIpIGN1cnJlbnRSZWdpb24gPSB7IHN0YXJ0OiBpIH07CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlciArPSBjOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRTdHlsZSA9PSBLLkNPTE9SX09SX0lEKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhpcyBpcyBub3QgYW4gdW5lc2NhcGVkIGVuZCBxdW90ZSAoZWl0aGVyIGEgc2luZ2xlIHF1b3RlIG9yIGRvdWJsZSBxdW90ZSB0byBtYXRjaCBob3cgdGhlIHN0cmluZyBzdGFydGVkKSB0aGVuIGtlZXAgZ29pbmcKICAgICAgICAgICAgICAgICAgICBpZiAoYnVmZmVyLm1hdGNoKC8jWzAtOUFhQmJDY0RkRWVGZl17Myw2fS8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTdHlsZSA9IEsuQ09MT1I7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFN0eWxlID0gSy5PVEhFUjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFJlZ2lvbi5zdG9wID0gaTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZFJlZ2lvbihyZWdpb25zLCBjdXJyZW50U3R5bGUsIGN1cnJlbnRSZWdpb24pOwoKICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmVnaW9uID0geyBzdGFydDogaSB9OyAvLyBjbGVhcgogICAgICAgICAgICAgICAgICAgIHN0cmluZ0NoYXIgPSAiIjsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBjOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTdHlsZSA9IHVuZGVmaW5lZDsKCiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gaWYgdGhlIGJ1ZmZlciBpcyBmdWxsLCBhZGQgaXQgdG8gdGhlIHJlZ2lvbnMKICAgICAgICAgICAgICAgIGlmIChidWZmZXIgIT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmVnaW9uLnN0b3AgPSBpOwoKICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGlzIGlzIGEgc3RyaW5nLCB3ZSdyZSBhbGwgc2V0IHRvIGFkZCBpdDsgaWYgbm90LCBmaWd1cmUgb3V0IGlmIGl0cyBhIGtleXdvcmQsIHZhbHVlLCBvciBpbXBvcnRhbnQKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFN0eWxlICE9IEsuU1RSSU5HKSB7IAogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5rZXl3b3Jkcy5pbmRleE9mKGJ1ZmZlcikgIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBidWZmZXIgY29udGFpbnMgYSBrZXl3b3JkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3R5bGUgPSBLLktFWVdPUkQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy52YWx1ZXMuaW5kZXhPZihidWZmZXIudG9Mb3dlckNhc2UoKSkgIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTdHlsZSA9IEsuVkFMVUU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYnVmZmVyLm1hdGNoKHRoaXMuc2l6ZVJlZ2V4KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFN0eWxlID0gSy5TSVpFOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW1wb3J0YW50LmluZGV4T2YoYnVmZmVyKSAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFN0eWxlID0gSy5JTVBPUlRBTlQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3R5bGUgPSBLLk9USEVSOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkUmVnaW9uKHJlZ2lvbnMsIGN1cnJlbnRTdHlsZSwgY3VycmVudFJlZ2lvbik7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFJlZ2lvbiA9IHt9OwogICAgICAgICAgICAgICAgICAgIHN0cmluZ0NoYXIgPSAiIjsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSAiIjsKICAgICAgICAgICAgICAgICAgICAvLyBpIGRvbid0IGNsZWFyIHRoZSBjdXJyZW50IHN0eWxlIGhlcmUgc28gSSBjYW4gY2hlY2sgaWYgaXQgd2FzIGEgc3RyaW5nIGJlbG93CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNQdW5jdHVhdGlvbihjKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjID09ICIqIiAmJiBpID4gMCAmJiAobGluZS5jaGFyQXQoaSAtIDEpID09ICIvIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBwcmV2aW91cyByZWdpb24gaW4gdGhlIHB1bmN0dWF0aW9uIGJ1Y2tldCwgd2hpY2ggaXMgYSBmb3J3YXJkIHNsYXNoCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZ2lvbnNbSy5QVU5DVFVBVElPTl0ucG9wKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgaW4gYSBjLXN0eWxlIGNvbW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgbXVsdGlsaW5lID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFN0eWxlID0gSy5DX1NUWUxFX0NPTU1FTlQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRSZWdpb24gPSB7IHN0YXJ0OiBpIC0gMSB9OwogICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSAiLyoiOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGFkZCBhbiBhZC1ob2MgcmVnaW9uIGZvciBqdXN0IHRoaXMgb25lIHB1bmN0dWF0aW9uIGNoYXJhY3RlcgogICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkUmVnaW9uKHJlZ2lvbnMsIEsuUFVOQ1RVQVRJT04sIHsgc3RhcnQ6IGksIHN0b3A6IGkgKyAxIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGZpbmQgb3V0IGlmIHRoZSBjdXJyZW50IHF1b3RlIGlzIHRoZSBlbmQgb3IgdGhlIGJlZ2lubmluZyBvZiB0aGUgc3RyaW5nCiAgICAgICAgICAgICAgICBpZiAoKGMgPT0gIiciIHx8IGMgPT0gJyInKSAmJiAoY3VycmVudFN0eWxlICE9IEsuU1RSSU5HKSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTdHlsZSA9IEsuU1RSSU5HOwogICAgICAgICAgICAgICAgICAgIHN0cmluZ0NoYXIgPSBjOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3R5bGUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChidWZmZXIgPT0gIiIpIGN1cnJlbnRSZWdpb24gPSB7IHN0YXJ0OiBpIH07CiAgICAgICAgICAgIGJ1ZmZlciArPSBjOwogICAgICAgIH0KCiAgICAgICAgLy8gY2hlY2sgZm9yIGEgdHJhaWxpbmcgY2hhcmFjdGVyIGluc2lkZSBvZiBhIHN0cmluZyBvciBhIGNvbW1lbnQKICAgICAgICBpZiAoYnVmZmVyICE9ICIiKSB7CiAgICAgICAgICAgIGlmICghY3VycmVudFN0eWxlKSBjdXJyZW50U3R5bGUgPSBLLk9USEVSOwogICAgICAgICAgICBjdXJyZW50UmVnaW9uLnN0b3AgPSBsaW5lLmxlbmd0aDsKICAgICAgICAgICAgdGhpcy5hZGRSZWdpb24ocmVnaW9ucywgY3VycmVudFN0eWxlLCBjdXJyZW50UmVnaW9uKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7IHJlZ2lvbnM6IHJlZ2lvbnMsIG1ldGE6IHsgaW5NdWx0aWxpbmVDb21tZW50OiBtdWx0aWxpbmUgfSB9OwogICAgfSwKCiAgICBhZGRSZWdpb246IGZ1bmN0aW9uKHJlZ2lvbnMsIHR5cGUsIGRhdGEpIHsKICAgICAgICBpZiAoIXJlZ2lvbnNbdHlwZV0pIHJlZ2lvbnNbdHlwZV0gPSBbXTsKICAgICAgICByZWdpb25zW3R5cGVdLnB1c2goZGF0YSk7CiAgICB9LAoKICAgIGlzSGFzaENoYXI6IGZ1bmN0aW9uKGNoKSB7CiAgICAgICAgcmV0dXJuIGNoID09ICIjIjsKICAgIH0sCgogICAgaXNXaGl0ZVNwYWNlT3JQdW5jdHVhdGlvbjogZnVuY3Rpb24oY2gpIHsKICAgICAgICByZXR1cm4gdGhpcy5pc1B1bmN0dWF0aW9uKGNoKSB8fCB0aGlzLmlzV2hpdGVTcGFjZShjaCk7CiAgICB9LAoKICAgIGlzUHVuY3R1YXRpb246IGZ1bmN0aW9uKGNoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucHVuY3R1YXRpb24uaW5kZXhPZihjaCkgIT0gLTE7CiAgICB9LAoKICAgIGlzV2hpdGVTcGFjZTogZnVuY3Rpb24oY2gpIHsKICAgICAgICByZXR1cm4gY2ggPT0gIiAiOwogICAgfQp9KTsKCi8vIFJlZ2lzdGVyIHRoaXMgcHVwcHkKQmVzcGluLlN5bnRheC5FbmdpbmVSZXNvbHZlci5yZWdpc3RlcihuZXcgQmVzcGluLlN5bnRheC5DU1NTeW50YXhFbmdpbmUoKSwgWydjc3MnXSk7Ci8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKioKICogVmVyc2lvbjogTVBMIDEuMQogKgogKiBUaGUgY29udGVudHMgb2YgdGhpcyBmaWxlIGFyZSBzdWJqZWN0IHRvIHRoZSBNb3ppbGxhIFB1YmxpYyBMaWNlbnNlCiAqIFZlcnNpb24gMS4xICh0aGUgIkxpY2Vuc2UiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4KICogY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICogaHR0cDovL3d3dy5tb3ppbGxhLm9yZy9NUEwvCiAqCiAqIFNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIKICogYmFzaXMsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyByaWdodHMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBUaGUgT3JpZ2luYWwgQ29kZSBpcyBCZXNwaW4uCiAqCiAqIFRoZSBJbml0aWFsIERldmVsb3BlciBvZiB0aGUgT3JpZ2luYWwgQ29kZSBpcyBNb3ppbGxhLgogKiBQb3J0aW9ucyBjcmVhdGVkIGJ5IHRoZSBJbml0aWFsIERldmVsb3BlciBhcmUgQ29weXJpZ2h0IChDKSAyMDA5CiAqIHRoZSBJbml0aWFsIERldmVsb3Blci4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogQ29udHJpYnV0b3Iocyk6CiAqICAgQmVzcGluIFRlYW0gKGJlc3BpbkBtb3ppbGxhLmNvbSkKICoKICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi8KCi8vID0gSFRNTCBTeW50YXggSGlnaGxpZ2h0aW5nIEltcGxlbWVudGF0aW9uID0KLy8KLy8gTW9kdWxlIGZvciBzeW50YXggaGlnaGxpZ2h0aW5nIEhUTUwuCgppZiAodHlwZW9mIEJlc3BpbiA9PSAidW5kZWZpbmVkIikgQmVzcGluID0ge307CmlmICghQmVzcGluLlN5bnRheCkgQmVzcGluLlN5bnRheCA9IHt9OwoKLy8gKioge3t7IEJlc3Bpbi5TeW50YXguSFRNTFN5bnRheEVuZ2luZSB9fX0gKioKLy8KLy8gVHJhY2tzIHN5bnRheCBoaWdobGlnaHRpbmcgZGF0YSBvbiBhIHBlci1saW5lIGJhc2lzLiBUaGlzIGlzIGEgcXVpY2stYW5kLWRpcnR5IGltcGxlbWVudGF0aW9uIHRoYXQKLy8gc3VwcG9ydHMga2V5d29yZHMgYW5kIHRoZSBsaWtlLCBidXQgZG9lc24ndCBhY3R1YWxseSB1bmRlcnN0YW5kIEhUTUwgYXMgaXQgc2hvdWxkLgoKQmVzcGluLlN5bnRheC5IVE1MQ29uc3RhbnRzID0gewogICAgSFRNTF9TVFlMRV9DT01NRU5UOiAiY29tbWVudCIsCiAgICBTVFJJTkc6ICJzdHJpbmciLAogICAgS0VZV09SRDogImtleXdvcmQiLAogICAgUFVOQ1RVQVRJT046ICJwdW5jdHVhdGlvbiIsCiAgICBPVEhFUjogInBsYWluIgp9CgpCZXNwaW4uU3ludGF4LkhUTUxTeW50YXhFbmdpbmUgPSBDbGFzcy5jcmVhdGUoewogICAga2V5d29yZFJlZ2V4OiAiLyooaHRtbHxoZWFkfGJvZHl8ZG9jdHlwZXxsaW5rfHNjcmlwdHxkaXZ8c3BhbnxpbWd8aDF8aDJ8aDN8aDR8aDV8aDZ8dWx8bGl8b2x8YmxvY2txdW90ZSkiLAoKICAgIHB1bmN0dWF0aW9uOiAnPCA+ID0gIiBcJycsCgogICAgaGlnaGxpZ2h0OiBmdW5jdGlvbihsaW5lLCBtZXRhKSB7CiAgICAgICAgaWYgKCFtZXRhKSBtZXRhID0ge307CiAgICAgICAgCiAgICAgICAgdmFyIEsgPSBCZXNwaW4uU3ludGF4LkhUTUxDb25zdGFudHM7ICAgIC8vIGFsaWFzaW5nIHRoZSBjb25zdGFudHMgZm9yIHNob3J0ZXIgcmVmZXJlbmNlIDstKQoKICAgICAgICB2YXIgcmVnaW9ucyA9IHt9OyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjb250YWlucyB0aGUgaW5kaXZpZHVhbCBzdHlsZSB0eXBlcyBhcyBrZXlzLCB3aXRoIGFycmF5IG9mIHN0YXJ0L3N0b3AgcG9zaXRpb25zIGFzIHZhbHVlCgogICAgICAgIC8vIGN1cnJlbnQgc3RhdGUsIG1haW50YWluZWQgYXMgd2UgcGFyc2UgdGhyb3VnaCBlYWNoIGNoYXJhY3RlciBpbiB0aGUgbGluZTsgdmFsdWVzIGF0IGFueSB0aW1lIHNob3VsZCBiZSBjb25zaXN0ZW50CiAgICAgICAgdmFyIGN1cnJlbnRTdHlsZSA9IChtZXRhLmluTXVsdGlsaW5lQ29tbWVudCkgPyBLLkhUTUxfU1RZTEVfQ09NTUVOVCA6IHVuZGVmaW5lZDsKICAgICAgICB2YXIgY3VycmVudFJlZ2lvbiA9IHt9OyAvLyBzaG91bGQgYWx3YXlzIGhhdmUgYSBzdGFydCBwcm9wZXJ0eSBmb3IgYSBub24tYmxhbmsgYnVmZmVyCiAgICAgICAgdmFyIGJ1ZmZlciA9ICIiOwoKICAgICAgICAvLyB0aGVzZSBwcm9wZXJ0aWVzIGFyZSByZWxhdGVkIHRvIHRoZSBwYXJzZXIgc3RhdGUgYWJvdmUgYnV0IGFyZSBzcGVjaWFsIGNhc2VzCiAgICAgICAgdmFyIHN0cmluZ0NoYXIgPSAiIjsgICAgLy8gdGhlIGNoYXJhY3RlciB1c2VkIHRvIHN0YXJ0IHRoZSBjdXJyZW50IHN0cmluZwogICAgICAgIHZhciBtdWx0aWxpbmUgPSBtZXRhLmluTXVsdGlsaW5lQ29tbWVudDsgIC8vIHRoaXMgbGluZSBjb250YWlucyBhbiB1bnRlcm1pbmF0ZWQgbXVsdGktbGluZSBjb21tZW50CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGluZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgYyA9IGxpbmUuY2hhckF0KGkpOwoKICAgICAgICAgICAgLy8gY2hlY2sgaWYgd2UncmUgaW4gYSBjb21tZW50IGFuZCB3aGV0aGVyIHRoaXMgY2hhcmFjdGVyIGVuZHMgdGhlIGNvbW1lbnQKICAgICAgICAgICAgaWYgKGN1cnJlbnRTdHlsZSA9PSBLLkhUTUxfU1RZTEVfQ09NTUVOVCkgewogICAgICAgICAgICAgICAgaWYgKGMgPT0gIj4iICYmIGJ1ZmZlci5lbmRzV2l0aCgiLS0iKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAhICgoYnVmZmVyLmVuZHNXaXRoKCI8IS0tIikpICYmICFtZXRhLmluTXVsdGlMaW5lQ29tbWVudCAmJiBjdXJyZW50UmVnaW9uLnN0YXJ0ID09IGkgLSA0KSAmJgogICAgICAgICAgICAgICAgICAgICAgICAhICgoYnVmZmVyLmVuZHNXaXRoKCI8IS0tLSIpKSAmJiAhbWV0YS5pbk11bHRpTGluZUNvbW1lbnQgJiYgY3VycmVudFJlZ2lvbi5zdGFydCA9PSBpIC0gNSkgICAvLyBJJ20gcmVhbGx5IHRpcmVkCiAgICAgICAgICAgICAgICAgICAgICAgICkgeyAvLyBoYXMgdGhlIG11bHRpbGluZSBjb21tZW50IGp1c3QgZW5kZWQ/CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFJlZ2lvbi5zdG9wID0gaSArIDE7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRSZWdpb24ocmVnaW9ucywgY3VycmVudFN0eWxlLCBjdXJyZW50UmVnaW9uKTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmVnaW9uID0ge307CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFN0eWxlID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIG11bHRpbGluZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9ICIiOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYnVmZmVyID09ICIiKSBjdXJyZW50UmVnaW9uID0geyBzdGFydDogaSB9OwogICAgICAgICAgICAgICAgICAgIGJ1ZmZlciArPSBjOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5pc1doaXRlU3BhY2VPclB1bmN0dWF0aW9uKGMpKSB7CiAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiB3ZSdyZSBpbiBhIHN0cmluZwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRTdHlsZSA9PSBLLlNUUklORykgewogICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoaXMgaXMgbm90IGFuIHVuZXNjYXBlZCBlbmQgcXVvdGUgKGVpdGhlciBhIHNpbmdsZSBxdW90ZSBvciBkb3VibGUgcXVvdGUgdG8gbWF0Y2ggaG93IHRoZSBzdHJpbmcgc3RhcnRlZCkgdGhlbiBrZWVwIGdvaW5nCiAgICAgICAgICAgICAgICAgICAgaWYgKCAhIChjID09IHN0cmluZ0NoYXIgJiYgIWJ1ZmZlci5lbmRzV2l0aCgiXFwiKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ1ZmZlciA9PSAiIikgY3VycmVudFJlZ2lvbiA9IHsgc3RhcnQ6IGkgfTsKICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyICs9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBpZiB0aGUgYnVmZmVyIGlzIGZ1bGwsIGFkZCBpdCB0byB0aGUgcmVnaW9ucwogICAgICAgICAgICAgICAgaWYgKGJ1ZmZlciAhPSAiIikgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRSZWdpb24uc3RvcCA9IGk7CgogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50U3R5bGUgIT0gSy5TVFJJTkcpIHsgICAvLyBpZiB0aGlzIGlzIGEgc3RyaW5nLCB3ZSdyZSBhbGwgc2V0IHRvIGFkZCBpdDsgaWYgbm90LCBmaWd1cmUgb3V0IGlmIGl0cyBhIGtleXdvcmQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ1ZmZlci5tYXRjaCh0aGlzLmtleXdvcmRSZWdleCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBidWZmZXIgY29udGFpbnMgYSBrZXl3b3JkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3R5bGUgPSBLLktFWVdPUkQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3R5bGUgPSBLLk9USEVSOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkUmVnaW9uKHJlZ2lvbnMsIGN1cnJlbnRTdHlsZSwgY3VycmVudFJlZ2lvbik7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFJlZ2lvbiA9IHt9OwogICAgICAgICAgICAgICAgICAgIHN0cmluZ0NoYXIgPSAiIjsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSAiIjsKICAgICAgICAgICAgICAgICAgICAvLyBpIGRvbid0IGNsZWFyIHRoZSBjdXJyZW50IHN0eWxlIGhlcmUgc28gSSBjYW4gY2hlY2sgaWYgaXQgd2FzIGEgc3RyaW5nIGJlbG93CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNQdW5jdHVhdGlvbihjKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjID09ICI8IiAmJiAobGluZS5sZW5ndGggPiBpICsgMykgJiYgKGxpbmUuc3Vic3RyaW5nKGksIGkgKyA0KSA9PSAiPCEtLSIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBpbiBhIG11bHRpbGluZSBjb21tZW50CiAgICAgICAgICAgICAgICAgICAgICAgIG11bHRpbGluZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTdHlsZSA9IEsuSFRNTF9TVFlMRV9DT01NRU5UOwogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmVnaW9uID0geyBzdGFydDogaSB9OwogICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSAiPCEtLSI7CiAgICAgICAgICAgICAgICAgICAgICAgIGkgKz0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBhZGQgYW4gYWQtaG9jIHJlZ2lvbiBmb3IganVzdCB0aGlzIG9uZSBwdW5jdHVhdGlvbiBjaGFyYWN0ZXIKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZFJlZ2lvbihyZWdpb25zLCBLLlBVTkNUVUFUSU9OLCB7IHN0YXJ0OiBpLCBzdG9wOiBpICsgMSB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBmaW5kIG91dCBpZiB0aGUgY3VycmVudCBxdW90ZSBpcyB0aGUgZW5kIG9yIHRoZSBiZWdpbm5pbmcgb2YgdGhlIHN0cmluZwogICAgICAgICAgICAgICAgaWYgKChjID09ICInIiB8fCBjID09ICciJykgJiYgKGN1cnJlbnRTdHlsZSAhPSBLLlNUUklORykpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3R5bGUgPSBLLlNUUklORzsKICAgICAgICAgICAgICAgICAgICBzdHJpbmdDaGFyID0gYzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFN0eWxlID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYnVmZmVyID09ICIiKSBjdXJyZW50UmVnaW9uID0geyBzdGFydDogaSB9OwogICAgICAgICAgICBidWZmZXIgKz0gYzsKICAgICAgICB9CgogICAgICAgIC8vIGNoZWNrIGZvciBhIHRyYWlsaW5nIGNoYXJhY3RlciBpbnNpZGUgb2YgYSBzdHJpbmcgb3IgYSBjb21tZW50CiAgICAgICAgaWYgKGJ1ZmZlciAhPSAiIikgewogICAgICAgICAgICBpZiAoIWN1cnJlbnRTdHlsZSkgY3VycmVudFN0eWxlID0gSy5PVEhFUjsKICAgICAgICAgICAgY3VycmVudFJlZ2lvbi5zdG9wID0gbGluZS5sZW5ndGg7CiAgICAgICAgICAgIHRoaXMuYWRkUmVnaW9uKHJlZ2lvbnMsIGN1cnJlbnRTdHlsZSwgY3VycmVudFJlZ2lvbik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4geyByZWdpb25zOiByZWdpb25zLCBtZXRhOiB7IGluTXVsdGlsaW5lQ29tbWVudDogbXVsdGlsaW5lIH0gfTsKICAgIH0sCgogICAgYWRkUmVnaW9uOiBmdW5jdGlvbihyZWdpb25zLCB0eXBlLCBkYXRhKSB7CiAgICAgICAgaWYgKCFyZWdpb25zW3R5cGVdKSByZWdpb25zW3R5cGVdID0gW107CiAgICAgICAgcmVnaW9uc1t0eXBlXS5wdXNoKGRhdGEpOwogICAgfSwKCiAgICBpc1doaXRlU3BhY2VPclB1bmN0dWF0aW9uOiBmdW5jdGlvbihjaCkgewogICAgICAgIHJldHVybiB0aGlzLmlzUHVuY3R1YXRpb24oY2gpIHx8IHRoaXMuaXNXaGl0ZVNwYWNlKGNoKTsKICAgIH0sCgogICAgaXNQdW5jdHVhdGlvbjogZnVuY3Rpb24oY2gpIHsKICAgICAgICByZXR1cm4gdGhpcy5wdW5jdHVhdGlvbi5pbmRleE9mKGNoKSAhPSAtMTsKICAgIH0sCgogICAgaXNXaGl0ZVNwYWNlOiBmdW5jdGlvbihjaCkgewogICAgICAgIHJldHVybiBjaCA9PSAiICI7CiAgICB9Cn0pOwoKLy8gUmVnaXN0ZXIKQmVzcGluLlN5bnRheC5FbmdpbmVSZXNvbHZlci5yZWdpc3RlcihuZXcgQmVzcGluLlN5bnRheC5IVE1MU3ludGF4RW5naW5lKCksIFsnaHRtbCcsICdodG0nLCAneG1sJywgJ3hodG1sJ10pOy8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKioKICogVmVyc2lvbjogTVBMIDEuMQogKgogKiBUaGUgY29udGVudHMgb2YgdGhpcyBmaWxlIGFyZSBzdWJqZWN0IHRvIHRoZSBNb3ppbGxhIFB1YmxpYyBMaWNlbnNlCiAqIFZlcnNpb24gMS4xICh0aGUgIkxpY2Vuc2UiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4KICogY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICogaHR0cDovL3d3dy5tb3ppbGxhLm9yZy9NUEwvCiAqCiAqIFNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIKICogYmFzaXMsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyByaWdodHMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBUaGUgT3JpZ2luYWwgQ29kZSBpcyBCZXNwaW4uCiAqCiAqIFRoZSBJbml0aWFsIERldmVsb3BlciBvZiB0aGUgT3JpZ2luYWwgQ29kZSBpcyBNb3ppbGxhLgogKiBQb3J0aW9ucyBjcmVhdGVkIGJ5IHRoZSBJbml0aWFsIERldmVsb3BlciBhcmUgQ29weXJpZ2h0IChDKSAyMDA5CiAqIHRoZSBJbml0aWFsIERldmVsb3Blci4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogQ29udHJpYnV0b3Iocyk6CiAqICAgQmVzcGluIFRlYW0gKGJlc3BpbkBtb3ppbGxhLmNvbSkKICoKICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi8KICAgIAovLyA9IENvbW1hbmQgTGluZSA9Ci8vCi8vIFRoaXMgY29tbWFuZCBsaW5lIG1vZHVsZSBwcm92aWRlcyBldmVyeXRoaW5nIHRoYXQgdGhlIGNvbW1hbmQgbGluZSBpbnRlcmZhY2UgbmVlZHM6Ci8vCi8vICoge3t7QmVzcGluLkNvbW1hbmRMaW5lLkludGVyZmFjZX19fSA6IFRoZSBiYXNlIGNsYXNzIGl0c2VsZi4gVGhlIGFjdHVhbGx5IGludGVyZmFjZS4KLy8gKiB7e3tCZXNwaW4uQ29tbWFuZExpbmUuS2V5QmluZGluZ3N9fX0gOiBIYW5kbGluZyB0aGUgc3BlY2lhbCBrZXkgaGFuZGxpbmcgaW4gdGhlIGNvbW1hbmQgbGluZQovLyAqIHt7e0Jlc3Bpbi5Db21tYW5kTGluZS5IaXN0b3J5fX19IDogSGFuZGxlIGNvbW1hbmQgbGluZSBoaXN0b3J5Ci8vICoge3t7QmVzcGluLkNvbW1hbmRMaW5lLlNpbXBsZUhpc3RvcnlTdG9yZX19fSA6IFNpbXBsZSBvbmUgc2Vzc2lvbiBzdG9yYWdlIG9mIGhpc3RvcnkKLy8gKiB7e3tCZXNwaW4uQ29tbWFuZExpbmUuRXZlbnRzfX19IDogVGhlIGN1c3RvbSBldmVudHMgdGhhdCB0aGUgY29tbWFuZCBsaW5lIG5lZWRzIHRvIGhhbmRsZQoKaWYgKHR5cGVvZiBCZXNwaW4gPT0gInVuZGVmaW5lZCIpIEJlc3BpbiA9IHt9OwppZiAoIUJlc3Bpbi5Db21tYW5kTGluZSkgQmVzcGluLkNvbW1hbmRMaW5lID0ge307CgoKLy8gKioge3t7IEJlc3Bpbi5Db21tYW5kTGluZS5JbnRlcmZhY2UgfX19ICoqCi8vCi8vIFRoZSBjb3JlIGNvbW1hbmQgbGluZSBkcml2ZXIuIEl0IGV4ZWN1dGVzIGNvbW1hbmRzLCBzdG9yZXMgdGhlbSwgYW5kIGhhbmRsZXMgY29tcGxldGlvbgoKQmVzcGluLkNvbW1hbmRMaW5lLkludGVyZmFjZSA9IENsYXNzLmNyZWF0ZSh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihjb21tYW5kTGluZSwgaW5pdENvbW1hbmRzKSB7CiAgICAgICAgdGhpcy5jb21tYW5kTGluZSA9IGNvbW1hbmRMaW5lOwoKICAgICAgICBpZiAod2luZG93WydfZmlsZXMnXSkgdGhpcy5maWxlcyA9IF9maWxlczsgICAgICAgIAogICAgICAgIGlmICh3aW5kb3dbJ19zZXR0aW5ncyddKSB0aGlzLnNldHRpbmdzID0gX3NldHRpbmdzOwogICAgICAgIGlmICh3aW5kb3dbJ19lZGl0b3InXSkgdGhpcy5lZGl0b3IgPSBfZWRpdG9yOwoKICAgICAgICB0aGlzLmluQ29tbWFuZExpbmUgPSBmYWxzZTsKICAgICAgICB0aGlzLmNvbW1hbmRzID0ge307CiAgICAgICAgdGhpcy5hbGlhc2VzID0ge307CgogICAgICAgIHRoaXMuY29tbWFuZExpbmVLZXlCaW5kaW5ncyA9IG5ldyBCZXNwaW4uQ29tbWFuZExpbmUuS2V5QmluZGluZ3ModGhpcyk7CiAgICAgICAgdGhpcy5jb21tYW5kTGluZUhpc3RvcnkgPSBuZXcgQmVzcGluLkNvbW1hbmRMaW5lLkhpc3RvcnkodGhpcyk7CiAgICAgICAgdGhpcy5jdXN0b21FdmVudHMgPSBuZXcgQmVzcGluLkNvbW1hbmRMaW5lLkV2ZW50cyh0aGlzKTsKCiAgICAgICAgaWYgKGluaXRDb21tYW5kcykgdGhpcy5hZGRDb21tYW5kcyhpbml0Q29tbWFuZHMpOyAvLyBpbml0aWFsaXplIHRoZSBjb21tYW5kcyBmb3IgdGhlIGNsaQogICAgfSwKCiAgICBleGVjdXRlQ29tbWFuZDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgZGF0YSA9IHZhbHVlLnNwbGl0KC9ccysvKTsKICAgICAgICB2YXIgY29tbWFuZG5hbWUgPSBkYXRhLnNoaWZ0KCk7CgogICAgICAgIHZhciBjb21tYW5kOwoKICAgICAgICBpZiAodGhpcy5jb21tYW5kc1tjb21tYW5kbmFtZV0pIHsKICAgICAgICAgICAgY29tbWFuZCA9IHRoaXMuY29tbWFuZHNbY29tbWFuZG5hbWVdOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5hbGlhc2VzW2NvbW1hbmRuYW1lXSkgewogICAgICAgICAgICBjb21tYW5kID0gdGhpcy5jb21tYW5kc1t0aGlzLmFsaWFzZXNbY29tbWFuZG5hbWVdXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnNob3dJbmZvKCJTb3JyeSwgbm8gY29tbWFuZCAnIiArIGNvbW1hbmRuYW1lICsgIicuIE1heWJlIHRyeSB0byBydW4gJnJhcXVvOyBoZWxwIiwgdHJ1ZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGRvY3VtZW50LmZpcmUoImJlc3BpbjpjbWRsaW5lOmV4ZWN1dGVkIiwgeyBjb21tYW5kOiBjb21tYW5kLCBhcmdzOiBkYXRhIH0pOwoKICAgICAgICBjb21tYW5kLmV4ZWN1dGUodGhpcywgdGhpcy5nZXRBcmdzKGRhdGEsIGNvbW1hbmQpKTsKICAgICAgICB0aGlzLmNvbW1hbmRMaW5lLnZhbHVlID0gJyc7IC8vIGNsZWFyIGFmdGVyIHRoZSBjb21tYW5kCiAgICB9LAoKICAgIGFkZENvbW1hbmQ6IGZ1bmN0aW9uKGNvbW1hbmQpIHsKICAgICAgICAvLyAtLSBBbGxvdyBmb3IgdGhlIGRlZmF1bHQgWyBdIHRha2VzIHN0eWxlIGJ5IGV4cGFuZGluZyBpdCB0byBzb21ldGhpbmcgYmlnZ2VyCiAgICAgICAgaWYgKGNvbW1hbmQudGFrZXMgJiYKICAgICAgICAgICAgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGNvbW1hbmQudGFrZXMpID09PSAnW29iamVjdCBBcnJheV0nKSB7CiAgICAgICAgICAgIGNvbW1hbmQgPSB0aGlzLm5vcm1hbGl6ZVRha2VzKGNvbW1hbmQpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyAtLSBBZGQgYmluZGluZ3MKICAgICAgICBpZiAoY29tbWFuZC53aXRoS2V5KSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gQmVzcGluLktleS5maWxsQXJndW1lbnRzKGNvbW1hbmQud2l0aEtleSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBhcmdzLmFjdGlvbiA9ICJiZXNwaW46Y21kbGluZTpleGVjdXRlO25hbWU9IiArIGNvbW1hbmQubmFtZTsKCiAgICAgICAgICAgIGRvY3VtZW50LmZpcmUoImJlc3BpbjplZGl0b3I6YmluZGtleSIsIGFyZ3MpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb21tYW5kc1tjb21tYW5kLm5hbWVdID0gY29tbWFuZDsKCiAgICAgICAgaWYgKGNvbW1hbmRbJ2FsaWFzZXMnXSkgewogICAgICAgICAgICBjb21tYW5kWydhbGlhc2VzJ10uZWFjaChmdW5jdGlvbihhbGlhcykgewogICAgICAgICAgICAgICAgdGhpcy5hbGlhc2VzW2FsaWFzXSA9IGNvbW1hbmQubmFtZTsKICAgICAgICAgICAgfS5iaW5kKHRoaXMpKTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICBhZGRDb21tYW5kczogZnVuY3Rpb24oY29tbWFuZHMpIHsKICAgICAgICBjb21tYW5kcy5lYWNoKGZ1bmN0aW9uKGNvbW1hbmQpIHsKICAgICAgICAgICAgaWYgKE9iamVjdC5pc1N0cmluZyhjb21tYW5kKSkgY29tbWFuZCA9IEJlc3Bpbi5Db21tYW5kcy5nZXQoY29tbWFuZCk7CiAgICAgICAgICAgIHRoaXMuYWRkQ29tbWFuZChjb21tYW5kKTsgICAgICAgICAgICAgICAgCiAgICAgICAgfS5iaW5kKHRoaXMpKTsKICAgIH0sCiAgICAKICAgIGhhc0NvbW1hbmQ6IGZ1bmN0aW9uKGNvbW1hbmRuYW1lKSB7CiAgICAgICAgaWYgKHRoaXMuY29tbWFuZHNbY29tbWFuZG5hbWVdKSB7IC8vIHl1cCwgdGhlcmUgc2hlIGJsb3dzLiBzaG9ydGN1dAogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGZvciAoY29tbWFuZCBpbiB0aGlzLmNvbW1hbmRzKSB7IC8vIHRyeSB0aGUgYWxpYXNlcwogICAgICAgICAgICBpZiAodGhpcy5jb21tYW5kc1tjb21tYW5kXVsnYWxpYXNlcyddKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbW1hbmRzW2NvbW1hbmRdWydhbGlhc2VzJ10uZWFjaChmdW5jdGlvbihhbGlhcykgewogICAgICAgICAgICAgICAgICAgIGlmIChhbGlhcyA9PSBjb21tYW5kbmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICBzaG93SW5mbzogZnVuY3Rpb24oaHRtbCwgYXV0b2hpZGUpIHsKICAgICAgICB0aGlzLmhpZGVJbmZvKCk7CgogICAgICAgICQoJ2luZm8nKS5pbm5lckhUTUwgPSBodG1sOwogICAgICAgICQoJ2luZm8nKS5zaG93KCk7CiAgICAgICAgJCgnaW5mbycpLm9uY2xpY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5oaWRlSW5mbygpOwogICAgICAgIH0uYmluZCh0aGlzKTsKCiAgICAgICAgaWYgKGF1dG9oaWRlKSB7CiAgICAgICAgICAgIHRoaXMuaW5mb1RpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhpcy5oaWRlSW5mbygpOwogICAgICAgICAgICB9LmJpbmQodGhpcyksIDQ2MDApOwogICAgICAgIH0KICAgIH0sCgogICAgaGlkZUluZm86IGZ1bmN0aW9uKCkgewogICAgICAgICQoJ2luZm8nKS5oaWRlKCk7CiAgICAgICAgaWYgKHRoaXMuaW5mb1RpbWVvdXQpIGNsZWFyVGltZW91dCh0aGlzLmluZm9UaW1lb3V0KTsKICAgIH0sCgogICAgZmluZENvbXBsZXRpb25zOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHZhciBtYXRjaGVzID0gW107CgogICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGZvciAoY29tbWFuZCBpbiB0aGlzLmNvbW1hbmRzKSB7CiAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5pbmRleE9mKHZhbHVlKSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgIG1hdGNoZXMucHVzaChjb21tYW5kKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jb21tYW5kc1tjb21tYW5kXVsnYWxpYXNlcyddKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21tYW5kc1tjb21tYW5kXVsnYWxpYXNlcyddLmVhY2goZnVuY3Rpb24oYWxpYXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFsaWFzLmluZGV4T2YodmFsdWUpID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVzLnB1c2goYWxpYXMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBtYXRjaGVzOwogICAgfSwKCiAgICBjb21wbGV0ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgbWF0Y2hlcyA9IHRoaXMuZmluZENvbXBsZXRpb25zKHZhbHVlKTsKICAgICAgICBpZiAobWF0Y2hlcy5sZW5ndGggPT0gMSkgewogICAgICAgICAgICB2YXIgY29tbWFuZCA9IHRoaXMuY29tbWFuZHNbbWF0Y2hlc1swXV0gfHwgdGhpcy5jb21tYW5kc1t0aGlzLmFsaWFzZXNbbWF0Y2hlc1swXV1dOwoKICAgICAgICAgICAgdmFyIGNvbW1hbmRMaW5lVmFsdWUgPSBtYXRjaGVzWzBdOwoKICAgICAgICAgICAgaWYgKHRoaXMuY29tbWFuZFRha2VzQXJncyhjb21tYW5kKSkgewogICAgICAgICAgICAgICAgY29tbWFuZExpbmVWYWx1ZSArPSAnICc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jb21tYW5kTGluZS52YWx1ZSA9IGNvbW1hbmRMaW5lVmFsdWU7CgogICAgICAgICAgICBpZiAoY29tbWFuZFsnY29tcGxldGVUZXh0J10pIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd0luZm8oY29tbWFuZFsnY29tcGxldGVUZXh0J10pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY29tbWFuZFsnY29tcGxldGUnXSkgewogICAgICAgICAgICAgICAgdGhpcy5zaG93SW5mbyhjb21tYW5kLmNvbXBsZXRlKHRoaXMsIHZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIGNvbW1hbmRUYWtlc0FyZ3M6IGZ1bmN0aW9uKGNvbW1hbmQpIHsKICAgICAgICByZXR1cm4gY29tbWFuZC50YWtlcyAhPSB1bmRlZmluZWQ7CiAgICB9LAoKICAgIC8vICoqIHt7eyBnZXRBcmdzIH19fSAqKgogICAgLy8KICAgIC8vIENhbGN1bGF0ZSB0aGUgYXJncyBvYmplY3QgdG8gYmUgcGFzc2VkIGludG8gdGhlIGNvbW1hbmQuIAogICAgLy8gSWYgaXQgb25seSB0YWtlcyBvbmUgYXJndW1lbnQganVzdCBzZW5kIGluIHRoYXQgZGF0YSwgYnV0IGlmIGl0IHdhbnRzIG1vcmUsIHNwbGl0IGl0IGFsbCB1cCBmb3IgdGhlIGNvbW1hbmQgYW5kIHNlbmQgaW4gYW4gb2JqZWN0LgoKICAgIGdldEFyZ3M6IGZ1bmN0aW9uKGZyb21Vc2VyLCBjb21tYW5kKSB7CiAgICAgICAgaWYgKCFjb21tYW5kLnRha2VzKSByZXR1cm4gdW5kZWZpbmVkOwoKICAgICAgICB2YXIgYXJnczsKICAgICAgICB2YXIgdXNlclN0cmluZyA9IGZyb21Vc2VyLmpvaW4oJyAnKTsKCiAgICAgICAgaWYgKGNvbW1hbmQudGFrZXMgJiYgY29tbWFuZC50YWtlcy5vcmRlci5sZW5ndGggPCAyKSB7IC8vIE9uZSBhcmd1bWVudCwgc28ganVzdCByZXR1cm4gdGhhdAogICAgICAgICAgICBhcmdzID0gdXNlclN0cmluZzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhcmdzID0gbmV3IEJlc3Bpbi5Ub2tlbk9iamVjdCh1c2VyU3RyaW5nLCB7IHBhcmFtczogY29tbWFuZC50YWtlcy5vcmRlci5qb2luKCcgJykgfSk7CiAgICAgICAgICAgIGFyZ3MucmF3aW5wdXQgPSB1c2VyU3RyaW5nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJnczsKICAgIH0sCgogICAgbm9ybWFsaXplVGFrZXM6IGZ1bmN0aW9uKGNvbW1hbmQpIHsKICAgICAgICAvLyBUT0RPOiBoYW5kbGUgc2hvcnRzIHRoYXQgYXJlIHRoZSBzYW1lISA6KQogICAgICAgIHZhciB0YWtlcyA9IGNvbW1hbmQudGFrZXM7CiAgICAgICAgY29tbWFuZC50YWtlcyA9IHsKICAgICAgICAgICAgb3JkZXI6IHRha2VzCiAgICAgICAgfQoKICAgICAgICB0YWtlcy5lYWNoKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgY29tbWFuZC50YWtlc1tpdGVtXSA9IHsKICAgICAgICAgICAgICAgICJzaG9ydCI6IGl0ZW1bMF0KICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gY29tbWFuZDsKICAgIH0sCiAgICAKICAgIGhhbmRsZUNvbW1hbmRMaW5lRm9jdXM6IGZ1bmN0aW9uKGUpIHsKICAgICAgICBpZiAodGhpcy5pbkNvbW1hbmRMaW5lKSByZXR1cm4gdHJ1ZTsgLy8gaW4gdGhlIGNvbW1hbmQgbGluZSEKCiAgICAgICAgaWYgKGUua2V5Q29kZSA9PSBCZXNwaW4uS2V5LkogJiYgZS5jdHJsS2V5KSB7IC8vIHNlbmQgdG8gY29tbWFuZCBsaW5lCiAgICAgICAgICAgIHRoaXMuY29tbWFuZExpbmUuZm9jdXMoKTsKCiAgICAgICAgICAgIEV2ZW50LnN0b3AoZSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgIH0KCn0pOwoKLy8gKioge3t7IEJlc3Bpbi5Db21tYW5kTGluZS5LZXlCaW5kaW5ncyB9fX0gKioKLy8KLy8gSGFuZGxlIGtleSBiaW5kaW5ncyBmb3IgdGhlIGNvbW1hbmQgbGluZQoKQmVzcGluLkNvbW1hbmRMaW5lLktleUJpbmRpbmdzID0gQ2xhc3MuY3JlYXRlKHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGNsKSB7ICAgICAgICAKICAgICAgICAvLyAtLSBUaWUgdG8gdGhlIGNvbW1hbmRMaW5lIGVsZW1lbnQgaXRzZWxmCiAgICAgICAgY2wuY29tbWFuZExpbmUub25mb2N1cyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAod2luZG93WydfZWRpdG9yJ10pIF9lZGl0b3Iuc2V0Rm9jdXMoZmFsc2UpOwogICAgICAgICAgICB0aGlzLmluQ29tbWFuZExpbmUgPSB0cnVlOwogICAgICAgICAgICAkKCdwcm9tcHRpbWcnKS5zcmMgPSAnaW1hZ2VzL2ljbl9jb21tYW5kX29uLnBuZyc7CiAgICAgICAgfS5iaW5kKGNsKTsKCiAgICAgICAgY2wuY29tbWFuZExpbmUub25ibHVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaW5Db21tYW5kTGluZSA9IGZhbHNlOwogICAgICAgICAgICAkKCdwcm9tcHRpbWcnKS5zcmMgPSAnaW1hZ2VzL2ljbl9jb21tYW5kLnBuZyc7CiAgICAgICAgfS5iaW5kKGNsKTsKCiAgICAgICAgY2wuY29tbWFuZExpbmUub25rZXl1cCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICB2YXIgS2V5ID0gQmVzcGluLktleTsKICAgICAgICAgICAgCiAgICAgICAgICAgaWYgKGUua2V5Q29kZSA+PSBLZXkuQSAmJiBlLmtleUNvZGUgPCBLZXkuWikgeyAvLyBvbmx5IHJlYWwgbGV0dGVycwogICAgICAgICAgICAgICAgdmFyIGNvbXBsZXRpb25zID0gdGhpcy5maW5kQ29tcGxldGlvbnMoJCgnY29tbWFuZCcpLnZhbHVlKTsKICAgICAgICAgICAgICAgIHZhciBjb21tYW5kU3RyaW5nID0gY29tcGxldGlvbnNbMF07CiAgICAgICAgICAgICAgICBpZiAoY29tcGxldGlvbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpc0F1dG9Db21wbGV0ZSA9IF9zZXR0aW5ncy5pc09uKF9zZXR0aW5ncy5nZXQoJ2F1dG9jb21wbGV0ZScpKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNBdXRvQ29tcGxldGUgJiYgY29tcGxldGlvbnMubGVuZ3RoID09IDEpIHsgLy8gaWYgb25seSBvbmUganVzdCBzZXQgdGhlIHZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb21tYW5kID0gdGhpcy5jb21tYW5kc1tjb21tYW5kU3RyaW5nXSB8fCB0aGlzLmNvbW1hbmRzW3RoaXMuYWxpYXNlc1tjb21tYW5kU3RyaW5nXV07CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3BhY2luZyA9ICh0aGlzLmNvbW1hbmRUYWtlc0FyZ3MoY29tbWFuZCkpID8gJyAnIDogJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICQoJ2NvbW1hbmQnKS52YWx1ZSA9IGNvbW1hbmRTdHJpbmcgKyBzcGFjaW5nOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbW1hbmRbJ2NvbXBsZXRlVGV4dCddKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dJbmZvKGNvbW1hbmRbJ2NvbXBsZXRlVGV4dCddKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUluZm8oKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29tcGxldGlvbnMubGVuZ3RoID09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBsZXRpb25zWzBdICE9ICQoJ2NvbW1hbmQnKS52YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93SW5mbyhjb21wbGV0aW9ucy5qb2luKCcsICcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb21tYW5kID0gdGhpcy5jb21tYW5kc1tjb21wbGV0aW9uc1swXV0gfHwgdGhpcy5jb21tYW5kc1t0aGlzLmFsaWFzZXNbY29tcGxldGlvbnNbMF1dXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jb21tYW5kVGFrZXNBcmdzKGNvbW1hbmQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wbGV0ZSgkKCdjb21tYW5kJykudmFsdWUpOyAvLyBtYWtlIGl0IGNvbXBsZXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUluZm8oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0luZm8oY29tcGxldGlvbnMuam9pbignLCAnKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfS5iaW5kKGNsKTsKCiAgICAgICAgY2wuY29tbWFuZExpbmUub25rZXlkb3duID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgS2V5ID0gQmVzcGluLktleTsgLy8gYWxpYXMKICAgICAgICAgICAgaWYgKGUua2V5Q29kZSA9PSBLZXkuSiAmJiBlLmN0cmxLZXkpIHsgLy8gc2VuZCBiYWNrCiAgICAgICAgICAgICAgICBFdmVudC5zdG9wKGUpOwoKICAgICAgICAgICAgICAgICQoJ2NvbW1hbmQnKS5ibHVyKCk7CiAgICAgICAgICAgICAgICBpZiAod2luZG93WydfZWRpdG9yJ10pIF9lZGl0b3Iuc2V0Rm9jdXModHJ1ZSk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgaWYgKChlLmtleUNvZGUgPT0gS2V5Lk4gJiYgZS5jdHJsS2V5KSB8fCBlLmtleUNvZGUgPT0gS2V5LkFSUk9XX0RPV04pIHsKICAgICAgICAgICAgICAgIHRoaXMuY29tbWFuZExpbmVIaXN0b3J5LnNldE5leHQoKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIGlmICgoZS5rZXlDb2RlID09IEtleS5QICYmIGUuY3RybEtleSkgfHwgZS5rZXlDb2RlID09IEtleS5BUlJPV19VUCkgewogICAgICAgICAgICAgICAgdGhpcy5jb21tYW5kTGluZUhpc3Rvcnkuc2V0UHJldmlvdXMoKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlLmtleUNvZGUgPT0gS2V5LkVOVEVSKSB7CiAgICAgICAgICAgICAgICB0aGlzLmV4ZWN1dGVDb21tYW5kKCQoJ2NvbW1hbmQnKS52YWx1ZSk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGUua2V5Q29kZSA9PSBLZXkuVEFCKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbXBsZXRlKCQoJ2NvbW1hbmQnKS52YWx1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZS5rZXlDb2RlID09IEtleS5FU0NBUEUpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZUluZm8oKTsKICAgICAgICAgICAgfQogICAgICAgIH0uYmluZChjbCk7CiAgICB9Cn0pOwoKLy8gKioge3t7IEJlc3Bpbi5Db21tYW5kTGluZS5IaXN0b3J5IH19fSAqKgovLwovLyBTdG9yZSBjb21tYW5kIGxpbmUgaGlzdG9yeSBzbyB5b3UgY2FuIGdvIGJhY2sgYW5kIGZvcnRoCgpCZXNwaW4uQ29tbWFuZExpbmUuSGlzdG9yeSA9IENsYXNzLmNyZWF0ZSh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihjbCkgewogICAgICAgIHRoaXMuY29tbWFuZExpbmUgPSBjbDsKICAgICAgICB0aGlzLmhpc3RvcnkgPSBbXTsKICAgICAgICB0aGlzLnBvaW50ZXIgPSAwOwogICAgICAgIHRoaXMuc3RvcmUgPSBuZXcgQmVzcGluLkNvbW1hbmRMaW5lLlNpbXBsZUhpc3RvcnlTdG9yZSgpOwogICAgICAgIHRoaXMuc2VlZCgpOwogICAgfSwKCiAgICAvLyBUT0RPOiBnZXQgZnJvbSB0aGUgZGF0YWJhc2UKICAgIHNlZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaGlzdG9yeSA9IHRoaXMuc3RvcmUuc2VlZCgpOwogICAgfSwKCiAgICBhZGQ6IGZ1bmN0aW9uKGNvbW1hbmQpIHsKICAgICAgICBjb21tYW5kID0gY29tbWFuZC5zdHJpcCgpOwogICAgICAgIGlmICh0aGlzLmxhc3QoKSAhPSBjb21tYW5kKSB7CiAgICAgICAgICAgIHRoaXMuc3RvcmUuYWRkKGNvbW1hbmQpOwogICAgICAgICAgICB0aGlzLmhpc3RvcnkucHVzaChjb21tYW5kKTsKICAgICAgICAgICAgdGhpcy5wb2ludGVyID0gdGhpcy5oaXN0b3J5Lmxlbmd0aCAtIDE7CiAgICAgICAgfQogICAgfSwKCiAgICBuZXh0OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5wb2ludGVyIDwgdGhpcy5oaXN0b3J5Lmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5oaXN0b3J5W3RoaXMucG9pbnRlcisrXTsKICAgICAgICB9CiAgICB9LAoKICAgIHByZXZpb3VzOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5wb2ludGVyID4gMCkgewogICAgICAgICAgIHJldHVybiB0aGlzLmhpc3RvcnlbdGhpcy5wb2ludGVyLS1dOwogICAgICAgIH0KICAgIH0sCgogICAgbGFzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaGlzdG9yeVt0aGlzLmhpc3RvcnkubGVuZ3RoIC0gMV07CiAgICB9LAoKICAgIGZpcnN0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5oaXN0b3J5WzBdOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKGNvbW1hbmQpIHsKICAgICAgICB0aGlzLmNvbW1hbmRMaW5lLmNvbW1hbmRMaW5lLnZhbHVlID0gY29tbWFuZDsKICAgIH0sCgogICAgc2V0TmV4dDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG5leHQgPSB0aGlzLm5leHQoKTsKICAgICAgICBpZiAobmV4dCkgewogICAgICAgICAgICB0aGlzLnNldChuZXh0KTsKICAgICAgICB9CiAgICB9LAoKICAgIHNldFByZXZpb3VzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgcHJldiA9IHRoaXMucHJldmlvdXMoKTsKICAgICAgICBpZiAocHJldikgewogICAgICAgICAgICB0aGlzLnNldChwcmV2KTsKICAgICAgICB9CiAgICB9Cn0pOwoKLy8gKioge3t7IEJlc3Bpbi5Db21tYW5kTGluZS5TaW1wbGVIaXN0b3J5U3RvcmUgfX19ICoqCi8vCi8vIEEgc2ltcGxlIHN0b3JlIHRoYXQga2VlcHMgdGhlIGNvbW1hbmRzIGluIG1lbW9yeS4KLy8gSW4gdGhlIGZ1dHVyZSB3ZSB3b3VsZCB3YW50IHRvIHN0b3JlIHRoZSBoaXN0b3J5IGNyb3NzIHNlc3Npb24uCgpCZXNwaW4uQ29tbWFuZExpbmUuU2ltcGxlSGlzdG9yeVN0b3JlID0gQ2xhc3MuY3JlYXRlKHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuY29tbWFuZHMgPSBbXTsKICAgIH0sCgogICAgc2VlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5hZGQoJ2xzJyk7CiAgICAgICAgdGhpcy5hZGQoJ2NsZWFyJyk7CiAgICAgICAgdGhpcy5hZGQoJ3N0YXR1cycpOwoKICAgICAgICByZXR1cm4gdGhpcy5jb21tYW5kcy5jbG9uZSgpOwogICAgfSwKCiAgICBhZGQ6IGZ1bmN0aW9uKGNvbW1hbmQpIHsKICAgICAgICB0aGlzLmNvbW1hbmRzLnB1c2goY29tbWFuZCk7CiAgICB9Cn0pOwoKLy8gKioge3t7IEJlc3Bpbi5Db21tYW5kTGluZS5FdmVudHMgfX19ICoqCi8vCi8vIFRoZSBjdXN0b20gZXZlbnRzIHRoYXQgdGhlIGNvbW1hbmRsaW5lIHBhcnRpY2lwYXRlcyBpbgoKQmVzcGluLkNvbW1hbmRMaW5lLkV2ZW50cyA9IENsYXNzLmNyZWF0ZSh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihjb21tYW5kbGluZSkgewogICAgICAgIHRoaXMuY29tbWFuZGxpbmUgPSBjb21tYW5kbGluZTsKCiAgICAgICAgLy8gKioge3t7IEV2ZW50OiBiZXNwaW46Y21kbGluZTpzaG93aW5mbyB9fX0gKioKICAgICAgICAvLyAKICAgICAgICAvLyBPYnNlcnZlIHdoZW4gb3RoZXJzIHdhbnQgdG8gc2hvdyB0aGUgaW5mbyBiYXIgZm9yIHRoZSBjb21tYW5kIGxpbmUKICAgICAgICBkb2N1bWVudC5vYnNlcnZlKCJiZXNwaW46Y21kbGluZTpzaG93aW5mbyIsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBtc2cgPSBldmVudC5tZW1vLm1zZzsKICAgICAgICAgICAgaWYgKG1zZykgY29tbWFuZGxpbmUuc2hvd0luZm8obXNnKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gKioge3t7IEV2ZW50OiBiZXNwaW46Y21kbGluZTpleGVjdXRlZCB9fX0gKioKICAgICAgICAvLyAKICAgICAgICAvLyBPbmNlIHRoZSBjb21tYW5kIGhhcyBiZWVuIGV4ZWN1dGVkLCBkbyBzb21ldGhpbmcuCiAgICAgICAgLy8gSW4gdGhpcyBjYXNlLCBzYXZlIGl0IGZvciB0aGUgaGlzdG9yeQogICAgICAgIGRvY3VtZW50Lm9ic2VydmUoImJlc3BpbjpjbWRsaW5lOmV4ZWN1dGVkIiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIGNvbW1hbmRuYW1lID0gZXZlbnQubWVtby5jb21tYW5kLm5hbWU7CiAgICAgICAgICAgIHZhciBhcmdzICAgICAgICA9IGV2ZW50Lm1lbW8uYXJnczsKCiAgICAgICAgICAgIGNvbW1hbmRsaW5lLmNvbW1hbmRMaW5lSGlzdG9yeS5hZGQoY29tbWFuZG5hbWUgKyAiICIgKyBhcmdzKTsgLy8gb25seSBhZGQgdG8gdGhlIGhpc3Rvcnkgd2hlbiBhIHZhbGlkIGNvbW1hbmQKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICAvLyAqKiB7e3sgRXZlbnQ6IGJlc3BpbjpjbWRsaW5lOmV4ZWN1dGVkIH19fSAqKgogICAgICAgIC8vIAogICAgICAgIC8vIE9uY2UgdGhlIGNvbW1hbmQgaGFzIGJlZW4gZXhlY3V0ZWQsIGRvIHNvbWV0aGluZy4gICAgICAgIAogICAgICAgIGRvY3VtZW50Lm9ic2VydmUoImJlc3BpbjpjbWRsaW5lOmV4ZWN1dGUiLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICB2YXIgY29tbWFuZCA9IGV2ZW50Lm1lbW8ubmFtZTsKICAgICAgICAgICAgdmFyIGFyZ3MgICAgPSBldmVudC5tZW1vLmFyZ3M7CiAgICAgICAgICAgIGlmIChjb21tYW5kICYmIGFyZ3MpIHsgLy8gaWYgd2UgaGF2ZSBhIGNvbW1hbmQgYW5kIHNvbWUgYXJncwogICAgICAgICAgICAgICAgY29tbWFuZCArPSAiICIgKyBhcmdzOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY29tbWFuZCkgY29tbWFuZGxpbmUuZXhlY3V0ZUNvbW1hbmQoY29tbWFuZCk7CiAgICAgICAgfSk7CgoKICAgICAgICAvLyAtLSBGaWxlcwogICAgICAgIC8vICoqIHt7eyBFdmVudDogYmVzcGluOmVkaXRvcjpvcGVuZmlsZTpvcGVuZmFpbCB9fX0gKioKICAgICAgICAvLyAKICAgICAgICAvLyBJZiBhbiBvcGVuIGZpbGUgYWN0aW9uIGZhaWxlZCwgdGVsbCB0aGUgdXNlci4KICAgICAgICBkb2N1bWVudC5vYnNlcnZlKCJiZXNwaW46ZWRpdG9yOm9wZW5maWxlOm9wZW5mYWlsIiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIGZpbGVuYW1lID0gZXZlbnQubWVtby5maWxlbmFtZTsKCiAgICAgICAgICAgIGNvbW1hbmRsaW5lLnNob3dJbmZvKCdDb3VsZCBub3Qgb3BlbiBmaWxlOiAnICsgZmlsZW5hbWUgKyAiPGJyLz48YnIvPjxlbT4obWF5YmUgdHJ5ICZyYXF1bzsgbGlzdCk8L2VtPiIpOwogICAgICAgIH0pOwoKICAgICAgICAvLyAqKiB7e3sgRXZlbnQ6IGJlc3BpbjplZGl0b3I6b3BlbmZpbGU6b3BlbnN1Y2Nlc3MgfX19ICoqCiAgICAgICAgLy8gCiAgICAgICAgLy8gVGhlIG9wZW4gZmlsZSBhY3Rpb24gd29ya2VkLCBzbyB0ZWxsIHRoZSB1c2VyCiAgICAgICAgZG9jdW1lbnQub2JzZXJ2ZSgiYmVzcGluOmVkaXRvcjpvcGVuZmlsZTpvcGVuc3VjY2VzcyIsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBmaWxlID0gZXZlbnQubWVtby5maWxlOwoKICAgICAgICAgICAgY29tbWFuZGxpbmUuc2hvd0luZm8oJ0xvYWRlZCBmaWxlOiAnICsgZmlsZS5uYW1lLCB0cnVlKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gLS0gUHJvamVjdHMKICAgICAgICAvLyAqKiB7e3sgRXZlbnQ6IGJlc3BpbjplZGl0b3I6cHJvamVjdDpzZXQgfX19ICoqCiAgICAgICAgLy8gCiAgICAgICAgLy8gV2hlbiB0aGUgcHJvamVjdCBjaGFuZ2VzLCBhbGVydCB0aGUgdXNlcgogICAgICAgIGRvY3VtZW50Lm9ic2VydmUoImJlc3BpbjplZGl0b3I6cHJvamVjdDpzZXQiLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICB2YXIgcHJvamVjdCA9IGV2ZW50Lm1lbW8ucHJvamVjdDsKCiAgICAgICAgICAgIF9lZGl0U2Vzc2lvbi5wcm9qZWN0ID0gcHJvamVjdDsKICAgICAgICAgICAgY29tbWFuZGxpbmUuc2hvd0luZm8oJ0NoYW5nZWQgcHJvamVjdCB0byAnICsgcHJvamVjdCwgdHJ1ZSk7CiAgICAgICAgfSk7CgogICAgfQp9KTsKLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKgogKiBWZXJzaW9uOiBNUEwgMS4xCiAqCiAqIFRoZSBjb250ZW50cyBvZiB0aGlzIGZpbGUgYXJlIHN1YmplY3QgdG8gdGhlIE1vemlsbGEgUHVibGljIExpY2Vuc2UKICogVmVyc2lvbiAxLjEgKHRoZSAiTGljZW5zZSIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbgogKiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKiBodHRwOi8vd3d3Lm1vemlsbGEub3JnL01QTC8KICoKICogU29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIgogKiBiYXNpcywgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHJpZ2h0cyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIFRoZSBPcmlnaW5hbCBDb2RlIGlzIEJlc3Bpbi4KICoKICogVGhlIEluaXRpYWwgRGV2ZWxvcGVyIG9mIHRoZSBPcmlnaW5hbCBDb2RlIGlzIE1vemlsbGEuCiAqIFBvcnRpb25zIGNyZWF0ZWQgYnkgdGhlIEluaXRpYWwgRGV2ZWxvcGVyIGFyZSBDb3B5cmlnaHQgKEMpIDIwMDkKICogdGhlIEluaXRpYWwgRGV2ZWxvcGVyLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBDb250cmlidXRvcihzKToKICogICBCZXNwaW4gVGVhbSAoYmVzcGluQG1vemlsbGEuY29tKQogKgogKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqLwoKaWYgKHR5cGVvZiBCZXNwaW4gPT0gInVuZGVmaW5lZCIpIEJlc3BpbiA9IHt9OwppZiAoIUJlc3Bpbi5Db21tYW5kcykgQmVzcGluLkNvbW1hbmRzID0ge307CgovLyA9IEJlc3Bpbi5Db21tYW5kcyA9Ci8vCi8vIFRoaXMgYXJyYXkgc3RvcmVzIGFsbCBvZiB0aGUgZGVmYXVsdCBjb21tYW5kcy4KCi8vICoqIHt7e0Jlc3Bpbi5Db21tYW5kcy5TdG9yZX19fSAqKgovLwovLyBUaGUgY29yZSBzdG9yZSB0byBob2xkIGNvbW1hbmRzIHRoYXQgb3RoZXJzIHNoYXJlLgpCZXNwaW4uQ29tbWFuZHMuU3RvcmUgPSB7fTsKCi8vICoqIHt7e0Jlc3Bpbi5Db21tYW5kcy5hZGR9fX0gKioKLy8KLy8gQWRkIHRoZSBjb21tYW5kIHRvIHRoZSBzdG9yZSB3aGljaCBoYXMgYSBuYW1lIC0+IGNvbW1hbmQgaGFzaApCZXNwaW4uQ29tbWFuZHMuYWRkID0gZnVuY3Rpb24oY29tbWFuZCkgewogICAgQmVzcGluLkNvbW1hbmRzLlN0b3JlW2NvbW1hbmQubmFtZV0gPSBjb21tYW5kOwp9CgovLyAqKiB7e3tCZXNwaW4uQ29tbWFuZHMuZ2V0fX19ICoqCi8vCi8vIFJldHVybiBhIGNvbW1hbmQgZnJvbSB0aGUgc3RvcmUKQmVzcGluLkNvbW1hbmRzLmdldCA9IGZ1bmN0aW9uKGNvbW1hbmRuYW1lKSB7CiAgICByZXR1cm4gQmVzcGluLkNvbW1hbmRzLlN0b3JlW2NvbW1hbmRuYW1lXTsKfQoKLy8gPT0gU3RhcnQgYWRkaW5nIGNvbW1hbmRzIHRvIHRoZSBzdG9yZSA9PQovLwoKLy8gKioge3t7Q29tbWFuZDogaGVscH19fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgIG5hbWU6ICdoZWxwJywKICAgIHRha2VzOiBbJ3NlYXJjaCddLAogICAgcHJldmlldzogJ3Nob3cgY29tbWFuZHMnLAogICAgZGVzY3JpcHRpb246ICdUaGUgPHU+aGVscDwvdT4gZ2l2ZXMgeW91IGFjY2VzcyB0byB0aGUgdmFyaW91cyBjb21tYW5kcyBpbiB0aGUgQmVzcGluIHN5c3RlbS48YnIvPjxici8+WW91IGNhbiBuYXJyb3cgdGhlIHNlYXJjaCBvZiBhIGNvbW1hbmQgYnkgYWRkaW5nIGFuIG9wdGlvbmFsIHNlYXJjaCBwYXJhbXMuPGJyLz48YnIvPklmIHlvdSBwYXNzIGluIHRoZSBtYWdpYyA8ZW0+aGlkZGVuPC9lbT4gcGFyYW1ldGVyLCB5b3Ugd2lsbCBmaW5kIHN1YnRsZSBoaWRkZW4gY29tbWFuZHMuPGJyLz48YnIvPkZpbmFsbHksIHBhc3MgaW4gdGhlIGZ1bGwgbmFtZSBvZiBhIGNvbW1hbmQgYW5kIHlvdSBjYW4gZ2V0IHRoZSBmdWxsIGRlc2NyaXB0aW9uLCB3aGljaCB5b3UganVzdCBkaWQgdG8gc2VlIHRoaXMhJywKICAgIGNvbXBsZXRlVGV4dDogJ29wdGlvbmFsbHksIG5hcnJvdyBkb3duIHRoZSBzZWFyY2gnLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZiwgZXh0cmEpIHsKICAgICAgICB2YXIgY29tbWFuZHMgPSBbXTsKICAgICAgICBpZiAoc2VsZi5jb21tYW5kc1tleHRyYV0pIHsgLy8gY2F1Z2h0IGEgcmVhbCBjb21tYW5kCiAgICAgICAgICAgIGNvbW1hbmRzLnB1c2goIjx1PkhlbHAgZm9yIHRoZSBjb21tYW5kOiA8ZW0+IiArIGV4dHJhICsgIjwvZW0+PC91Pjxici8+Iik7CiAgICAgICAgICAgIHZhciBjb21tYW5kID0gc2VsZi5jb21tYW5kc1tleHRyYV07CiAgICAgICAgICAgIGNvbW1hbmRzLnB1c2goY29tbWFuZFsnZGVzY3JpcHRpb24nXSA/IGNvbW1hbmQuZGVzY3JpcHRpb24gOiBjb21tYW5kLnByZXZpZXcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzaG93SGlkZGVuID0gZmFsc2U7CiAgICAgICAgICAgIGNvbW1hbmRzLnB1c2goIjx1PkNvbW1hbmRzIEF2YWlsYWJsZTwvdT48YnIvPiIpOwoKICAgICAgICAgICAgaWYgKGV4dHJhKSB7CiAgICAgICAgICAgICAgICBpZiAoZXh0cmEgPT0gImhpZGRlbiIpIHsgLy8gc25lYWt5LCBzbmVha3kuCiAgICAgICAgICAgICAgICAgICAgZXh0cmEgPSAiIjsKICAgICAgICAgICAgICAgICAgICBzaG93SGlkZGVuID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbW1hbmRzLnB1c2goIjxlbT4oc3RhcnRpbmcgd2l0aDwvZW0+ICIgKyBleHRyYSArICIgPGVtPik8L2VtPjxici8+Iik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciB0b2Jlc29ydGVkID0gW107CiAgICAgICAgICAgIGZvciAobmFtZSBpbiBzZWxmLmNvbW1hbmRzKSB7CiAgICAgICAgICAgICAgICB0b2Jlc29ydGVkLnB1c2gobmFtZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBzb3J0ZWQgPSB0b2Jlc29ydGVkLnNvcnQoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc29ydGVkLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IHNvcnRlZFtpXTsKICAgICAgICAgICAgICAgIHZhciBjb21tYW5kID0gc2VsZi5jb21tYW5kc1tuYW1lXTsKCiAgICAgICAgICAgICAgICBpZiAoIXNob3dIaWRkZW4gJiYgY29tbWFuZC5oaWRkZW4pIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgaWYgKGV4dHJhICYmIG5hbWUuaW5kZXhPZihleHRyYSkgIT0gMCkgY29udGludWU7CgogICAgICAgICAgICAgICAgdmFyIGFyZ3VtZW50cyA9IChjb21tYW5kLnRha2VzKSA/ICcgWycgKyBjb21tYW5kLnRha2VzLm9yZGVyLmpvaW4oJ10gWycpICsgJ10nIDogJyc7CiAgICAgICAgICAgICAgICBjb21tYW5kcy5wdXNoKCc8Yj4nICsgbmFtZSArIGFyZ3VtZW50cyArICc8L2I+OiAnICsgY29tbWFuZC5wcmV2aWV3KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZWxmLnNob3dJbmZvKCI8ZGl2IHN0eWxlPSdmb250LXNpemU6IDAuODBlbSc+IiArIGNvbW1hbmRzLmpvaW4oIjxici8+IikgKyAiPC9kaXY+Iik7CiAgICB9Cn0pOyAKCi8vICoqIHt7e0NvbW1hbmQ6IHNldH19fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgICAgICBuYW1lOiAnc2V0JywKICAgICAgICB0YWtlczogWydrZXknLCAndmFsdWUnXSwKICAgICAgICBwcmV2aWV3OiAnZGVmaW5lIGFuZCBzaG93IHNldHRpbmdzJywKICAgICAgICBjb21wbGV0ZVRleHQ6ICdvcHRpb25hbGx5LCBhZGQgYSBrZXkgYW5kL29yIGEgdmFsdWUsIGVsc2UgeW91IHdpbGwgc2VlIGFsbCBzZXR0aW5ncycsCiAgICAgICAgLy8gY29tcGxldGU6IGZ1bmN0aW9uKHNlbGYsIHZhbHVlKSB7CiAgICAgICAgLy8gICAgIGNvbnNvbGUubG9nKHNlbGYpOwogICAgICAgIC8vICAgICBjb25zb2xlLmxvZyh2YWx1ZSk7CiAgICAgICAgLy8gICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAvLyB9LAogICAgICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKHNlbGYsIHNldHRpbmcpIHsKICAgICAgICAgICAgdmFyIG91dHB1dDsKCiAgICAgICAgICAgIGlmICghc2V0dGluZy5rZXkpIHsgLy8gLS0gc2hvdyBhbGwKICAgICAgICAgICAgICAgIHZhciBzZXR0aW5ncyA9IHNlbGYuc2V0dGluZ3MubGlzdCgpOwoKICAgICAgICAgICAgICAgIG91dHB1dCA9ICI8dT5Zb3VyIFNldHRpbmdzPC91Pjxici8+PGJyLz4iOwogICAgICAgICAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCBzZXR0aW5ncy5sZW5ndGg7IHgrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChzZXR0aW5nc1t4XS5rZXlbMF0gIT0gJ18nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dCArPSBzZXR0aW5nc1t4XS5rZXkgKyAiOiAiICsgc2V0dGluZ3NbeF0udmFsdWUgKyAiPGJyLz4iOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSBzZXR0aW5nLmtleTsKICAgICAgICAgICAgICAgIGlmIChzZXR0aW5nLnZhbHVlID09IHVuZGVmaW5lZCkgeyAvLyBzaG93IGl0CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gc2VsZi5zZXR0aW5ncy5nZXQoa2V5KTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gIjx1PllvdXIgc2V0dGluZzwvdT48YnIvPjxici8+IjsKICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0ICs9IGtleSArICI6ICIgKyB2YWx1ZTsgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSAiWW91IGRvIG5vdCBoYXZlIGEgc2V0dGluZyBmb3IgPGVtPiIgKyBrZXkgKyAiPC9lbT4iOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gIjx1PlNhdmluZyBzZXR0aW5nPC91Pjxici8+PGJyLz4iOwogICAgICAgICAgICAgICAgICAgIG91dHB1dCArPSBrZXkgKyAiOiAiICsgc2V0dGluZy52YWx1ZTsKICAgICAgICAgICAgICAgICAgICBzZWxmLnNldHRpbmdzLnNldChrZXksIHNldHRpbmcudmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGYuc2hvd0luZm8ob3V0cHV0KTsKICAgICAgICB9Cn0pOwoKLy8gKioge3t7Q29tbWFuZDogZmlsZXMgKGxzLCBsaXN0KX19fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgIG5hbWU6ICdmaWxlcycsCiAgICBhbGlhc2VzOiBbJ2xzJywgJ2xpc3QnXSwKICAgIHRha2VzOiBbJ3Byb2plY3QnXSwKICAgIHByZXZpZXc6ICdzaG93IGZpbGVzJywKICAgIGNvbXBsZXRlVGV4dDogJ29wdGlvbmFsbHksIGFkZCB0aGUgcHJvamVjdCBuYW1lIG9mIHlvdXIgY2hvaWNlJywKICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKHNlbGYsIHByb2plY3QpIHsKICAgICAgICBpZiAoIXByb2plY3QgJiYgKHR5cGVvZiBfZWRpdFNlc3Npb24gIT0gInVuZGVmaW5lZCIpICkgewogICAgICAgICAgICBwcm9qZWN0ID0gX2VkaXRTZXNzaW9uLnByb2plY3RGb3JEaXNwbGF5KCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXByb2plY3QpIHsKICAgICAgICAgICAgc2VsZi5zaG93SW5mbygiWW91IG5lZWQgdG8gcGFzcyBpbiBhIHByb2plY3QiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgc2VsZi5maWxlcy5maWxlTmFtZXMocHJvamVjdCwgZnVuY3Rpb24oZmlsZU5hbWVzKSB7CiAgICAgICAgICAgIHZhciBmaWxlcyA9ICI8dT5GaWxlcyBpbiBwcm9qZWN0OiAiICsgcHJvamVjdCArICI8L3U+PGJyLz48YnIvPiI7CiAgICAgICAgICAgIGZvciAodmFyIHggPSAwOyB4IDwgZmlsZU5hbWVzLmxlbmd0aDsgeCsrKSB7CiAgICAgICAgICAgICAgICBmaWxlcyArPSBmaWxlTmFtZXNbeF0ubmFtZSArICI8YnIvPiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZi5zaG93SW5mbyhmaWxlcyk7CiAgICAgICAgfSk7CiAgICB9Cn0pOwoKLy8gKioge3t7Q29tbWFuZDogc3RhdHVzfX19ICoqCkJlc3Bpbi5Db21tYW5kcy5hZGQoewogICAgbmFtZTogJ3N0YXR1cycsCiAgICBwcmV2aWV3OiAnZ2V0IGluZm8gb24gdGhlIGN1cnJlbnQgcHJvamVjdCBhbmQgZmlsZScsCiAgICBleGVjdXRlOiBmdW5jdGlvbihzZWxmKSB7CiAgICAgIHZhciBmaWxlID0gX2VkaXRTZXNzaW9uLnBhdGggfHwgJ2EgbmV3IHNjcmF0Y2ggZmlsZSc7CiAgICAgIHNlbGYuc2hvd0luZm8oJ0hleSAnICsgX2VkaXRTZXNzaW9uLnVzZXJuYW1lICsgJywgeW91IGFyZSBlZGl0aW5nICcgKyBmaWxlICsgJyBpbiBwcm9qZWN0ICcgKyBfZWRpdFNlc3Npb24ucHJvamVjdEZvckRpc3BsYXkoKSk7CiAgICB9Cn0pOwoKLy8gKioge3t7Q29tbWFuZDogcHJvamVjdH19fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgIG5hbWU6ICdwcm9qZWN0JywKICAgIHRha2VzOiBbJ3Byb2plY3RuYW1lJ10sCiAgICBwcmV2aWV3OiAnc2hvdyB0aGUgY3VycmVudCBwcm9qZWN0LCBvciBzZXQgdG8gYSBuZXcgb25lJywKICAgIGNvbXBsZXRlVGV4dDogJ29wdGlvbmFsbHksIGFkZCB0aGUgcHJvamVjdCBuYW1lIHRvIGNoYW5nZSB0byB0aGF0IHByb2plY3QnLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZiwgcHJvamVjdG5hbWUpIHsKICAgICAgICBpZiAocHJvamVjdG5hbWUpIHsKICAgICAgICAgICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOmVkaXRvcjpwcm9qZWN0OnNldCIsIHsgcHJvamVjdDogcHJvamVjdG5hbWUgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5leGVjdXRlQ29tbWFuZCgnc3RhdHVzJyk7CiAgICAgICAgfQogICAgfQp9KTsKCi8vICoqIHt7e0NvbW1hbmQ6IHByb2plY3RzfX19ICoqCkJlc3Bpbi5Db21tYW5kcy5hZGQoewogICAgbmFtZTogJ3Byb2plY3RzJywKICAgIHByZXZpZXc6ICdzaG93IHByb2plY3RzJywKICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKHNlbGYsIGV4dHJhKSB7CiAgICAgIHNlbGYuZmlsZXMucHJvamVjdHMoZnVuY3Rpb24ocHJvamVjdE5hbWVzKSB7CiAgICAgICAgICB2YXIgcHJvamVjdHMgPSAiPHU+WW91ciBwcm9qZWN0czwvdT48YnIvPjxici8+IjsKICAgICAgICAgIGZvciAodmFyIHggPSAwOyB4IDwgcHJvamVjdE5hbWVzLmxlbmd0aDsgeCsrKSB7CiAgICAgICAgICAgIHByb2plY3RzICs9IHByb2plY3ROYW1lc1t4XS5uYW1lICsgIjxici8+IjsKICAgICAgICAgIH0KICAgICAgICAgIHNlbGYuc2hvd0luZm8ocHJvamVjdHMpOwogICAgICB9KTsKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiBjbGlwYm9hcmR9fX0gKioKQmVzcGluLkNvbW1hbmRzLmFkZCh7CiAgICBuYW1lOiAnY2xpcGJvYXJkJywKICAgIHZlcnNpb246IDAuMSwKICAgIHByZXZpZXc6ICdleHBvcnQgdGhlIGNvbnRlbnRzIHRvIHRoZSBjbGlwYm9hcmQnLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZikgewogICAgICAgIEJlc3Bpbi5DbGlwYm9hcmQuY29weShzZWxmLmVkaXRvci5tb2RlbC5nZXREb2N1bWVudCgpKTsKCiAgICAgICAgc2VsZi5zaG93SW5mbygnU2F2ZWQgZmlsZSBjb250ZW50cyB0byBjbGlwYm9hcmQnKTsKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiBzYXZlfX19ICoqCkJlc3Bpbi5Db21tYW5kcy5hZGQoewogICAgbmFtZTogJ3NhdmUnLAogICAgdGFrZXM6IFsnZmlsZW5hbWUnXSwKICAgIHByZXZpZXc6ICdzYXZlIHRoZSBjdXJyZW50IGNvbnRlbnRzJywKICAgIGNvbXBsZXRlVGV4dDogJ2FkZCB0aGUgZmlsZW5hbWUgdG8gc2F2ZSBhcywgb3IgdXNlIHRoZSBjdXJyZW50IGZpbGUnLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZiwgZmlsZW5hbWUpIHsKICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOnNhdmVmaWxlIiwgewogICAgICAgICAgICBmaWxlbmFtZTogZmlsZW5hbWUKICAgICAgICB9KTsKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiBsb2FkIChvcGVuKX19fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgIG5hbWU6ICdsb2FkJywKICAgIGFsaWFzZXM6IFsnb3BlbiddLAogICAgdGFrZXM6IFsnZmlsZW5hbWUnXSwKICAgIHByZXZpZXc6ICdsb2FkIHVwIHRoZSBjb250ZW50cyBvZiB0aGUgZmlsZScsCiAgICBjb21wbGV0ZVRleHQ6ICdhZGQgdGhlIGZpbGVuYW1lIHRvIG9wZW4nLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZiwgZmlsZW5hbWUpIHsKICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOm9wZW5maWxlIiwgewogICAgICAgICAgICBmaWxlbmFtZTogZmlsZW5hbWUKICAgICAgICB9KTsKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiBwcmV2aWV3fX19ICoqCkJlc3Bpbi5Db21tYW5kcy5hZGQoewogICAgbmFtZTogJ3ByZXZpZXcnLAogICAgdGFrZXM6IFsnZmlsZW5hbWUnXSwKICAgIHByZXZpZXc6ICd2aWV3IHRoZSBmaWxlIGluIGEgbmV3IGJyb3dzZXIgd2luZG93JywKICAgIGNvbXBsZXRlVGV4dDogJ2FkZCB0aGUgZmlsZW5hbWUgdG8gdmlldyBvciB1c2UgdGhlIGN1cnJlbnQgZmlsZScsCiAgICBleGVjdXRlOiBmdW5jdGlvbihzZWxmLCBmaWxlbmFtZSkgewogICAgICAgIGRvY3VtZW50LmZpcmUoImJlc3BpbjplZGl0b3I6cHJldmlldyIsIHsKICAgICAgICAgICAgZmlsZW5hbWU6IGZpbGVuYW1lIAogICAgICAgIH0pOwogICAgfQp9KTsKCgovLyAqKiB7e3tDb21tYW5kOiBlZGl0Y29uZmlnfX19ICoqCkJlc3Bpbi5Db21tYW5kcy5hZGQoewogICAgbmFtZTogJ2VkaXRjb25maWcnLAogICAgYWxpYXNlczogWydjb25maWcnXSwKICAgIHByZXZpZXc6ICdsb2FkIHVwIHRoZSBjb25maWcgZmlsZScsCiAgICBleGVjdXRlOiBmdW5jdGlvbihzZWxmKSB7CiAgICAgICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOmVkaXRvcjpvcGVuZmlsZSIsIHsKICAgICAgICAgICAgcHJvamVjdDogX2VkaXRTZXNzaW9uLnVzZXJwcm9qZWN0LAogICAgICAgICAgICBmaWxlbmFtZTogImNvbmZpZy5qcyIKICAgICAgICB9KTsKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiBydW5jb25maWd9fX0gKioKQmVzcGluLkNvbW1hbmRzLmFkZCh7CiAgICBuYW1lOiAncnVuY29uZmlnJywKICAgIHByZXZpZXc6ICdydW4geW91ciBjb25maWcgZmlsZScsCiAgICBleGVjdXRlOiBmdW5jdGlvbihzZWxmKSB7CiAgICAgICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOmVkaXRvcjpjb25maWc6cnVuIik7CiAgICB9Cn0pOwoKLy8gKioge3t7Q29tbWFuZDogbmV3ZmlsZX19fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgIG5hbWU6ICduZXdmaWxlJywKICAgIC8vYWxpYXNlczogWyduZXcnXSwKICAgIHRha2VzOiBbJ2ZpbGVuYW1lJ10sCiAgICBwcmV2aWV3OiAnY3JlYXRlIGEgbmV3IGJ1ZmZlciBmb3IgZmlsZScsCiAgICBjb21wbGV0ZVRleHQ6ICdvcHRpb25hbGx5LCBuYW1lIHRoZSBuZXcgZmlsZW5hbWUnLAogICAgd2l0aEtleTogIkNUUkwgU0hJRlQgTiIsICAgICAgICAgICAgCiAgICBleGVjdXRlOiBmdW5jdGlvbihzZWxmLCBmaWxlbmFtZSkgewogICAgICAgIHZhciBvcHRzID0gKGZpbGVuYW1lKSA/IHsgbmV3ZmlsZW5hbWU6IGZpbGVuYW1lIH0gOiB7fTsKICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOm5ld2ZpbGUiLCBvcHRzKTsKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiBybSAocmVtb3ZlLCBkZWwpfX19ICoqCkJlc3Bpbi5Db21tYW5kcy5hZGQoewogICAgbmFtZTogJ3JtJywKICAgIGFsaWFzZXM6IFsncmVtb3ZlJywgJ2RlbCddLAogICAgdGFrZXM6IFsnZmlsZW5hbWUnXSwKICAgIHByZXZpZXc6ICdyZW1vdmUgdGhlIGZpbGUnLAogICAgY29tcGxldGVUZXh0OiAnYWRkIHRoZSBmaWxlbmFtZSB0byByZW1vdmUnLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZiwgZmlsZW5hbWUpIHsKICAgICAgICBpZiAoIWZpbGVuYW1lKSB7CiAgICAgICAgICAgIHNlbGYuc2hvd0luZm8oImdpdmUgbWUgYSBmaWxlbmFtZSBvciBkaXJlY3RvcnkgdG8gZGVsZXRlIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgc2VsZi5maWxlcy5yZW1vdmVGaWxlKF9lZGl0U2Vzc2lvbi5wcm9qZWN0LCBmaWxlbmFtZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChfZWRpdFNlc3Npb24ucGF0aCA9PSBmaWxlbmFtZSkgc2VsZi5lZGl0b3IubW9kZWwuY2xlYXIoKTsgLy8gb25seSBjbGVhciBpZiBkZWxldGluZyB0aGUgc2FtZSBmaWxlCiAgICAgICAgICAgIHNlbGYuc2hvd0luZm8oJ1JlbW92ZWQgZmlsZTogJyArIGZpbGVuYW1lLCB0cnVlKTsKICAgICAgICB9LCBmdW5jdGlvbih4aHIpIHsKICAgICAgICAgICAgc2VsZi5zaG93SW5mbygiV2Fzbid0IGFibGUgdG8gcmVtb3ZlIHRoZSBmaWxlIDxiPiIgKyBmaWxlbmFtZSArICI8L2I+PGJyLz48ZW0+RXJyb3I8L2VtPiAocHJvYmFibHkgZG9lc24ndCBleGlzdCk6ICIgKyB4aHIucmVzcG9uc2VUZXh0KTsKICAgICAgICB9KTsKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiBjbG9zZWZpbGV9fX0gKioKQmVzcGluLkNvbW1hbmRzLmFkZCh7CiAgICBuYW1lOiAnY2xvc2VmaWxlJywKICAgIHRha2VzOiBbJ2ZpbGVuYW1lJ10sCiAgICBwcmV2aWV3OiAnY2xvc2UgdGhlIGZpbGUgKG1heSBsb3NlIGVkaXRzKScsCiAgICBjb21wbGV0ZVRleHQ6ICdhZGQgdGhlIGZpbGVuYW1lIHRvIGNsb3NlJywKICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKHNlbGYsIGZpbGVuYW1lKSB7CiAgICAgICAgc2VsZi5maWxlcy5jbG9zZUZpbGUoX2VkaXRTZXNzaW9uLnByb2plY3QsIGZpbGVuYW1lLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOmVkaXRvcjpjbG9zZWRmaWxlIiwgeyBmaWxlbmFtZTogZmlsZW5hbWUgfSk7CiAgICAgICAgICAgIGlmIChmaWxlbmFtZSA9PSBfZWRpdFNlc3Npb24ucGF0aCkgZG9jdW1lbnQuZmlyZSgiYmVzcGluOmVkaXRvcjpuZXdmaWxlIik7CgogICAgICAgICAgICBzZWxmLnNob3dJbmZvKCdDbG9zZWQgZmlsZTogJyArIGZpbGVuYW1lLCB0cnVlKTsKICAgICAgICB9KTsKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiBkYXNoYm9hcmR9fX0gKioKQmVzcGluLkNvbW1hbmRzLmFkZCh7CiAgICBuYW1lOiAnZGFzaGJvYXJkJywKICAgIHByZXZpZXc6ICduYXZpZ2F0ZSB0byB0aGUgZmlsZScsCiAgICBleGVjdXRlOiBmdW5jdGlvbihzZWxmKSB7CiAgICAgICAgQmVzcGluLk5hdmlnYXRlLmRhc2hib2FyZCgpOwogICAgfQp9KTsKCi8vICoqIHt7e0NvbW1hbmQ6IHZlcnNpb259fX0gKioKQmVzcGluLkNvbW1hbmRzLmFkZCh7CiAgICBuYW1lOiAndmVyc2lvbicsCiAgICB0YWtlczogWydjb21tYW5kJ10sCiAgICBwcmV2aWV3OiAnc2hvdyB0aGUgdmVyc2lvbiBmb3IgQmVzcGluIG9yIGEgY29tbWFuZCcsCiAgICBjb21wbGV0ZVRleHQ6ICdvcHRpb25hbGx5LCBhIGNvbW1hbmQgbmFtZScsCiAgICBleGVjdXRlOiBmdW5jdGlvbihzZWxmLCBjb21tYW5kKSB7CiAgICAgICAgdmFyIGJlc3BpblZlcnNpb24gPSAnWW91ciBCZXNwaW4gaXMgYXQgdmVyc2lvbiAnICsgQmVzcGluLnZlcnNpb25OdW1iZXIgKyAnLCBDb2RlIG5hbWU6ICInICsgQmVzcGluLnZlcnNpb25Db2RlbmFtZSArICciJzsKICAgICAgICB2YXIgdmVyc2lvbjsKICAgICAgICBpZiAoY29tbWFuZCkgewogICAgICAgICAgICB2YXIgdGhlQ29tbWFuZCA9IHNlbGYuY29tbWFuZHNbY29tbWFuZF07CiAgICAgICAgICAgIGlmICghdGhlQ29tbWFuZCkgewogICAgICAgICAgICAgICAgdmVyc2lvbiA9ICJJdCBhcHBlYXJzIHRoYXQgdGhlcmUgaXMgbm8gY29tbWFuZCBuYW1lZCAnIiArIGNvbW1hbmQgKyAiJywgYnV0ICIgKyBiZXNwaW5WZXJzaW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmVyc2lvbiA9ICh0aGVDb21tYW5kLnZlcnNpb24pCiAgICAgICAgICAgICAgICAgICAgPyAiVGhlIGNvbW1hbmQgbmFtZWQgJyIgKyBjb21tYW5kICsgIicgaXMgYXQgdmVyc2lvbiAiICsgdGhlQ29tbWFuZC52ZXJzaW9uIAogICAgICAgICAgICAgICAgICAgIDogIlRoZSBjb21tYW5kIG5hbWVkICciICsgY29tbWFuZCArICInIGlzIGEgY29yZSBjb21tYW5kIGluIEJlc3BpbiB2ZXJzaW9uICIgKyBCZXNwaW4udmVyc2lvbk51bWJlcjsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZlcnNpb24gPSBiZXNwaW5WZXJzaW9uOwogICAgICAgIH0KICAgICAgICBzZWxmLnNob3dJbmZvKHZlcnNpb24pOwogICAgfQp9KTsKCi8vICoqIHt7e0NvbW1hbmQ6IGNsZWFyfX19ICoqCkJlc3Bpbi5Db21tYW5kcy5hZGQoewogICAgbmFtZTogJ2NsZWFyJywKICAgIGFsaWFzZXM6IFsnY2xzJ10sCiAgICBwcmV2aWV3OiAnY2xlYXIgdGhlIGZpbGUnLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZikgewogICAgICAgIHNlbGYuZWRpdG9yLm1vZGVsLmNsZWFyKCk7CiAgICB9Cn0pOwoKLy8gKioge3t7Q29tbWFuZDogZ290b319fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgIG5hbWU6ICdnb3RvJywKICAgIHRha2VzOiBbJ2xpbmVudW1iZXInXSwKICAgIHByZXZpZXc6ICdtb3ZlIGl0ISBtYWtlIHRoZSBlZGl0b3IgaGVhZCB0byB5b3VyIGxpbmUgbnVtYmVyLicsCiAgICBjb21wbGV0ZVRleHQ6ICdhZGQgdGhlIGxpbmUgbnVtYmVyIHRvIG1vdmUgdG8nLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZiwgbGluZW51bWJlcikgewogICAgICAgIGlmIChsaW5lbnVtYmVyKSB7CiAgICAgICAgICAgIHZhciBsaW5lbnVtQXNJbnQgPSBwYXJzZUludChsaW5lbnVtYmVyKSAtIDE7CiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmVkaXRvci5tb3ZlQ3Vyc29yKHsgcm93OiBsaW5lbnVtQXNJbnQsIGNvbDogMCB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIHRoZSBsaW5lIHRoYXQgd2UgYXJlIG1vdmluZyB0byBpcyBvZmYgc2NyZWVuLCBjZW50ZXIgaXQsIGVsc2UganVzdCBtb3ZlIGluIHBsYWNlCiAgICAgICAgICAgIGlmICggKGxpbmVudW1Bc0ludCA8IHNlbGYuZWRpdG9yLnVpLmZpcnN0VmlzaWJsZVJvdykgfHwgKGxpbmVudW1Bc0ludCA+PSBzZWxmLmVkaXRvci51aS5maXJzdFZpc2libGVSb3crc2VsZi5lZGl0b3IudWkudmlzaWJsZVJvd3MpICkgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOmVkaXRvcjpkb2FjdGlvbiIsIHsKICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdtb3ZlQ3Vyc29yUm93VG9DZW50ZXInCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiByZXBsYWNlfX19ICoqCkJlc3Bpbi5Db21tYW5kcy5hZGQoewogICAgbmFtZTogJ3JlcGxhY2UnLAogICAgdGFrZXM6IFsnc2VhcmNoJywgJ3JlcGxhY2UnXSwKICAgIHByZXZpZXc6ICdzL2Zvby9iYXIvZycsCiAgICBjb21wbGV0ZVRleHQ6ICdhZGQgdGhlIHNlYXJjaCByZWdleCwgYW5kIHRoZW4gdGhlIHJlcGxhY2VtZW50IHRleHQnLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZiwgYXJncykgewogICAgICAgIHNlbGYuZWRpdG9yLm1vZGVsLnJlcGxhY2UoYXJncy5zZWFyY2gsIGFyZ3MucmVwbGFjZSk7CiAgICB9Cn0pOwoKLy8gKioge3t7Q29tbWFuZDogbG9naW59fX0gKioKQmVzcGluLkNvbW1hbmRzLmFkZCh7CiAgICBuYW1lOiAnbG9naW4nLAogICAgLy8gYWxpYXNlczogWyd1c2VyJ10sCiAgICAvLyAgICAgICAgICAgIHRha2VzOiBbJ3VzZXJuYW1lJywgJ3Bhc3N3b3JkJ10sCiAgICBoaWRkZW46IHRydWUsCiAgICB0YWtlczogewogICAgICAgIG9yZGVyOiBbJ3VzZXJuYW1lJywgJ3Bhc3N3b3JkJ10sCiAgICAgICAgdXNlcm5hbWU6IHsKICAgICAgICAgICAgInNob3J0IjogJ3UnLAogICAgICAgIH0sCiAgICAgICAgcGFzc3dvcmQ6IHsKICAgICAgICAgICAgInNob3J0IjogJ3AnLAogICAgICAgICAgICBvcHRpb25hbDogdHJ1ZQogICAgICAgIH0KICAgIH0sCiAgICBwcmV2aWV3OiAnbG9naW4gdG8gdGhlIHNlcnZpY2UnLAogICAgY29tcGxldGVUZXh0OiAncGFzcyBpbiB5b3VyIHVzZXJuYW1lIGFuZCBwYXNzd29yZCcsCiAgICBleGVjdXRlOiBmdW5jdGlvbihzZWxmLCBhcmdzKSB7CiAgICAgICAgaWYgKCFhcmdzKSB7IC8vIHNob3J0IGNpcmN1aXQgaWYgbm8gdXNlcm5hbWUKICAgICAgICAgICAgc2VsZi5leGVjdXRlQ29tbWFuZCgic3RhdHVzIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgX2VkaXRTZXNzaW9uLnVzZXJuYW1lID0gYXJncy51c2VyOyAvLyBUT0RPOiBub3JtYWxpemUgc3luY2luZwogICAgICAgIF9zZXJ2ZXIubG9naW4oYXJncy51c2VyLCBhcmdzLnBhc3MpOwogICAgfQp9KTsKCi8vICoqIHt7e0NvbW1hbmQ6IGxvZ291dH19fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgIG5hbWU6ICdsb2dvdXQnLAogICAgcHJldmlldzogJ2xvZyBvdXQnLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZikgewogICAgICAgIGRlbGV0ZSBfZWRpdFNlc3Npb24udXNlcm5hbWU7CiAgICAgICAgX3NlcnZlci5sb2dvdXQoZnVuY3Rpb24oKSB7CgkJCXdpbmRvdy5sb2NhdGlvbi5ocmVmPSIvIjsKCQl9KTsKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiBiZXNwaW59fX0gKioKQmVzcGluLkNvbW1hbmRzLmFkZCh7CiAgICBuYW1lOiAnYmVzcGluJywKICAgIHByZXZpZXc6ICdoYXMnLAogICAgaGlkZGVuOiB0cnVlLAogICAgbWVzc2FnZXM6IFsKICAgICAgICAicmVhbGx5IHdhbnRzIHlvdSB0byB0cmljayBpdCBvdXQgaW4gc29tZSB3YXkuIiwKICAgICAgICAiaXMgeW91ciBXZWIgZWRpdG9yLiIsCiAgICAgICAgIndvdWxkIGxvdmUgdG8gYmUgbGlrZSBFbWFjcyBvbiB0aGUgV2ViLiIsCiAgICAgICAgImlzIHdyaXR0ZW4gb24gdGhlIFdlYiBwbGF0Zm9ybSwgc28geW91IGNhbiB0d2VhayBpdC4iCiAgICBdLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZikgewogICAgICAgIHNlbGYuc2hvd0luZm8oIkJlc3BpbiAiICsgdGhpcy5tZXNzYWdlc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB0aGlzLm1lc3NhZ2VzLmxlbmd0aCldKTsKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiBhY3Rpb259fX0gKioKQmVzcGluLkNvbW1hbmRzLmFkZCh7CiAgICBuYW1lOiAnYWN0aW9uJywKICAgIHRha2VzOiBbJ2FjdGlvbm5hbWUnXSwKICAgIHByZXZpZXc6ICdleGVjdXRlIGFueSBlZGl0b3IgYWN0aW9uJywKICAgIGhpZGRlbjogdHJ1ZSwKICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKHNlbGYsIGFjdGlvbm5hbWUpIHsKICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOmRvYWN0aW9uIiwgewogICAgICAgICAgICBhY3Rpb246IGFjdGlvbm5hbWUKICAgICAgICB9KTsKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiBzb3J0fX19ICoqCkJlc3Bpbi5Db21tYW5kcy5hZGQoewogICAgbmFtZTogJ3NvcnQnLAogICAgdGFrZXM6IFsnZGlyZWN0aW9uJ10sCiAgICBwcmV2aWV3OiAnc29ydCB0aGUgY3VycmVudCBidWZmZXInLAogICAgY29tcGxldGVUZXh0OiAnb3B0aW9uYWxseSwgc29ydCBkZXNjZW5kaW5nJywKICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKHNlbGYsIGRpcmVjdGlvbikgewogICAgICAgIHZhciBidWZmZXIgPSBzZWxmLmVkaXRvci5tb2RlbC5nZXREb2N1bWVudCgpLnNwbGl0KC9cbi8pOwogICAgICAgIGJ1ZmZlci5zb3J0KCk7CiAgICAgICAgaWYgKGRpcmVjdGlvbiAmJiBkaXJlY3Rpb24udG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKCJkZXNjIikpIGJ1ZmZlci5yZXZlcnNlKCk7CiAgICAgICAgc2VsZi5lZGl0b3IubW9kZWwuaW5zZXJ0RG9jdW1lbnQoYnVmZmVyLmpvaW4oIlxuIikpOwogICAgfQp9KTsKCi8vICoqIHt7e0NvbW1hbmQ6IGV4cG9ydH19fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgIG5hbWU6ICdleHBvcnQnLAogICAgdGFrZXM6IFsncHJvamVjdCcsICdhcmNoaXZldHlwZSddLAogICAgcHJldmlldzogJ2V4cG9ydCB0aGUgZ2l2ZW4gcHJvamVjdCB3aXRoIGFuIGFyY2hpdmV0eXBlIG9mIHppcCBvciB0Z3onLAogICAgY29tcGxldGVUZXh0OiAncHJvamVjdCBuYW1lLCBhcmNoaXZldHlwZSAoemlwIHwgdGd6LCBkZWZhdWx0cyB0byB6aXApJywKICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKHNlbGYsIGFyZ3MpIHsKICAgICAgICB2YXIgcHJvamVjdCA9IGFyZ3MucHJvamVjdCB8fCBfZWRpdFNlc3Npb24ucHJvamVjdDsKICAgICAgICAKICAgICAgICB2YXIgdHlwZSA9IGFyZ3MuYXJjaGl2ZXR5cGU7CiAgICAgICAgaWYgKCFbJ3ppcCcsJ3RneicsJ3Rhci5neiddLmluY2x1ZGUodHlwZSkpIHsKICAgICAgICAgICAgdHlwZSA9ICd6aXAnOwogICAgICAgIH0KCiAgICAgICAgX3NlcnZlci5leHBvcnRQcm9qZWN0KHByb2plY3QsIHR5cGUpOyAvLyB0cnkgdG8gZG8gaXQgdmlhIHRoZSBpZnJhbWUKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiBpbXBvcnR9fX0gKioKQmVzcGluLkNvbW1hbmRzLmFkZCh7CiAgICBuYW1lOiAnaW1wb3J0JywKICAgIHRha2VzOiBbJ3Byb2plY3QnLCAndXJsJ10sCiAgICBwcmV2aWV3OiAnaW1wb3J0IHRoZSBnaXZlbiB1cmwgYXMgYSBwcm9qZWN0JywKICAgIGNvbXBsZXRlVGV4dDogJ3Byb2plY3QgbmFtZSwgdXJsICh0byBhbiBhcmNoaXZlIHppcCB8IHRneiknLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZiwgYXJncykgewogICAgICAgIHZhciBwcm9qZWN0ID0gYXJncy5wcm9qZWN0OwogICAgICAgIGlmICghcHJvamVjdCkgewogICAgICAgICAgICBzZWxmLnNob3dJbmZvKCJQbGVhc2UgcnVuOiBpbXBvcnQgW3Byb2plY3RuYW1lXSBbdXJsIG9mIGFyY2hpdmVdIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdmFyIHVybCA9IGFyZ3MudXJsOwogICAgICAgIGlmICghdXJsIHx8ICEodXJsLmVuZHNXaXRoKCcudGd6JykgfHwgdXJsLmVuZHNXaXRoKCcudGFyLmd6JykgfHwgdXJsLmVuZHNXaXRoKCcuemlwJykpKSB7CiAgICAgICAgICAgIHNlbGYuc2hvd0luZm8oIlBsZWFzZSBydW46IGltcG9ydCBbcHJvamVjdG5hbWVdIFt1cmwgb2YgYXJjaGl2ZV08YnI+KG1ha2Ugc3VyZSB0aGUgYXJjaGl2ZSBpcyBhIHppcCwgb3IgdGd6KSIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBzZWxmLnNob3dJbmZvKCJBYm91dCB0byBpbXBvcnQgIiArIHByb2plY3QgKyAiIGZyb206PGJyPjxicj4iICsgdXJsICsgIjxicj48YnI+PGVtPkl0IGNhbiB0YWtlIGF3aGlsZSB0byBkb3dubG9hZCB0aGUgcHJvamVjdCwgc28gYmUgcGF0aWVudCE8L2VtPiIpOwogICAgICAgIAogICAgICAgIF9zZXJ2ZXIuaW1wb3J0UHJvamVjdChwcm9qZWN0LCB1cmwsIHsgY2FsbDogZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgICAgIHNlbGYuc2hvd0luZm8oIlByb2plY3QgIiArIHByb2plY3QgKyAiIGltcG9ydGVkIGZyb206PGJyPjxicj4iICsgdXJsKTsKICAgICAgICB9LCBvbkZhaWx1cmU6IGZ1bmN0aW9uKHhocikgewogICAgICAgICAgICBzZWxmLnNob3dJbmZvKCJVbmFibGUgdG8gaW1wb3J0ICIgKyBwcm9qZWN0ICsgIiBmcm9tOjxicj48YnI+IiArIHVybCArICIuPGJyPjxicj5NYXliZSBkdWUgdG86ICIgKyB4aHIucmVzcG9uc2VUZXh0KTsKICAgICAgICB9fSk7CiAgICB9Cn0pOwoKLy8gKioge3t7Q29tbWFuZDogZG9jdHlwZX19fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgIG5hbWU6ICdkb2N0eXBlJywKICAgIHRha2VzOiBbJ3NlY3Rpb24nXSwgLy8gcGFydCBvbiB0aGUgV2lraQogICAgcHJldmlldzogJ2dyYWIgdGhlIGRvY3R5cGUgaW5mbyBmb3IgYSBzZWN0aW9uJywKICAgIGNvbXBsZXRlVGV4dDogJ2NhbiB5b3UgZ2l2ZSBtZSB0aGUgRG9jdHlwZSB3aWtpIHNlY3Rpb24/JywKICAgIGhpZGRlbjogdHJ1ZSwKICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKHNlbGYsIHNlY3Rpb24pIHsKICAgICAgICAvL1RPRE8gZ3JhYiB0aGUgSFRNTDogaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL2RvY3R5cGUvd2lraS9TZWN0aW9uRWxlbWVudD9zaG93PWNvbnRlbnQKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiB0cmltfX19ICoqCkJlc3Bpbi5Db21tYW5kcy5hZGQoewogICAgbmFtZTogJ3RyaW0nLAogICAgdGFrZXM6IFsnc2lkZSddLCAvLyBsZWZ0LCByaWdodCwgYm90aAogICAgcHJldmlldzogJ3RyaW0gdHJhaWxpbmcgb3IgbGVhZGluZyB3aGl0ZXNwYWNlJywKICAgIGNvbXBsZXRlVGV4dDogJ29wdGlvbmFsbHksIGdpdmUgYSBzaWRlIG9mIGxlZnQsIHJpZ2h0LCBvciBib3RoIChkZWZhdWx0cyB0byByaWdodCknLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZiwgc2lkZSkgewogICAgICAgIHNlbGYuZWRpdG9yLm1vZGVsLmNoYW5nZUVhY2hSb3coZnVuY3Rpb24ocm93KSB7CiAgICAgICAgICAgIGlmICghc2lkZSkgc2lkZSA9ICJyaWdodCI7CiAgICAgICAgICAgIGlmIChbImxlZnQiLCAiYm90aCJdLmluY2x1ZGUoc2lkZSkpIHsKICAgICAgICAgICAgICAgIHdoaWxlIChyb3cuZmlyc3QoKSA9PSAnICcpIHsKICAgICAgICAgICAgICAgICAgICByb3cuc2hpZnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoWyJyaWdodCIsICJib3RoIl0uaW5jbHVkZShzaWRlKSkgewogICAgICAgICAgICAgICAgdmFyIGkgPSByb3cubGVuZ3RoIC0gMTsKCiAgICAgICAgICAgICAgICB3aGlsZSAocm93W2ldID09ICcgJykgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSByb3dbaV07CiAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByb3c7CiAgICAgICAgfSk7CiAgICB9Cn0pOwoKLy8gKioge3t7Q29tbWFuZDogYmluZGtleX19fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgIG5hbWU6ICdiaW5ka2V5JywKICAgIHRha2VzOiBbJ21vZGlmaWVyJywgJ2tleScsICdhY3Rpb24nXSwKICAgIHByZXZpZXc6ICdCaW5kIGEga2V5IHRvIGFuIGFjdGlvbicsCiAgICBjb21wbGV0ZVRleHQ6ICdnaXZlIGEgbW9kaWZpZXIsIGtleSwgYW5kIGFjdGlvbiBuYW1lJywKICAgIGhpZGRlbjogdHJ1ZSwKICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKHNlbGYsIGFyZ3MpIHsKICAgICAgICBpZiAoYXJncy5tb2RpZmllcnMgPT0gIm5vbmUiKSBhcmdzLm1vZGlmaWVycyA9ICcnOwoKICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOmJpbmRrZXkiLCBhcmdzKTsKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiBpbnNlcnR9fX0gKioKQmVzcGluLkNvbW1hbmRzLmFkZCh7CiAgICBuYW1lOiAnaW5zZXJ0JywKICAgIHRha2VzOiBbJ3RleHQnXSwKICAgIHByZXZpZXc6ICdpbnNlcnQgdGhlIGdpdmVuIHRleHQgYXQgdGhpcyBwb2ludC4nLAogICAgaGlkZGVuOiB0cnVlLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZiwgdGV4dCkgewogICAgICAgIHNlbGYuZWRpdG9yLm1vZGVsLmluc2VydENodW5rKHNlbGYuZWRpdG9yLmN1cnNvclBvc2l0aW9uLCB0ZXh0KTsKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiB0eXBpbmd0ZXN0fX19ICoqCkJlc3Bpbi5Db21tYW5kcy5hZGQoewogICAgbmFtZTogJ3R5cGluZ3Rlc3QnLAogICAgcHJldmlldzogJ3R5cGUgaW4gdGhlIGFscGhhYmV0IGEgZmV3IHRpbWVzJywKICAgIGhpZGRlbjogdHJ1ZSwKICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKHNlbGYpIHsKICAgICAgICB2YXIgc3RhcnQgPSBEYXRlLm5vdygpOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKykgewogICAgICAgICAgICAkUignYScsICd6JykuZWFjaChmdW5jdGlvbihjKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IHsgcG9zOiBCZXNwaW4uRWRpdG9yLlV0aWxzLmNvcHlQb3Moc2VsZi5lZGl0b3IuY3Vyc29yUG9zaXRpb24pIH07CiAgICAgICAgICAgICAgICBhcmdzLm5ld2NoYXIgPSBjOwogICAgICAgICAgICAgICAgc2VsZi5lZGl0b3IudWkuYWN0aW9ucy5pbnNlcnRDaGFyYWN0ZXIoYXJncyk7ICAgICAgICAgICAgCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB2YXIgc3RvcCA9IERhdGUubm93KCk7CiAgICAgICAgCiAgICAgICAgc2VsZi5zaG93SW5mbygiSXQgdG9vayAiICsgKHN0b3AgLSBzdGFydCkgKyAiIG1pbGxpc2Vjb25kcyB0byBkbyB0aGlzIik7ICAgICAgICAKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiB0ZW1wbGF0ZX19fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgIG5hbWU6ICd0ZW1wbGF0ZScsCiAgICB0YWtlczogWyd0eXBlJ10sCiAgICBwcmV2aWV3OiAnaW5zZXJ0IHRlbXBsYXRlcycsCiAgICBjb21wbGV0ZVRleHQ6ICdwYXNzIGluIHRoZSB0ZW1wbGF0ZSBuYW1lJywKICAgIHRlbXBsYXRlczogeyAnaW4nOiAiZm9yICh2YXIga2V5IGluIG9iamVjdCkge1xuXG59In0sCiAgICBleGVjdXRlOiBmdW5jdGlvbihjbWRsaW5lLCB0eXBlKSB7CiAgICAgICAgY21kbGluZS5lZGl0b3IubW9kZWwuaW5zZXJ0Q2h1bmsoY21kbGluZS5lZGl0b3IuY3Vyc29yUG9zaXRpb24sIHRoaXMudGVtcGxhdGVzW3R5cGVdKTsKICAgIH0KfSk7CgovLyAqKiB7e3tDb21tYW5kOiBhbGlhc319fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgIG5hbWU6ICdhbGlhcycsCiAgICB0YWtlczogWydhbGlhcycsICdjb21tYW5kJ10sCiAgICBwcmV2aWV3OiAnZGVmaW5lIGFuZCBzaG93IGFsaWFzZXMgZm9yIGNvbW1hbmRzJywKICAgIGNvbXBsZXRlVGV4dDogJ29wdGlvbmFsbHksIGFkZCB5b3VyIGFsaWFzIG5hbWUsIGFuZCB0aGVuIHRoZSBjb21tYW5kIG5hbWUnLAogICAgZXhlY3V0ZTogZnVuY3Rpb24oc2VsZiwgYXJncykgewogICAgICB2YXIgb3V0cHV0OwogICAgICBpZiAoIWFsaWFzKSB7IC8vIC0tIHNob3cgYWxsCiAgICAgICAgb3V0cHV0ID0gIjx1PllvdXIgQWxpYXNlczwvdT48YnIvPjxici8+IjsKICAgICAgICBmb3IgKHZhciB4IGluIHNlbGYuYWxpYXNlcykgewogICAgICAgICAgb3V0cHV0ICs9IHggKyAiOiAiICsgc2VsZi5hbGlhc2VzW3hdICsgIjxici8+IjsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGFyZ3MuY29tbWFuZCA9PSB1bmRlZmluZWQpIHsgLy8gc2hvdyBpdAogICAgICAgICAgb3V0cHV0ID0gIjx1PllvdXIgYWxpYXM8L3U+PGJyLz48YnIvPiI7CiAgICAgICAgICBvdXRwdXQgKz0gYXJncy5hbGlhcyArICI6ICIgKyBzZWxmLmFsaWFzZXNbYXJncy5hbGlhc107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBrZXkgPSBhcmdzLmFsaWFzOwogICAgICAgICAgdmFyIHZhbHVlID0gYXJncy5jb21tYW5kOwogICAgICAgICAgb3V0cHV0ID0gIjx1PlNhdmluZyBzZXR0aW5nPC91Pjxici8+PGJyLz4iOwogICAgICAgICAgaWYgKHNlbGYuY29tbWFuZHNbdmFsdWVdKSB7CiAgICAgICAgICAgICAgb3V0cHV0ICs9IGtleSArICI6ICIgKyB2YWx1ZTsKICAgICAgICAgICAgc2VsZi5hbGlhc2VzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoc2VsZi5hbGlhc2VzW3ZhbHVlXSkgeyAvLyBUT0RPOiBoYXZlIHRoZSBzeW1saW5rIHRvIHRoZSBhbGlhcyBub3QgdGhlIGVuZCBwb2ludAogICAgICAgICAgICAgIG91dHB1dCArPSBrZXkgKyAiOiAiICsgc2VsZi5hbGlhc2VzW3ZhbHVlXSArICIgKCIgKyB2YWx1ZSArICIgd2FzIGFuIGFsaWFzIGl0c2VsZikiOwogICAgICAgICAgICBzZWxmLmFsaWFzZXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb3V0cHV0ICs9ICJTb3JyeSwgbm8gY29tbWFuZCBvciBhbGlhcyB3aXRoIHRoYXQgbmFtZS4iCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHNlbGYuc2hvd0luZm8ob3V0cHV0KTsKICAgIH0sCn0pOwoKLy8gKioge3t7Q29tbWFuZDogaGlzdG9yeX19fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgIG5hbWU6ICdoaXN0b3J5JywKICAgIHByZXZpZXc6ICdzaG93IGhpc3Rvcnkgb2YgdGhlIGNvbW1hbmRzJywKICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKHNlbGYpIHsKICAgICAgICBzZWxmLnNob3dJbmZvKCc8dT5Db21tYW5kIEhpc3Rvcnk8L3U+PGJyLz48YnIvPicgKyBzZWxmLmNvbW1hbmRMaW5lSGlzdG9yeS5oaXN0b3J5LmpvaW4oJzxici8+JykpOwogICAgfQp9KTsKCi8vICoqIHt7e0NvbW1hbmQ6IHVzZX19fSAqKgpCZXNwaW4uQ29tbWFuZHMuYWRkKHsKICAgIG5hbWU6ICd1c2UnLAogICAgcHJldmlldzogJ3VzZSBwYXR0ZXJucyB0byBicmluZyBpbiBjb2RlJywKICAgIGNvbXBsZXRlVGV4dDogJyJzb3VuZCIgd2lsbCBhZGQgc291bmQgc3VwcG9ydCcsCiAgICBsaWJuYW1lczogewogICAgICAgICdqcXVlcnknOiAnanF1ZXJ5Lm1pbi5qcycKICAgIH0sCiAgICBleGVjdXRlOiBmdW5jdGlvbihzZWxmLCB0eXBlKSB7CiAgICAgICAgaWYgKHR5cGUgPT0gJ3NvdW5kJykgewogICAgICAgICAgICBzZWxmLmVkaXRvci5tb2RlbC5pbnNlcnRDaHVuayh7IHJvdzogMywgY29sOiAwIH0sCiAgICAgICAgICAgICAgICAnICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCIgc3JjPSJzb3VuZG1hbmFnZXIyLmpzIj48L3NjcmlwdD5cbicpOwogICAgICAgICAgICBzZWxmLmVkaXRvci5tb2RlbC5pbnNlcnRDaHVuayh7IHJvdzogNCwgY29sOiAwIH0sCiAgICAgICAgICAgICAgICAiICA8c2NyaXB0PlxuICB2YXIgc291bmQ7IFxuICBzb3VuZE1hbmFnZXIub25sb2FkID0gZnVuY3Rpb24oKSB7XG4gICAgc291bmQgPSAgc291bmRNYW5hZ2VyLmNyZWF0ZVNvdW5kKCdteVNvdW5kJywnL3BhdGgvdG8vbXlzb3VuZGZpbGUubXAzJyk7XG4gIH1cbiAgPC9zY3JpcHQ+XG4iKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT0gJ2pzJykgewogICAgICAgICAgICB2YXIganNsaWIgPSAnaHR0cDovL2FqYXguZ29vZ2xlYXBpcy5jb20vYWpheC9saWJzL2pxdWVyeS8xLjIuNi9qcXVlcnkubWluLmpzJzsKICAgICAgICAgICAgdmFyIHNjcmlwdCA9ICc8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCIgc3JjPSInICsganNsaWIgKyAnIj48L3NjcmlwdD5cbic7CiAgICAgICAgICAgIHNlbGYuZWRpdG9yLm1vZGVsLmluc2VydENodW5rKHsgcm93OiAzLCBjb2w6IDAgfSwgc2NyaXB0KTsKICAgICAgICB9CiAgICB9Cn0pOwovKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqCiAqIFZlcnNpb246IE1QTCAxLjEKICoKICogVGhlIGNvbnRlbnRzIG9mIHRoaXMgZmlsZSBhcmUgc3ViamVjdCB0byB0aGUgTW96aWxsYSBQdWJsaWMgTGljZW5zZQogKiBWZXJzaW9uIDEuMSAodGhlICJMaWNlbnNlIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluCiAqIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqIGh0dHA6Ly93d3cubW96aWxsYS5vcmcvTVBMLwogKgogKiBTb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiCiAqIGJhc2lzLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcmlnaHRzIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICoKICogVGhlIE9yaWdpbmFsIENvZGUgaXMgQmVzcGluLgogKgogKiBUaGUgSW5pdGlhbCBEZXZlbG9wZXIgb2YgdGhlIE9yaWdpbmFsIENvZGUgaXMgTW96aWxsYS4KICogUG9ydGlvbnMgY3JlYXRlZCBieSB0aGUgSW5pdGlhbCBEZXZlbG9wZXIgYXJlIENvcHlyaWdodCAoQykgMjAwOQogKiB0aGUgSW5pdGlhbCBEZXZlbG9wZXIuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIENvbnRyaWJ1dG9yKHMpOgogKiAgIEJlc3BpbiBUZWFtIChiZXNwaW5AbW96aWxsYS5jb20pCiAqCiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovCiAKaWYgKHR5cGVvZiBCZXNwaW4gPT0gInVuZGVmaW5lZCIpIEJlc3BpbiA9IHt9OwppZiAoIUJlc3Bpbi5Db21tYW5kcykgQmVzcGluLkNvbW1hbmRzID0ge307CgovLyA9IEJlc3Bpbi5Db21tYW5kcy5FZGl0b3IgPQovLwovLyBUaGlzIGFycmF5IHN0b3JlcyBhbGwgb2YgdGhlIGVkaXRvciBjb21tYW5kcy4KCkJlc3Bpbi5Db21tYW5kcy5FZGl0b3IgPSAkSChCZXNwaW4uQ29tbWFuZHMuU3RvcmUpLmtleXMoKTsvKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqCiAqIFZlcnNpb246IE1QTCAxLjEKICoKICogVGhlIGNvbnRlbnRzIG9mIHRoaXMgZmlsZSBhcmUgc3ViamVjdCB0byB0aGUgTW96aWxsYSBQdWJsaWMgTGljZW5zZQogKiBWZXJzaW9uIDEuMSAodGhlICJMaWNlbnNlIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluCiAqIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqIGh0dHA6Ly93d3cubW96aWxsYS5vcmcvTVBMLwogKgogKiBTb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiCiAqIGJhc2lzLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcmlnaHRzIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICoKICogVGhlIE9yaWdpbmFsIENvZGUgaXMgQmVzcGluLgogKgogKiBUaGUgSW5pdGlhbCBEZXZlbG9wZXIgb2YgdGhlIE9yaWdpbmFsIENvZGUgaXMgTW96aWxsYS4KICogUG9ydGlvbnMgY3JlYXRlZCBieSB0aGUgSW5pdGlhbCBEZXZlbG9wZXIgYXJlIENvcHlyaWdodCAoQykgMjAwOQogKiB0aGUgSW5pdGlhbCBEZXZlbG9wZXIuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIENvbnRyaWJ1dG9yKHMpOgogKiAgIEJlc3BpbiBUZWFtIChiZXNwaW5AbW96aWxsYS5jb20pCiAqCiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovCiAKLy8gPSBGaWxlU3lzdGVtID0KLy8KLy8gVGhpcyBhYnN0cmFjdHMgdGhlIHJlbW90ZSBXZWIgU2VydmljZSBmaWxlIHN5c3RlbSwgYW5kIGluIHRoZSBmdXR1cmUKLy8gbG9jYWwgZmlsZSBzeXN0ZW1zIHRvby4KLy8gCi8vIEl0IHRpZXMgaW50byB0aGUge3t7U2VydmVyfX19IG9iamVjdCBmb3IgcmVtb3RlIGFjY2VzcwoKaWYgKHR5cGVvZiBCZXNwaW4gPT0gInVuZGVmaW5lZCIpIEJlc3BpbiA9IHt9OwoKQmVzcGluLkZpbGVTeXN0ZW0gPSBDbGFzcy5jcmVhdGUoewoKICAgIC8vICoqIHt7eyBGaWxlU3lzdGVtLm5ld0ZpbGUocHJvamVjdCwgcGF0aCwgY2FsbGJhY2spIH19fQogICAgLy8KICAgIC8vIENyZWF0ZSBhIG5ldyBmaWxlIGluIHRoZSBmaWxlIHN5c3RlbSB1c2luZzoKICAgIC8vCiAgICAvLyAqIHt7e3Byb2plY3R9fX0gaXMgdGhlIG5hbWUgb2YgdGhlIHByb2plY3QgdG8gY3JlYXRlIHRoZSBmaWxlIGluCiAgICAvLyAqIHt7e3BhdGh9fX0gaXMgdGhlIGZ1bGwgcGF0aCB0byBzYXZlIHRoZSBmaWxlIGludG8KICAgIC8vICoge3t7b25TdWNjZXNzfX19IGlzIGEgY2FsbGJhY2sgdG8gZmlyZSBpZiB0aGUgZmlsZSBpcyBjcmVhdGVkCiAgICBuZXdGaWxlOiBmdW5jdGlvbihwcm9qZWN0LCBwYXRoLCBvblN1Y2Nlc3MpIHsKICAgICAgICB0aGlzLndoZW5GaWxlRG9lc05vdEV4aXN0KHByb2plY3QsIHBhdGgsIHsKICAgICAgICAgICAgZXhlY3V0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBfZWRpdFNlc3Npb24uc3RhcnRTZXNzaW9uKHByb2plY3QsIHBhdGggfHwgIm5ldy50eHQiKTsKICAgICAgICAgICAgICAgIG9uU3VjY2VzcygpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBlbHNlRmFpbGVkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmZpcmUoImJlc3BpbjpjbWRsaW5lOnNob3dpbmZvIiwgeyBtc2c6ICdUaGUgZmlsZSAnICsgcGF0aCArICcgYWxyZWFkeSBleGlzdHMgbXkgZnJpZW5kLid9KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKCiAgICAvLyAqKiB7e3sgRmlsZVN5c3RlbS5sb2FkRmlsZShwcm9qZWN0LCBwYXRoLCBjYWxsYmFjaykgfX19CiAgICAvLwogICAgLy8gTG9hZCB0aGUgZmlsZSBpbiB0aGUgZ2l2ZW4gcHJvamVjdCBhbmQgcGF0aCBhbmQgZ2V0IGdvaW5nCiAgICAvLwogICAgLy8gKiB7e3twcm9qZWN0fX19IGlzIHRoZSBuYW1lIG9mIHRoZSBwcm9qZWN0IHRoYXQgaG91c2VzIHRoZSBmaWxlCiAgICAvLyAqIHt7e3BhdGh9fX0gaXMgdGhlIGZ1bGwgcGF0aCB0byBsb2FkIHRoZSBmaWxlIGludG8KICAgIC8vICoge3t7b25TdWNjZXNzfX19IGlzIGEgY2FsbGJhY2sgdG8gZmlyZSBpZiB0aGUgZmlsZSBpcyBsb2FkZWQKICAgIC8vICoge3t7ZG9udFN0YXJ0U2Vzc2lvbn19fSBpcyBhIGZsYWcgdG8gdHVybiBvZmYgc3RhcnRpbmcgYSBzZXNzaW9uLiBVc2VkIGluIHRoZSBjb25maWcgbG9hZGluZyBmb3IgZXhhbXBsZQogICAgbG9hZEZpbGU6IGZ1bmN0aW9uKHByb2plY3QsIHBhdGgsIG9uU3VjY2VzcywgZG9udFN0YXJ0U2Vzc2lvbikgewogICAgICAgIGlmICghZG9udFN0YXJ0U2Vzc2lvbikgX2VkaXRTZXNzaW9uLnN0YXJ0U2Vzc2lvbihwcm9qZWN0LCBwYXRoKTsKCiAgICAgICAgX3NlcnZlci5sb2FkRmlsZShwcm9qZWN0LCBwYXRoLCBmdW5jdGlvbihjb250ZW50KSB7CiAgICAgICAgICAgIGlmIChjb250ZW50LmVuZHNXaXRoKCJcbiIpKSBjb250ZW50ID0gY29udGVudC5zdWJzdHIoMCwgY29udGVudC5sZW5ndGggLSAxKTsKCiAgICAgICAgICAgIG9uU3VjY2Vzcyh7CiAgICAgICAgICAgICAgICBuYW1lOiBwYXRoLAogICAgICAgICAgICAgICAgY29udGVudDogY29udGVudCwKICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS5nZXRUaW1lKCkKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICB9LAoKICAgIC8vICoqIHt7eyBGaWxlU3lzdGVtLnByb2plY3RzKGNhbGxiYWNrKSB9fX0KICAgIC8vCiAgICAvLyBSZXR1cm4gYSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBwcm9qZWN0cyB0aGF0IHRoZSB1c2VyIGhhcyBhY2Nlc3MgdG9vCiAgICAvLwogICAgLy8gKiB7e3tjYWxsYmFja319fSBpcyBhIGNhbGxiYWNrIHRoYXQgZmlyZXMgZ2l2ZW4gdGhlIHByb2plY3QgbGlzdAogICAgcHJvamVjdHM6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgX3NlcnZlci5wcm9qZWN0cyhjYWxsYmFjayk7CiAgICB9LAoKICAgIC8vICoqIHt7eyBGaWxlU3lzdGVtLmZpbGVOYW1lcyhjYWxsYmFjaykgfX19CiAgICAvLwogICAgLy8gUmV0dXJuIGEgSlNPTiByZXByZXNlbnRhdGlvbiBvZiB0aGUgZmlsZXMgYXQgdGhlIHJvb3Qgb2YgdGhlIGdpdmVuIHByb2plY3QKICAgIC8vCiAgICAvLyAqIHt7e2NhbGxiYWNrfX19IGlzIGEgY2FsbGJhY2sgdGhhdCBmaXJlcyBnaXZlbiB0aGUgZmlsZXMKICAgIGZpbGVOYW1lczogZnVuY3Rpb24ocHJvamVjdCwgY2FsbGJhY2spIHsKICAgICAgICBfc2VydmVyLmxpc3QocHJvamVjdCwgJycsIGNhbGxiYWNrKTsKICAgIH0sCgogICAgLy8gKioge3t7IEZpbGVTeXN0ZW0uc2F2ZUZpbGUocHJvamVjdCwgZmlsZSkgfX19CiAgICAvLwogICAgLy8gU2F2ZSBhIGZpbGUgdG8gdGhlIGdpdmVuIHByb2plY3QKICAgIC8vCiAgICAvLyAqIHt7e3Byb2plY3R9fX0gaXMgdGhlIG5hbWUgb2YgdGhlIHByb2plY3QgdG8gc2F2ZSBpbnRvCiAgICAvLyAqIHt7e2ZpbGV9fX0gaXMgdGhlIGZpbGUgb2JqZWN0IHRoYXQgY29udGFpbnMgdGhlIHBhdGggYW5kIGNvbnRlbnQgdG8gc2F2ZQogICAgc2F2ZUZpbGU6IGZ1bmN0aW9uKHByb2plY3QsIGZpbGUpIHsKICAgICAgICAvLyBVbml4IGZpbGVzIHNob3VsZCBhbHdheXMgaGF2ZSBhIHRyYWlsaW5nIG5ldy1saW5lOyBhZGQgaWYgbm90IHByZXNlbnQKICAgICAgICBpZiAoIWZpbGUuY29udGVudC5lbmRzV2l0aCgiXG4iKSkgZmlsZS5jb250ZW50ICs9ICJcbiI7CgogICAgICAgIF9zZXJ2ZXIuc2F2ZUZpbGUocHJvamVjdCwgZmlsZS5uYW1lLCBmaWxlLmNvbnRlbnQsIGZpbGUubGFzdE9wKTsKICAgIH0sCgogICAgLy8gKioge3t7IEZpbGVTeXN0ZW0ucmVtb3ZlRmlsZShwcm9qZWN0LCBwYXRoLCBvblN1Y2Nlc3MsIG9uRmFpbHVyZSkgfX19CiAgICAvLwogICAgLy8gUmVtb3ZlIHRoZSBmaWxlIGZyb20gdGhlIGZpbGUgc3lzdGVtCiAgICAvLwogICAgLy8gKiB7e3twcm9qZWN0fX19IGlzIHRoZSBuYW1lIG9mIHRoZSBwcm9qZWN0IHRvIGRlbGV0ZSB0aGUgZmlsZSBmcm9tCiAgICAvLyAqIHt7e3BhdGh9fX0gaXMgdGhlIGZ1bGwgcGF0aCB0byB0aGUgZmlsZSB0byBkZWxldGUKICAgIC8vICoge3t7b25TdWNjZXNzfX19IGlzIHRoZSBjYWxsYmFjayB0byBmaXJlIGlmIHRoZSByZW1vdmUgd29ya3MKICAgIC8vICoge3t7b25GYWlsdXJlfX19IGlzIHRoZSBjYWxsYmFjayB0byBmaXJlIGlmIHRoZSByZW1vdmUgZmFpbHMKICAgIHJlbW92ZUZpbGU6IGZ1bmN0aW9uKHByb2plY3QsIHBhdGgsIG9uU3VjY2Vzcywgb25GYWlsdXJlKSB7CiAgICAgICAgX3NlcnZlci5yZW1vdmVGaWxlKHByb2plY3QsIHBhdGgsIG9uU3VjY2Vzcywgb25GYWlsdXJlKTsKICAgIH0sCgogICAgLy8gKioge3t7IEZpbGVTeXN0ZW0ucmVtb3ZlRmlsZShwcm9qZWN0LCBwYXRoLCBvblN1Y2Nlc3MsIG9uRmFpbHVyZSkgfX19CiAgICAvLwogICAgLy8gQ2xvc2UgdGhlIG9wZW4gc2Vzc2lvbiBmb3IgdGhlIGZpbGUKICAgIC8vCiAgICAvLyAqIHt7e3Byb2plY3R9fX0gaXMgdGhlIG5hbWUgb2YgdGhlIHByb2plY3QgdG8gY2xvc2UgdGhlIGZpbGUgZnJvbQogICAgLy8gKiB7e3twYXRofX19IGlzIHRoZSBmdWxsIHBhdGggdG8gdGhlIGZpbGUgdG8gY2xvc2UKICAgIC8vICoge3t7Y2FsbGJhY2t9fX0gaXMgdGhlIGNhbGxiYWNrIHRvIGZpcmUgd2hlbiBjbG9zZWQKICAgIGNsb3NlRmlsZTogZnVuY3Rpb24ocHJvamVjdCwgcGF0aCwgY2FsbGJhY2spIHsKICAgICAgICBfc2VydmVyLmNsb3NlRmlsZShwcm9qZWN0LCBwYXRoLCBjYWxsYmFjayk7CiAgICB9LAoKICAgIC8vICoqIHt7eyBGaWxlU3lzdGVtLndoZW5GaWxlRXhpc3RzKHByb2plY3QsIHBhdGgsIGNhbGxiYWNrcykgfX19CiAgICAvLwogICAgLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBmaWxlIGV4aXN0cyBhbmQgdGhlbiBydW4gdGhlIGFwcHJvcHJpYXRlIGNhbGxiYWNrCiAgICAvLwogICAgLy8gKiB7e3twcm9qZWN0fX19IGlzIHRoZSBuYW1lIG9mIHRoZSBwcm9qZWN0CiAgICAvLyAqIHt7e3BhdGh9fX0gaXMgdGhlIGZ1bGwgcGF0aCB0byB0aGUgZmlsZQogICAgLy8gKiB7e3tjYWxsYmFja3N9fX0gaXMgdGhlIHBhaXIgb2YgY2FsbGJhY2tzOgogICAgLy8gICBleGVjdXRlIChmaWxlIGV4aXN0cykKICAgIC8vICAgZWxzZUZhaWxlZCAoZmlsZSBkb2VzIG5vdCBleGlzdCkKICAgIHdoZW5GaWxlRXhpc3RzOiBmdW5jdGlvbihwcm9qZWN0LCBwYXRoLCBjYWxsYmFja3MpIHsKICAgICAgICBfc2VydmVyLmxpc3QocHJvamVjdCwgQmVzcGluLlBhdGguZGlyZWN0b3J5KHBhdGgpLCBmdW5jdGlvbihmaWxlcykgewogICAgICAgICAgICBpZiAoZmlsZXMgJiYgZmlsZXMuaW5jbHVkZShwYXRoKSkgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzWydleGVjdXRlJ10oKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja3NbJ2Vsc2VGYWlsZWQnXSkgY2FsbGJhY2tzWydlbHNlRmFpbGVkJ10oKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKCiAgICAvLyAqKiB7e3sgRmlsZVN5c3RlbS53aGVuRmlsZURvZXNOb3RFeGlzdChwcm9qZWN0LCBwYXRoLCBjYWxsYmFja3MpIH19fQogICAgLy8KICAgIC8vIFRoZSBvcHBvc2l0ZSBvZiB7e3sgRmlsZVN5c3RlbS53aGVuRmlsZUV4aXN0cygpIH19fQogICAgLy8KICAgIC8vICoge3t7cHJvamVjdH19fSBpcyB0aGUgbmFtZSBvZiB0aGUgcHJvamVjdAogICAgLy8gKiB7e3twYXRofX19IGlzIHRoZSBmdWxsIHBhdGggdG8gdGhlIGZpbGUKICAgIC8vICoge3t7Y2FsbGJhY2tzfX19IGlzIHRoZSBwYWlyIG9mIGNhbGxiYWNrczoKICAgIC8vICAgZXhlY3V0ZSAoZmlsZSBkb2VzIG5vdCBleGlzdCkKICAgIC8vICAgZWxzZUZhaWxlZCAoZmlsZSBleGlzdHMpCiAgICB3aGVuRmlsZURvZXNOb3RFeGlzdDogZnVuY3Rpb24ocHJvamVjdCwgcGF0aCwgY2FsbGJhY2tzKSB7CiAgICAgICAgX3NlcnZlci5saXN0KHByb2plY3QsIEJlc3Bpbi5QYXRoLmRpcmVjdG9yeShwYXRoKSwgZnVuY3Rpb24oZmlsZXMpIHsKICAgICAgICAgICAgaWYgKCFmaWxlcyB8fCAhZmlsZXMuaW5jbHVkZShwYXRoKSkgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzWydleGVjdXRlJ10oKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja3NbJ2Vsc2VGYWlsZWQnXSkgY2FsbGJhY2tzWydlbHNlRmFpbGVkJ10oKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKfSk7Ci8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKioKICogVmVyc2lvbjogTVBMIDEuMQogKgogKiBUaGUgY29udGVudHMgb2YgdGhpcyBmaWxlIGFyZSBzdWJqZWN0IHRvIHRoZSBNb3ppbGxhIFB1YmxpYyBMaWNlbnNlCiAqIFZlcnNpb24gMS4xICh0aGUgIkxpY2Vuc2UiKTsgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4KICogY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICogaHR0cDovL3d3dy5tb3ppbGxhLm9yZy9NUEwvCiAqCiAqIFNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIKICogYmFzaXMsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyByaWdodHMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBUaGUgT3JpZ2luYWwgQ29kZSBpcyBCZXNwaW4uCiAqCiAqIFRoZSBJbml0aWFsIERldmVsb3BlciBvZiB0aGUgT3JpZ2luYWwgQ29kZSBpcyBNb3ppbGxhLgogKiBQb3J0aW9ucyBjcmVhdGVkIGJ5IHRoZSBJbml0aWFsIERldmVsb3BlciBhcmUgQ29weXJpZ2h0IChDKSAyMDA5CiAqIHRoZSBJbml0aWFsIERldmVsb3Blci4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogQ29udHJpYnV0b3Iocyk6CiAqICAgQmVzcGluIFRlYW0gKGJlc3BpbkBtb3ppbGxhLmNvbSkKICoKICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi8KCmlmICh0eXBlb2YgQmVzcGluID09ICJ1bmRlZmluZWQiKSBCZXNwaW4gPSB7fTsKaWYgKCFCZXNwaW4uU2V0dGluZ3MpIEJlc3Bpbi5TZXR0aW5ncyA9IHt9OwoKLy8gPSBTZXR0aW5ncyA9Ci8vCi8vIFRoaXMgc2V0dGluZ3MgbW9kdWxlIHByb3ZpZGVzIGEgYmFzZSBpbXBsZW1lbnRhdGlvbiB0byBzdG9yZSBzZXR0aW5ncyBmb3IgdXNlcnMuCi8vIEl0IGFsc28gY29udGFpbnMgdmFyaW91cyAic3RvcmVzIiB0byBzYXZlIHRoYXQgZGF0YSwgaW5jbHVkaW5nOgovLwovLyAqIHt7e0Jlc3Bpbi5TZXR0aW5ncy5Db3JlfX19IDogQ29yZSBpbnRlcmZhY2UgdG8gc2V0dGluZ3MuIFVzZXIgY29kZSBhbHdheXMgZ29lcyB0aHJvdWdoIGhlcmUuCi8vICoge3t7QmVzcGluLlNldHRpbmdzLlNlcnZlcn19fSA6IFRoZSBtYWluIHN0b3JlLiBTYXZlcyBiYWNrIHRvIHRoZSBCZXNwaW4gU2VydmVyIEFQSQovLyAqIHt7e0Jlc3Bpbi5TZXR0aW5ncy5Jbk1lbW9yeX19fSA6IEluIG1lbW9yeSBzZXR0aW5ncyB0aGF0IGFyZSB1c2VkIHByaW1hcmlseSBmb3IgZGVidWdnaW5nCi8vICoge3t7QmVzcGluLlNldHRpbmdzLkNvb2tpZX19fSA6IFN0b3JlIGluIGEgY29va2llIHVzaW5nIGNvb2tpZS1qYXIKLy8gKiB7e3tCZXNwaW4uU2V0dGluZ3MuVVJMfX19IDogSW50ZXJjZXB0IHNldHRpbmdzIGluIHRoZSBVUkwuIE9mdGVuIHVzZWQgdG8gb3ZlcnJpZGUKLy8gKiB7e3tCZXNwaW4uU2V0dGluZ3MuREJ9fX0gOiBDb21tZW50ZWQgb3V0IGZvciBub3csIGJ1dCBhIHdheSB0byBzdG9yZSBzZXR0aW5ncyBsb2NhbGx5Ci8vICoge3t7QmVzcGluLlNldHRpbmdzLkV2ZW50c319fSA6IEN1c3RvbSBldmVudHMgdGhhdCB0aGUgc2V0dGluZ3Mgc3RvcmUgY2FuIGludGVyY2VwdCBhbmQgc2VuZAoKLy8gKioge3t7IEJlc3Bpbi5TZXR0aW5ncy5Db3JlIH19fSAqKgovLwovLyBIYW5kbGVzIGxvYWQvc2F2ZSBvZiB1c2VyIHNldHRpbmdzLgovLyBUT0RPOiB0aWUgaW50byB0aGUgc2Vzc2lvbnMgc2VydmxldDsgZWxpbWluYXRlIEdlYXJzIGRlcGVuZGVuY3kKCkJlc3Bpbi5TZXR0aW5ncy5Db3JlID0gQ2xhc3MuY3JlYXRlKHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYnJvd3Nlck92ZXJyaWRlcyA9IHt9OwogICAgICAgIHRoaXMuZnJvbVVSTCA9IG5ldyBCZXNwaW4uU2V0dGluZ3MuVVJMKCk7CiAgICAgICAgdGhpcy5jdXN0b21FdmVudHMgPSBuZXcgQmVzcGluLlNldHRpbmdzLkV2ZW50cyh0aGlzKTsKCiAgICAgICAgdGhpcy5sb2FkU3RvcmUoKTsgICAgLy8gTG9hZCB1cCB0aGUgY29ycmVjdCBzZXR0aW5ncyBzdG9yZQogICAgfSwKCiAgICBsb2FkU2Vzc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHBhdGggICAgPSB0aGlzLmZyb21VUkwuZ2V0KCdwYXRoJykgfHwgdGhpcy5nZXQoJ19wYXRoJyk7CiAgICAgICAgdmFyIHByb2plY3QgPSB0aGlzLmZyb21VUkwuZ2V0KCdwcm9qZWN0JykgfHwgdGhpcy5nZXQoJ19wcm9qZWN0Jyk7CgogICAgICAgIGRvY3VtZW50LmZpcmUoImJlc3BpbjpzZXR0aW5nczppbml0IiwgeyAvLyAtLSB0aW1lIHRvIGluaXQgbXkgZnJpZW5kcwogICAgICAgICAgICBwYXRoOiBwYXRoLAogICAgICAgICAgICBwcm9qZWN0OiBwcm9qZWN0CiAgICAgICAgfSk7CiAgICB9LAoKICAgIGRlZmF1bHRTZXR0aW5nczogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ2tleWJpbmRpbmdzJzogJ2VtYWNzJywKICAgICAgICAgICAgJ3RhYnNpemUnOiAnMicsCiAgICAgICAgICAgICdmb250c2l6ZSc6ICcxMCcsCiAgICAgICAgICAgICdhdXRvY29tcGxldGUnOiAnb2ZmJywKICAgICAgICAgICAgJ2NvbGxhYm9yYXRlJzogJ29uJywKICAgICAgICAgICAgJ3N5bnRheCc6ICdhdXRvJwogICAgICAgIH07CiAgICB9LAoKICAgIC8vIFRPRE86IE1ha2Ugc3VyZSBJIGNhbiBudWtlIHRoZSBkZWZhdWx0IGZ1bmN0aW9uCiAgICBpbml0U2V0dGluZ3M6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOnNldHRpbmdzOnNldDpjb2xsYWJvcmF0ZSIsIHsKICAgICAgICAgICAgdmFsdWU6IHNlbGYuZ2V0KCJjb2xsYWJvcmF0ZSIpCiAgICAgICAgfSk7CiAgICB9LAoKICAgIGlzT246IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlID09ICdvbicgfHwgdmFsdWUgPT0gJ3RydWUnOwogICAgfSwKCiAgICBpc09mZjogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgPT0gJ29mZicgfHwgdmFsdWUgPT0gJ2ZhbHNlJzsKICAgIH0sCgogICAgLy8gKioge3t7IFNldHRpbmdzLmxvYWRTdG9yZSgpIH19fSAqKgogICAgLy8KICAgIC8vIFRoaXMgaXMgd2hlcmUgd2UgY2hvb3NlIHdoaWNoIHN0b3JlIHRvIGxvYWQKICAgIGxvYWRTdG9yZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zdG9yZSA9IG5ldyBCZXNwaW4uU2V0dGluZ3MuU2VydmVyKHRoaXMpOwoKLy8gICAgICAgIHRoaXMuc3RvcmUgPSBuZXcgQmVzcGluLlNldHRpbmdzLkNvb2tpZSh0aGlzKTsKCi8vIFRPRE86IGlnbm9yZSBnZWFycyBmb3Igbm93OgovLyB0aGlzLnN0b3JlID0gKHdpbmRvd1snZ29vZ2xlJ10pID8gbmV3IEJlc3Bpbi5TZXR0aW5ncy5EQiA6IG5ldyBCZXNwaW4uU2V0dGluZ3MuSW5NZW1vcnk7Ci8vIHRoaXMuc3RvcmUgPSBuZXcgQmVzcGluLlNldHRpbmdzLkluTWVtb3J5OwogICAgfSwKCiAgICB0b0xpc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzZXR0aW5ncyA9IFtdOwogICAgICAgIHZhciBzdG9yZVNldHRpbmdzID0gdGhpcy5zdG9yZS5zZXR0aW5nczsKICAgICAgICBmb3IgKHZhciBwcm9wIGluIHN0b3JlU2V0dGluZ3MpIHsKICAgICAgICAgICAgaWYgKHN0b3JlU2V0dGluZ3MuaGFzT3duUHJvcGVydHkocHJvcCkpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzLnB1c2goeyAna2V5JzogcHJvcCwgJ3ZhbHVlJzogc3RvcmVTZXR0aW5nc1twcm9wXSB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2V0dGluZ3M7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIHRoaXMuc3RvcmUuc2V0KGtleSwgdmFsdWUpOwoKICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46c2V0dGluZ3M6c2V0OiIgKyBrZXksIHsgdmFsdWU6IHZhbHVlIH0pOwogICAgfSwKCiAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHZhciBmcm9tVVJMID0gdGhpcy5mcm9tVVJMLmdldChrZXkpOyAvLyBzaG9ydCBjaXJjdWl0CiAgICAgICAgaWYgKGZyb21VUkwpIHJldHVybiBmcm9tVVJMOwoKICAgICAgICByZXR1cm4gdGhpcy5zdG9yZS5nZXQoa2V5KTsKICAgIH0sCgogICAgdW5zZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHRoaXMuc3RvcmUudW5zZXQoa2V5KTsKICAgIH0sCgogICAgbGlzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnN0b3JlWydsaXN0J10gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zdG9yZS5saXN0KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9MaXN0KCk7CiAgICAgICAgfQogICAgfQoKfSk7CgovLyAqKiB7e3sgQmVzcGluLlNldHRpbmdzLkluTWVtb3J5IH19fSAqKgovLwovLyBEZWJ1Z2dpbmcgaW4gbWVtb3J5IHNldHRpbmdzIChkaWUgd2hlbiBicm93c2VyIGlzIGNsb3NlZCkKCkJlc3Bpbi5TZXR0aW5ncy5Jbk1lbW9yeSA9IENsYXNzLmNyZWF0ZSh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihwYXJlbnQpIHsKICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKCiAgICAgICAgdGhpcy5zZXR0aW5ncyA9IHRoaXMucGFyZW50LmRlZmF1bHRTZXR0aW5ncygpOwoKICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46c2V0dGluZ3M6bG9hZGVkIik7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIHRoaXMuc2V0dGluZ3Nba2V5XSA9IHZhbHVlOwogICAgfSwKCiAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHJldHVybiB0aGlzLnNldHRpbmdzW2tleV07CiAgICB9LAoKICAgIHVuc2V0OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICBkZWxldGUgdGhpcy5zZXR0aW5nc1trZXldOwogICAgfQp9KTsKCi8vICoqIHt7eyBCZXNwaW4uU2V0dGluZ3MuQ29va2llIH19fSAqKgovLwovLyBTYXZlIHRoZSBzZXR0aW5ncyBpbiBhIHt7e0Nvb2tpZUphcn19fQoKQmVzcGluLlNldHRpbmdzLkNvb2tpZSA9IENsYXNzLmNyZWF0ZSh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihwYXJlbnQpIHsKICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICB0aGlzLmphciA9IG5ldyBDb29raWVKYXIoewogICAgICAgICAgICBleHBpcmVzOiAzNjAwLCAvLyBzZWNvbmRzCiAgICAgICAgICAgIHBhdGg6ICcvJwogICAgICAgIH0pOwoKICAgICAgICB2YXIgZnJvbUphciA9IHRoaXMuamFyLmdldCgnc2V0dGluZ3MnKTsKCiAgICAgICAgaWYgKGZyb21KYXIpIHsKICAgICAgICAgICAgdGhpcy5zZXR0aW5ncyA9IGZyb21KYXI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5zZXR0aW5ncyA9IHsKICAgICAgICAgICAgICAgICdrZXliaW5kaW5ncyc6ICdlbWFjcycsCiAgICAgICAgICAgICAgICAndGFic2l6ZSc6ICcyJywKICAgICAgICAgICAgICAgICdmb250c2l6ZSc6ICcxMCcsCiAgICAgICAgICAgICAgICAnYXV0b2NvbXBsZXRlJzogJ29mZicsCiAgICAgICAgICAgICAgICAnY29sbGFib3JhdGUnOiAnb24nLAogICAgICAgICAgICAgICAgJ191c2VybmFtZSc6ICdkaW9uJwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmphci5wdXQoJ3NldHRpbmdzJywgdGhpcy5zZXR0aW5ncyk7CiAgICAgICAgfQogICAgICAgIGRvY3VtZW50LmZpcmUoImJlc3BpbjpzZXR0aW5nczpsb2FkZWQiKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXR0aW5nc1trZXldID0gdmFsdWU7CiAgICAgICAgdGhpcy5qYXIucHV0KCdzZXR0aW5ncycsIHRoaXMuc2V0dGluZ3MpOwogICAgfSwKCiAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHJldHVybiB0aGlzLnNldHRpbmdzW2tleV07CiAgICB9LAoKICAgIHVuc2V0OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICBkZWxldGUgdGhpcy5zZXR0aW5nc1trZXldOwogICAgICAgIHRoaXMuamFyLnB1dCgnc2V0dGluZ3MnLCB0aGlzLnNldHRpbmdzKTsKICAgIH0KfSk7CgovLyAqKiB7e3sgQmVzcGluLlNldHRpbmdzLlNlcnZlciB9fX0gKioKLy8KLy8gVGhlIHJlYWwgZ3JhbmQtZGFkZHkgdGhhdCBpbXBsZW1lbnRzIHVzZXMge3t7U2VydmVyfX19IHRvIGFjY2VzcyB0aGUgYmFja2VuZAoKQmVzcGluLlNldHRpbmdzLlNlcnZlciA9IENsYXNzLmNyZWF0ZSh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihwYXJlbnQpIHsKICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICB0aGlzLnNlcnZlciA9IF9zZXJ2ZXI7CgogICAgICAgIC8vIFRPRE86IHNlZWQgdGhlIHNldHRpbmdzCiAgICAgICAgdGhpcy5zZXJ2ZXIubGlzdFNldHRpbmdzKGZ1bmN0aW9uKHNldHRpbmdzKSB7CiAgICAgICAgICAgIHRoaXMuc2V0dGluZ3MgPSBzZXR0aW5nczsKICAgICAgICAgICAgaWYgKHNldHRpbmdzWyd0YWJzaXplJ10gPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldHRpbmdzID0gdGhpcy5wYXJlbnQuZGVmYXVsdFNldHRpbmdzKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNlcnZlci5zZXRTZXR0aW5ncyh0aGlzLnNldHRpbmdzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOnNldHRpbmdzOmxvYWRlZCIpOwogICAgICAgIH0uYmluZCh0aGlzKSk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIHRoaXMuc2V0dGluZ3Nba2V5XSA9IHZhbHVlOwogICAgICAgIHRoaXMuc2VydmVyLnNldFNldHRpbmcoa2V5LCB2YWx1ZSk7CiAgICB9LAoKICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0dGluZ3Nba2V5XTsKICAgIH0sCgogICAgdW5zZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIGRlbGV0ZSB0aGlzLnNldHRpbmdzW2tleV07CiAgICAgICAgdGhpcy51bnNldFNldHRpbmcoa2V5KTsKICAgIH0KfSk7CgoKLy8gKioge3t7IEJlc3Bpbi5TZXR0aW5ncy5EQiB9fX0gKioKLy8KLy8gVGFrZW4gb3V0IGZvciBub3cgdG8gYWxsb3cgdXMgdG8gbm90IHJlcXVpcmUgZ2VhcnNfZGIuanMgKGFuZCBHZWFycyBpdHNlbGYpLgovLyBFeHBlcmltZW50YWwgYWJpbGl0eSB0byBzYXZlIGxvY2FsbHkgaW4gdGhlIFNRTGl0ZSBkYXRhYmFzZS4KLy8gVGhlIHBsYW4gaXMgdG8gbWlncmF0ZSB0byBBY3RpdmVSZWNvcmQuanMgb3Igc29tZXRoaW5nIGxpa2UgaXQgdG8gYWJzdHJhY3Qgb24gdG9wCi8vIG9mIHZhcmlvdXMgc3RvcmVzIChIVE1MNSwgR2VhcnMsIGdsb2JhbFN0b3JhZ2UsIGV0Yy4pCgovKgovLyB0dXJuIG9mZiBmb3Igbm93IHNvIHdlIGNhbiB0YWtlIGdlYXJzX2RiLmpzIG91dAoKQmVzcGluLlNldHRpbmdzLkRCID0gQ2xhc3MuY3JlYXRlKHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKHBhcmVudCkgewogICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgIHRoaXMuZGIgPSBuZXcgR2VhcnNEQignd2lkZWJveScpOwoKICAgICAgICAvL3RoaXMuZGIucnVuKCdkcm9wIHRhYmxlIHNldHRpbmdzJyk7CiAgICAgICAgdGhpcy5kYi5ydW4oJ2NyZWF0ZSB0YWJsZSBpZiBub3QgZXhpc3RzIHNldHRpbmdzICgnICsKICAgICAgICAgICAgICAgJ2lkIGludGVnZXIgcHJpbWFyeSBrZXksJyArCiAgICAgICAgICAgICAgICdrZXkgdmFyY2hhcigyNTUpIHVuaXF1ZSBub3QgbnVsbCwnICsKICAgICAgICAgICAgICAgJ3ZhbHVlIHZhcmNoYXIoMjU1KSBub3QgbnVsbCwnICsKICAgICAgICAgICAgICAgJ3RpbWVzdGFtcCBpbnQgbm90IG51bGwpJyk7CgogICAgICAgIHRoaXMuZGIucnVuKCdDUkVBVEUgSU5ERVggSUYgTk9UIEVYSVNUUyBzZXR0aW5nc19pZF9pbmRleCBPTiBzZXR0aW5ncyAoaWQpJyk7CiAgICAgICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOnNldHRpbmdzOmxvYWRlZCIpOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICB0aGlzLmRiLmZvcmNlUm93KCdzZXR0aW5ncycsIHsgJ2tleSc6IGtleSwgJ3ZhbHVlJzogdmFsdWUsIHRpbWVzdGFtcDogbmV3IERhdGUoKS5nZXRUaW1lKCkgfSwgJ2tleScpOwogICAgfSwKCiAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHZhciBycyA9IHRoaXMuZGIucnVuKCdzZWxlY3QgZGlzdGluY3QgdmFsdWUgZnJvbSBzZXR0aW5ncyB3aGVyZSBrZXkgPSA/JywgWyBrZXkgXSk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKHJzICYmIHJzLmlzVmFsaWRSb3coKSkgewogICAgICAgICAgICAgIHJldHVybiBycy5maWVsZCgwKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coZS5tZXNzYWdlKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBycy5jbG9zZSgpOwogICAgICAgIH0KICAgIH0sCgogICAgdW5zZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHRoaXMuZGIucnVuKCdkZWxldGUgZnJvbSBzZXR0aW5ncyB3aGVyZSBrZXkgPSA/JywgWyBrZXkgXSk7CiAgICB9LAoKICAgIGxpc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIFRPRE86IE5lZWQgdG8gb3ZlcnJpZGUgd2l0aCBicm93c2VyIHNldHRpbmdzCiAgICAgICAgcmV0dXJuIHRoaXMuZGIuc2VsZWN0Um93cygnc2V0dGluZ3MnLCAnMT0xJyk7CiAgICB9LAoKICAgIC8vIC0tIFByaXZhdGUteQogICAgc2VlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5kYi5ydW4oJ2RlbGV0ZSBmcm9tIHNldHRpbmdzJyk7CgogICAgICAgIC8vIFRPRE86IGxvb3AgdGhyb3VnaCB0aGUgc2V0dGluZ3MKICAgICAgICB0aGlzLmRiLnJ1bignaW5zZXJ0IGludG8gc2V0dGluZ3MgKGtleSwgdmFsdWUsIHRpbWVzdGFtcCkgdmFsdWVzICg/LCA/LCA/KScsIFsna2V5YmluZGluZ3MnLCAnZW1hY3MnLCAxMTgzODc4MDAwMDAwXSk7CiAgICAgICAgdGhpcy5kYi5ydW4oJ2luc2VydCBpbnRvIHNldHRpbmdzIChrZXksIHZhbHVlLCB0aW1lc3RhbXApIHZhbHVlcyAoPywgPywgPyknLCBbJ3RhYnNpemUnLCAnMicsIDExODM4NzgwMDAwMDBdKTsKICAgICAgICB0aGlzLmRiLnJ1bignaW5zZXJ0IGludG8gc2V0dGluZ3MgKGtleSwgdmFsdWUsIHRpbWVzdGFtcCkgdmFsdWVzICg/LCA/LCA/KScsIFsnZm9udHNpemUnLCAnMTAnLCAxMTgzODc4MDAwMDAwXSk7CiAgICAgICAgdGhpcy5kYi5ydW4oJ2luc2VydCBpbnRvIHNldHRpbmdzIChrZXksIHZhbHVlLCB0aW1lc3RhbXApIHZhbHVlcyAoPywgPywgPyknLCBbJ2F1dG9jb21wbGV0ZScsICdvZmYnLCAxMTgzODc4MDAwMDAwXSk7CiAgICB9Cn0pOwoqLwoKLy8gKioge3t7IEJlc3Bpbi5TZXR0aW5ncy5VUkwgfX19ICoqCi8vCi8vIEdyYWIgdGhlIHNldHRpbmcgZnJvbSB0aGUgVVJMLCBlaXRoZXIgdmlhICMgb3IgPwoKQmVzcGluLlNldHRpbmdzLlVSTCA9IENsYXNzLmNyZWF0ZSh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihxdWVyeVN0cmluZykgewogICAgICAgIHRoaXMucXVlcnlTdHJpbmcgPSB0aGlzLnN0cmlwSGFzaChxdWVyeVN0cmluZyB8fCB3aW5kb3cubG9jYXRpb24uaGFzaCk7CiAgICAgICAgdGhpcy5yZXN1bHRzID0gdGhpcy5xdWVyeVN0cmluZy50b1F1ZXJ5UGFyYW1zKCk7CiAgICB9LAoKICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgcmV0dXJuIHRoaXMucmVzdWx0c1trZXldOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICB0aGlzLnJlc3VsdHNba2V5XSA9IHZhbHVlOwogICAgfSwKICAgIAogICAgc3RyaXBIYXNoOiBmdW5jdGlvbih1cmwpIHsKICAgICAgICB2YXIgdG9iZSA9IHVybC5zcGxpdCgnJyk7CiAgICAgICAgdG9iZS5zaGlmdCgpOwogICAgICAgIHJldHVybiB0b2JlLmpvaW4oJycpOwogICAgfQp9KTsKCi8vICoqIHt7eyBCZXNwaW4uU2V0dGluZ3MuRXZlbnRzIH19fSAqKgovLwovLyBDdXN0b20gRXZlbnQgaG9sZGVyIGZvciB0aGUgU2V0dGluZ3Mgd29yay4gCi8vIEl0IGRlYWxzIHdpdGggYm90aCBzZXR0aW5ncyB0aGVtc2VsdmVzLCBhbmQgb3RoZXIgZXZlbnRzIHRoYXQKLy8gc2V0dGluZ3MgbmVlZCB0byB3YXRjaCBhbmQgbG9vayBmb3IKCkJlc3Bpbi5TZXR0aW5ncy5FdmVudHMgPSBDbGFzcy5jcmVhdGUoewogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oc2V0dGluZ3MpIHsKICAgICAgICB0aGlzLnNldHRpbmdzID0gc2V0dGluZ3M7CgogICAgICAgIC8vICoqIHt7eyBFdmVudDogYmVzcGluOnNldHRpbmdzOnNldCB9fX0gKioKICAgICAgICAvLyAKICAgICAgICAvLyBXYXRjaCBmb3Igc29tZW9uZSB3YW50aW5nIHRvIGRvIGEgc2V0IG9wZXJhdGlvbgogICAgICAgIGRvY3VtZW50Lm9ic2VydmUoImJlc3BpbjpzZXR0aW5nczpzZXQiLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICB2YXIga2V5ID0gZXZlbnQubWVtby5rZXk7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGV2ZW50Lm1lbW8udmFsdWU7CgogICAgICAgICAgICBzZXR0aW5ncy5zZXQoa2V5LCB2YWx1ZSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vICoqIHt7eyBFdmVudDogYmVzcGluOmVkaXRvcjpvcGVuZmlsZTpvcGVuc3VjY2VzcyB9fX0gKioKICAgICAgICAvLyAKICAgICAgICAvLyBDaGFuZ2UgdGhlIHNlc3Npb24gc2V0dGluZ3Mgd2hlbiBhIG5ldyBmaWxlIGlzIG9wZW5lZAogICAgICAgIGRvY3VtZW50Lm9ic2VydmUoImJlc3BpbjplZGl0b3I6b3BlbmZpbGU6b3BlbnN1Y2Nlc3MiLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICB2YXIgZmlsZSA9IGV2ZW50Lm1lbW8uZmlsZTsKCiAgICAgICAgICAgIF9lZGl0U2Vzc2lvbi5wYXRoID0gZmlsZS5uYW1lOwoKICAgICAgICAgICAgc2V0dGluZ3Muc2V0KCdfcHJvamVjdCcsICBfZWRpdFNlc3Npb24ucHJvamVjdCk7CiAgICAgICAgICAgIHNldHRpbmdzLnNldCgnX3BhdGgnLCAgICAgX2VkaXRTZXNzaW9uLnBhdGgpOwogICAgICAgICAgICBzZXR0aW5ncy5zZXQoJ191c2VybmFtZScsIF9lZGl0U2Vzc2lvbi51c2VybmFtZSk7CgogICAgICAgICAgICBpZiAoX2VkaXRTZXNzaW9uLnN5bmNIZWxwZXIpIF9lZGl0U2Vzc2lvbi5zeW5jSGVscGVyLnN5bmNXaXRoU2VydmVyKCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vICoqIHt7eyBFdmVudDogYmVzcGluOmVkaXRvcjpvcGVuZmlsZTpvcGVuc3VjY2VzcyB9fX0gKioKICAgICAgICAvLyAKICAgICAgICAvLyBDaGFuZ2UgdGhlIHN5bnRheCBoaWdobGlnaHRlciB3aGVuIGEgbmV3IGZpbGUgaXMgb3BlbmVkCiAgICAgICAgZG9jdW1lbnQub2JzZXJ2ZSgiYmVzcGluOmVkaXRvcjpvcGVuZmlsZTpvcGVuc3VjY2VzcyIsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBmaWxlID0gZXZlbnQubWVtby5maWxlOwogICAgICAgICAgICB2YXIgdHlwZSA9IGZpbGUubmFtZS5zcGxpdCgnLicpLmxhc3QoKTsKCiAgICAgICAgICAgIGlmICh0eXBlKQogICAgICAgICAgICAgICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOnNldHRpbmdzOnN5bnRheCIsIHsgbGFuZ3VhZ2U6IHR5cGUgfSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vICoqIHt7eyBFdmVudDogYmVzcGluOnNldHRpbmdzOnNldDpzeW50YXggfX19ICoqCiAgICAgICAgLy8gCiAgICAgICAgLy8gV2hlbiB0aGUgc3ludGF4IHNldHRpbmcgaXMgY2hhbmdlZCwgdGVsbCB0aGUgc3ludGF4IHN5c3RlbSB0byBjaGFuZ2UKICAgICAgICBkb2N1bWVudC5vYnNlcnZlKCJiZXNwaW46c2V0dGluZ3M6c2V0OnN5bnRheCIsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGV2ZW50Lm1lbW8udmFsdWU7CiAgICAgICAgICAgIAogICAgICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46c2V0dGluZ3M6c3ludGF4IiwgeyBsYW5ndWFnZTogdmFsdWUsIGZyb21Db21tYW5kOiB0cnVlIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyAqKiB7e3sgRXZlbnQ6IGJlc3BpbjpzZXR0aW5nczpzeW50YXggfX19ICoqCiAgICAgICAgLy8gCiAgICAgICAgLy8gR2l2ZW4gYSBuZXcgc3ludGF4IGNvbW1hbmQsIGNoYW5nZSB0aGUgZWRpdG9yLmxhbmd1YWdlICAgICAgICAKICAgICAgICBkb2N1bWVudC5vYnNlcnZlKCJiZXNwaW46c2V0dGluZ3M6c3ludGF4IiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIGxhbmd1YWdlID0gZXZlbnQubWVtby5sYW5ndWFnZTsKICAgICAgICAgICAgdmFyIGZyb21Db21tYW5kID0gZXZlbnQubWVtby5mcm9tQ29tbWFuZDsKICAgICAgICAgICAgdmFyIHN5bnRheFNldHRpbmcgPSBzZXR0aW5ncy5nZXQoJ3N5bnRheCcpIHx8ICJvZmYiOwoKICAgICAgICAgICAgaWYgKGxhbmd1YWdlID09IF9lZGl0b3IubGFuZ3VhZ2UpIHJldHVybjsgLy8gYWxyZWFkeSBzZXQgdG8gYmUgdGhhdCBsYW5ndWFnZQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKFsnYXV0bycsICdvbiddLmluY2x1ZGUobGFuZ3VhZ2UpKSB7CiAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGxvY2F0aW9uLmhhc2guc3BsaXQoJy4nKS5sYXN0KCk7CiAgICAgICAgICAgICAgICBpZiAodHlwZSkgX2VkaXRvci5sYW5ndWFnZSA9IHR5cGU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoWydhdXRvJywgJ29uJ10uaW5jbHVkZShzeW50YXhTZXR0aW5nKSB8fCBmcm9tQ29tbWFuZCkgewogICAgICAgICAgICAgICAgX2VkaXRvci5sYW5ndWFnZSA9IGxhbmd1YWdlOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN5bnRheFNldHRpbmcgPT0gJ29mZicpIHsKICAgICAgICAgICAgICAgIF9lZGl0b3IubGFuZ3VhZ2UgPSAnb2ZmJzsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyAqKiB7e3sgRXZlbnQ6IGJlc3BpbjpzZXR0aW5nczpzZXQ6Y29sbGFib3JhdGUgfX19ICoqCiAgICAgICAgLy8gCiAgICAgICAgLy8gVHVybiBvbiB0aGUgY29sbGFib3JhdGlvbiBzeXN0ZW0gaWYgc2V0IHRvIGJlIG9uCiAgICAgICAgZG9jdW1lbnQub2JzZXJ2ZSgiYmVzcGluOnNldHRpbmdzOnNldDpjb2xsYWJvcmF0ZSIsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGV2ZW50Lm1lbW8udmFsdWU7CgogICAgICAgICAgICBfZWRpdFNlc3Npb24uY29sbGFib3JhdGUgPSBzZXR0aW5ncy5pc09uKHZhbHVlKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gKioge3t7IEV2ZW50OiBiZXNwaW46c2V0dGluZ3M6c2V0OmZvbnRzaXplIH19fSAqKgogICAgICAgIC8vIAogICAgICAgIC8vIENoYW5nZSB0aGUgZm9udCBzaXplIGZvciB0aGUgZWRpdG9yCiAgICAgICAgZG9jdW1lbnQub2JzZXJ2ZSgiYmVzcGluOnNldHRpbmdzOnNldDpmb250c2l6ZSIsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGV2ZW50Lm1lbW8udmFsdWU7CgogICAgICAgICAgICB2YXIgZm9udHNpemUgPSBwYXJzZUludCh2YWx1ZSk7CiAgICAgICAgICAgIF9lZGl0b3IudGhlbWUubGluZU51bWJlckZvbnQgPSBmb250c2l6ZSArICJwdCBNb25hY28sIEx1Y2lkYSBDb25zb2xlLCBtb25vc3BhY2UiOwogICAgICAgIH0pOwoKICAgICAgICAvLyAqKiB7e3sgRXZlbnQ6IGJlc3BpbjpzZXR0aW5nczpzZXQ6dGhlbWUgfX19ICoqCiAgICAgICAgLy8gCiAgICAgICAgLy8gQ2hhbmdlIHRoZSBUaGVtZSBvYmplY3QgdXNlZCBieSB0aGUgZWRpdG9yCiAgICAgICAgZG9jdW1lbnQub2JzZXJ2ZSgiYmVzcGluOnNldHRpbmdzOnNldDp0aGVtZSIsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciB0aGVtZSA9IGV2ZW50Lm1lbW8udmFsdWU7CgogICAgICAgICAgICBpZiAodGhlbWUpIHsKICAgICAgICAgICAgICAgIHZhciB0aGVtZVNldHRpbmdzID0gQmVzcGluLlRoZW1lc1t0aGVtZV07CgogICAgICAgICAgICAgICAgaWYgKHRoZW1lU2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhlbWVTZXR0aW5ncyAhPSBfZWRpdG9yLnRoZW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2VkaXRvci50aGVtZSA9IHRoZW1lU2V0dGluZ3M7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46Y21kbGluZTpzaG93aW5mbyIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgbXNnOiAiU29ycnkgb2xkIGNoYXAuIE5vIHRoZW1lIGNhbGxlZCAnIiArIHRoZW1lICsgIicuIEZhbmN5IG1ha2luZyBpdD8iCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgLy8gKioge3t7IEV2ZW50OiBiZXNwaW46c2V0dGluZ3M6c2V0OmtleWJpbmRpbmdzIH19fSAqKgogICAgICAgIC8vIAogICAgICAgIC8vIEFkZCBpbiBlbWFjcyBrZXkgYmluZGluZ3MKICAgICAgICBkb2N1bWVudC5vYnNlcnZlKCJiZXNwaW46c2V0dGluZ3M6c2V0OmtleWJpbmRpbmdzIiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gZXZlbnQubWVtby52YWx1ZTsKCiAgICAgICAgICAgIGlmICh2YWx1ZSA9PSAiZW1hY3MiKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOmJpbmRrZXkiLCB7CiAgICAgICAgICAgICAgICAgICAgbW9kaWZpZXJzOiAiY3RybCIsCiAgICAgICAgICAgICAgICAgICAga2V5OiAiYiIsCiAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiAibW92ZUN1cnNvckxlZnQiCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOmJpbmRrZXkiLCB7CiAgICAgICAgICAgICAgICAgICAgbW9kaWZpZXJzOiAiY3RybCIsCiAgICAgICAgICAgICAgICAgICAga2V5OiAiZiIsCiAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiAibW92ZUN1cnNvclJpZ2h0IgogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOmVkaXRvcjpiaW5ka2V5IiwgewogICAgICAgICAgICAgICAgICAgIG1vZGlmaWVyczogImN0cmwiLAogICAgICAgICAgICAgICAgICAgIGtleTogInAiLAogICAgICAgICAgICAgICAgICAgIGFjdGlvbjogIm1vdmVDdXJzb3JVcCIKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGRvY3VtZW50LmZpcmUoImJlc3BpbjplZGl0b3I6YmluZGtleSIsIHsKICAgICAgICAgICAgICAgICAgICBtb2RpZmllcnM6ICJjdHJsIiwKICAgICAgICAgICAgICAgICAgICBrZXk6ICJuIiwKICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICJtb3ZlQ3Vyc29yRG93biIKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGRvY3VtZW50LmZpcmUoImJlc3BpbjplZGl0b3I6YmluZGtleSIsIHsKICAgICAgICAgICAgICAgICAgICBtb2RpZmllcnM6ICJjdHJsIiwKICAgICAgICAgICAgICAgICAgICBrZXk6ICJhIiwKICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICJtb3ZlVG9MaW5lU3RhcnQiCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOmJpbmRrZXkiLCB7CiAgICAgICAgICAgICAgICAgICAgbW9kaWZpZXJzOiAiY3RybCIsCiAgICAgICAgICAgICAgICAgICAga2V5OiAiZSIsCiAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiAibW92ZVRvTGluZUVuZCIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgLy8gKioge3t7IEV2ZW50OiBiZXNwaW46c2V0dGluZ3M6aW5pdCB9fX0gKioKICAgICAgICAvLyAKICAgICAgICAvLyBJZiB3ZSBhcmUgb3BlbmluZyB1cCBhIG5ldyBmaWxlCiAgICAgICAgZG9jdW1lbnQub2JzZXJ2ZSgiYmVzcGluOnNldHRpbmdzOmluaXQiLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICB2YXIgcGF0aCAgICA9IGV2ZW50Lm1lbW8ucGF0aDsKICAgICAgICAgICAgdmFyIHByb2plY3QgPSBldmVudC5tZW1vLnByb2plY3Q7CgogICAgICAgICAgICAvLyBUT0RPOiB1c2UgdGhlIGFjdGlvbiBhbmQgZG9uJ3QgcnVuIGEgY29tbWFuZCBpdHNlbGYKICAgICAgICAgICAgdmFyIG5ld2ZpbGUgPSBzZXR0aW5ncy5mcm9tVVJMLmdldCgnbmV3Jyk7CiAgICAgICAgICAgIGlmICghbmV3ZmlsZSkgeyAvLyBzY3JhdGNoIGZpbGUKICAgICAgICAgICAgICAgIGlmIChwcm9qZWN0ICYmIChfZWRpdFNlc3Npb24ucHJvamVjdCAhPSBwcm9qZWN0KSkgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmZpcmUoImJlc3BpbjplZGl0b3I6cHJvamVjdDpzZXQiLCB7IHByb2plY3Q6IHByb2plY3QgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHBhdGgpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOm9wZW5maWxlIiwgeyBmaWxlbmFtZTogcGF0aCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyAqKiB7e3sgRXZlbnQ6IGJlc3BpbjpzZXR0aW5nczppbml0IH19fSAqKgogICAgICAgIC8vIAogICAgICAgIC8vIFNldHVwIHRoZSB0aGVtZQogICAgICAgIGRvY3VtZW50Lm9ic2VydmUoImJlc3BpbjpzZXR0aW5nczppbml0IiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgZG9jdW1lbnQuZmlyZSgiYmVzcGluOnNldHRpbmdzOnNldDp0aGVtZSIsIHsKICAgICAgICAgICAgICAgIHZhbHVlOiBzZXR0aW5ncy5nZXQoJ3RoZW1lJykKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vICoqIHt7eyBFdmVudDogYmVzcGluOnNldHRpbmdzOmluaXQgfX19ICoqCiAgICAgICAgLy8gCiAgICAgICAgLy8gQ2hlY2sgZm9yIGF1dG8gbG9hZAogICAgICAgIGRvY3VtZW50Lm9ic2VydmUoImJlc3BpbjpzZXR0aW5nczppbml0IiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKHNldHRpbmdzLmlzT24oc2V0dGluZ3MuZ2V0KCdhdXRvY29uZmlnJykpKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46ZWRpdG9yOmNvbmZpZzpydW4iKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyAqKiB7e3sgRXZlbnQ6IGJlc3BpbjpzZXR0aW5nczppbml0IH19fSAqKgogICAgICAgIC8vIAogICAgICAgIC8vIFNldHVwIHRoZSBmb250IHNpemUgdGhhdCB0aGUgdXNlciBoYXMgY29uZmlndXJlZAogICAgICAgIGRvY3VtZW50Lm9ic2VydmUoImJlc3BpbjpzZXR0aW5nczppbml0IiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIGZvbnRzaXplID0gc2V0dGluZ3MuZ2V0KCdmb250c2l6ZScpOwogICAgICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46c2V0dGluZ3M6c2V0OmZvbnRzaXplIiwgewogICAgICAgICAgICAgICAgdmFsdWU6IGZvbnRzaXplCiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOyAgICAgICAgCiAgICB9Cn0pOwovKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqCiAqIFZlcnNpb246IE1QTCAxLjEKICoKICogVGhlIGNvbnRlbnRzIG9mIHRoaXMgZmlsZSBhcmUgc3ViamVjdCB0byB0aGUgTW96aWxsYSBQdWJsaWMgTGljZW5zZQogKiBWZXJzaW9uIDEuMSAodGhlICJMaWNlbnNlIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluCiAqIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqIGh0dHA6Ly93d3cubW96aWxsYS5vcmcvTVBMLwogKgogKiBTb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiCiAqIGJhc2lzLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcmlnaHRzIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICoKICogVGhlIE9yaWdpbmFsIENvZGUgaXMgQmVzcGluLgogKgogKiBUaGUgSW5pdGlhbCBEZXZlbG9wZXIgb2YgdGhlIE9yaWdpbmFsIENvZGUgaXMgTW96aWxsYS4KICogUG9ydGlvbnMgY3JlYXRlZCBieSB0aGUgSW5pdGlhbCBEZXZlbG9wZXIgYXJlIENvcHlyaWdodCAoQykgMjAwOQogKiB0aGUgSW5pdGlhbCBEZXZlbG9wZXIuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIENvbnRyaWJ1dG9yKHMpOgogKiAgIEJlc3BpbiBUZWFtIChiZXNwaW5AbW96aWxsYS5jb20pCiAqCiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovCgppZiAodHlwZW9mIEJlc3BpbiA9PSAidW5kZWZpbmVkIikgQmVzcGluID0ge307CgovLyA9IFNlcnZlciA9Ci8vCi8vIFRoZSBTZXJ2ZXIgb2JqZWN0IGltcGxlbWVudHMgdGhlIFtbaHR0cHM6Ly93aWtpLm1vemlsbGEub3JnL0Jlc3BpblNlcnZlckFQSXxCZXNwaW4gU2VydmVyIEFQSV1dCi8vIGdpdmluZyB0aGUgY2xpZW50IGFjY2VzcyB0byB0aGUgYmFja2VuZCBzdG9yZS4gVGhlIHt7e0ZpbGVTeXN0ZW19fX0gb2JqZWN0IHVzZXMgdGhpcyB0byB0YWxrIGJhY2suCgpCZXNwaW4uU2VydmVyID0gQ2xhc3MuY3JlYXRlKHsKICAgIC8vICoqIHt7eyBpbml0aWFsaXplKGJhc2UpIH19fQogICAgLy8KICAgIC8vIE9iamVjdCBjcmVhdGlvbiBpbml0aWFsaXphdGlvbgogICAgLy8KICAgIC8vICoge3t7YmFzZX19fSBpcyB0aGUgYmFzZSBzZXJ2ZXIgVVJMIHRvIGFjY2VzcwogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oYmFzZSkgewogICAgICAgIHRoaXMuU0VSVkVSX0JBU0VfVVJMID0gYmFzZSB8fCAnJzsKICAgIH0sCgogICAgLy8gPT0gSGVscGVycyA9PQoKICAgIC8vICoqIHt7eyByZXF1ZXN0KG1ldGhvZCwgdXJsLCBwYXlsb2FkLCBjYWxsYmFja09wdGlvbnMpIH19fQogICAgLy8KICAgIC8vIFRoZSBjb3JlIHdheSB0byBhY2Nlc3MgdGhlIGJhY2tlbmQgc3lzdGVtLgogICAgLy8gU2ltaWxhciB0byB0aGUgUHJvdG90eXBlIEFqYXguUmVxdWVzdCB3cmFwcGVyIAogICAgLy8KICAgIC8vICoge3t7bWV0aG9kfX19IGlzIHRoZSBIVFRQIG1ldGhvZCAoR0VUfFBPU1R8UFVUfERFTEVURSkKICAgIC8vICoge3t7dXJsfX19IGlzIHRoZSBzdWIgdXJsIHRvIGhpdCAoYWZ0ZXIgdGhlIGJhc2UgdXJsKQogICAgLy8gKiB7e3twYXlsb2FkfX19IGlzIHdoYXQgdG8gc2VuZCB1cCBmb3IgUE9TVCByZXF1ZXN0cwogICAgLy8gKiB7e3tjYWxsYmFja09wdGlvbnN9fX0gaXMgaG93IHlvdSBwYXNzIGluIHZhcmlvdXMgY2FsbGJhY2tzLgogICAgLy8gICBjYWxsYmFja09wdGlvbnNbJ2V2YWxKU09OJ10gPSB0cnVlIG9yIGZhbHNlIHRvIGF1dG8gZXZhbAogICAgLy8gICBjYWxsYmFja09wdGlvbnNbJ2NhbGwnXSA9IHRoZSBtYWluIGNhbGxiYWNrCiAgICAvLyAgIGNhbGxiYWNrT3B0aW9uc1snbG9nJ10gPSBqdXN0IGxvZyB0aGUgZm9sbG93aW5nCiAgICAvLyAgIGNhbGxiYWNrT3B0aW9uc1snb25GYWlsdXJlJ10gPSBjYWxsIGZvciBnZW5lcmFsIGZhaWx1cmVzCiAgICAvLyAgIGNhbGxiYWNrT3B0aW9uc1snb24nICsgU1RBVFVTIENPREVdID0gY2FsbCBmb3Igc3BlY2lmaWMgZmFpbHVyZXMKICAgIHJlcXVlc3Q6IGZ1bmN0aW9uKG1ldGhvZCwgdXJsLCBwYXlsb2FkLCBjYWxsYmFja09wdGlvbnMpIHsKICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgCiAgICAgICAgaWYgKGxvY2F0aW9uLmhyZWYuc3RhcnRzV2l0aCgiZmlsZToiKSkgeyAvLyBpZiBkZXZlbG9waW5nIGFuZCB1c2luZyB0aGlzIGxvY2FsbHkgb25seSEKICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICBpZiAobmV0c2NhcGUuc2VjdXJpdHkuUHJpdmlsZWdlTWFuYWdlci5lbmFibGVQcml2aWxlZ2UpIHsKICAgICAgICAgICAgICAgICAgIG5ldHNjYXBlLnNlY3VyaXR5LlByaXZpbGVnZU1hbmFnZXIuZW5hYmxlUHJpdmlsZWdlKCdVbml2ZXJzYWxCcm93c2VyUmVhZCcpOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChjYWxsYmFja09wdGlvbnMpIHsgLy8gZG8gaXQgYXN5bmMgKGJlc3QpCiAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7ICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgJiYgeGhyLnN0YXR1cyAhPSAwICYmICh4aHIuc3RhdHVzID49IDIwMCAmJiB4aHIuc3RhdHVzIDwgMzAwKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tPcHRpb25zWydldmFsSlNPTiddICYmIHRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQuZXZhbEpTT04odHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChzeW50YXhFeGNlcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiQ291bGRuJ3QgZXZhbCB0aGUgSlNPTjogIiArIHRleHQgKyAiIChTeW50YXhFcnJvcjogIiArIHN5bnRheEV4Y2VwdGlvbiArICIpIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3QuaXNGdW5jdGlvbihjYWxsYmFja09wdGlvbnNbJ2NhbGwnXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrT3B0aW9uc1snY2FsbCddKHRleHQsIHhocik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2tPcHRpb25zWydsb2cnXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coY2FsbGJhY2tPcHRpb25zWydsb2cnXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgb25TdGF0dXMgPSAnb24nICsgeGhyLnN0YXR1czsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrT3B0aW9uc1tvblN0YXR1c10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrT3B0aW9uc1tvblN0YXR1c10oeGhyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjYWxsYmFja09wdGlvbnNbJ29uRmFpbHVyZSddKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja09wdGlvbnNbJ29uRmFpbHVyZSddKHhocik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeGhyLm9wZW4obWV0aG9kLCB0aGlzLlNFUlZFUl9CQVNFX1VSTCArIHVybCwgdHJ1ZSk7IC8vIHVybCBtdXN0IGhhdmUgbGVhZGluZyAvCgkJCXhoci5zZXRSZXF1ZXN0SGVhZGVyKCJDb250ZW50LVR5cGUiLCAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJykKICAgICAgICAgICAgeGhyLnNlbmQocGF5bG9hZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGZ1bGxVcmwgPSB0aGlzLlNFUlZFUl9CQVNFX1VSTCArIHVybDsKICAgICAgICAgICAgY29uc29sZS5sb2coIkFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBkbyBhIHN5bmNocm9ub3VzIEFqYXggY2FsbD8gUmVhbGx5PyAiICsgZnVsbFVybCk7CiAgICAgICAgICAgIHhoci5vcGVuKG1ldGhvZCwgZnVsbFVybCwgZmFsc2UpOwogICAgICAgICAgICB4aHIuc2VuZChwYXlsb2FkKTsKICAgICAgICAgICAgcmV0dXJuIHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgfQogICAgfSwKCiAgICAvLyA9PSBVU0VSID09CgogICAgLy8gKioge3t7IGxvZ2luKHVzZXIsIHBhc3MsIGNhbGxiYWNrLCBub3Rsb2dnZWRpbikgfX19CiAgICAvLwogICAgLy8gVHJ5IHRvIGxvZ2luIHRvIHRoZSBiYWNrZW5kIHN5c3RlbS4KICAgIC8vIAogICAgLy8gKiB7e3t1c2VyfX19IGlzIHRoZSB1c2VybmFtZQogICAgLy8gKiB7e3twYXNzfX19IGlzIHRoZSBwYXNzd29yZAogICAgLy8gKiB7e3tvblN1Y2Nlc3N9fX0gZmlyZXMgd2hlbiB0aGUgdXNlciBpcyBsb2dnZWQgaW4KICAgIC8vICoge3t7b25GYWlsdXJlfX19IGZpcmVzIHdoZW4gdGhlIHVzZXIgZmFpbGVkIHRvIGxvZ2luCiAgICBsb2dpbjogZnVuY3Rpb24odXNlciwgcGFzcywgb25TdWNjZXNzLCBvbkZhaWx1cmUpIHsKICAgICAgICB2YXIgdXJsID0gIi9yZWdpc3Rlci9sb2dpbi8iICsgdXNlcjsKICAgICAgICB0aGlzLnJlcXVlc3QoJ1BPU1QnLCB1cmwsICJwYXNzd29yZD0iICsgZXNjYXBlKHBhc3MpLCB7IAogICAgICAgICAgICBjYWxsOiBvblN1Y2Nlc3MsIG9uNDAxOiBvbkZhaWx1cmUsIGxvZzogJ0xvZ2luIGNvbXBsZXRlLicgCiAgICAgICAgfSk7CiAgICB9LAoKICAgIC8vICoqIHt7eyBzaWdudXAodXNlciwgcGFzcywgZW1haWwsIGNhbGxiYWNrLCBub3Rsb2dnZWRpbiwgdXNlcmNvbmZsaWN0KSB9fX0KICAgIC8vCiAgICAvLyBTaWdudXAgLyBSZWdpc3RlciB0aGUgdXNlciB0byB0aGUgYmFja2VuZCBzeXN0ZW0KICAgIC8vIAogICAgLy8gKiB7e3t1c2VyfX19IGlzIHRoZSB1c2VybmFtZQogICAgLy8gKiB7e3twYXNzfX19IGlzIHRoZSBwYXNzd29yZAogICAgLy8gKiB7e3tlbWFpbH19fSBpcyB0aGUgZW1haWwKICAgIC8vICoge3t7b25TdWNjZXNzfX19IGZpcmVzIHdoZW4gdGhlIHVzZXIgaXMgbG9nZ2VkIGluCiAgICAvLyAqIHt7e25vdGxvZ2dlZGlufX19IGZpcmVzIHdoZW4gbm90IGxvZ2dlZCBpbgogICAgLy8gKiB7e3t1c2VyY29uZmxpY3R9fX0gZmlyZXMgd2hlbiB0aGUgdXNlcm5hbWUgZXhpc3RzCglzaWdudXA6IGZ1bmN0aW9uKHVzZXIsIHBhc3MsIGVtYWlsLCBvblN1Y2Nlc3MsIG5vdGxvZ2dlZGluLCB1c2VyY29uZmxpY3QpIHsKICAgICAgICB2YXIgdXJsID0gIi9yZWdpc3Rlci9uZXcvIiArIHVzZXI7CiAgICAgICAgdGhpcy5yZXF1ZXN0KCdQT1NUJywgdXJsLCAKCQkJInBhc3N3b3JkPSIgKyBlc2NhcGUocGFzcykgKyAiJmVtYWlsPSIgKyBlc2NhcGUoZW1haWwpLCB7IAoJCQljYWxsOiBvblN1Y2Nlc3MsIG9uNDAxOiBub3Rsb2dnZWRpbiwgb240MDk6IHVzZXJjb25mbGljdCwKCQkJbG9nOiAnTG9naW4gY29tcGxldGUuJyAKCQl9KTsKCX0sCgogICAgLy8gKioge3t7IGxvZ291dChjYWxsYmFjaykgfX19CiAgICAvLwogICAgLy8gTG9nb3V0IGZyb20gdGhlIGJhY2tlbmQKICAgIC8vIAogICAgLy8gKiB7e3tjYWxsYmFja319fSBmaXJlcyBhZnRlciB0aGUgbG9nb3V0IGF0dGVtcHQKICAgIGxvZ291dDogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICB2YXIgdXJsID0gIi9yZWdpc3Rlci9sb2dvdXQvIjsKICAgICAgICB0aGlzLnJlcXVlc3QoJ1BPU1QnLCB1cmwsIG51bGwsIHsgbG9nOiAnTG9nb3V0IGNvbXBsZXRlLicsIGNhbGw6IGNhbGxiYWNrIH0pOwogICAgfSwKCiAgICAvLyAqKiB7e3sgY3VycmVudHVzZXIoY2FsbGJhY2ssIG5vdGxvZ2dlZGluKSB9fX0KICAgIC8vCiAgICAvLyBSZXR1cm4gaW5mbyBvbiB0aGUgY3VycmVudCBsb2dnZWQgaW4gdXNlcgogICAgLy8gCiAgICAvLyAqIHt7e2NhbGxiYWNrfX19IGZpcmVzIGFmdGVyIHRoZSB1c2VyIGF0dGVtcHQKICAgIC8vICoge3t7bm90bG9nZ2VkaW59fX0gZmlyZXMgaWYgdGhlIHVzZXIgaXNuJ3QgbG9nZ2VkIGluCiAgICBjdXJyZW50dXNlcjogZnVuY3Rpb24oY2FsbGJhY2ssIG5vdGxvZ2dlZGluKSB7CiAgICAgICAgdmFyIHVybCA9ICIvcmVnaXN0ZXIvdXNlcmluZm8vIjsKICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KCdHRVQnLCB1cmwsIG51bGwsIAogICAgICAgICAgICAgICAgeyBjYWxsOiBjYWxsYmFjaywgb240MDE6IG5vdGxvZ2dlZGluLCBldmFsSlNPTjogdHJ1ZSB9KTsKICAgIH0sCgogICAgLy8gPT0gRklMRVMgPT0KCiAgICAvLyAqKiB7e3sgbGlzdChwcm9qZWN0LCBwYXRoLCBjYWxsYmFjaykgfX19CiAgICAvLwogICAgLy8gTGlzdCB0aGUgcGF0aCBpbiB0aGUgZ2l2ZW4gcHJvamVjdAogICAgLy8gCiAgICAvLyAqIHt7e3Byb2plY3R9fX0gaXMgdGhlIHByb2plY3QgdG8gbGlzdAogICAgLy8gKiB7e3twYXRofX19IGlzIHRoZSBwYXRoIHRvIGxpc3Qgb3V0CiAgICAvLyAqIHt7e2NhbGxiYWNrfX19IGZpcmVzIGFmdGVyIHRoZSBsaXN0IHJldHVybnMKICAgIGxpc3Q6IGZ1bmN0aW9uKHByb2plY3QsIHBhdGgsIGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIHByb2plY3QgPSBwcm9qZWN0IHx8ICcnOwogICAgICAgIHZhciB1cmwgPSBCZXNwaW4uUGF0aC5jb21iaW5lKCcvZmlsZS9saXN0LycsIHByb2plY3QsIHBhdGggfHwgJy8nKTsKCiAgICAgICAgdGhpcy5yZXF1ZXN0KCdHRVQnLCB1cmwsIG51bGwsIHsgY2FsbDogY2FsbGJhY2ssIGV2YWxKU09OOiB0cnVlLCBsb2c6ICJMaXN0aW5nIGZpbGVzIGluOiAiICsgdXJsIH0pOwogICAgfSwKCiAgICAvLyAqKiB7e3sgcHJvamVjdHMoY2FsbGJhY2spIH19fQogICAgLy8KICAgIC8vIFJldHVybiB0aGUgbGlzdCBvZiBwcm9qZWN0cyB0aGF0IHlvdSBoYXZlIGFjY2VzcyB0b28KICAgIC8vIAogICAgLy8gKiB7e3tjYWxsYmFja319fSBnZXRzIGZpcmVkIHdpdGggdGhlIHByb2plY3QgbGlzdAogICAgcHJvamVjdHM6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0KCdHRVQnLCAnL2ZpbGUvbGlzdC8nLCBudWxsLCB7IGNhbGw6IGNhbGxiYWNrLCBldmFsSlNPTjogdHJ1ZSB9KTsKICAgIH0sCgogICAgLy8gKioge3t7IHNhdmVGaWxlKHByb2plY3QsIHBhdGgsIGNvbnRlbnRzLCBsYXN0T3ApIH19fQogICAgLy8KICAgIC8vIFNhdmUgdGhlIGdpdmVuIGZpbGUKICAgIC8vIAogICAgLy8gKiB7e3twcm9qZWN0fX19IGlzIHRoZSBwcm9qZWN0IHRvIHNhdmUKICAgIC8vICoge3t7cGF0aH19fSBpcyB0aGUgcGF0aCB0byBzYXZlIHRvCiAgICAvLyAqIHt7e2NhbGxiYWNrfX19IGZpcmVzIGFmdGVyIHRoZSBzYXZlIHJldHVybnMKICAgIC8vICoge3t7bGFzdE9wfX19IGNvbnRhaW5zIHRoZSBsYXN0IGVkaXQgb3BlcmF0aW9uCiAgICBzYXZlRmlsZTogZnVuY3Rpb24ocHJvamVjdCwgcGF0aCwgY29udGVudHMsIGxhc3RPcCkgewogICAgICAgIGlmICghcHJvamVjdCB8fCAhcGF0aCkgcmV0dXJuOwoKICAgICAgICB2YXIgdXJsID0gJy9maWxlL2F0LycgKyBwcm9qZWN0ICsgJy8nICsgKHBhdGggfHwgJycpOwogICAgICAgIGlmIChsYXN0T3ApIHVybCArPSAiP2xhc3RFZGl0PSIgKyBsYXN0T3A7CgogICAgICAgIHRoaXMucmVxdWVzdCgnUFVUJywgdXJsLCBjb250ZW50cywgeyBsb2c6ICdTYXZlZCBmaWxlLicgfSk7CiAgICB9LAoKICAgIC8vICoqIHt7eyBsb2FkRmlsZShwcm9qZWN0LCBwYXRoLCBjb250ZW50cykgfX19CiAgICAvLwogICAgLy8gTG9hZCB0aGUgZ2l2ZW4gZmlsZQogICAgLy8gCiAgICAvLyAqIHt7e3Byb2plY3R9fX0gaXMgdGhlIHByb2plY3QgdG8gbG9hZCBmcm9tCiAgICAvLyAqIHt7e3BhdGh9fX0gaXMgdGhlIHBhdGggdG8gbG9hZAogICAgLy8gKiB7e3tjYWxsYmFja319fSBmaXJlcyBhZnRlciB0aGUgZmlsZSBpcyBsb2FkZWQKICAgIGxvYWRGaWxlOiBmdW5jdGlvbihwcm9qZWN0LCBwYXRoLCBjYWxsYmFjaykgewogICAgICAgIHZhciBwcm9qZWN0ID0gcHJvamVjdCB8fCAnJzsKICAgICAgICB2YXIgcGF0aCA9IHBhdGggfHwgJyc7CiAgICAgICAgdmFyIHVybCA9IEJlc3Bpbi5QYXRoLmNvbWJpbmUoJy9maWxlL2F0JywgcHJvamVjdCwgcGF0aCk7CgogICAgICAgIHRoaXMucmVxdWVzdCgnR0VUJywgdXJsLCBudWxsLCB7IGNhbGw6IGNhbGxiYWNrIH0pOwogICAgfSwKCiAgICAvLyAqKiB7e3sgcmVtb3ZlRmlsZShwcm9qZWN0LCBwYXRoLCBvblN1Y2Nlc3MsIG9uRmFpbHVyZSkgfX19CiAgICAvLwogICAgLy8gUmVtb3ZlIHRoZSBnaXZlbiBmaWxlCiAgICAvLyAKICAgIC8vICoge3t7cHJvamVjdH19fSBpcyB0aGUgcHJvamVjdCB0byByZW1vdmUgZnJvbQogICAgLy8gKiB7e3twYXRofX19IGlzIHRoZSBwYXRoIHRvIHJlbW92ZQogICAgLy8gKiB7e3tvblN1Y2Nlc3N9fX0gZmlyZXMgaWYgdGhlIGRlbGV0aW9uIHdvcmtzCiAgICAvLyAqIHt7e29uRmFpbHVyZX19fSBmaXJlcyBpZiB0aGUgZGVsZXRpb24gZmFpbGVkCiAgICByZW1vdmVGaWxlOiBmdW5jdGlvbihwcm9qZWN0LCBwYXRoLCBvblN1Y2Nlc3MsIG9uRmFpbHVyZSkgewogICAgICAgIHZhciBwcm9qZWN0ID0gcHJvamVjdCB8fCAnJzsKICAgICAgICB2YXIgcGF0aCA9IHBhdGggfHwgJyc7CiAgICAgICAgdmFyIHVybCA9IEJlc3Bpbi5QYXRoLmNvbWJpbmUoJy9maWxlL2F0JywgcHJvamVjdCwgcGF0aCk7CiAgICAgICAgdmFyIG9wdHMgPSB7IGNhbGw6IG9uU3VjY2VzcyB9OwogICAgICAgIGlmIChPYmplY3QuaXNGdW5jdGlvbihvbkZhaWx1cmUpKSBvcHRzLm9uRmFpbHVyZSA9IG9uRmFpbHVyZTsKICAgICAgICAKICAgICAgICB0aGlzLnJlcXVlc3QoJ0RFTEVURScsIHVybCwgbnVsbCwgb3B0cyk7CiAgICB9LAoKICAgICAvLyAqKiB7e3sgbGlzdE9wZW4oY2FsbGJhY2spIH19fQogICAgIC8vCiAgICAgLy8gUmV0dXJucyBKU09OIHdpdGggdGhlIGtleSBvZiBmaWxlbmFtZSwgYW5kIHRoZSB2YWx1ZSBvZiBhbiBhcnJheSBvZiB1c2VybmFtZXM6CiAgICAgLy8geyAiZm9vLnR4dCI6IFsiYmVuIl0sICJTb21lQWpheEFwcC9mb28udHh0IjogWyJkaW9uIl0gfQogICAgIC8vIAogICAgIC8vICoge3t7Y2FsbGJhY2t9fX0gZmlyZXMgYWZ0ZXIgbGlzdGluZyB0aGUgb3BlbiBmaWxlcwogICAgbGlzdE9wZW46IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0KCdHRVQnLCAnL2ZpbGUvbGlzdG9wZW4vJywgbnVsbCwgewogICAgICAgICAgICBjYWxsOiBjYWxsYmFjaywgZXZhbEpTT046IHRydWUsIGxvZzogJ0xpc3Qgb3BlbiBmaWxlcy4nIAogICAgICAgIH0pOwogICAgfSwKCiAgICAvLyAqKiB7e3sgY2xvc2VGaWxlKHByb2plY3QsIHBhdGgsIGNhbGxiYWNrKSB9fX0KICAgIC8vCiAgICAvLyBDbG9zZSB0aGUgZ2l2ZW4gZmlsZSAocmVtb3ZlIGZyb20gb3BlbiBzZXNzaW9ucykKICAgIC8vIAogICAgLy8gKiB7e3twcm9qZWN0fX19IGlzIHRoZSBwcm9qZWN0IHRvIGNsb3NlIGZyb20KICAgIC8vICoge3t7cGF0aH19fSBpcyB0aGUgcGF0aCB0byBjbG9zZQogICAgLy8gKiB7e3tjYWxsYmFja319fSBmaXJlcyBhZnRlciB0aGUgZmlsZSBpcyBjbG9zZWQKICAgIGNsb3NlRmlsZTogZnVuY3Rpb24ocHJvamVjdCwgcGF0aCwgY2FsbGJhY2spIHsKICAgICAgICB2YXIgcGF0aCA9IHBhdGggfHwgJyc7CiAgICAgICAgdmFyIHVybCA9IEJlc3Bpbi5QYXRoLmNvbWJpbmUoJy9maWxlL2Nsb3NlJywgcHJvamVjdCwgcGF0aCk7CiAgICAgICAgdGhpcy5yZXF1ZXN0KCdQT1NUJywgdXJsLCBudWxsLCB7IGNhbGw6IGNhbGxiYWNrIH0pOwogICAgfSwKCiAgICAvLyA9PSBFRElUID09CgogICAgLy8gKioge3t7IGVkaXRBY3Rpb25zKHByb2plY3QsIHBhdGgsIGNhbGxiYWNrKSB9fX0KICAgIC8vCiAgICAvLyBHZXQgdGhlIGxpc3Qgb2YgZWRpdCBhY3Rpb25zCiAgICAvLyAKICAgIC8vICoge3t7cHJvamVjdH19fSBpcyB0aGUgcHJvamVjdCB0byBlZGl0IGZyb20KICAgIC8vICoge3t7cGF0aH19fSBpcyB0aGUgcGF0aCB0byBlZGl0CiAgICAvLyAqIHt7e2NhbGxiYWNrfX19IGZpcmVzIGFmdGVyIHRoZSBlZGl0IGlzIGRvbmUKICAgIGVkaXRBY3Rpb25zOiBmdW5jdGlvbihwcm9qZWN0LCBwYXRoLCBjYWxsYmFjaykgewogICAgICAgIHZhciBwYXRoID0gcGF0aCB8fCAnJzsKICAgICAgICB2YXIgdXJsID0gQmVzcGluLlBhdGguY29tYmluZSgnL2VkaXQvbGlzdCcsIHByb2plY3QsIHBhdGgpOwogICAgICAgIHRoaXMucmVxdWVzdCgnR0VUJywgdXJsLCBudWxsLCB7IGNhbGw6IGNhbGxiYWNrLCBsb2c6ICJFZGl0IEFjdGlvbnMgQ29tcGxldGUuIiB9KTsKICAgIH0sCgogICAgLy8gKioge3t7IGVkaXRBZnRlckFjdGlvbnMocHJvamVjdCwgcGF0aCwgY2FsbGJhY2spIH19fQogICAgLy8KICAgIC8vIEdldCB0aGUgbGlzdCBvZiBlZGl0IGFmdGVyIGFjdGlvbnMKICAgIC8vIAogICAgLy8gKiB7e3twcm9qZWN0fX19IGlzIHRoZSBwcm9qZWN0IHRvIGVkaXQgZnJvbQogICAgLy8gKiB7e3twYXRofX19IGlzIHRoZSBwYXRoIHRvIGVkaXQKICAgIC8vICoge3t7Y2FsbGJhY2t9fX0gZmlyZXMgYWZ0ZXIgdGhlIGVkaXQgaXMgZG9uZQogICAgZWRpdEFmdGVyQWN0aW9uczogZnVuY3Rpb24ocHJvamVjdCwgcGF0aCwgaW5kZXgsIGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIHBhdGggPSBwYXRoIHx8ICcnOwogICAgICAgIHZhciB1cmwgPSBCZXNwaW4uUGF0aC5jb21iaW5lKCcvZWRpdC9yZWNlbnQnLCBpbmRleCwgcHJvamVjdCwgcGF0aCk7CiAgICAgICAgdGhpcy5yZXF1ZXN0KCdHRVQnLCB1cmwsIG51bGwsIHsgY2FsbDogY2FsbGJhY2ssIGxvZzogIkVkaXQgQWZ0ZXIgQWN0aW9ucyBDb21wbGV0ZS4iIH0pOwogICAgfSwKCiAgICAvLyAqKiB7e3sgZG9BY3Rpb24ocHJvamVjdCwgcGF0aCwgYWN0aW9ucykgfX19CiAgICAvLwogICAgLy8gU3RvcmUgYWN0aW9ucyB0byB0aGUgZWRpdCBxdWV1ZQogICAgLy8gCiAgICAvLyAqIHt7e3Byb2plY3R9fX0gaXMgdGhlIHByb2plY3QKICAgIC8vICoge3t7cGF0aH19fSBpcyB0aGUgcGF0aAogICAgLy8gKiB7e3thY3Rpb25zfX19IGNvbnRhaW4gdGhlIGFjdGlvbnMgdG8gc3RvcmUKICAgIGRvQWN0aW9uOiBmdW5jdGlvbihwcm9qZWN0LCBwYXRoLCBhY3Rpb25zKSB7CiAgICAgICAgdmFyIHBhdGggPSBwYXRoIHx8ICcnOwogICAgICAgIHZhciB1cmwgPSBCZXNwaW4uUGF0aC5jb21iaW5lKCcvZWRpdCcsIHByb2plY3QsIHBhdGgpOwoKICAgICAgICB2YXIgc3AgPSAiWyIgKyBhY3Rpb25zLmpvaW4oIiwiKSArICJdIjsKCiAgICAgICAgdGhpcy5yZXF1ZXN0KCdQVVQnLCB1cmwsIHNwLCB7IGNhbGw6IGZ1bmN0aW9uKCl7fSB9KTsKICAgIH0sCgogICAgLy8gPT0gUFJPSkVDVFMgPT0KICAgIC8vCiAgICAvLyBzdGlsbCBuZWVkZWQ6IG93bmVycywgYXV0aG9yaXplLCBkZWF1dGhvcml6ZQogICAgCiAgICAvLyAqKiB7e3sgZXhwb3J0UHJvamVjdChwcm9qZWN0LCBhcmNoaXZldHlwZSkgfX19CiAgICAvLwogICAgLy8gRXhwb3J0IHRoZSBwcm9qZWN0IGFzIGVpdGhlciBhIHppcCBmaWxlIG9yIHRhciArIGd6CiAgICAvLyAKICAgIC8vICoge3t7cHJvamVjdH19fSBpcyB0aGUgcHJvamVjdCB0byBleHBvcnQKICAgIC8vICoge3t7YXJjaGl2ZXR5cGV9fX0gaXMgZWl0aGVyIHppcCB8IHRnegogICAgZXhwb3J0UHJvamVjdDogZnVuY3Rpb24ocHJvamVjdCwgYXJjaGl2ZXR5cGUpIHsKICAgICAgICBpZiAoWyd6aXAnLCd0Z3onLCd0YXIuZ3onXS5pbmNsdWRlKGFyY2hpdmV0eXBlKSkgewogICAgICAgICAgICB2YXIgaWZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaWZyYW1lIik7CiAgICAgICAgICAgIGlmcmFtZS5zcmMgPSBCZXNwaW4uUGF0aC5jb21iaW5lKCcvcHJvamVjdC9leHBvcnQnLCBwcm9qZWN0ICsgIi4iICsgYXJjaGl2ZXR5cGUpOwogICAgICAgICAgICBpZnJhbWUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgaWZyYW1lLnN0eWxlLmhlaWdodCA9IGlmcmFtZS5zdHlsZS53aWR0aCA9ICIwIjsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXS5hcHBlbmRDaGlsZChpZnJhbWUpOwogICAgICAgIH0KICAgIH0sCgogICAgLy8gKioge3t7IGltcG9ydFByb2plY3QocHJvamVjdCwgdXJsLCBvcHRzKSB9fX0KICAgIC8vCiAgICAvLyBJbXBvcnQgdGhlIGdpdmVuIGZpbGUgaW50byB0aGUgZ2l2ZW4gcHJvamVjdAogICAgLy8gCiAgICAvLyAqIHt7e3Byb2plY3R9fX0gaXMgdGhlIHByb2plY3QgdG8gZXhwb3J0CiAgICAvLyAqIHt7e3VybH19fSBpcyB0aGUgVVJMIHRvIHRoZSBmaWxlIHRvIGltcG9ydAogICAgLy8gKiB7e3thcmNoaXZldHlwZX19fSBpcyBlaXRoZXIgemlwIHwgdGd6CiAgICBpbXBvcnRQcm9qZWN0OiBmdW5jdGlvbihwcm9qZWN0LCB1cmwsIG9wdHMpIHsKICAgICAgICBpZiAob3B0cykgeyAvLyB3cmFwIHRoZSBpbXBvcnQgc3VjY2VzcyBjYWxsIGluIGFuIGV2ZW50IHRvIHNheSB0aGF0IHRoZSBpbXBvcnQgaXMgY29tcGxldGUKICAgICAgICAgICAgdmFyIHVzZXJDYWxsID0gb3B0cy5jYWxsOwogICAgICAgICAgICBvcHRzLmNhbGwgPSBmdW5jdGlvbih0ZXh0LCB4aHIpIHsKICAgICAgICAgICAgICAgIHVzZXJDYWxsKHRleHQsIHhocik7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5maXJlKCJiZXNwaW46cHJvamVjdDppbXBvcnRlZCIsIHsKICAgICAgICAgICAgICAgICAgICBwcm9qZWN0OiBwcm9qZWN0LAogICAgICAgICAgICAgICAgICAgIHVybDogdXJsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLnJlcXVlc3QoJ1BPU1QnLCAnL3Byb2plY3QvZnJvbXVybC8nICsgcHJvamVjdCwgdXJsLCBvcHRzIHx8IHt9KTsKICAgIH0sCgogICAgLy8gPT0gU0VUVElOR1MgPT0KICAgIC8vCiAgICAvLwogICAgLy8gKiBHRVQgL3NldHRpbmdzLyB0byBsaXN0IGFsbCBzZXR0aW5ncyBmb3IgY3VycmVudGx5IGxvZ2dlZCBpbiB1c2VyIGFzIGpzb24gZGljdAogICAgLy8gKiBHRVQgL3NldHRpbmdzL1tzZXR0aW5nXSB0byBnZXQgdGhlIHZhbHVlIGZvciBhIHNpbmdsZSBzZXR0aW5nIGFzIGpzb24gc3RyaW5nCiAgICAvLyAqIFBPU1QgL3NldHRpbmdzLyB3aXRoIEhUVFAgUE9TVCBEQVRBIChpbiBzdGFuZGFyZCBmb3JtIHBvc3Qgc3ludGF4KSB0byBzZXQgdGhlIHZhbHVlIGZvciBhIGNvbGxlY3Rpb24gb2Ygc2V0dGluZ3MgKGFsbCB2YWx1ZXMgYXJlIHN0cmluZ3MpCiAgICAvLyAqIERFTEVURSAvc2V0dGluZ3MvW3NldHRpbmddIHRvIGRlbGV0ZSBhIHNpbmdsZSBzZXR0aW5nCgogICAgbGlzdFNldHRpbmdzOiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aGlzLnJlcXVlc3QoJ0dFVCcsICcvc2V0dGluZ3MvJywgbnVsbCwgeyBjYWxsOiBjYWxsYmFjaywgZXZhbEpTT046IHRydWUgfSk7CiAgICAgICAgfQogICAgfSwKCiAgICBnZXRTZXR0aW5nOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaykgewogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aGlzLnJlcXVlc3QoJ0dFVCcsICcvc2V0dGluZ3MvJyArIG5hbWUsIG51bGwsIHsgY2FsbDogY2FsbGJhY2sgfSk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgc2V0U2V0dGluZzogZnVuY3Rpb24obmFtZSwgdmFsdWUsIGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIHNldHRpbmdzID0ge307CiAgICAgICAgc2V0dGluZ3NbbmFtZV0gPSB2YWx1ZTsKICAgICAgICB0aGlzLnNldFNldHRpbmdzKHNldHRpbmdzLCAoY2FsbGJhY2sgfHwgUHJvdG90eXBlLmVtcHR5RnVuY3Rpb24pKTsKICAgIH0sCiAgICAKICAgIHNldFNldHRpbmdzOiBmdW5jdGlvbihzZXR0aW5ncywgY2FsbGJhY2spIHsKICAgICAgICB0aGlzLnJlcXVlc3QoJ1BPU1QnLCAnL3NldHRpbmdzLycsIE9iamVjdC50b1F1ZXJ5U3RyaW5nKHNldHRpbmdzKSwgeyBjYWxsOiAoY2FsbGJhY2sgfHwgUHJvdG90eXBlLmVtcHR5RnVuY3Rpb24pIH0pOwogICAgfSwKICAgIAogICAgdW5zZXRTZXR0aW5nOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaykgewogICAgICAgIHRoaXMucmVxdWVzdCgnREVMRVRFJywgJy9zZXR0aW5ncy8nICsgbmFtZSwgbnVsbCwgeyBjYWxsOiAoY2FsbGJhY2sgfHwgUHJvdG90eXBlLmVtcHR5RnVuY3Rpb24pIH0pOwogICAgfQp9KTsKLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKgogKiBWZXJzaW9uOiBNUEwgMS4xCiAqCiAqIFRoZSBjb250ZW50cyBvZiB0aGlzIGZpbGUgYXJlIHN1YmplY3QgdG8gdGhlIE1vemlsbGEgUHVibGljIExpY2Vuc2UKICogVmVyc2lvbiAxLjEgKHRoZSAiTGljZW5zZSIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbgogKiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKiBodHRwOi8vd3d3Lm1vemlsbGEub3JnL01QTC8KICoKICogU29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIgogKiBiYXNpcywgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHJpZ2h0cyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIFRoZSBPcmlnaW5hbCBDb2RlIGlzIEJlc3Bpbi4KICoKICogVGhlIEluaXRpYWwgRGV2ZWxvcGVyIG9mIHRoZSBPcmlnaW5hbCBDb2RlIGlzIE1vemlsbGEuCiAqIFBvcnRpb25zIGNyZWF0ZWQgYnkgdGhlIEluaXRpYWwgRGV2ZWxvcGVyIGFyZSBDb3B5cmlnaHQgKEMpIDIwMDkKICogdGhlIEluaXRpYWwgRGV2ZWxvcGVyLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBDb250cmlidXRvcihzKToKICogICBCZXNwaW4gVGVhbSAoYmVzcGluQG1vemlsbGEuY29tKQogKgogKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqLwoKLy8gPSBTdGF0dXNDaGVja2VyID0KLy8KLy8gVGhpcyBpcyBjdXJyZW50bHkganVzdCBhIG1vY2sgdG8gcmFuZG9tbHkgc2hhcmUgc3RhdHVzIG1lc3NhZ2VzLgovLyBJbiB0aGUgZnV0dXJlIHRoZSBzZXJ2ZXIgd2lsbCBzZXJ2ZSB1cCBpbnRlcmVzdGluZyBkYXRhLgovLyBGb3Igbm93LCBpdCBpcyB0dXJuZWQgb2ZmLgoKdmFyIFN0YXR1c0NoZWNrZXIgPSBDbGFzcy5jcmVhdGUoewogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5pbnRlcnZhbDsKICAgICAgICB0aGlzLnN0YXR1c01lc3NhZ2VzID0gWwogICAgICAgICAgICAiQm9iIGlzIGVkaXRpbmcgdGhlIGZpbGUgYnJpY2suaHRtbCIsCiAgICAgICAgICAgICJFbWlseSBpcyBjcmVhdGluZyBhIG5ldyB0YWcgY2FsbGVkICd2My40JyIsCiAgICAgICAgICAgICJKZXNzaWNhIGlzIHNhdmluZyB0aGUgZmlsZSBraWRseS5odG1sIiwKICAgICAgICAgICAgIkpvaG4gaXMgaWRsZS4gTGF6eSBnaXQhIiwKICAgICAgICAgICAgIk1pY2tleSBoYXMgY2hlY2tlZCBpbiBhIHNldCBvZiA0IGZpbGVzIHRvIHByb2plY3QgJ0JhbmsnIiwKICAgICAgICAgICAgIkRvbiBoYXMgY3JlYXRlZCB0aGUgZnVuY3Rpb24gJ2RvQ2FsY3VsYXRpb24nIGluIGNsYXNzICdCYW5rJyIsCiAgICAgICAgICAgICJCZW5qaSBpcyBkZWxldGluZyB0aGUgZnVuY3Rpb24gJ2RvQ2FsY3VsYXRpb24nIGluIGNsYXNzICdCYW5rJyIKICAgICAgICBdOwogICAgfSwKCiAgICBzdGFydDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5pbnRlcnZhbCA9IHNldEludGVydmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXR1cygpOwogICAgICAgIH0uYmluZCh0aGlzKSwgMTIwMDApOwogICAgfSwKCiAgICBzdG9wOiBmdW5jdGlvbigpIHsKICAgICAgICBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWwpOwogICAgfSwKCiAgICB1cGRhdGVTdGF0dXM6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciByYW5kb21NZXNzYWdlID0gdGhpcy5yYW5kb21TdGF0dXMoKTsKICAgICAgICB0aGlzLnNldFN0YXR1cyhyYW5kb21NZXNzYWdlKTsKICAgIH0sCgogICAgcmFuZG9tU3RhdHVzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgcmFuZG9tID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdGhpcy5zdGF0dXNNZXNzYWdlcy5sZW5ndGgpCiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdHVzTWVzc2FnZXNbcmFuZG9tXTsKICAgIH0sCgogICAgc2V0U3RhdHVzOiBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgICAgJCgnbWVzc2FnZScpLmlubmVySFRNTCA9IG1lc3NhZ2U7CiAgICB9Cn0pLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKgogKiBWZXJzaW9uOiBNUEwgMS4xCiAqCiAqIFRoZSBjb250ZW50cyBvZiB0aGlzIGZpbGUgYXJlIHN1YmplY3QgdG8gdGhlIE1vemlsbGEgUHVibGljIExpY2Vuc2UKICogVmVyc2lvbiAxLjEgKHRoZSAiTGljZW5zZSIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbgogKiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKiBodHRwOi8vd3d3Lm1vemlsbGEub3JnL01QTC8KICoKICogU29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIgogKiBiYXNpcywgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHJpZ2h0cyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqCiAqIFRoZSBPcmlnaW5hbCBDb2RlIGlzIEJlc3Bpbi4KICoKICogVGhlIEluaXRpYWwgRGV2ZWxvcGVyIG9mIHRoZSBPcmlnaW5hbCBDb2RlIGlzIE1vemlsbGEuCiAqIFBvcnRpb25zIGNyZWF0ZWQgYnkgdGhlIEluaXRpYWwgRGV2ZWxvcGVyIGFyZSBDb3B5cmlnaHQgKEMpIDIwMDkKICogdGhlIEluaXRpYWwgRGV2ZWxvcGVyLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBDb250cmlidXRvcihzKToKICogICBCZXNwaW4gVGVhbSAoYmVzcGluQG1vemlsbGEuY29tKQogKgogKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqLwoKLy8gPSBTZXNzaW9uID0KLy8KLy8gVGhpcyBzZXNzaW9uIG1vZHVsZSBwcm92aWRlcyBmdW5jdGlvbmFsaXR5IHRoYXQgYm90aCBzdG9yZXMgc2Vzc2lvbiBpbmZvcm1hdGlvbgovLyBhbmQgaGFuZGxlIGNvbGxhYm9yYXRpb24uCi8vCi8vIFRoaXMgbW9kdWxlIGluY2x1ZGVzOgovLwovLyAqIHt7eyBCZXNwaW4uU2Vzc2lvbi5FZGl0U2Vzc2lvbiB9fX06IFdyYXBzIGEgZmlsZSBlZGl0IHNlc3Npb24KLy8gKiB7e3sgQmVzcGluLlNlc3Npb24uU3luY0hlbHBlciB9fX06IERlYWxzIHdpdGggc3luY2luZyBlZGl0cyBiYWNrIHRvIHRoZSBzZXJ2ZXIKCmlmICh0eXBlb2YgQmVzcGluID09ICJ1bmRlZmluZWQiKSBCZXNwaW4gPSB7fTsKaWYgKCFCZXNwaW4uU2Vzc2lvbikgQmVzcGluLlNlc3Npb24gPSB7fTsKCi8vICoqIHt7eyBFZGl0U2Vzc2lvbiB9fX0gKioKLy8KLy8gRWRpdFNlc3Npb24gcmVwcmVzZW50cyBhIGZpbGUgZWRpdCBzZXNzaW9uIHdpdGggdGhlIEJlc3BpbiBiYWNrLWVuZCBzZXJ2ZXIuIEl0IGlzIHJlc3BvbnNpYmxlIGZvcgovLyBzZW5kaW5nIGNoYW5nZXMgdG8gdGhlIHNlcnZlciBhcyB3ZWxsIGFzIHJlY2VpdmluZyBjaGFuZ2VzIGZyb20gdGhlIHNlcnZlciBhbmQgbXV0YXRpbmcgdGhlIGRvY3VtZW50Ci8vIG1vZGVsIHdpdGggcmVjZWl2ZWQgY2hhbmdlcy4KCkJlc3Bpbi5TZXNzaW9uLkVkaXRTZXNzaW9uID0gQ2xhc3MuY3JlYXRlKHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGVkaXRvcikgewogICAgICAgIHRoaXMuZWRpdG9yID0gZWRpdG9yOwogICAgICAgIHRoaXMucHJvamVjdCA9ICdTb21lQWpheEFwcCc7IC8vIFRPRE86IGRlZmF1bHQKICAgICAgICB0aGlzLmNvbGxhYm9yYXRlID0gdHJ1ZTsKICAgIH0sCiAgICAKICAgIHByb2plY3RGb3JEaXNwbGF5OiBmdW5jdGlvbih0ZXN0UHJvamVjdCkgewogICAgICAgIHZhciBwcm9qZWN0ID0gdGVzdFByb2plY3QgfHwgdGhpcy5wcm9qZWN0OwogICAgICAgIHJldHVybiAocHJvamVjdCA9PSB0aGlzLnVzZXJwcm9qZWN0KSA/ICIqIFlvdXIgU3BlY2lhbCBQcm9qZWN0ICoiIDogcHJvamVjdDsKICAgIH0sCgogICAgc3RhcnRTZXNzaW9uOiBmdW5jdGlvbihwcm9qZWN0LCBwYXRoLCB1c2VybmFtZSkgewogICAgICAgIHRoaXMucHJvamVjdCA9IHByb2plY3Q7CiAgICAgICAgdGhpcy5wYXRoID0gcGF0aDsKICAgICAgICBpZiAoIXRoaXMudXNlcm5hbWUpIHRoaXMudXNlcm5hbWUgPSB1c2VybmFtZTsKCiAgICAgICAgaWYgKHRoaXMuY29sbGFib3JhdGUpIHRoaXMuc3luY0hlbHBlciA9IG5ldyBCZXNwaW4uU2Vzc2lvbi5TeW5jSGVscGVyKHRoaXMuZWRpdG9yKTsKICAgIH0sCgogICAgc3RvcFNlc3Npb246IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucHJvamVjdCA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLnBhdGggPSB1bmRlZmluZWQ7CgogICAgICAgIGlmICh0aGlzLmNvbGxhYm9yYXRlKSB0aGlzLnN5bmNIZWxwZXIuc3RvcCgpOwogICAgfQp9KTsKCi8vICoqIHt7eyBTeW5jSGVscGVyIH19fSAqKgovLwovLyBTZW5kcyBkYXRhIHVwIHRvIHRoZSBzZXJ2ZXIgKGVkaXRzKSwgYW5kIHJldHJpZXZlcyB1cGRhdGVzIGJhY2sgYW5kIGFwcGxpZXMgdGhlbS4KLy8gVGhlIHt7eyBFZGl0U2Vzc2lvbiB9fX0gc3RhcnRzIGFuZCBzdG9wcyB0aGlzIHByb2Nlc3MuCgpCZXNwaW4uU2Vzc2lvbi5TeW5jSGVscGVyID0gQ2xhc3MuY3JlYXRlKHsKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGVkaXRvcikgewogICAgICAgIHRoaXMuU0VORF9JTlRFUlZBTCA9IDEwMDA7CiAgICAgICAgdGhpcy5VUERBVEVfSU5URVJWQUwgPSAxMDAwOwoKICAgICAgICB0aGlzLmVkaXRvciA9IGVkaXRvcjsKICAgICAgICB0aGlzLmVkaXRvci51bmRvTWFuYWdlci5zeW5jSGVscGVyID0gdGhpczsKICAgICAgICB0aGlzLm9wUXVldWUgPSBbXTsKICAgICAgICB0aGlzLmxhc3RPcCA9IDA7CiAgICAgICAgdGhpcy5zdG9wcGVkID0gZmFsc2U7CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBzZWxmLnByb2Nlc3NTZW5kUXVldWUoKSB9LCBzZWxmLlNFTkRfSU5URVJWQUwgKTsKICAgIH0sCgogICAgcmV0cmlldmVVcGRhdGVzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIC8vIFRPRE86IGZpeCBnbG9iYWwgcmVmZXJlbmNlcwogICAgICAgIF9zZXJ2ZXIuZWRpdEFmdGVyQWN0aW9ucyhfZWRpdFNlc3Npb24ucHJvamVjdCwgX2VkaXRTZXNzaW9uLnBhdGgsIHRoaXMubGFzdE9wLCBmdW5jdGlvbihqc29uKSB7IAoKICAgICAgICAgICAgc2VsZi5lZGl0b3IudW5kb01hbmFnZXIuc3luY0hlbHBlciA9IHVuZGVmaW5lZDsgLy8gVE9ETzogZG9jdW1lbnQgd2h5IEkgZG8gdGhpcwoKICAgICAgICAgICAgdmFyIG9wcyA9IGV2YWwoanNvbik7CiAgICAgICAgICAgIHRoaXMubGFzdE9wICs9IG9wcy5sZW5ndGg7CgogICAgICAgICAgICBvcHMuZWFjaChmdW5jdGlvbihvcCkgewogICAgICAgICAgICAgICAgaWYgKG9wLnVzZXJuYW1lICE9IF9lZGl0U2Vzc2lvbi51c2VybmFtZSkgeyAvLyBkb24ndCBwbGF5IG9wZXJhdGlvbnMgdGhhdCBoYXZlIGJlZW4gcGVyZm9ybWVkIGJ5IHRoaXMgdXNlcgogICAgICAgICAgICAgICAgICAgIHNlbGYucGxheU9wKG9wKTsKICAgICAgICAgICAgICAgICAgICBfc2hvd0NvbGxhYkhvdENvdW50ZXIgPSAyMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoIV9zaG93Q29sbGFiKSB7CiAgICAgICAgICAgICAgICAkKCJjb2xsYWJvcmF0aW9uIikuc3JjID0gKF9zaG93Q29sbGFiSG90Q291bnRlciA+IDApID8gImltYWdlcy9pY25fY29sbGFiX3dhdGNoaW5nLnBuZyIgOiAiaW1hZ2VzL2ljbl9jb2xsYWJfb2ZmLnBuZyI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChfc2hvd0NvbGxhYkhvdENvdW50ZXIgPiAwKSBfc2hvd0NvbGxhYkhvdENvdW50ZXItLTsKCiAgICAgICAgICAgIHNlbGYuZWRpdG9yLnVuZG9NYW5hZ2VyLnN5bmNIZWxwZXIgPSBzZWxmOwoKICAgICAgICAgICAgaWYgKCFzZWxmLnN0b3BwZWQpIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHNlbGYucmV0cmlldmVVcGRhdGVzKCkgfSwgc2VsZi5VUERBVEVfSU5URVJWQUwgKTsKICAgICAgICB9KTsKICAgIH0sCgogICAgcGxheU9wOiBmdW5jdGlvbih2YWwpIHsKICAgICAgICB2YXIgdCwgZHM7CiAgICAgICAgaWYgKHZhbC5yZWRvT3ApIHsKICAgICAgICAgICAgdmFsLnJlZG9PcC5xdWV1ZWQgPSB1bmRlZmluZWQ7CgogICAgICAgICAgICB0aGlzLmVkaXRvci51aS5hY3Rpb25zW3ZhbC5yZWRvT3AuYWN0aW9uXSh2YWwucmVkb09wKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmVkaXRvci51aS5hY3Rpb25zW3ZhbC5hY3Rpb25dKHZhbCk7CiAgICAgICAgfQogICAgfSwKCiAgICBzeW5jV2l0aFNlcnZlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBfc2VydmVyLmVkaXRBY3Rpb25zKF9lZGl0U2Vzc2lvbi5wcm9qZWN0LCBfZWRpdFNlc3Npb24ucGF0aCwgZnVuY3Rpb24oanNvbikgewogICAgICAgICAgICBpZiAoanNvbi5sZW5ndGggPiAyKSB7CiAgICAgICAgICAgICAgICBzZWxmLmVkaXRvci51bmRvTWFuYWdlci5zeW5jSGVscGVyID0gdW5kZWZpbmVkOwoKICAgICAgICAgICAgICAgIHZhciBvcHMgPSBldmFsKGpzb24pOwogICAgICAgICAgICAgICAgdGhpcy5sYXN0T3AgPSBvcHMubGVuZ3RoOwoKICAgICAgICAgICAgICAgIHNlbGYuZWRpdG9yLnVpLmFjdGlvbnMuaWdub3JlUmVwYWludHMgPSB0cnVlOwogICAgICAgICAgICAgICAgb3BzLmVhY2goZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wbGF5T3AodmFsKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgc2VsZi5lZGl0b3IudWkuYWN0aW9ucy5pZ25vcmVSZXBhaW50cyA9IGZhbHNlOwogICAgICAgICAgICAgICAgc2VsZi5lZGl0b3IudWkuYWN0aW9ucy5yZXBhaW50KCk7CgogICAgICAgICAgICAgICAgc2VsZi5lZGl0b3IudW5kb01hbmFnZXIuc3luY0hlbHBlciA9IHNlbGY7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHNlbGYucmV0cmlldmVVcGRhdGVzKCkgfSwgc2VsZi5VUERBVEVfSU5URVJWQUwgKTsKICAgICAgICB9KTsKICAgIH0sCgogICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zdG9wcGVkID0gdHJ1ZTsKICAgIH0sCgogICAgcHJvY2Vzc1NlbmRRdWV1ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMub3BRdWV1ZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBzZW5kUXVldWUgPSB0aGlzLm9wUXVldWUuc3BsaWNlKDAsIHRoaXMub3BRdWV1ZS5sZW5ndGgpOwogICAgICAgICAgICBfc2VydmVyLmRvQWN0aW9uKF9lZGl0U2Vzc2lvbi5wcm9qZWN0LCBfZWRpdFNlc3Npb24ucGF0aCwgc2VuZFF1ZXVlKTsKICAgICAgICB9CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICBpZiAoIXRoaXMuc3RvcHBlZCkgc2V0VGltZW91dChmdW5jdGlvbigpIHsgc2VsZi5wcm9jZXNzU2VuZFF1ZXVlKCkgfSwgc2VsZi5TRU5EX0lOVEVSVkFMICk7CiAgICB9LAoKICAgIGFwcGx5RWRpdE9wZXJhdGlvbnM6IGZ1bmN0aW9uKG9wcykgewogICAgICAgIHRoaXMuZWRpdG9yLnVpLmFjdGlvbnMuaWdub3JlUmVwYWludHMgPSB0cnVlOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9wcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgb3AgPSBvcHNbaV07CgogICAgICAgICAgICAvLyBjaGVjayBpZiB0aGlzIGlzIGFuIGVkaXRvcCBvciBhbiB1bmRvb3AKICAgICAgICAgICAgaWYgKG9wLnJlZG9PcCkgewogICAgICAgICAgICAgICAgb3AucmVkbygpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5lZGl0b3IudWkuYWN0aW9uc1t0aGlzLm9wLmFjdGlvbl0odGhpcy5vcCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuZWRpdG9yLnVpLmFjdGlvbnMuaWdub3JlUmVwYWludHMgPSBmYWxzZTsKICAgICAgICB0aGlzLmVkaXRvci51aS5hY3Rpb25zLnJlcGFpbnQoKTsKICAgIH0sCgogICAgdW5kbzogZnVuY3Rpb24ob3ApIHsKICAgICAgICB0aGlzLm9wUXVldWUucHVzaChPYmplY3QudG9KU09OKHsgdXNlcm5hbWU6IF9lZGl0U2Vzc2lvbi51c2VybmFtZSwgYWN0aW9uOiAndW5kbycgfSkpOwogICAgfSwKCiAgICByZWRvOiBmdW5jdGlvbihvcCkgewogICAgICAgIHRoaXMub3BRdWV1ZS5wdXNoKE9iamVjdC50b0pTT04oeyB1c2VybmFtZTogX2VkaXRTZXNzaW9uLnVzZXJuYW1lLCBhY3Rpb246ICdyZWRvJyB9KSk7CiAgICB9LAoKICAgIHF1ZXVlVW5kb09wOiBmdW5jdGlvbih1bmRvT3ApIHsKICAgICAgICB2YXIgdW5kb09wSnNvbiA9IHsKICAgICAgICAgICAgdXNlcm5hbWU6IF9lZGl0U2Vzc2lvbi51c2VybmFtZSwKICAgICAgICAgICAgdW5kb09wOiB1bmRvT3AudW5kb09wLAogICAgICAgICAgICByZWRvT3A6IHVuZG9PcC5yZWRvT3AKICAgICAgICB9CiAgICAgICAgdGhpcy5vcFF1ZXVlLnB1c2goT2JqZWN0LnRvSlNPTih1bmRvT3BKc29uKSk7CiAgICB9LAoKICAgIHF1ZXVlU2VsZWN0OiBmdW5jdGlvbihzZWxlY3Rpb24pIHsKICAgICAgICB0aGlzLm9wUXVldWUucHVzaChPYmplY3QudG9KU09OKHsgdXNlcm5hbWU6IF9lZGl0U2Vzc2lvbi51c2VybmFtZSwgYWN0aW9uOiAic2VsZWN0IiwgYXJnczogeyBzdGFydFBvczogKHNlbGVjdGlvbikgPyBzZWxlY3Rpb24uc3RhcnRQb3MgOiB1bmRlZmluZWQsIGVuZFBvczogKHNlbGVjdGlvbikgPyBzZWxlY3Rpb24uZW5kUG9zIDogdW5kZWZpbmVkIH19KSk7CiAgICB9Cn0pOw==</content>
</attachment>
<attachment>
<filename>icnfontsize.png</filename>
<filesize>1120</filesize>
<author>XWiki.Admin</author>
<date>1235337053000</date>
<version>1.2</version>
<comment></comment>
<content>iVBORw0KGgoAAAANSUhEUgAAACIAAAAUCAYAAADoZO9yAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABAJJREFUeNrMVl1IlFkY9hunsnTaaqLBorCUcCzRhH4gI4MK+3Fx3ail2m22aJMFoYsugugiYfAqXGHTkAIlULIkTc3Mi23xRtCLTJS1UZD8mdT1Z5oZR8cZp+eh98TXkHUhhAcezvee9z3veX/P+bRQKBSxFIb2HfQbBPym10GZP4uAcTGnfCuamqZFYooCont7ey+YzeZNMzMzL2JjY59jbxD8RXtJB1bIIcsBHqjRMAWRiwa2ZGRkHA7JmJ2d7ZB9i87GMmA1sNHpdBb7fL5/MZ+gMWGG0NgNwO7Kysp7Id1oa2vLkHR91dtI8XKFHGoI48cAW9PT0zOVYo/H85TyYYasBLYBx4aHh99Srrm5uYnzyMjIHdG94KAXJsAyODhoRz5fdnZ2WnVhjBQv91RUVNynUr/f7+ZcVFS0RaVHjF8DpGRnZ+eRD32DCQkJ1/kdCARckjZtoWisYk4Zzrm5uffcNDY2dktnvfIyE8XXQ35NTc1jzv39/dfoiBhC+Y3AgZaWlqfkV1dXPwF9ZWBg4DXpjo6On8WxiIiwsBukiNYVFBScMBqNpqmpKYfJZPpJlyKmKyYnJ2dbfHz8dhjjKC4ufsXNFovlAuW0j62wXFJoSklJ2Us+IvgCk7u2tvYl6bi4uN8X6loeshk42N3d3QYjxkpLS2/T+tbW1kPCp5f7GxsbK7heVlb2APSloaGhV6QbGhpSRbmZUc3Pz7dLWtgpmcDpxMTEvPB0hqeFtWFNS0s7rQorKSnpiq64fgC2A8ddLtco161W6580pL6+/iHp0dHRv1XLAkfhQIsqaLfb/Y77Jicn/1drKp16Q1QR7i0pKfmLQk1NTc30GB3hRO+/lWjtzs3NvRlaYIicBdiRnJxsQ2tPc53RpRGcJyYmxtU65k6pu0+DtREHHIaVXV86pKqq6g/wjygv2ZJ9fX3/ORyONwSM8HC9rq6Oud+PsN8hTRnQ55kWwAZcRX3dUPKSToNKCy+oHampqWfJREE9An2RYQd+ZU57enrq8X0KLe0l8P0b8IvI5BUWFt7lXhjFO+Wkcqi8vLwA9D4gDUgHcoDL7e3t/+jSuUx1yzpgJ7wpItNms51l6zHPwI9dXV2NNMZut+eTj2J+Jsp3sbiBbOAMZQg4dI4e8zsrK2ufpH2NFDv3ZFGX1+sdhlOv2QjqJmVE1ouwn20GzEkLrpbUqVfUB0wI/CJjlr0GeV1ZgAFgHHACLlln560FYqU5vMIf13T3x0rpfyqflo1RcslF6e6cGVEwLYepOyNa1wGa8CjnAWbl2VevcYwYFRSnfZrufYnUeUTMi2LFU/0elEMCotwgcsawC3JeJzcf9n+i9IaEH9SWyh+aIWKJjA8CDAB1IbdTlOlFiQAAAABJRU5ErkJggg==</content>
</attachment>
<attachment>
<filename>script.gif</filename>
<filesize>1071</filesize>
<author>XWiki.Admin</author>
<date>1235823650000</date>
<version>1.1</version>
<comment></comment>
<content>R0lGODlhEAAQAPfEAPf7/sTd+cHd+v3+/8Pd+r/c+Pv9//r8/8Db+cHc+cDd+b/c+tHj+vT5/U9zoFeO02md4sri+qbL6aXK64CdwdPf7jVekrzb+VmFtLza+X+96NTn+0+Lv93t+e/y9pSqxuTx/YWkx/H2/kBuocLd+vn7/4G86v3+/nyewne36Nvo+miu4P3//8Dc+JWvznG15UuFuVeUyIau5KO61vD2/Pn8/sjh+/z9/qa50Mzk+sXe+bXV+dnr+HCg4GyKsMLe+FmP1NPm+73c+W+e2NLl+uLq9cLd+dDi8dDj+1qPy5/I5+bv+22y5r3a+Gmr3djp/L/b+FeJub/b+rvM3vT4+8Db+ICx2F+CrcHd+ZbI7OLw/VBzoV1+qMng+3Gd0nul2Ye437LQ7erz+8Tf897r/ff6/fb6/cbh+tvq/fX5/MPU59Dl+sDb+jlhldXp+4zA6oO/6PH3/sPd+eTw/ISiw12S1n2852ix5Iyu1WiSvPn7/PP3+090o3aav/D0+Fuazd/t/eLt9crh+sLb+dXe6PH4/VONweHp8t/r+7PG37ra8eHt+9jr/ZrG61KGuaK72GOW2Ky+07rO4mqb16LH98Da+UqEuMzj+8Da9KrQ7Oz1/cPc+vD2/8Hb+tjn9ZK+4Wiw5Nvq/O/0+3uWuGiezcfg+uLv/OXw/VaGt83c7EFpmsbf9a3P922QuMLc+c3i+pGrx5OsyIrC6vz+/+nv9tDn9sHZ8Gak1UFomb/c+dXp/e71/cLe+sff+evx/dPm+MHZ7svi++fw/f///////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAMQALAAAAAAQABAAAAj/AIkR6wDHRAomoO68sKNBVpZaNwQqejOs4rAGYnj8WiVhxRiBmRoNMyXM165CZQ4MA4DJiUAlEwzoYoQGkBYQc4b1KAFG4KcwnARdQhLEzZNQLLwAuyXQiq1FlVzpKBXh1ZoBSf4cEUjKE5EMF6QIEBDAhoEYewQS40Cjl5AFnQiQCNDlgCEqAvXAAJCgQIEqChTICZbGklpajmrkgtJiUAIjBDYEiqL2EKoTvBYgQICFzSYyqfII9IMCzylKrHY0+XEmhyZJfQROGYHhy5BJkOoAeQCBwSM6AmOFsDhsFoA4ImSocAFLYKRWMxKpqVBElJkBiJZQwCHQw4dRPrg4DMBloY0qPle2EBIYEAA7</content>
</attachment>
<attachment>
<filename>bullettoggleplus.gif</filename>
<filesize>186</filesize>
<author>XWiki.Admin</author>
<date>1235823655000</date>
<version>1.1</version>
<comment></comment>
<content>R0lGODlhEAAQAMQYAK2trX9/f7S0tJqamnR0dLq6uoeHh729vampqdPT06+vr4SEhHZ2dp2dnaOjo5CQkHl5eaysrLu7u7Ozs4qKir+/v8LCwv///////wAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAABgALAAAAAAQABAAAAU3ICaOZGmeaKquYlIVgoJI6WHd95AKFnABlkcqYrkYLYaUo/ezBFID3I2RmlAWAQihwep6v+BvCAA7</content>
</attachment>
<attachment>
<filename>scriptedit.gif</filename>
<filesize>1077</filesize>
<author>XWiki.Admin</author>
<date>1235824814000</date>
<version>1.1</version>
<comment></comment>
<content>R0lGODlhEAAQAPfTAPf7/v33x7/c+sHd+r/c+PfiW/fhWsrh+vDStMHc+f3//+TJVcDa+czj+9Xp/dvq/Mff+YzA6tSia/3+/pSqxorC6qbL6Wieze7TeeTw/ISiw8Hb+vD2/OXw/fn7/JuBVvn7/9Xe6Pz9/oWkx8/QrWyKsNuZS4RnLk+Lv/32xP/y4EuFucrSvZWvzsLe+tKYSr56GvnJkfXfW9XUudjn9b3c+env9r/b+tjr/bLQ7cDc+NDn9oG86vT5/Wmr3eLv/MaOSdCdRu71/Wak1cXe+cDb+Pbq3NDj+6a50K5rJ8Pd+rvM3s3i+oe438nOu/D0+NLY4NPm+J/I583QslKGuZbI7KqJQ8fg+uHp8r2+rdG3kOHt+090o+/SrFBzofH4/ZOnxsmFQefLd8HZ8HCg4H2857C2r+/y9tilWHyewnG15bzb+dvq/cri+r/c+fr8/9yYSvLWelVAFvXcX9CVT9W5dvXcXu3QeN/r+22y5kFpmoZgKt3t+fnHlNLl+vDTeVaGt//z5buHSnul2Ulkh+7Ufffv5b/b+F+CrWiu4NPm+5OsyPzgxOe+d8HZ7sWYScLc+fffY5rG6/D2/4CJj+fAi6LH96XK64Cdwefw/fnjssbf9Wix5He36KK72Ky+03+96O3VgWiw5N/t/b7GzZGrx9nr+ICx2IO/6PjiXdiaVLza+evx/dvo+vbdbNjp/JK+4arQ7Pf6/eLw/dDGqHaav0BuofbTrvHUe/n8/tXp+8Tf86O61uTx/dW2eu3KbbPG336RodejY1mFtHGd0urz+9uxhfv9/8yWWW2QuIyu1XuWuNWiabra8f32wsDa9PDl2Obv+////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAANMALAAAAAAQABAAAAj/AKdN44OKR6c8ojipKQOqQpUdIgQ2iyCtorQexUxF2WQh0S6BsSRJ+5GJlZAvst5IA/DMh0Apl445wMFm1KxeGaSRAdFEIKwckw40OKJI16sHCog5GiLw1JgtDCARudKGyQw0xoLQEniBhp9Va24MGECiEYJAXZAJRMEBQg0BG5RMCaWp0i1GEqZ5WAEgAQECRVgUSuHqlzBmhqbZoJLLzSEdTjAEmFMgzgsjArEAmuBCQBYxAewYwGUimMAnaZR1sGSmjrNIqf7AIVVL4BJbwwZR8qVlgYw7dKB40iBw0YiKVlSogvEICJhWLUoJ/JSMF7ATfWKESQINTzRMSASeEqGwrIScPYI+ENLDBZGXEAIDAgA7</content>
</attachment>
<attachment>
<filename>zoom.gif</filename>
<filesize>608</filesize>
<author>XWiki.Admin</author>
<date>1235824818000</date>
<version>1.1</version>
<comment></comment>
<content>R0lGODlhEAAQAOZ1AOz0+u/1+/Tr4u30+vn7/ezz+uny+vTs3PD2++ny+e71+/f6/fr8/ujx+dSwcPbv5L6HTfP4/PL3/OLLud/Fj+fTuuHJuMOSW82mYtKuhMSUWMGOWNGrg93CkfHl2L5zQPHm2KxlP9a1f5dhRsWVa8uplPz5986nY/Ln2cGPWsiaYPfx7fn08dy/pd/Ep9m7jNq7gN/Fo6VcM/Po2vH2+8yhZ/H3/NKubePNu9e2fdCoasORVt3DkdKtbM+pZb2FTM2naNi5i7yEUeTMrPn7/vjy7+jVo7mASObRuezcv9u/h7uFT+nXpfv39b+LUPT4/OXPqeDHk7FyRb6JVdKtd9Krb8mbY9e3febRruTOrN7Eo7NzS7uBTOfToNGqdsGNU+DHtubRr8qgb/jx7ePMmfz6+da0ed7Ejffv5c2kcffw5cmbYd7DpryDT9y+pMqfZc+oY7uGUte1fery+uvz+v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAHUALAAAAAAQABAAAAe9gHV1Bzw3Pic6LzOCjIJJDldhag9ZVDUVjYMOUAsBc3Q0BDFWII0dOQt0DQkGcwoEaRmNPVgIq610dBIuF41waHStn3QFCgJOjRgPBXPDBQABAhCNQEM2uXQAAAMRLVONQV4EAdoDAwgMSySNKG9aRBEBAU8MGlUfOI1IKmJsAgJuvpghc6bNmEYeOKSA8CMOFyVGmMAIsSJTowkbKHSJsmaECYuMLAiRI2KHlCYgGYGRcWRLkZSNWJQoIygQADs=</content>
</attachment>
<object>
<class>
<name>XWiki.JavaScriptExtension</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<cache>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>cache</name>
<number>5</number>
<prettyName>Caching policy</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>long|short|default|forbid</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</cache>
<code>
<name>code</name>
<number>2</number>
<prettyName>Code</prettyName>
<rows>20</rows>
<size>50</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
</code>
<name>
<name>name</name>
<number>1</number>
<prettyName>Name</prettyName>
<size>30</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</name>
<parse>
<displayFormType>select</displayFormType>
<displayType>yesno</displayType>
<name>parse</name>
<number>4</number>
<prettyName>Parse content</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</parse>
<use>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>use</name>
<number>3</number>
<prettyName>Use this extension</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>onDemand=On demand|always=Always</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</use>
</class>
<name>XWiki.SkinEditor</name>
<number>0</number>
<className>XWiki.JavaScriptExtension</className>
<property>
<cache>default</cache>
</property>
<property>
<code>(function(){

var previousSelected;

document.observe("dom:loaded", function(){
    var skinFiles = $$("ul[class='xlist'] li[class*='skinfile']");
    for(var i=0; i&lt;skinFiles.length;i++) {
      if (skinFiles[i].hasClassName("selected")){ 
          previousSelected = skinFiles[i];
      }
      if (skinFiles[i].down('span.xshowcode')) {
         Event.observe(skinFiles[i].down('span.xshowcode'), "click", function(e){
           previousSelected.removeClassName("selected");
           e.element().up('li.xitem').addClassName("selected");
           previousSelected = e.element().up('li.xitem');
           var code = e.element().up('li.xitem').down('div.code pre').innerHTML;
           var filename = e.element().up('li.xitem').down('div.filename').innerHTML;
           $('codecontainercontent').down('pre').innerHTML = code;
           $('codecontainerfile').innerHTML = filename;
         }.bind(this));
      }
    }
});

})();</code>
</property>
<property>
<name>Skin Editor</name>
</property>
<property>
<parse>0</parse>
</property>
<property>
<use>onDemand</use>
</property>
</object>
<object>
<class>
<name>XWiki.StyleSheetExtension</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<cache>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>cache</name>
<number>5</number>
<prettyName>Caching policy</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>long|short|default|forbid</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</cache>
<code>
<name>code</name>
<number>2</number>
<prettyName>Code</prettyName>
<rows>20</rows>
<size>50</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
</code>
<name>
<name>name</name>
<number>1</number>
<prettyName>Name</prettyName>
<size>30</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</name>
<parse>
<displayFormType>select</displayFormType>
<displayType>yesno</displayType>
<name>parse</name>
<number>4</number>
<prettyName>Parse content</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</parse>
<use>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>use</name>
<number>3</number>
<prettyName>Use this extension</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>onDemand=On demand|always=Always</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</use>
</class>
<name>XWiki.SkinEditor</name>
<number>0</number>
<className>XWiki.StyleSheetExtension</className>
<property>
<cache>default</cache>
</property>
<property>
<code>#if(!$xwiki.jsfx) ## PRE 1.8M2 -- add missing styles (are not yet in toucan.css)
.xspacer {
  clear:both !important;
  height: 0 !important;
  width: 0 !important;
  line-height: 0 !important;
  padding: 0 !important;
  margin: 0 !important;
}

/* 
** Wiki items lists (spaces, pages, comments, attachments)
*/

ul.xlist {
  margin: 0 0 0 0.5em !important;
  padding: 0 !important;
}

ul.xlist li.xunderline {
  border-bottom: solid 1px #efefef !important;
}

ul.xlist li.xhighlight:hover {
  background-color: lemonChiffon;
}

ul.xlist li {
  width: 100% !important;
  padding-top: 0.2em;
  list-style-type: none;
}

ul.xlist li.space, ul.xlist li.page, ul.xlist li.comment, ul.xlist li.attachment {
  background-repeat: no-repeat;
  background-position: 2px 3px;
}

ul.xlist li.xitem div.xitemcontainer {
  text-indent: 1.5em;
}

ul.xlist li.xitem div.xitemcontainer ul.xlist {
  text-indent: 0em;
}

#xwikimaincontainerinner .code {
  background-color:#F1F7FF;
  border:1px dotted #555555;
}
#end

#xwikicontent #header {
  background: #000000 url($xwiki.getDocument("XWiki.SkinEditorExtension").getAttachmentURL("SKElogo.jpg")) no-repeat scroll 0 0;
  min-height:50px;
}

ul.xlist li.skinfile span.xshowcode {cursor:pointer;}
ul.xlist li.skinfile div.xmore {
  background-image: url($doc.getAttachmentURL("bullettoggleplus.gif"));
  background-position:2px 3px;
  background-repeat:no-repeat;
  float:right;
  font-size:0.8em;
  padding:0 0.5em 0 0;
}
ul.xlist li.skinfile {
  background-image:url($doc.getAttachmentURL("script.gif"));
  background-position:2px 3px;
  background-repeat:no-repeat;
}
/*ul.xlist li.skinfile div.actions {line-height:0;}
*/
ul.xlist li.selected {background-color:#F1F7FF;}
ul.xlist li.skinfile div.actions a {
  background-image: url($doc.getAttachmentURL("scriptedit.gif"));
  background-repeat: no-repeat;
  background-position:0px -4px;
  padding-left:20px;
} 
ul.xlist li.skinfile div.actions span.xshowcode a {
  background-image: url($doc.getAttachmentURL("zoom.gif"));
  background-repeat: no-repeat;
  background-position:3px -2px;
  padding-left:20px;
} 
/* 
** Hidden elements in lists that are show on hover 
*/
ul.xlist li.xitem div.xshowonhover {
  float: right;
  font-size: 0.8em;
  padding: 0;
  padding-right: 0.5em;
  display: none;
}
ul.xlist li.xitem:hover div.xshowonhover {  display:block;}
/* IE6 hack, see JSX */
ul.xlist li.over div.xshowonhover {display:block;}
</code></property><property><name>Skin Editor</name>
</property>
<property>
<parse>1</parse>
</property>
<property>
<use>onDemand</use>
</property>
</object>
<object>
<class>
<name>XWiki.TagClass</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<tags>
<cache>0</cache>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>tags</name>
<number>1</number>
<prettyName>Tags</prettyName>
<relationalStorage>1</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>30</size>
<unmodifiable>0</unmodifiable>
<values></values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</tags>
</class>
<name>XWiki.SkinEditor</name>
<number>0</number>
<className>XWiki.TagClass</className>
<property>
<tags/>
</property>
</object>
<content>##
## Skin Editor Application
## @programming (to access the engine context for storing pseudo-locks)
## 
## TODO
## - Relative paths for proto + xwiki.js (or check version)
##
##  = Global vars =
##
#set($openPRE = "{" + "pre}")     ## Trick XEclipse to keep syntax coloration inside pre
#set($closePRE = "{/" + "pre}")
#set($code = "{" + "code}")
#set($sc = $context.context.engineContext.servletContext)
#if($request.xpage &amp;&amp; $request.xpage=="plain")
  ##
  ## = Services =
  ##
  #if("$!request.filename" != "")
    ##
    ## @service serve skin or SX content. 
    ## Decode the passed filename to retrieve the proper content. (skin file or JSX/SSX)
    ##
    #set($filename = $request.filename)
    #if($filename.startsWith("XWiki.XWikiSkins_")) ## Ah! we have a skin!
      #set($prefix = "XWiki.XWikiSkins_0_")
      #set($filename = $filename.substring($prefix.length()))
      #set($content = $doc.getObject("XWiki.XWikiSkins").getProperty("$filename").value)
    #else ## Probably a SX
      #if($filename.startsWith("XWiki.StyleSheetExtension_"))  ## SSX
        #set($filename = $filename.replaceAll(".css$",""))    ## Stript the .css, we don't need it here
        #set($nb = $util.parseInt($filename.substring($mathtool.sub($filename.length(), 1)))) ## Miam :)
        #set($content = $doc.getObject("XWiki.StyleSheetExtension", $nb).getProperty("code").value)
      #elseif($filename.startsWith("XWiki.JavaScriptExtension_")) ## JSX 
        #set($filename = $filename.replaceAll(".js$",""))        ## Stript the .js, we don't need it here
        #set($nb = $util.parseInt($filename.substring($mathtool.sub($filename.length(), 1)))) ## Again, Miam :(
        #set($content = $doc.getObject("XWiki.JavaScriptExtension", $nb).getProperty("code").value)
      #end ## If not, you won't have content and that's it! 
    #end
    ##
    ## give the found content if any as ajax request response.
    ##
    #if("$!content" != "")
$openPRE
$content
$closePRE
    #else ## in case it's empty, so that we don't get template does not exists.
Empty file.
    #end
  #elseif("$!request.release" != "")
    ##
    ## @service release a pseudo-lock (when changing file or leaving the editor). 
    ##
    #set($docName = $request.release)
    #set($file = $request.file)
    #set($locks = $sc.getAttribute("pseudolocks")) 
    #if($locks.containsKey("${context.database}:${docName}_${file}"))
      $locks.remove("${context.database}:${docName}_${file}")
      OK
    #end
  #elseif("$!request.update" != "")
    ##
    ## @service update a pseudo-lock (when saving file). 
    ##
    #set($docName = $request.update)
    #set($file = $request.file)
    #set($locks = $sc.getAttribute("pseudolocks")) 
    #if($locks.containsKey("${context.database}:${docName}_${file}"))
        #set($data = $util.arrayList)
        #set($ok = $data.add($mathtool.add($xwiki.date.time, 1800000))) ## 30 minutes
        #set($ok = $data.add($context.user)) 
        #set($ok = $locks.put("${context.database}:${docName}_${file}", $data))   
      OK
    #end
  #elseif("$!request.service" == "files")
    ##
    ## @service 
    ## give the file list for a SX or a Skin document.
    ## Called by the editor to refresh list of files and locks. 
    ##
    #set($sDoc = $xwiki.getDocument("$!request.doc"))
    #if($sDoc.getObject('XWiki.XWikiSkins'))
      #skinFilesList($sc $sDoc, "$!request.file", false, false)
    #else
      #sxFilesList($sc $sDoc, "$!request.file", false, false)
    #end
  #elseif($xwiki.hasAccessLevel("edit"))
    ##
    ## = Main = (edit mode)
    ##
$openPRE
    #if("$request.type" != "") ## Available types: sx, skin
      #set($type=$request.type)
    #else
      #set($type="sx") ## default on SX
    #end
    #if($type == "skin")
      ##
      ## XWiki.XWikiSkins files edition.
      ##
      #if("$!request.file" != "") #set($file = $request.file) #else #set($file = "style.css") #end
      #set($skin = $doc.getObject('XWiki.XWikiSkins'))
      #set($content = $skin.getProperty("${file}").value)
      ## Compose pseudo filename that will be passed around in bespin
      #set($filename = "XWiki.XWikiSkins_0_${file}") 
    #elseif($type == "sx")
      ##
      ## XWiki.JavaScriptExtension and XWiki.StyleSheetExtension files edition.
      ##
      #if("$!request.ext" != "") #set($ext = $request.ext) #else #set($ext = "js") #end
      #if($ext == "js") 
        #set($className = "XWiki.JavaScriptExtension")
      #elseif($ext == "css")
        #set($className = "XWiki.StyleSheetExtension")
      #else    
        #error("Invalid SX extension $ext") #set($hasError = 1)
      #end
      #if(!$hasError) ## No need to go further
        #if("$!request.o" != "") #set($number = $util.parseInt($request.o)) #else #set($number = 0) #end
        #set($extObject = $doc.getObject("$className",$number))
        #if($extObject)
          #set($content = $extObject.getProperty("code").value)
          #set($filename = "${className}_${number}.${ext}")
          #set($file = "${number}.${ext}")
        #else
          #error("Cound not find object $className number $number")
        #end
      #end
    #else
      #error("Invalid type: $type") #set($hasError = 1)
    #end
    #set($sc = $context.context.engineContext.servletContext)
    #if($hasError)
      #error("Error")
    #else
      ##
      ## Check pseudo-locks
      ##
      #if(!$sc.getAttribute("pseudolocks")) ## Lazy lock map creation in memory
        #set($ok = $sc.setAttribute("pseudolocks", $util.hashMap))
      #end
      #set($locks = $sc.getAttribute("pseudolocks"))
      #if($locks.containsKey("${context.database}:${doc.fullName}_${filename}"))
        #set($lockData = $locks.get("${context.database}:${doc.fullName}_${filename}"))
        #set($lockedUntil = $listtool.get($lockData, 0))
        #if($lockedUntil &lt; $xwiki.date.time)
          ## Lock is timed-out, let's remove it
          #set($ok = $locks.remove("${context.database}:${doc.fullName}_${filename}"))
        #else
          #set($locker = $listtool.get($lockData, 1))
          #if($locker != "$context.user") ## The locker is different from the context user
            #if($request.force &amp;&amp; $request.force=="1")
              #set($ok = $locks.remove("${context.database}:${doc.fullName}_${filename}")) ## Forced, let's remove the old lock
            #else
              #set($isLocked=1)
            #end
          #end
        #end
      #end
      #includeMacros("XWiki.SkinEditorMacros")
      #if(!$isLocked) ## if it's free, put our own lock here
        #set($data = $util.arrayList)
        #set($ok = $data.add($mathtool.add($xwiki.date.time, 1800000))) ## 30 minutes
        #set($ok = $data.add($context.user)) 
        #set($ok = $locks.put("${context.database}:${doc.fullName}_${filename}", $data))   
      #end
#template("xwikivars.vm")
&lt;html&gt;
  &lt;head&gt;
    &lt;meta name="document" content="$doc.fullName"/&gt; ## Useful metas for the JS code
    &lt;meta name="filename" content="$filename"/&gt;
    &lt;meta name="file" content="$file"/&gt;
#template("stylesheets.vm")  ## couple of includes. TODO: replace and include just what is necessary
    ## Bootstrap bespin.
    #if($xwiki.jsfx) ## POST 1.8 M2
      &lt;script type="text/javascript" src="$xwiki.getSkinFile("js/prototype/prototype.js")"&gt;&lt;/script&gt;
      &lt;script type="text/javascript" src="$xwiki.getSkinFile("js/xwiki/xwiki.js", true)"&gt;&lt;/script&gt;
    #else ## compatibility with older versions
      &lt;script type="text/javascript" src="${request.contextPath}/prototype.js"&gt;&lt;/script&gt;
      &lt;script type="text/javascript" src="$xwiki.getSkinFile("xwiki.js")"&gt;&lt;/script&gt;
    #end
    #if(!$isLocked)
    &lt;script src=$xwiki.getDocument('XWiki.SkinEditor').getAttachmentURL('bespin.js')&gt;&lt;/script&gt;
    #end
    ## Hook for inserting JavaScript skin extensions
    &lt;!-- com.xpn.xwiki.plugin.skinx.JsSkinExtensionPlugin --&gt;
    &lt;!-- com.xpn.xwiki.plugin.skinx.JsSkinFileExtensionPlugin --&gt;
        #set($ok = $xwiki.ssx.use('XWiki.SkinEditorExtension'))
  &lt;/head&gt;
        #set($sxParams = $util.hashMap)
        #if(!$isLocked)
          #set($void = $xwiki.jsx.use("XWiki.BespinXWikiAdapter"))
          #set($void = $xwiki.jsx.use("XWiki.SkinEditorExtension"))
        #end
        ##
        ## Some elements bespin code relies they are in the DOM. 
        ## Hide the things we don't want (collab, buttons, etc.) and add our stuff
        ##
  &lt;body id=body&gt;
    &lt;div id="header"&gt;
      &lt;div id="collab_line" style="display:none"&gt;&lt;/div&gt;
      &lt;div id="version" style="display:none"&gt;&lt;/div&gt;
      &lt;span id="selected_browsers" style="display:none"&gt;&lt;/span&gt;
      &lt;span id="themes"&gt;
        #set($theme = $xwiki.getUserPreferenceFromCookie("skineditortheme"))
        #if("$!theme" == "") #set($theme = "coffee") #end
        &lt;select id="skineditortheme"&gt;
          &lt;option value="coffee" #if($theme=="coffee")selected#end&gt;Coffee&lt;/option&gt;
          &lt;option value="white"#if($theme=="white")selected#end&gt;White&lt;/option&gt;
          &lt;option value="black"#if($theme=="black")selected#end&gt;Black&lt;/option&gt;
        &lt;/select&gt;
        #set($zebra = $xwiki.getUserPreferenceFromCookie("skineditorzebra"))
        #if("$!zebra" == "") #set($zebra = "0") #end
        Zebra &lt;input type="checkbox" id="skineditorzebra" #if($zebra != "0")checked#end/&gt;
      &lt;/span&gt;
    &lt;/div&gt;
    &lt;div id="subheader" style="right:220px;"&gt; ## Do not remove the style, bespin relies on it.
      &lt;div id="xwikiextra" class="coffee"&gt;
        &lt;span class="buttonwrapper"&gt;&lt;button id="bespinsave"&gt;Save&lt;/button&gt;&lt;/span&gt;
        &lt;span class="buttonwrapper"&gt;&lt;button id="backtoxwiki"&gt;Back to the wiki&lt;/button&gt;&lt;/span&gt;
        &lt;img id="fontsize" title="Font Size" alt="Font Size" src="$xwiki.getDocument('XWiki.SkinEditor').getAttachmentURL('icnfontsize.png')"/&gt;
        &lt;span id="info" class="infomessage" style="display:none"&gt;&lt;/span&gt;
      &lt;/div&gt;
      &lt;div id="status" style="display:none"&gt;&lt;canvas id="projectLabel"&gt;&lt;/canvas&gt;&lt;/div&gt;
    &lt;/div&gt;
    #if($isLocked)
    &lt;div id="lockmessage"&gt;
      #set($forceLink = "${doc.getURL('view')}?${request.queryString}&amp;force=1")
      #warning("Locked by $xwiki.getUserName($locker, false). &lt;a href=${forceLink}&gt;Click this link to force edition.&lt;/a&gt;")
    &lt;/div&gt;
    #else
    &lt;div id="editor" width="1200" height="500"&gt;&lt;/div&gt;
    #end
    &lt;div id="files" class="coffee"&gt;
      ## Look in user cookie to see wheter or not to hide empty files when firing the editor.
        #set($hideemptyfiles = $xwiki.getUserPreferenceFromCookie("skineditorhideemptyfiles"))
      &lt;div id="filesheader"&gt;Files &lt;span&gt;hide empty&lt;input type="checkbox" id="skinfileshide" #if(!$hideemptyfiles ||"$!hideemptyfiles"=="1")checked#end/&gt;&lt;/span&gt;&lt;/div&gt;
      &lt;div id="filelist"&gt;
      #if($doc.getObject('XWiki.XWikiSkins'))
        #skinFilesList($sc $doc, $file, false, false)
      #else
        #sxFilesList($sc $doc, $file, false, false)
      #end
      &lt;/div&gt;
      &lt;div id="filesfooter"&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div id="footer"  style="height:18px;"&gt;
      &lt;div id="prompt" style="display:none; height:18px;"&gt;&lt;img id="promptimg" src="images/icn_command.png" alt="&gt;" &gt;&lt;/div&gt;
      &lt;div id="commandline" style="height:18px;"&gt;&lt;input id="command" style="display:none;"&gt;&lt;/div&gt;
      &lt;div id="message" style="display:none;"&gt;&lt;/div&gt;
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
    #end
  #else
$response.sendRedirect("$doc.getURL('view','warning=cannotedit')")
  #end
#else
 ##
 ## = Main = (view mode)
 ##
#if($xwiki.getDocument("XWiki.SkinEditor").document) ## Check we can execute the programming right.
#includeMacros("XWiki.SkinEditorMacros")
#set($code = "{" + "code}") ## Trick to expand a velocity variable inside the code block
#if("$!request.warning" == "cannotedit")
 #warning("You are not allowed to edit this document.")
#end
#if("$!request.info" == "activated")
 #info("The Skin Editor has been successfully activated on this wiki. Thanks!")
#end
&lt;div id="header"&gt;&lt;/div&gt;

1.1 $doc.name

$xwiki.jsx.use("XWiki.SkinEditor")
$xwiki.ssx.use("XWiki.SkinEditor")

&lt;div id="skinfilelist"&gt;
&lt;div style="float: left; width: 33%;"&gt;
#if($doc.getObject("XWiki.XWikiSkins"))
#skinFilesList($sc, $doc, "", true, true)
#else
#sxFilesList($sc, $doc, "", true, true)
#end
&lt;/div&gt;
#if($codeContainerFile &amp;&amp; $codeContainerContent) ## Check that not all files are empty
&lt;div id="codecontainer" style="float: left; width: 66%;"&gt;
 &lt;div style="padding-left:20px;"&gt;
  &lt;div id="codecontainerfile"&gt;&lt;tt&gt;$codeContainerFile&lt;/tt&gt;&lt;/div&gt;
  &lt;div id="codecontainercontent"&gt;
  $code
  $codeContainerContent
  $code
  &lt;/div&gt;
 &lt;/div&gt;
&lt;/div&gt;
#end
&lt;div style="clear: both; margin-bottom: 40px;"&gt;&lt;/div&gt;
&lt;/div&gt;
 #else
  ##
  ## Skin Editor not saved with programming right.
  ##
  #set($documentName = "XWiki.SkinEditor")
   #set($warningText = "The document *${documentName}* needs to be saved with by a user with Programming Access Level for the Skin Editor to be available.")
   #if($context.hasAccessLevel("programming", $documentName))
    #set($saveURL = $xwiki.getURL("${documentName}",'save',"xredirect=${doc.getURL('view')}?info=activated"))
    #set($warningText = "${warningText} You ($xwiki.getUserName($context.user, false)) have the programming Access Level. &lt;a href=${saveURL}&gt;Click this link to save $documentName&lt;/a&gt; and activate the Skin Editor.")
   #else
    #set($warningText = "${warningText} You ($xwiki.getUserName($context.user, false)) do not have the Programming Access Level. Contact your administrator to activate the Skin Editor on this wiki.")
   #end
   #warning("${warningText}")
 #end
#end</content>
</xwikidoc>
